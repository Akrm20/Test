<!DOCTYPE html>
<html lang="ar" dir="rtl" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro-ERP ูุญูู</title>
    
    <!-- ุฑูุงุจุท CDN ูุญุฏุซุฉ ููุถูููุฉ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        /* ========== ุฃููุงุท CSS ุงูุฎุงุตุฉ ุจุงูุชุทุจูู ========== */

        /* ========== ุงููุชุบูุฑุงุช ุงูุนุงูุฉ (ุงูุฃููุงูุ ุงูุฃุจุนุงุฏุ ุงูุซููุงุช) ========== */
        :root {
            --primary-color: #4361ee;          /* ุงูููู ุงูุฃุณุงุณู ููุชุทุจูู */
            --secondary-color: #1108c1;        /* ุงูููู ุงูุซุงููู */
            --sidebar-width: 250px;            /* ุนุฑุถ ุงูุดุฑูุท ุงูุฌุงูุจู */
            --header-height: 60px;             /* ุงุฑุชูุงุน ุงูุฑุฃุณ */
            --success: #198754;                /* ููู ุงููุฌุงุญ */
            --warning: #ffc107;                /* ููู ุงูุชุญุฐูุฑ */
            --danger: #dc3545;                 /* ููู ุงูุฎุทุฃ */
            --info: #0dcaf0;                   /* ููู ุงููุนูููุงุช */
            --light: #f8f9fa;                  /* ุงูููู ุงููุงุชุญ */
            --dark: #212529;                   /* ุงูููู ุงูุฏุงูู */
        }

        /* ========== ุซูู ุงูููุท ุงููุงุชุญ ========== */
        [data-bs-theme="light"] {
            --bs-body-bg: #f8f9fa;             /* ุฎูููุฉ ุงูุฌุณู */
            --bs-body-color: #212529;          /* ููู ูุต ุงูุฌุณู */
            --card-bg: #ffffff;                /* ุฎูููุฉ ุงูุจุทุงูุงุช */
            --sidebar-bg: #ffffff;             /* ุฎูููุฉ ุงูุดุฑูุท ุงูุฌุงูุจู */
            --sidebar-link-hover: #e9ecef;     /* ุฎูููุฉ ุนูุงุตุฑ ุงูุดุฑูุท ุงูุฌุงูุจู ุนูุฏ ุงูุชูุฑูุฑ */
        }

        /* ========== ุซูู ุงูููุท ุงูุฏุงูู ========== */
        [data-bs-theme="dark"] {
            --bs-body-bg: #121212;             /* ุฎูููุฉ ุงูุฌุณู ูู ุงููุถุน ุงูุฏุงูู */
            --bs-body-color: #e0e0e0;          /* ููู ูุต ุงูุฌุณู ูู ุงููุถุน ุงูุฏุงูู */
            --card-bg: #1e1e1e;                /* ุฎูููุฉ ุงูุจุทุงูุงุช ูู ุงููุถุน ุงูุฏุงูู */
            --sidebar-bg: #1e1e1e;             /* ุฎูููุฉ ุงูุดุฑูุท ุงูุฌุงูุจู ูู ุงููุถุน ุงูุฏุงูู */
            --sidebar-link-hover: #2c2c2c;     /* ุฎูููุฉ ุนูุงุตุฑ ุงูุดุฑูุท ุงูุฌุงูุจู ุนูุฏ ุงูุชูุฑูุฑ ูู ุงููุถุน ุงูุฏุงูู */
            --bs-card-bg: var(--card-bg);      /* ุฎูููุฉ ุงูุจุทุงูุงุช ูู ุงููุถุน ุงูุฏุงูู */
            --bs-card-color: var(--bs-body-color); /* ููู ูุต ุงูุจุทุงูุงุช ูู ุงููุถุน ุงูุฏุงูู */
        }

        /* ========== ุฃููุงุท ุงูุฌุณู ุงูุนุงูุฉ ========== */
        body {
            background-color: var(--bs-body-bg);   /* ุชุทุจูู ุฎูููุฉ ุงูุฌุณู */
            color: var(--bs-body-color);           /* ุชุทุจูู ููู ุงููุต */
            transition: background-color 0.3s, color 0.3s; /* ุชุฃุซูุฑ ุงูุชูุงูู ููุชุบููุฑ ุจูู ุงูุซููุงุช */
            padding-top: var(--header-height);     /* ุฅุถุงูุฉ ูุณุงุญุฉ ููุฑุฃุณ ุงูุซุงุจุช */
        }

        /* ========== ุฃููุงุท ุงูุจุทุงูุงุช ุงูุนุงูุฉ ========== */
        .card {
            background-color: var(--card-bg);      /* ุฎูููุฉ ุงูุจุทุงูุงุช */
            transition: background-color 0.3s;     /* ุชุฃุซูุฑ ุงูุชูุงูู ูุชุบููุฑ ุงูุฎูููุฉ */
            border: 1px solid var(--sidebar-link-hover); /* ุฅุทุงุฑ ุงูุจุทุงูุงุช */
        }

        /* ========== ุฃููุงุท ุงูุฑุฃุณ ุงูุนููู ========== */
        .header {
            position: fixed;                    /* ุชุซุจูุช ุงูุฑุฃุณ ูู ุงูุฃุนูู */
            top: 0;                            /* ุงููุญุงุฐุงุฉ ููุฃุนูู */
            right: 0;                          /* ุงููุญุงุฐุงุฉ ูููููู (ููุชุฎุทูุท ุงูุนุฑุจู) */
            left: 0;                           /* ุชูุชุฏ ุนูู ูุงูู ุงูุนุฑุถ */
            height: var(--header-height);       /* ุงุฑุชูุงุน ุงูุฑุฃุณ */
            z-index: 1030;                     /* ุชุฑุชูุจ ุงูุทุจูุงุช (ุฃุนูู ูู ูุนุธู ุงูุนูุงุตุฑ) */
            background-color: var(--card-bg);  /* ุฎูููุฉ ุงูุฑุฃุณ */
            border-bottom: 1px solid var(--sidebar-link-hover); /* ุฎุท ูุงุตู ุฃุณูู ุงูุฑุฃุณ */
            display: flex;                      /* ุงุณุชุฎุฏุงู flexbox ูููุญุงุฐุงุฉ */
            align-items: center;               /* ูุญุงุฐุงุฉ ุงูุนูุงุตุฑ ูู ุงูููุชุตู ุนููุฏูุงู */
        }

        /* ========== ุฃููุงุท ุงูุดุฑูุท ุงูุฌุงูุจู ========== */
        .sidebar {
            position: fixed;                   /* ุชุซุจูุช ุงูุดุฑูุท ุงูุฌุงูุจู */
            top: var(--header-height);         /* ุงููุณุงูุฉ ูู ุงูุฃุนูู (ุฃุณูู ุงูุฑุฃุณ) */
            bottom: 0;                         /* ุชูุชุฏ ุญุชู ุงูุฃุณูู */
            right: 0;                          /* ุงููุญุงุฐุงุฉ ูููููู (ููุชุฎุทูุท ุงูุนุฑุจู) */
            width: var(--sidebar-width);       /* ุนุฑุถ ุงูุดุฑูุท ุงูุฌุงูุจู */
            z-index: 1000;                     /* ุชุฑุชูุจ ุงูุทุจูุงุช */
            background-color: var(--sidebar-bg); /* ุฎูููุฉ ุงูุดุฑูุท ุงูุฌุงูุจู */
            transform: translateX(100%);       /* ุฅุฎูุงุก ุงูุดุฑูุท ุฎุงุฑุฌ ุงูุดุงุดุฉ (ููููุงุชู) */
            transition: transform 0.3s ease-in-out; /* ุชุฃุซูุฑ ุงูุฒูุงูู */
            padding-top: 1rem;                 /* ูุณุงุญุฉ ุฏุงุฎููุฉ ูู ุงูุฃุนูู */
            border-left: 1px solid var(--sidebar-link-hover); /* ุฎุท ูุงุตู ุนูู ุงููุณุงุฑ */
        }

        .sidebar.show {
            transform: translateX(0);          /* ุฅุธูุงุฑ ุงูุดุฑูุท ุงูุฌุงูุจู */
        }

        /* ========== ุฃููุงุท ุงูุฑูุงุจุท ูู ุงูุดุฑูุท ุงูุฌุงูุจู ========== */
        .sidebar .nav-link {
            color: var(--bs-body-color);       /* ููู ูุต ุงูุฑูุงุจุท */
            padding: 0.75rem 1rem;             /* ุงููุณุงุญุฉ ุงูุฏุงุฎููุฉ ููุฑูุงุจุท */
            display: flex;                     /* ุงุณุชุฎุฏุงู flexbox */
            align-items: center;               /* ูุญุงุฐุงุฉ ุงูุนูุงุตุฑ ูู ุงูููุชุตู ุนููุฏูุงู */
        }

        .sidebar .nav-link:hover, 
        .sidebar .nav-link.active {
            background-color: var(--sidebar-link-hover); /* ุฎูููุฉ ุนูุฏ ุงูุชูุฑูุฑ ุฃู ุงูุชุญุฏูุฏ */
            color: var(--primary-color);       /* ุชุบููุฑ ููู ุงููุต */
            border-right: 3px solid var(--primary-color); /* ุฎุท ูููุฒ ุนูู ุงููููู */
        }

        /* ========== ุฃููุงุท ุงููุญุชูู ุงูุฑุฆูุณู ========== */
        .main-content {
            padding: 1rem;                     /* ูุณุงุญุฉ ุฏุงุฎููุฉ */
            transition: margin-right 0.3s;     /* ุชุฃุซูุฑ ุงูุชูุงูู ุนูุฏ ูุชุญ/ุฅุบูุงู ุงูุดุฑูุท ุงูุฌุงูุจู */
        }

        /* ========== ุฃููุงุท ุงููุญุฏุงุช/ุงูุดุงุดุงุช ========== */
        .module {
            display: none;                     /* ุฅุฎูุงุก ุฌููุน ุงูุดุงุดุงุช ุงูุชุฑุงุถูุงู */
            animation: fadeIn 0.5s;            /* ุชุฃุซูุฑ ุธููุฑ ุชุฏุฑูุฌู */
        }

        .module.active {
            display: block;                    /* ุฅุธูุงุฑ ุงูุดุงุดุฉ ุงููุดุทุฉ ููุท */
        }

        @keyframes fadeIn {
            from { opacity: 0; }              /* ุจุฏุงูุฉ ุงูุดูุงููุฉ */
            to { opacity: 1; }                /* ููุงูุฉ ุงูุดูุงููุฉ */
        }

        /* ========== ุฃููุงุท ุจุทุงูุงุช ุงููุคุดุฑุงุช (KPI) ูู ููุญุฉ ุงูุชุญูู ========== */
        .kpi-card {
            text-align: center;                /* ูุญุงุฐุงุฉ ุงููุต ูู ุงูููุชุตู */
            padding: 1rem;                     /* ูุณุงุญุฉ ุฏุงุฎููุฉ */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); /* ุธู ุฎููู */
        }

        .kpi-value {
            font-size: 2rem;                   /* ุญุฌู ุฎุท ูุจูุฑ ููููู */
            font-weight: 700;                  /* ุณูู ุงูุฎุท */
            color: white !important;       /* ููู ุงูููู */
            margin: 0.5rem 0;                  /* ูุณุงูุฉ ุญูู ุงูููู */
        }

        /* ========== ุฃููุงุท ุจุทุงูุงุช ุงูููุชุฌุงุช ========== */
        .product-card:hover {
            transform: translateY(-3px);       /* ุชุฃุซูุฑ ุฑูุน ุนูุฏ ุงูุชูุฑูุฑ */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* ุธู ุฃูุจุฑ ุนูุฏ ุงูุชูุฑูุฑ */
        }

        /* ========== ุฃููุงุท ุณูุฉ ุงููุดุชุฑูุงุช ูู ููุทุฉ ุงูุจูุน ========== */
        #posCart {
            position: fixed;                   /* ุชุซุจูุช ุงูุณูุฉ */
            top: 0;                            /* ุงููุญุงุฐุงุฉ ููุฃุนูู */
            left: 0;                           /* ุงููุญุงุฐุงุฉ ูููุณุงุฑ */
            width: 100%;                       /* ุนุฑุถ ูุงูู ุนูู ุงูููุงุชู */
            max-width: 400px;                  /* ุฃูุตู ุนุฑุถ ุนูู ุงูุดุงุดุงุช ุงููุจูุฑุฉ */
            height: 100%;                      /* ุงุฑุชูุงุน ูุงูู */
            background-color: var(--card-bg);  /* ุฎูููุฉ ุงูุณูุฉ */
            z-index: 1050;                     /* ุชุฑุชูุจ ุทุจูุงุช ุนุงูู */
            transform: translateX(-100%);      /* ุฅุฎูุงุก ุฎุงุฑุฌ ุงูุดุงุดุฉ */
            transition: transform 0.3s ease-in-out; /* ุชุฃุซูุฑ ุงูุฒูุงูู */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); /* ุธู */
            padding-top: var(--header-height); /* ูุณุงุญุฉ ููุฑุฃุณ */
        }

        #posCart.show {
            transform: translateX(0);          /* ุฅุธูุงุฑ ุงูุณูุฉ */
        }

        /* ========== ุฒุฑ ุงูุณูุฉ ุงูุนุงุฆู (FAB) ========== */
        .fab-cart {
            position: fixed;                   /* ุชุซุจูุช ุงูุฒุฑ */
            bottom: 20px;                      /* ุงููุณุงูุฉ ูู ุงูุฃุณูู */
            left: 20px;                        /* ุงููุณุงูุฉ ูู ุงููุณุงุฑ */
            width: 60px;                       /* ุนุฑุถ ุงูุฒุฑ */
            height: 60px;                      /* ุงุฑุชูุงุน ุงูุฒุฑ */
            border-radius: 50%;                /* ุดูู ุฏุงุฆุฑู */
            font-size: 1.5rem;                 /* ุญุฌู ุงูุฃููููุฉ */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* ุธู */
            z-index: 1040;                     /* ุชุฑุชูุจ ุงูุทุจูุงุช */
        }

        /* ========== ุนุฏุงุฏ ุงูุณูุฉ ========== */
        .cart-counter {
            position: absolute;                /* ุชููุถุน ูุทูู ุฏุงุฎู ุงูุฒุฑ */
            top: -5px;                         /* ุงููุณุงูุฉ ูู ุงูุฃุนูู */
            right: -5px;                       /* ุงููุณุงูุฉ ูู ุงููููู */
            background: #dc3545 !important;               /* ุฎูููุฉ ุญูุฑุงุก */
            color: white !important;                      /* ููู ุงููุต ุฃุจูุถ */
            border-radius: 50%;                /* ุดูู ุฏุงุฆุฑู */
            padding: 2px 7px;                  /* ูุณุงุญุฉ ุฏุงุฎููุฉ */
            font-size: 0.75rem;                /* ุญุฌู ุฎุท ุตุบูุฑ */
        }

        /* ========== ุงุณุชุนูุงูุงุช ุงููุณุงุฆุท ููุดุงุดุงุช ุงููุชูุณุทุฉ ูุงููุจูุฑุฉ ========== */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);      /* ุฅุธูุงุฑ ุงูุดุฑูุท ุงูุฌุงูุจู ุฏุงุฆููุง */
                right: 0;                      /* ุงููุญุงุฐุงุฉ ูููููู */
                top: 0;                        /* ุงููุญุงุฐุงุฉ ููุฃุนูู */
                height: 100vh;                 /* ุงุฑุชูุงุน ูุงูู ููุดุงุดุฉ */
                padding-top: var(--header-height); /* ูุณุงุญุฉ ููุฑุฃุณ */
                border-bottom: none;           /* ุฅุฒุงูุฉ ุงูุญุฏูุฏ */
                border-top: none;              /* ุฅุฒุงูุฉ ุงูุญุฏูุฏ */
                border-left: 1px solid var(--sidebar-link-hover); /* ุฎุท ูุงุตู */
            }
            
            .main-content {
                margin-right: var(--sidebar-width); /* ุฅุถุงูุฉ ูุณุงุญุฉ ููุดุฑูุท ุงูุฌุงูุจู */
                padding: 1rem 1rem 1rem 2rem;  /* ูุณุงุญุฉ ุฏุงุฎููุฉ ูุนุฏูุฉ */
            }
            
            .header {
                right: var(--sidebar-width);   /* ุชุนุฏูู ุนุฑุถ ุงูุฑุฃุณ ูุงุณุชุจุนุงุฏ ุงูุดุฑูุท ุงูุฌุงูุจู */
                left: 0;                       /* ุงููุญุงุฐุงุฉ ูููุณุงุฑ */
            }
            
            #sidebarToggle {
                display: none;                 /* ุฅุฎูุงุก ุฒุฑ toggle ุงูุดุฑูุท ุนูู ุงูุดุงุดุงุช ุงููุจูุฑุฉ */
            }
            
            #posCart {
                left: 0;                       /* ุงููุญุงุฐุงุฉ ูููุณุงุฑ */
                width: 350px;                  /* ุนุฑุถ ุซุงุจุช ููุณูุฉ */
                transform: translateX(-100%);  /* ุฅุฎูุงุก ุฎุงุฑุฌ ุงูุดุงุดุฉ */
            }
            
            .fab-cart {
                display: none;                 /* ุฅุฎูุงุก ุฒุฑ FAB ุนูู ุงูุดุงุดุงุช ุงููุจูุฑุฉ */
            }
        }

        /* ========== ุฃููุงุท ุงููุฎุฒูู ========== */
        .low-stock {
            background-color: rgba(255, 0, 0, 0.1) !important; /* ุฎูููุฉ ุญูุฑุงุก ูุงุชุญุฉ ูููุฎุฒูู ุงูููุฎูุถ */
        }

        .expired {
            background-color: rgba(255, 165, 0, 0.1) !important; /* ุฎูููุฉ ุจุฑุชูุงููุฉ ูุงุชุญุฉ ููููุชุฌุงุช ุงูููุชููุฉ */
        }

        .table th {
            border-top: none;                  /* ุฅุฒุงูุฉ ุงูุญุฏ ุงูุนููู ูุฑุฃุณ ุงูุฌุฏูู */
        }

        /* ========== ุฃููุงุท ููุทุฉ ุงูุจูุน (POS) ========== */
        .pos-container {
            max-width: 500px;                  /* ุฃูุตู ุนุฑุถ ููุญุงููุฉ */
            margin: 0 auto;                    /* ุชูุณูุท ุงูุญุงููุฉ */
        }

        .quick-suggestions {
            display: flex;                     /* ุนุฑุถ ุฃููู ููุงูุชุฑุงุญุงุช */
            overflow-x: auto;                  /* ุชูุฑูุฑ ุฃููู ุฅุฐุง ูุฒู ุงูุฃูุฑ */
            gap: 10px;                         /* ูุณุงูุฉ ุจูู ุงูุนูุงุตุฑ */
            padding: 10px 0;                   /* ูุณุงุญุฉ ุฏุงุฎููุฉ */
            margin-bottom: 15px;               /* ูุณุงูุฉ ูู ุงูุฃุณูู */
        }

        .suggestion-item {
            flex: 0 0 auto;                    /* ููุน ุงูุชูุฏุฏ ูุงูุงูููุงุด */
            width: 80px;                       /* ุนุฑุถ ุซุงุจุช ููุนูุงุตุฑ */
            text-align: center;                /* ูุญุงุฐุงุฉ ุงููุต ูู ุงูููุชุตู */
            cursor: pointer;                   /* ูุคุดุฑ ูุฏ ุนูุฏ ุงูุชูุฑูุฑ */
            padding: 10px;                     /* ูุณุงุญุฉ ุฏุงุฎููุฉ */
            border-radius: 50%;                /* ุดูู ุฏุงุฆุฑู */
            background: var(--card-bg);        /* ุฎูููุฉ ุงูุนูุงุตุฑ */
            border: 2px solid var(--sidebar-link-hover); /* ุฅุทุงุฑ ุงูุนูุงุตุฑ */
            transition: all 0.3s ease;         /* ุชุฃุซูุฑ ุงูุชูุงูู */
        }

        .suggestion-item:hover {
            border-color: var(--primary-color); /* ุชุบููุฑ ููู ุงูุฅุทุงุฑ ุนูุฏ ุงูุชูุฑูุฑ */
            transform: scale(1.05);            /* ุชูุจูุฑ ุทููู ุนูุฏ ุงูุชูุฑูุฑ */
        }

        .suggestion-emoji {
            font-size: 2.5rem;                 /* ุญุฌู ูุจูุฑ ููุฅูููุฌู */
            margin-bottom: 5px;                /* ูุณุงูุฉ ูู ุงูุฃุณูู */
        }

        .suggestion-name {
            font-size: 0.7rem;                 /* ุญุฌู ุฎุท ุตุบูุฑ ููุฃุณูุงุก */
            white-space: nowrap;               /* ููุน ุงูุชูุงู ุงููุต */
            overflow: hidden;                  /* ุฅุฎูุงุก ุงููุต ุงูุฒุงุฆุฏ */
            text-overflow: ellipsis;           /* ุฅุธูุงุฑ ููุงุท ุนูุฏูุง ูุทูู ุงููุต */
        }

        /* ========== ุดุงุฑุฉ ุงููููุฉ ุนูู ุงูููุชุฌุงุช ========== */
        .quantity-badge {
            position: absolute;                /* ุชููุถุน ูุทูู */
            top: -5px;                         /* ุงููุณุงูุฉ ูู ุงูุฃุนูู */
            right: -5px;                       /* ุงููุณุงูุฉ ูู ุงููููู */
            background: var(--warning);        /* ุฎูููุฉ ุตูุฑุงุก */
            color: #000;                       /* ููู ุงููุต ุฃุณูุฏ */
            border-radius: 50%;                /* ุดูู ุฏุงุฆุฑู */
            width: 22px;                       /* ุนุฑุถ ุซุงุจุช */
            height: 22px;                      /* ุงุฑุชูุงุน ุซุงุจุช */
            font-size: 1.5rem;                /* ุญุฌู ุฎุท ุตุบูุฑ */
            display: flex;                     /* ุงุณุชุฎุฏุงู flexbox */
            align-items: center;               /* ูุญุงุฐุงุฉ ุฑุฃุณูุฉ ูู ุงูููุชุตู */
            justify-content: center;           /* ูุญุงุฐุงุฉ ุฃูููุฉ ูู ุงูููุชุตู */
            font-weight: bold;                 /* ูุต ุนุฑูุถ */
            border: 2px solid var(--card-bg);  /* ุฅุทุงุฑ ุจููู ุฎูููุฉ ุงูุจุทุงูุฉ */
            z-index: 1;                        /* ุชุฑุชูุจ ุทุจูุงุช */
        }

        /* ========== ุงูุฅุดุนุงุฑุงุช ุงููุคูุชุฉ ========== */
        .toast-notification {
            position: fixed;                   /* ุชุซุจูุช ุงูุฅุดุนุงุฑ */
            top: 70px;                         /* ุงููุณุงูุฉ ูู ุงูุฃุนูู */
            left: 50%;                         /* ุชูุณูุท ุฃููู */
            transform: translateX(-50%);       /* ุชุนุฏูู ูุฑูุฒู ุฏููู */
            background: var(--success);        /* ุฎูููุฉ ุฎุถุฑุงุก */
            color: white;                      /* ููู ุงููุต ุฃุจูุถ */
            padding: 10px 20px;                /* ูุณุงุญุฉ ุฏุงุฎููุฉ */
            border-radius: 5px;                /* ุฒูุงูุง ุฏุงุฆุฑูุฉ */
            z-index: 1060;                     /* ุชุฑุชูุจ ุทุจูุงุช ุนุงูู */
            animation: slideDown 0.3s ease;    /* ุชุฃุซูุฑ ุงูุฒูุงูู */
        }

        @keyframes slideDown {
            from { top: -50px; opacity: 0; }  /* ุจุฏุงูุฉ ูู ุฎุงุฑุฌ ุงูุดุงุดุฉ */
            to { top: 70px; opacity: 1; }     /* ููุงูุฉ ูู ููุงูู ูุน ุงูุธููุฑ */
        }

        /* ========== ุนุฑุถ ุงูุฑุจุญ ุงููุงุฌุญ ========== */
        .success-profit {
            color: var(--primary-dark, #2d4cd2); /* ููู ุฃุฒุฑู ุฏุงูู ููุฑุจุญ */
            font-weight: bold;                 /* ูุต ุนุฑูุถ */
            font-size: 1.1em;                  /* ุญุฌู ุฎุท ุฃูุจุฑ ููููุงู */
        }

        /* ========== ูุนุงููุฉ ุฑุณุงูุฉ ุงููุงุชุณุงุจ ========== */
        .whatsapp-preview {
            background: #f0f0f0;               /* ุฎูููุฉ ุฑูุงุฏูุฉ ูุงุชุญุฉ */
            padding: 15px;                     /* ูุณุงุญุฉ ุฏุงุฎููุฉ */
            border-radius: 8px;                /* ุฒูุงูุง ุฏุงุฆุฑูุฉ */
            font-family: monospace;            /* ุฎุท ุซุงุจุช ุงูุนุฑุถ */
            white-space: pre-wrap;             /* ุงูุญูุงุธ ุนูู ุงููุณุงูุงุช ูุงูุชูุงู ุงููุต */
            direction: ltr;                    /* ุงุชุฌุงู ุงููุต ูู ุงููุณุงุฑ ูููููู */
            text-align: left;                  /* ูุญุงุฐุงุฉ ุงููุต ูููุณุงุฑ */
        }

        /* ========== ุนุฑุถ ุงููุฆุงุช ูู ููุทุฉ ุงูุจูุน ========== */
        #categoriesView .category-count {
            font-size: 0.8rem;                 /* ุญุฌู ุฎุท ุตุบูุฑ ููุนุฏุงุฏ */
            color: var(--bs-secondary);        /* ููู ุซุงููู */
            background: var(--sidebar-link-hover); /* ุฎูููุฉ */
            padding: 0.2rem 0.5rem;            /* ูุณุงุญุฉ ุฏุงุฎููุฉ */
            border-radius: 12px;               /* ุฒูุงูุง ุฏุงุฆุฑูุฉ */
            margin-top: 0.5rem;                /* ูุณุงูุฉ ูู ุงูุฃุนูู */
        }

        /* ========== ุจุทุงูุงุช ุงูููุชุฌุงุช ูู ููุทุฉ ุงูุจูุน ========== */
        .product-card {
            position: relative;                /* ุชููุถุน ูุณุจู ููุนูุงูุงุช */
            cursor: pointer;                   /* ูุคุดุฑ ูุฏ ุนูุฏ ุงูุชูุฑูุฑ */
            transition: all 0.2s ease-in-out;  /* ุชุฃุซูุฑ ุงูุชูุงูู */
            border: 1px solid var(--sidebar-link-hover); /* ุฅุทุงุฑ */
            border-radius: 8px;                /* ุฒูุงูุง ุฏุงุฆุฑูุฉ */
            padding: 10px;                     /* ูุณุงุญุฉ ุฏุงุฎููุฉ */
            margin-bottom: 10px;               /* ูุณุงูุฉ ุจูู ุงูุจุทุงูุงุช */
        }
        
        .product-image{
            font-size: 2em !important;
            transform: scale(1.5);
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .product-card.added {
            border: 2px solid var(--success);  /* ุฅุทุงุฑ ุฃุฎุถุฑ ุนูุฏ ุงูุฅุถุงูุฉ ููุณูุฉ */
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.3); /* ุธู ุฃุฎุถุฑ */
        }

        /* ========== ุงูุณูุฉ ุงูุนุงุฆูุฉ ========== */
        .floating-cart {
            position: fixed;                   /* ุชุซุจูุช ุงูุณูุฉ ุงูุนุงุฆูุฉ */
            bottom: 90px;                      /* ุงููุณุงูุฉ ูู ุงูุฃุณูู (ููู ุฒุฑ FAB) */
            left: 20px;                        /* ุงููุณุงูุฉ ูู ุงููุณุงุฑ */
            background: var(--primary-color);  /* ุฎูููุฉ ุฒุฑูุงุก */
            color: white;                      /* ููู ุงููุต ุฃุจูุถ */
            padding: 10px 15px;                /* ูุณุงุญุฉ ุฏุงุฎููุฉ */
            border-radius: 25px;               /* ุฒูุงูุง ุฏุงุฆุฑูุฉ ุจุดูู ุจูุถุงูู */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* ุธู */
            z-index: 1040;                     /* ุชุฑุชูุจ ุงูุทุจูุงุช */
            cursor: pointer;                   /* ูุคุดุฑ ูุฏ */
            display: none;                     /* ูุฎูู ุงูุชุฑุงุถููุง */
        }

        .floating-cart-content {
            display: flex;                     /* ุงุณุชุฎุฏุงู flexbox */
            align-items: center;               /* ูุญุงุฐุงุฉ ุฑุฃุณูุฉ ูู ุงูููุชุตู */
            gap: 10px;                         /* ูุณุงูุฉ ุจูู ุงูุนูุงุตุฑ */
        }

        .floating-cart.show {
            display: flex;                     /* ุฅุธูุงุฑ ุงูุณูุฉ ุงูุนุงุฆูุฉ */
        }

        #floatingCartTotal {
            color: #fcfcfc !important;
            font-size: medium;
            font-weight: bold;
        }
        /* ========== ูุชุงุฆุฌ ุงูุจุญุซ ุงูููุฑู ========== */
        .search-results-container {
            position: absolute;                /* ุชููุถุน ูุทูู ุชุญุช ุญูู ุงูุจุญุซ */
            top: 100%;                         /* ุฃุณูู ุญูู ุงูุจุญุซ ูุจุงุดุฑุฉ */
            left: 0;                           /* ูุญุงุฐุงุฉ ูููุณุงุฑ */
            right: 0;                          /* ูุญุงุฐุงุฉ ูููููู */
            background: var(--card-bg);        /* ุฎูููุฉ */
            border: 1px solid var(--sidebar-link-hover); /* ุฅุทุงุฑ */
            border-radius: 8px;                /* ุฒูุงูุง ุฏุงุฆุฑูุฉ */
            max-height: 300px;                 /* ุฃูุตู ุงุฑุชูุงุน */
            overflow-y: auto;                  /* ุชูุฑูุฑ ุฑุฃุณู ุฅุฐุง ูุฒู ุงูุฃูุฑ */
            z-index: 1000;                     /* ุชุฑุชูุจ ุงูุทุจูุงุช */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* ุธู */
        }

        /* ========== ุดุฑูุท ุงููุฆุงุช ========== */
        .categories-bar {
            display: flex;                     /* ุนุฑุถ ุฃููู */
            overflow-x: auto;                  /* ุชูุฑูุฑ ุฃููู ุฅุฐุง ูุฒู ุงูุฃูุฑ */
            gap: 10px;                         /* ูุณุงูุฉ ุจูู ุงูุนูุงุตุฑ */
            padding: 10px 0;                   /* ูุณุงุญุฉ ุฏุงุฎููุฉ */
            margin-bottom: 15px;               /* ูุณุงูุฉ ูู ุงูุฃุณูู */
        }

        .categories-bar .suggestion-item {
            flex: 0 0 auto;                    /* ููุน ุงูุชูุฏุฏ ูุงูุงูููุงุด */
            padding: 10px 15px;                /* ูุณุงุญุฉ ุฏุงุฎููุฉ */
            border-radius: 20px;               /* ุฒูุงูุง ุฏุงุฆุฑูุฉ ุจุดูู ุจูุถุงูู */
            background: var(--card-bg);        /* ุฎูููุฉ */
            border: 2px solid var(--sidebar-link-hover); /* ุฅุทุงุฑ */
            transition: all 0.3s ease;         /* ุชุฃุซูุฑ ุงูุชูุงูู */
            cursor: pointer;                   /* ูุคุดุฑ ูุฏ */
            white-space: nowrap;               /* ููุน ุงูุชูุงู ุงููุต */
        }

        .categories-bar .suggestion-item.active {
            border-color: var(--primary-color); /* ุฅุทุงุฑ ุฃุฒุฑู ูููุฆุฉ ุงููุดุทุฉ */
            background: var(--primary-color);  /* ุฎูููุฉ ุฒุฑูุงุก ูููุฆุฉ ุงููุดุทุฉ */
            color: white;                      /* ููู ุงููุต ุฃุจูุถ */
        }

        /* ========== ุนุฑุถ ุงููุฆุงุช ูู ููุทุฉ ุงูุจูุน ========== */
        #categoriesView .category-card {
            border: 2px solid #e9ecef;         /* ุฅุทุงุฑ ูุงุชุญ */
            border-radius: 12px;               /* ุฒูุงูุง ุฏุงุฆุฑูุฉ */
            padding: 1.5rem 1rem;              /* ูุณุงุญุฉ ุฏุงุฎููุฉ */
            text-align: center;                /* ูุญุงุฐุงุฉ ุงููุต ูู ุงูููุชุตู */
            cursor: pointer;                   /* ูุคุดุฑ ูุฏ */
            transition: all 0.3s ease;         /* ุชุฃุซูุฑ ุงูุชูุงูู */
            background: var(--card-bg);        /* ุฎูููุฉ */
            min-height: 120px;                 /* ุฃูุตู ุงุฑุชูุงุน ููุจุทุงูุฉ */
            display: flex;                     /* ุงุณุชุฎุฏุงู flexbox */
            flex-direction: column;            /* ุงุชุฌุงู ุนููุฏู */
            justify-content: center;           /* ูุญุงุฐุงุฉ ุฑุฃุณูุฉ ูู ุงูููุชุตู */
            align-items: center;               /* ูุญุงุฐุงุฉ ุฃูููุฉ ูู ุงูููุชุตู */
        }

        #categoriesView .category-card:hover {
            border-color: var(--primary-color); /* ุชุบููุฑ ููู ุงูุฅุทุงุฑ ุนูุฏ ุงูุชูุฑูุฑ */
            transform: translateY(-5px);       /* ุชุฃุซูุฑ ุฑูุน ุนูุฏ ุงูุชูุฑูุฑ */
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); /* ุธู ุฃูุจุฑ ุนูุฏ ุงูุชูุฑูุฑ */
        }

        #categoriesView .category-icon {
            font-size: 3.0rem;                 /* ุญุฌู ูุจูุฑ ููุฃููููุฉ */
            margin-bottom: 0.5rem;             /* ูุณุงูุฉ ูู ุงูุฃุณูู */
        }

        #categoriesView .category-name {
            font-weight: 600;                  /* ูุต ุนุฑูุถ ูุชูุณุท */
            font-size: 1rem;                   /* ุญุฌู ุงูุฎุท */
            margin-bottom: 0.25rem;            /* ูุณุงูุฉ ูู ุงูุฃุณูู */
        }

        /* ========== ุฑุฃุณ ุนุฑุถ ุงูููุชุฌุงุช ูู ููุทุฉ ุงูุจูุน ========== */
        #productsView .view-header {
            background: var(--sidebar-link-hover); /* ุฎูููุฉ ุงูุฑุฃุณ */
            padding: 1rem;                     /* ูุณุงุญุฉ ุฏุงุฎููุฉ */
            border-radius: 8px;                /* ุฒูุงูุง ุฏุงุฆุฑูุฉ */
            margin-bottom: 1rem;               /* ูุณุงูุฉ ูู ุงูุฃุณูู */
        }

        /* ========== ุงุณุชุนูุงูุงุช ุงููุณุงุฆุท ููููุงุชู ========== */
        @media (max-width: 768px) {
            .pos-container {
                max-width: 100%;               /* ุงุณุชุฎุฏุงู ุงูุนุฑุถ ุงููุงูู ุนูู ุงูููุงุชู */
                padding: 0.5rem;               /* ูุณุงุญุฉ ุฏุงุฎููุฉ ุฃูู */
            }
            
            .product-card {
                padding: 0.75rem;              /* ูุณุงุญุฉ ุฏุงุฎููุฉ ุฃูู ููุจุทุงูุงุช */
                margin-bottom: 0.5rem;         /* ูุณุงูุฉ ุฃูู ุจูู ุงูุจุทุงูุงุช */
            }
            
            .categories-bar {
                padding: 0.5rem 0;             /* ูุณุงุญุฉ ุฏุงุฎููุฉ ุฃูู ููุดุฑูุท */
            }
            
            .suggestion-item {
                min-width: 70px;               /* ุนุฑุถ ุฃูู ููุงูุชุฑุงุญุงุช */
                padding: 0.5rem;               /* ูุณุงุญุฉ ุฏุงุฎููุฉ ุฃูู */
            }
            
            .search-result-item {
                padding: 0.75rem;              /* ูุณุงุญุฉ ุฏุงุฎููุฉ ุฃูู ููุชุงุฆุฌ ุงูุจุญุซ */
            }
            
            #posCart {
                width: 100%;                   /* ุนุฑุถ ูุงูู ููุดุงุดุฉ */
                max-width: none;               /* ุฅุฒุงูุฉ ุงูุญุฏ ุงูุฃูุตู ููุนุฑุถ */
            }
            
            /* ุชุญุณูู ุนุฑุถ ุงูููุชุฌุงุช ุนูู ุงูููุงุชู */
            #productsGrid .col-4 {
                flex: 0 0 50%;                 /* ุนููุฏูู ูู ุงูุตู ุจุฏูุงู ูู ุซูุงุซุฉ */
                max-width: 50%;
            }
        }

        /* ========== ุงุณุชุนูุงูุงุช ุงููุณุงุฆุท ููููุงุชู ุงูุตุบูุฑุฉ ========== */
        @media (max-width: 480px) {
            #productsGrid .col-4 {
                flex: 0 0 100%;                /* ุนููุฏ ูุงุญุฏ ูู ุงูุตู ุนูู ุงูุดุงุดุงุช ุงูุตุบูุฑุฉ */
                max-width: 100%;
            }
            
            .suggestion-item {
                min-width: 60px;               /* ุนุฑุถ ุฃูู ููุงูุชุฑุงุญุงุช */
                font-size: 0.8rem;             /* ุญุฌู ุฎุท ุฃุตุบุฑ */
            }
        }

        /* ========== ุชุญุณููุงุช ุงูุจุญุซ ุงูููุฑู ========== */
        .search-result-item {
            transition: background-color 0.2s ease; /* ุชุฃุซูุฑ ุงูุชูุงูู ููุฎูููุฉ */
        }

        .search-result-item:hover {
            background-color: var(--sidebar-link-hover); /* ุชุบููุฑ ุงูุฎูููุฉ ุนูุฏ ุงูุชูุฑูุฑ */
        }

        .search-result-item:active {
            background-color: var(--primary-color); /* ุชุบููุฑ ุงูุฎูููุฉ ุนูุฏ ุงูููุฑ */
            color: white;                      /* ุชุบููุฑ ููู ุงููุต */
        }

        /* ========== ุฃููุงุท ุงูุทุจุงุนุฉ ========== */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .btn, .sidebar, .header {
                display: none !important;
            }
            
            .body {
                font-size: 12pt;
                line-height: 1.4;
            }
            
            .card {
                border: 1px solid #000 !important; /* ุฅุทุงุฑ ุฃุณูุฏ ููุจุทุงูุงุช */
                box-shadow: none !important;   /* ุฅุฒุงูุฉ ุงูุธูุงู */
            }
        }

        /* ========== ุชุญุณููุงุช ููุชูุงุฑูุฑ ========== */
        .credit-report-table th {
            background-color: #e9ecef !important; /* ุฎูููุฉ ุฑุฃุณ ุงูุฌุฏูู */
            color: #495057 !important;         /* ููู ูุต ุฑุฃุณ ุงูุฌุฏูู */
            font-weight: 600 !important;       /* ูุต ุนุฑูุถ */
        }

        .balance-positive {
            color: #28a745 !important;         /* ููู ุฃุฎุถุฑ ููุฃุฑุตุฏุฉ ุงูููุฌุจุฉ */
            font-weight: bold !important;      /* ูุต ุนุฑูุถ */
        }

        .balance-negative {
            color: #dc3545 !important;         /* ููู ุฃุญูุฑ ููุฃุฑุตุฏุฉ ุงูุณุงูุจุฉ */
            font-weight: bold !important;      /* ูุต ุนุฑูุถ */
        }

        .report-summary-card {
            transition: all 0.3s ease;         /* ุชุฃุซูุฑ ุงูุชูุงูู */
            border-left: 4px solid #007bff !important; /* ุฎุท ุฃุฒุฑู ุนูู ุงููุณุงุฑ */
        }

        .report-summary-card:hover {
            transform: translateY(-2px);       /* ุชุฃุซูุฑ ุฑูุน ุทููู */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* ุธู ุนูุฏ ุงูุชูุฑูุฑ */
        }

        /* ========== ุฅุฎูุงุก ุนูุงุตุฑ ุบูุฑ ูุฑุบูุจุฉ ========== */
        #categoriesView h4,
        #categoriesBar {
            display: none !important;          /* ุฅุฎูุงุก ุงูุนูุงููู ุบูุฑ ุงููุฑุบูุจุฉ */
        }

        /* ========== ุชุญุณููุงุช ุฅุถุงููุฉ ========== */
        .search-results-container {
            position: relative !important;     /* ุชููุถุน ูุณุจู ูููุชุงุฆุฌ */
            top: 0 !important;                 /* ุฅุนุงุฏุฉ ุชุนููู ุงูููุถุน */
            margin-top: 5px;                   /* ูุณุงูุฉ ูู ุงูุฃุนูู */
            max-height: 300px;                 /* ุฃูุตู ุงุฑุชูุงุน */
            z-index: 1000;                     /* ุชุฑุชูุจ ุงูุทุจูุงุช */
        }

        #categoriesGrid {
            margin-top: 20px;                  /* ูุณุงูุฉ ูู ุงูุฃุนูู ูุดุจูุฉ ุงููุฆุงุช */
        }

        @keyframes slideUp {
            from {
                opacity: 0;                    /* ุจุฏุงูุฉ ุดูุงููุฉ */
                transform: translateY(30px);   /* ุจุฏุงูุฉ ูู ุฃุณูู */
            }
            to {
                opacity: 1;                    /* ููุงูุฉ ุดูุงููุฉ */
                transform: translateY(0);      /* ููุงูุฉ ูู ููุงูู */
            }
        }
        /* ========== ุฃููุงุท ุงูุตูุฑ ูุงููุงููุฑุง ========== */
        .image-preview-container {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            background: #f8f9fa;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .image-preview-container img {
            max-width: 100%;
            border-radius: 6px;
        }

        .camera-option, .gallery-option {
            margin-bottom: 15px;
        }

        #cameraVideo {
            border-radius: 8px;
            background: #000;
        }

        #cameraCanvas {
            display: none;
        }

        .image-upload-options .btn {
            margin-bottom: 5px;
        }

        .uploaded-image-info {
            background: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        .image-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .image-actions .btn {
            flex: 1;
        }

        /* ========== ุฃููุงุท ุจุทุงูุงุช ุงูููุชุฌุงุช ุงููุญุณูุฉ ========== */
        .product-card {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--sidebar-link-hover);
            border-radius: 12px;
            overflow: hidden;
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-color);
        }

        .product-card.added {
            border: 2px solid var(--success);
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.3);
        }

        /* ุญุงููุฉ ุงูุตูุฑุฉ */
        .product-image-container {
            width: 100%;
            height: 120px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            position: relative;
        }

        /* ุงูุตูุฑุฉ ุงููุนููุฉ */
        .product-image-real {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .product-card:hover .product-image-real {
            transform: scale(1.05);
        }

        /* ููุงู ุงูุฅูููุฌู ุนูุฏูุง ูุง ุชูุฌุฏ ุตูุฑุฉ */
        .product-emoji-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* ูุนูููุงุช ุงูููุชุฌ */
        .product-info {
            padding: 12px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: var(--card-bg);
        }

        .product-name {
            font-size: 0.85rem;
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: 4px;
            color: var(--bs-body-color);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 2.6rem;
        }

        .product-code {
            font-size: 0.7rem;
            color: var(--bs-secondary);
            margin-bottom: 8px;
        }

        
        .product-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .product-price {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .product-stock {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
        }

        /* ุงูุนูุงูุฉ ุงูุฎุงุตุฉ ุจุงููููุฉ ูู ุงูุณูุฉ */
        .quantity-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--warning);
            color: #000;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid var(--card-bg);
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* ุชุญุณููุงุช ููุดุงุดุงุช ุงูุตุบูุฑุฉ */
        @media (max-width: 576px) {
            .product-image-container {
                height: 100px;
            }
            
            .product-emoji-placeholder {
                font-size: 2.5rem;
            }
            
            .product-name {
                font-size: 0.8rem;
                min-height: 2.4rem;
            }
            
            .product-price {
                font-size: 0.85rem;
            }
        }
        /* ========== ุชุญุณููุงุช CSS ููุงุชุฌุงู RTL ูุฅููุงููุฉ ุงููุตูู ========== */

        /* ุชุญุณููุงุช ุงูุชุฑููุฒ ูุฅููุงููุฉ ุงููุตูู */
        :focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* ุชุญุณููุงุช ุงูุชููู ุจุงูููุญุฉ ุงูููุงุชูุญ */
        .btn:focus,
        .nav-link:focus,
        .product-card:focus {
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.25);
        }

        /* ุงูุฎุตุงุฆุต ุงูููุทููุฉ ููุงุชุฌุงู RTL */
        .sidebar {
            border-inline-start: 1px solid var(--sidebar-link-hover);
            margin-inline-end: 0;
        }

        .header {
            padding-inline-start: 1rem;
            padding-inline-end: 1rem;
        }

        /* ุชุญุณููุงุช ุงููุต ููุบุฉ ุงูุนุฑุจูุฉ */
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            line-height: 1.6;
            text-align: start;
        }

        /* ุชุญุณููุงุช ุงูุฌูุงู ูุงูููุณ */
        @media (max-width: 768px) {
            .action-btn {
                min-width: 44px;
                min-height: 44px;
            }
            
            .product-card {
                min-height: 120px;
            }
            
            .search-result-item {
                padding: 1rem;
            }
        }

        /* ุฅุฎูุงุก ุงูุนูุงุตุฑ ุงููุฑุฆูุฉ ููุท ููุงุฑุฆุงุช ุงูุดุงุดุฉ */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* ุชุญุณููุงุช ุงูุชุจุงูู ูููุถุน ุงูุฏุงูู */
        [data-bs-theme="dark"] {
            --bs-body-color: #e9ecef;
            --bs-body-bg: #121212;
            --card-bg: #1e1e1e;
        }


        /* ุชุฃุซูุฑุงุช ุฎุงุตุฉ ููุจุทุงูุงุช */
        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .product-card:hover::before {
            transform: scaleX(1);
        }

        /* ุชุญุณููุงุช ูููุถุน ุงูุฏุงูู */
        [data-bs-theme="dark"] .product-image-container {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
        }

        [data-bs-theme="dark"] .product-emoji-placeholder {
            background: linear-gradient(135deg, #4fd1c7 0%, #63b3ed 100%);
        }

    </style>
</head>
<body>
    <!-- ========== ุดุงุดุฉ ุงูุชุญูู ูู ุงูุชุฑุฎูุต ========== -->
    <!-- ========== ุงููููู ุงูุฃุณุงุณู ========== -->
    <div class="header d-flex justify-content-between align-items-center px-3">
        <div>
            <span class="badge bg-success me-3">ุฑุตูุฏ ุงูุตูุฏูู: <span id="currentBalance">0.00 ุฑ.ู</span></span>
            <button class="btn btn-outline-secondary btn-sm" id="themeToggle">
                <i class="bi bi-sun" id="themeIcon"></i>
            </button>
            <button class="btn btn-primary btn-sm d-md-none me-2" id="sidebarToggle">
                <i class="bi bi-list"></i>
            </button>
        </div>
    </div>

    <!-- ========== ุงูุดุฑูุท ุงูุฌุงูุจู ========== -->
    <div class="sidebar d-flex flex-column" id="appSidebar">
        <nav class="nav nav-pills flex-column">
            <a class="nav-link" data-module="dashboard"><i class="bi bi-speedometer2 me-2"></i> ููุญุฉ ุงูุชุญูู</a>
            <a class="nav-link" data-module="pos"><i class="bi bi-cart-fill me-2"></i> ููุทุฉ ุงูุจูุน (POS)</a>
            <a class="nav-link" data-module="inventory"><i class="bi bi-box-seam-fill me-2"></i> ุฅุฏุงุฑุฉ ุงููุฎุฒูู</a>
            <a class="nav-link" data-module="cash"><i class="bi bi-currency-dollar me-2"></i> ุงูุตูุฏูู ูุงูุญุณุงุจุงุช</a>
            <a class="nav-link" data-module="accounting"><i class="bi bi-book-half me-2"></i> ุงููุญุงุณุจุฉ (COA)</a>
            <a class="nav-link" data-module="settings"><i class="bi bi-gear-fill me-2"></i> ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ</a>
        </nav>
    </div>
    <!-- ========== ุงููุญุชูู ุงูุฑุฆูุณู ========== -->
    <div class="main-content" id="mainContent">
        <div class="container-fluid py-4">

            <!-- ========== ุฅุถุงูุฉ ูุญุฏุฉ ููุญุฉ ุงูุชุญูู ========== -->
            <div class="module" id="dashboard">
                <h2>๐ ููุญุฉ ุงูุชุญูู ูุงูุชูุงุฑูุฑ</h2>
                <p class="text-muted">ูุธุฑุฉ ุดุงููุฉ ุนูู ุฃุฏุงุก ุงููุชุฌุฑ ูุงูุฅุญุตุงุฆูุงุช ุงููุงููุฉ</p>
                
                <!-- ุจุทุงูุงุช ุงูุฅุญุตุงุฆูุงุช ุงูุณุฑูุนุฉ -->
                <div class="row mb-4">
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card kpi-card bg-primary text-white">
                            <div class="card-body text-center">
                                <i class="bi bi-cash-coin fs-1"></i>
                                <div class="kpi-value" id="todaySales">0.00 ุฑ.ู</div>
                                <div class="kpi-title">ุงููุจูุนุงุช ุงูููู</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card kpi-card bg-success text-white">
                            <div class="card-body text-center">
                                <i class="bi bi-graph-up fs-1"></i>
                                <div class="kpi-value" id="todayProfit">0.00 ุฑ.ู</div>
                                <div class="kpi-title">ุงูุฑุจุญ ุงูููู</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card kpi-card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="bi bi-box-seam fs-1"></i>
                                <div class="kpi-value" id="inventoryValueCost">0.00 ุฑ.ู</div>
                                <div class="kpi-title">ูููุฉ ุงููุฎุฒูู (ุชูููุฉ)</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card kpi-card bg-warning text-white">
                            <div class="card-body text-center">
                                <i class="bi bi-box-seam fs-1"></i>
                                <div class="kpi-value" id="inventoryValueSale">0.00 ุฑ.ู</div>
                                <div class="kpi-title">ูููุฉ ุงููุฎุฒูู (ุจูุน)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ุชูุงุฑูุฑ ููุตูุฉ -->
                <div class="row">
                    <!-- ุชูุงุฑูุฑ ุงููุจูุนุงุช -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">๐ ุชูุงุฑูุฑ ุงููุจูุนุงุช</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ููุน ุงููุงุชูุฑุฉ</th>
                                                <th>ุนุฏุฏ ุงูููุงุชูุฑ</th>
                                                <th>ุงูุฅุฌูุงูู</th>
                                            </tr>
                                        </thead>
                                        <tbody id="salesReportsTable">
                                            <tr><td colspan="3" class="text-center text-muted">ุฌุงุฑู ุงูุชุญููู...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ุชูุงุฑูุฑ ุงููุดุชุฑูุงุช -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="card-title mb-0">๐ฆ ุชูุงุฑูุฑ ุงููุดุชุฑูุงุช</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ููุน ุงููุงุชูุฑุฉ</th>
                                                <th>ุนุฏุฏ ุงูููุงุชูุฑ</th>
                                                <th>ุงูุฅุฌูุงูู</th>
                                            </tr>
                                        </thead>
                                        <tbody id="purchasesReportsTable">
                                            <tr><td colspan="3" class="text-center text-muted">ุฌุงุฑู ุงูุชุญููู...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ุงูุนููุงุก ูุงูููุฑุฏูู -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="card-title mb-0">๐ฅ ุงูุนููุงุก ูุงูููุฑุฏูู</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-center p-3">
                                            <i class="bi bi-people fs-1 text-primary"></i>
                                            <h4 id="customersCount">0</h4>
                                            <p class="text-muted mb-0">ุฅุฌูุงูู ุงูุนููุงุก</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center p-3">
                                            <i class="bi bi-building fs-1 text-success"></i>
                                            <h4 id="suppliersCount">0</h4>
                                            <p class="text-muted mb-0">ุฅุฌูุงูู ุงูููุฑุฏูู</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <strong>ุฃุนูู 5 ุนููุงุก:</strong>
                                    <div id="topCustomersList" class="mt-2">
                                        <p class="text-muted">ุฌุงุฑู ุงูุชุญููู...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ุงูุฃุฑุจุงุญ ูุฑุฃุณ ุงููุงู -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-warning text-white">
                                <h5 class="card-title mb-0">๐ฐ ุงูุฃุฑุจุงุญ ูุฑุฃุณ ุงููุงู</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>ุฑุฃุณ ุงููุงู ุงูุญุงูู:</strong>
                                    <span class="float-end fw-bold text-success" id="currentCapital">0.00 ุฑ.ู</span>
                                </div>
                                <div class="mb-3">
                                    <strong>ุฅุฌูุงูู ุงูุฃุฑุจุงุญ ุงููุญููุฉ:</strong>
                                    <span class="float-end fw-bold text-primary" id="totalProfit">0.00 ุฑ.ู</span>
                                </div>
                                <div class="mb-3">
                                    <strong>ุตุงูู ุงูุฑุจุญ (ุจุนุฏ ุชูููุฉ ุงูุจุถุงุนุฉ):</strong>
                                    <span class="float-end fw-bold text-info" id="netProfit">0.00 ุฑ.ู</span>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshDashboard()">
                                        <i class="bi bi-arrow-clockwise"></i> ุชุญุฏูุซ ุงูุจูุงูุงุช
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ููุงุชูุฑ ุงูุจูุน ุงูุขุฌูุฉ -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header bg-danger text-white">
                                <h5 class="card-title mb-0">๐ ููุงุชูุฑ ุงูุจูุน ุงูุขุฌูุฉ</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ุฑูู ุงููุงุชูุฑุฉ</th>
                                                <th>ุงูุนููู</th>
                                                <th>ุงูุชุงุฑูุฎ</th>
                                                <th>ุงููุจูุบ</th>
                                                <th>ุงูุญุงูุฉ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="creditSalesTable">
                                            <tr><td colspan="5" class="text-center text-muted">ุฌุงุฑู ุงูุชุญููู...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ููุงุชูุฑ ุงูุดุฑุงุก ุงูุขุฌูุฉ -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="card-title mb-0">๐ ููุงุชูุฑ ุงูุดุฑุงุก ุงูุขุฌูุฉ</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ุฑูู ุงููุงุชูุฑุฉ</th>
                                                <th>ุงูููุฑุฏ</th>
                                                <th>ุงูุชุงุฑูุฎ</th>
                                                <th>ุงููุจูุบ</th>
                                                <th>ุงูุญุงูุฉ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="creditPurchasesTable">
                                            <tr><td colspan="5" class="text-center text-muted">ุฌุงุฑู ุงูุชุญููู...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== ููุทุฉ ุงูุจูุน ========== -->
            <div class="module" id="pos">
                <div class="pos-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>๐ ููุทุฉ ุงูุจูุน</h2>
                        <span class="badge bg-success">ุฑุตูุฏ ุงูุตูุฏูู: <span id="posBalance">0.00 ุฑ.ู</span></span>
                    </div>

                    <!-- ุดุฑูุท ุงูุจุญุซ -->
                    <div class="mb-3 position-relative">
                        <input type="text" class="form-control" id="productSearchInput" 
                            placeholder="๐ ุจุญุซ ููุฑู ุนู ุงูููุชุฌ (ุงูุงุณู ุฃู ุงูููุฏ)...">
                        <!-- ูุชุงุฆุฌ ุงูุจุญุซ -->
                        <div id="posSearchResults" class="search-results-container" style="display: none;"></div>
                    </div>
                    
                    <!-- ุนุฑุถ ุงููุฆุงุช -->
                    <div id="categoriesView">
                        <!-- ุชู ุฅุฒุงูุฉ ุงูุนููุงู ูุดุฑูุท ุงููุฆุงุช -->
                        
                        <!-- ุดุฑูุท ุงูุงูุชุฑุงุญุงุช ุงูุณุฑูุนุฉ -->
                        <div class="quick-suggestions mb-4" id="quickSuggestions">
                            <!-- ุณูุชู ุชุนุจุฆุชู ุฏููุงููููุงู -->
                        </div>

                        <!-- ุดุจูุฉ ุงููุฆุงุช -->
                        <div class="row g-3" id="categoriesGrid">
                            <!-- ุณูุชู ุชุนุจุฆุชูุง ุฏููุงููููุงู -->
                        </div>
                    </div>

                    <!-- ุนุฑุถ ุงูููุชุฌุงุช -->
                    <div id="productsView" style="display: none;">
                        <!-- ุฑุฃุณ ุนุฑุถ ุงูููุชุฌุงุช -->
                        <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                            <button class="btn btn-outline-primary btn-sm" id="backToCategoriesBtn">
                                <i class="bi bi-arrow-right"></i> ุงูุนูุฏุฉ ูููุฆุงุช
                            </button>
                            <h5 class="mb-0" id="currentCategoryTitle">ุงูููุชุฌุงุช</h5>
                            <div class="text-muted" id="productsCount"></div>
                        </div>

                        <!-- ุดุจูุฉ ุงูููุชุฌุงุช -->
                        <div class="row g-2" id="productsGrid">
                            <!-- ุณูุชู ุชุนุจุฆุชูุง ุฏููุงููููุงู -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== ุฅุฏุงุฑุฉ ุงููุฎุฒูู ========== -->
            <div class="module" id="inventory">
                <h2>๐ฆ ุฅุฏุงุฑุฉ ุงููุฎุฒูู ูุงููุดุชุฑูุงุช</h2>
                <div class="d-flex mb-3">
                    <button class="btn btn-primary me-2" id="addProductBtn"><i class="bi bi-plus-circle me-1"></i> ุฅุถุงูุฉ ุตูู</button>
                    <button class="btn btn-success me-2" id="importProductsBtn"><i class="bi bi-cloud-upload me-1"></i> ุงุณุชูุฑุงุฏ (XLSX)</button>
                    <button class="btn btn-info me-2 text-white" id="exportProductsBtn"><i class="bi bi-cloud-download me-1"></i> ุชุตุฏูุฑ (XLSX)</button>
                    <button class="btn btn-warning" id="recordPurchaseBtn"><i class="bi bi-truck me-1"></i> ุชุณุฌูู ูุงุชูุฑุฉ ุดุฑุงุก</button>
                </div>
                
                <!-- ุชุจููุจุงุช ุงููุฎุฒูู ุงููุฑุนูุฉ -->
                <ul class="nav nav-tabs mb-3">
                    <li class="nav-item"><a class="nav-link active" data-tab="inventory-items">ุงูุฃุตูุงู</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="inventory-purchases">ุณุฌู ุงููุดุชุฑูุงุช</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="inventory-categories">ูุฆุงุช ุงูููุชุฌุงุช</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="inventory-movements">ุญุฑูุงุช ุงูุตูู</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="inventory-suppliers">ุงูููุฑุฏูู</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="inventory-customers">ุงูุนููุงุก</a></li>
                </ul>

                <!-- ูุญุชูู ุชุจููุจุงุช ุงููุฎุฒูู -->
                <div class="tab-content" id="inventoryTabs">
                    <!-- ุชุจููุจ ุงูุฃุตูุงู -->
                    <div class="tab-pane fade show active" id="inventory-items">
                        <input type="text" class="form-control mb-3" id="inventorySearchInput" placeholder="ุจุญุซ ูู ุงูุฃุตูุงู...">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr><th>ุงูููุฏ</th><th>ุงูุงุณู</th><th>ุงููููุฉ</th><th>ุงูุชูููุฉ</th><th>ุงูุจูุน</th><th>ุชุงุฑูุฎ ุงูุงูุชูุงุก</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                                <tbody id="productsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ุชุจููุจ ุงููุดุชุฑูุงุช -->
                    <div class="tab-pane fade" id="inventory-purchases">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr><th>ุฑูู ุงููุงุชูุฑุฉ</th><th>ุงูููุฑุฏ</th><th>ุงูุชุงุฑูุฎ</th><th>ุงูุฅุฌูุงูู</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                                <tbody id="purchasesTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ุชุจููุจ ุงููุฆุงุช -->
                    <div class="tab-pane fade" id="inventory-categories">
                        <div class="d-flex mb-3">
                            <button class="btn btn-primary" id="addCategoryBtn"><i class="bi bi-plus-circle me-1"></i> ุฅุถุงูุฉ ูุฆุฉ</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr><th>ุงุณู ุงููุฆุฉ</th><th>ุงููุตู</th><th>ุนุฏุฏ ุงูุฃุตูุงู</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                                <tbody id="categoriesTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ุชุจููุจ ุงูุญุฑูุงุช -->
                    <div class="tab-pane fade" id="inventory-movements">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <select class="form-select" id="movementProductSelect">
                                    <option value="">ุงุฎุชุฑ ููุชุฌ ูุนุฑุถ ุญุฑูุงุชู</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูููุน</th><th>ุงููููุฉ</th><th>ุงูุณุนุฑ</th><th>ุงููุฑุฌุน</th></tr></thead>
                                <tbody id="movementsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ุชุจููุจ ุงูููุฑุฏูู -->
                    <div class="tab-pane fade" id="inventory-suppliers">
                        <div class="d-flex mb-3">
                            <button class="btn btn-primary" id="addSupplierBtn"><i class="bi bi-plus-circle me-1"></i> ุฅุถุงูุฉ ููุฑุฏ</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr><th>ุงูุงุณู</th><th>ุงููุงุชู</th><th>ุงูุจุฑูุฏ</th><th>ุงูุนููุงู</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                                <tbody id="suppliersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ุชุจููุจ ุงูุนููุงุก -->
                    <div class="tab-pane fade" id="inventory-customers">
                        <div class="d-flex mb-3">
                            <button class="btn btn-primary" id="addCustomerBtn"><i class="bi bi-plus-circle me-1"></i> ุฅุถุงูุฉ ุนููู</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr><th>ุงูุงุณู</th><th>ุงููุงุชู</th><th>ุงูุจุฑูุฏ</th><th>ุงูุนููุงู</th><th>ุงูุฑุตูุฏ</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                                <tbody id="customersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== ุงูุตูุฏูู ูุงูุญุณุงุจุงุช ========== -->
            <div class="module" id="cash">
                <h2>๐ฐ ุฅุฏุงุฑุฉ ุงูุตูุฏูู ูุงูุญุณุงุจุงุช ุงูููุฏูุฉ</h2>
                <p class="text-muted">ุนุฑุถ ุงูุฃุฑุตุฏุฉ ูุฅุฏุงุฑุฉ ุงูุฅูุฏุงุน ูุงูุณุญุจ ูุงูุชุญููู</p>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card kpi-card bg-light">
                            <div class="card-body">
                                <i class="bi bi-wallet2 text-primary fs-1"></i>
                                <div class="kpi-value" id="cashModuleBalance">0.00 ุฑ.ู</div>
                                <div class="kpi-title">ุฑุตูุฏ ุงูุตูุฏูู ุงูุญุงูู (YER)</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header"><h5 class="card-title mb-0">ุงูุนูููุงุช ุงูููุฏูุฉ</h5></div>
                            <div class="card-body d-grid gap-2">
                                <button class="btn btn-success" id="depositBtn"><i class="bi bi-plus-circle"></i> ุฅูุฏุงุน</button>
                                <button class="btn btn-danger" id="withdrawBtn"><i class="bi bi-dash-circle"></i> ุณุญุจ</button>
                                <button class="btn btn-info text-white" id="transferBtn"><i class="bi bi-arrow-repeat"></i> ุชุญููู</button>
                                <button class="btn btn-warning" id="closeShiftBtn"><i class="bi bi-stopwatch"></i> ุฅููุงู ูุฑุฏูุฉ/ุชุณููุฉ</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header"><h5 class="card-title mb-0">ุญุฑูุงุช ุงูุตูุฏูู ูุงูุณุฌู</h5></div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูููุน</th><th>ุงููุจูุบ</th><th>ุงููุฑุฌุน</th></tr></thead>
                                        <tbody id="cashTransactionsTable"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== ุงููุญุงุณุจุฉ ========== -->
            <div class="module" id="accounting">
                <h2>๐ ุงููุญุงุณุจุฉ ูุดุฌุฑุฉ ุงูุญุณุงุจุงุช</h2>
                <p class="text-muted">ุนุฑุถ ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ูุฅุฏุงุฑุฉ ุงููููุฏ ุงูููููุฉ</p>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header"><h5 class="card-title mb-0">ุดุฌุฑุฉ ุงูุญุณุงุจุงุช (COA)</h5></div>
                            <ul class="list-group list-group-flush" id="coaList">
                                <li class="list-group-item text-center text-muted">ุฌุงุฑู ุชุญููู ุดุฌุฑุฉ ุงูุญุณุงุจุงุช...</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between">
                                <h5 class="card-title mb-0">ูููุฏ ุงูููููุฉ</h5>
                                <button class="btn btn-sm btn-primary" id="addManualEntryBtn"><i class="bi bi-plus-circle"></i> ุฅุถุงูุฉ ููุฏ ูุฏูู</button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงููุตู</th><th>ุงููุฏูู</th><th>ุงูุฏุงุฆู</th></tr></thead>
                                        <tbody id="journalEntriesTable">
                                            <tr class="text-center text-muted"><td colspan="4">ูุง ุชูุฌุฏ ูููุฏ ููููุฉ ูุณุฌูุฉ ุจุนุฏ.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- ========== ุงูุฅุนุฏุงุฏุงุช ========== -->
            <div class="module" id="settings">
                <h2>โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ</h2>
                <p class="text-muted">ุฅุนุฏุงุฏุงุช ุงููุธุงู ูุงูุนููุงุช ูุงูุจูุงูุงุช</p>
                <div class="card mb-4">
                    <div class="card-header"><h5 class="card-title mb-0">ุจูุงูุงุช ุงูุดุฑูุฉ ูุงูุนููุงุช</h5></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ</label>
                                <input type="text" class="form-control" value="ุฑูุงู ูููู (YER)" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุงูุนููุฉ ุงูุซุงูููุฉ</label>
                                <input type="text" class="form-control" value="ุฑูุงู ุณุนูุฏู (SAR)" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุณุนุฑ ุงูุตุฑู (425 YER = 1 SAR)</label>
                                <input type="number" class="form-control" id="exchangeRateInput" value="425">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ูุณุจุฉ ุงูุถุฑูุจุฉ (%)</label>
                                <input type="number" class="form-control" id="taxRateInput" value="0">
                            </div>
                            // ุฅุถุงูุฉ ุนูุตุฑ ุชุญูู ุฌุฏูุฏ ูู ุงูุฅุนุฏุงุฏุงุช
                            <div class="mb-3 form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="showQuantityFieldSetting" checked>
                                <label class="form-check-label" for="showQuantityFieldSetting">ุฅุธูุงุฑ ุญูู ุงููููุฉ ูู ูููุฐุฌ ุงูููุชุฌ</label>
                                <small class="form-text text-muted">ุนูุฏ ุฅูุบุงุก ุงูุชุญุฏูุฏุ ุณูุชู ุฅุฎูุงุก ุญูู ุงููููุฉ ููุฌุจ ุฅุถุงูุฉ ุงููููุงุช ุนุจุฑ ููุงุชูุฑ ุงูุดุฑุงุก ููุท</small>
                            </div>
                        </div>
                        <button class="btn btn-success" id="saveSettingsBtn"><i class="bi bi-save"></i> ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header"><h5 class="card-title mb-0">ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุจูุงูุงุช</h5></div>
                    <div class="card-body d-grid gap-2">
                        <button class="btn btn-outline-primary" id="backupBtn"><i class="bi bi-cloud-arrow-down"></i> ูุณุฎ ุงุญุชูุงุทู ูุงูู (JSON)</button>
                        <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
                        <button class="btn btn-outline-success" id="restoreBtn"><i class="bi bi-cloud-arrow-up"></i> ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ========== ุงูููุงุฐุฌ (Modals) ========== -->
    
    <!-- ูููุฐุฌ ุฅุถุงูุฉ/ุชุนุฏูู ููุชุฌ -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm" novalidate>
                        <input type="hidden" id="productId">
                        <div class="row">
                            <div class="col-md-6">
                                <!-- ุงููุณู ุงูุฃูุณุฑ: ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ -->
                                <div class="mb-3">
                                    <label for="productCode" class="form-label">ููุฏ ุงูุตูู</label>
                                    <input type="text" class="form-control" id="productCode" required>
                                    <div class="invalid-feedback">ูุฑุฌู ุฅุฏุฎุงู ููุฏ ุงูุตูู</div>
                                </div>
                                <div class="mb-3">
                                    <label for="productName" class="form-label">ุงุณู ุงูุตูู</label>
                                    <input type="text" class="form-control" id="productName" required>
                                    <div class="invalid-feedback">ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุตูู</div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="productPurchasePrice" class="form-label">ุณุนุฑ ุงูุดุฑุงุก (ุงูุชูููุฉ)</label>
                                        <input type="number" class="form-control" id="productPurchasePrice" step="0.01" min="0" required>
                                        <div class="invalid-feedback">ูุฑุฌู ุฅุฏุฎุงู ุณุนุฑ ุดุฑุงุก ุตุญูุญ</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="productSalePrice" class="form-label">ุณุนุฑ ุงูุจูุน</label>
                                        <input type="number" class="form-control" id="productSalePrice" step="0.01" min="0" required>
                                        <div class="invalid-feedback">ูุฑุฌู ุฅุฏุฎุงู ุณุนุฑ ุจูุน ุตุญูุญ</div>
                                    </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="productBaseUnit" class="form-label">ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ (ููุจูุน)</label>
                                        <select class="form-select" id="productBaseUnit" required>
                                            <option value="ุญุจุฉ">ุญุจุฉ</option>
                                            <option value="ูููู">ูููู</option>
                                            <option value="ูุชุฑ">ูุชุฑ</option>
                                            <option value="ูุชุฑ">ูุชุฑ</option>
                                            <option value="ุนูุจุฉ">ุนูุจุฉ</option>
                                            <option value="ุฒุฌุงุฌุฉ">ุฒุฌุงุฌุฉ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="productPurchaseUnit" class="form-label">ูุญุฏุฉ ุงูุดุฑุงุก (ุฌููุฉ)</label>
                                        <select class="form-select" id="productPurchaseUnit" required>
                                            <option value="ูุฑุชูู">ูุฑุชูู</option>
                                            <option value="ุฏุฑุฒู">ุฏุฑุฒู</option>
                                            <option value="ุณูุฉ">ุณูุฉ</option>
                                            <option value="ููุณ">ููุณ</option>
                                            <option value="ุทู">ุทู</option>
                                            <option value="ุญุจุฉ">ุญุจุฉ</option>
                                            <option value="ูููู">ูููู</option>
                                            <option value="ูุชุฑ">ูุชุฑ</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="productConversionFactor" class="form-label">ูุนุงูู ุงูุชุญููู</label>
                                        <input type="number" class="form-control" id="productConversionFactor" value="1" min="1" required>
                                        <div class="form-text">ุนุฏุฏ ุงููุญุฏุงุช ุงูุฃุณุงุณูุฉ ูู ูุญุฏุฉ ุงูุดุฑุงุก (ูุซุงู: 24 ุฅุฐุง ูุงู ุงููุฑุชูู = 24 ุญุจุฉ)</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="productWholesalePrice" class="form-label">ุณุนุฑ ุงูุฌููุฉ (ุฑ.ู)</label>
                                        <input type="number" class="form-control" id="productWholesalePrice" step="0.01" min="0" required>
                                        <div class="form-text">ุณุนุฑ ูุญุฏุฉ ุงูุดุฑุงุก (ุฌููุฉ)</div>
                                    </div>
                                </div>

                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="productQuantity" class="form-label">ุงููููุฉ ุงููุชุงุญุฉ</label>
                                        <input type="number" class="form-control" id="productQuantity" min="0" required>
                                        <div class="invalid-feedback">ูุฑุฌู ุฅุฏุฎุงู ูููุฉ ุตุญูุญุฉ</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="productMinQuantity" class="form-label">ุงูุญุฏ ุงูุฃุฏูู ููุชูุจูู</label>
                                        <input type="number" class="form-control" id="productMinQuantity" min="0" value="5" required>
                                        <div class="invalid-feedback">ูุฑุฌู ุฅุฏุฎุงู ุญุฏ ุฃุฏูู ุตุญูุญ</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="productExpiryDate" class="form-label">ุชุงุฑูุฎ ุงูุงูุชูุงุก (ุงุฎุชูุงุฑู)</label>
                                    <input type="date" class="form-control" id="productExpiryDate">
                                </div>
                                <div class="mb-3">
                                    <label for="productCategory" class="form-label">ุงููุฆุฉ</label>
                                    <select class="form-select" id="productCategory">
                                        <option value="">ุจุฏูู ูุฆุฉ</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <!-- ุงููุณู ุงูุฃููู: ุงูุตูุฑ -->
                                <div class="mb-3">
                                    <label class="form-label">ุตูุฑุฉ ุงูููุชุฌ</label>
                                    
                                    <!-- ูุนุงููุฉ ุงูุตูุฑุฉ -->
                                    <div class="image-preview-container mb-3 text-center">
                                        <img id="productImagePreview" src="" alt="ูุนุงููุฉ ุงูุตูุฑุฉ" 
                                            class="img-thumbnail" style="max-height: 150px; display: none;">
                                        <div id="noImagePlaceholder" class="text-muted">
                                            <i class="bi bi-image fs-1"></i>
                                            <p class="mt-2">ูุง ุชูุฌุฏ ุตูุฑุฉ</p>
                                        </div>
                                    </div>
                                    
                                    <!-- ุฎูุงุฑุงุช ุฑูุน ุงูุตูุฑุฉ -->
                                    <div class="image-upload-options">
                                        <!-- ุฎูุงุฑ ุงููุงููุฑุง -->
                                        <div class="camera-option mb-3">
                                            <button type="button" class="btn btn-outline-primary btn-sm w-100" id="openCameraBtn">
                                                <i class="bi bi-camera"></i> ุงูุชูุงุท ุตูุฑุฉ ุจุงููุงููุฑุง
                                            </button>
                                            <div id="cameraContainer" class="mt-2" style="display: none;">
                                                <video id="cameraVideo" class="w-100" autoplay playsinline style="max-height: 200px; border-radius: 8px;"></video>
                                                <div class="text-center mt-2">
                                                    <button type="button" class="btn btn-success btn-sm me-2" id="captureBtn">
                                                        <i class="bi bi-camera-fill"></i> ุงูุชูุงุท
                                                    </button>
                                                    <button type="button" class="btn btn-secondary btn-sm" id="cancelCameraBtn">
                                                        <i class="bi bi-x"></i> ุฅูุบุงุก
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- ุฎูุงุฑ ุงููุนุฑุถ -->
                                        <div class="gallery-option mb-3">
                                            <label for="productImageUpload" class="btn btn-outline-success btn-sm w-100 mb-2">
                                                <i class="bi bi-folder-open"></i> ุงุฎุชูุงุฑ ุตูุฑุฉ ูู ุงููุนุฑุถ
                                            </label>
                                            <input type="file" id="productImageUpload" accept="image/*" class="d-none">
                                            <div id="uploadedImageInfo" class="mt-2" style="display: none;">
                                                <small class="text-success">โ ุชู ุงุฎุชูุงุฑ ุตูุฑุฉ ูู ุงููุนุฑุถ</small>
                                            </div>
                                        </div>
                                        
                                        <!-- ุฎูุงุฑ ุฑุงุจุท ุงูุตูุฑุฉ -->
                                        <div class="url-option mb-3">
                                            <label for="productImageUrl" class="form-label">ุฃู ุฃุฏุฎู ุฑุงุจุท ุงูุตูุฑุฉ</label>
                                            <div class="input-group input-group-sm">
                                                <input type="url" class="form-control" id="productImageUrl" placeholder="https://example.com/image.jpg">
                                                <button type="button" class="btn btn-outline-info" id="loadImageFromUrl">
                                                    <i class="bi bi-download"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- ุฅูููุฌู ุงุญุชูุงุทู -->
                                        <div class="emoji-option">
                                            <label for="productImageEmoji" class="form-label">ุฑูุฒ ุงูููุชุฌ (ุฅูููุฌู ุงุญุชูุงุทู)</label>
                                            <input type="text" class="form-control" id="productImageEmoji" placeholder="๐ฆ" maxlength="2">
                                            <small class="form-text text-muted">ุณูุชู ุงุณุชุฎุฏุงู ูุฐุง ุงูุฅูููุฌู ุฅุฐุง ูู ุชูุฌุฏ ุตูุฑุฉ</small>
                                        </div>
                                        
                                        <!-- ุฒุฑ ุฅุฒุงูุฉ ุงูุตูุฑุฉ -->
                                        <div class="mt-3 text-center">
                                            <button type="button" class="btn btn-outline-danger btn-sm" id="removeImageBtn" style="display: none;">
                                                <i class="bi bi-trash"></i> ุฅุฒุงูุฉ ุงูุตูุฑุฉ
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- ุญูู ูุฎูู ูุชุฎุฒูู ุจูุงูุงุช ุงูุตูุฑุฉ -->
                                    <input type="hidden" id="productImageData">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">ุญูุธ ุงูุตูู</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ุชุญุฏูุซ ูููุฐุฌ ูุงุชูุฑุฉ ุงูุดุฑุงุก -->
    <div class="modal fade" id="purchaseModal" tabindex="-1" aria-labelledby="purchaseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="purchaseModalLabel">ุชุณุฌูู ูุงุชูุฑุฉ ุดุฑุงุก</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="purchaseForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="purchaseSupplier" class="form-label">ุงูููุฑุฏ</label>
                                <select class="form-select" id="purchaseSupplier" required>
                                    <option value="">ุงุฎุชุฑ ุงูููุฑุฏ</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="purchaseDate" class="form-label">ุชุงุฑูุฎ ุงูุดุฑุงุก</label>
                                <input type="date" class="form-control" id="purchaseDate" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="purchasePaymentMethod" class="form-label">ุทุฑููุฉ ุงูุฏูุน</label>
                                <select class="form-select" id="purchasePaymentMethod" required>
                                    <option value="cash">ููุฏู</option>
                                    <option value="credit">ุขุฌู</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="purchaseInvoiceNumber" class="form-label">ุฑูู ูุงุชูุฑุฉ ุงูููุฑุฏ</label>
                                <input type="text" class="form-control" id="purchaseInvoiceNumber" placeholder="ุงุฎุชูุงุฑู">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="purchaseTaxRate" class="form-label">ูุณุจุฉ ุงูุถุฑูุจุฉ %</label>
                                <input type="number" class="form-control" id="purchaseTaxRate" value="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="purchaseCurrency" class="form-label">ุนููุฉ ุงูุดุฑุงุก</label>
                                <select class="form-select" id="purchaseCurrency">
                                    <option value="YER">ุฑูุงู ูููู (YER)</option>
                                    <option value="SAR">ุฑูุงู ุณุนูุฏู (SAR)</option>
                                    <option value="USD">ุฏููุงุฑ ุฃูุฑููู (USD)</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="purchaseExchangeRate" class="form-label">ุณุนุฑ ุงูุตุฑู</label>
                                <input type="number" class="form-control" id="purchaseExchangeRate" value="1" step="0.001" min="0.001">
                            </div>
                            <div class="col-md-6">
                                <label for="purchaseUnit" class="form-label">ูุญุฏุฉ ุงูุดุฑุงุก</label>
                                <select class="form-select" id="purchaseUnit">
                                    <option value="ุฌููุฉ">ุฌููุฉ</option>
                                    <option value="ุชุฌุฒุฆุฉ">ุชุฌุฒุฆุฉ</option>
                                </select>
                            </div>
                        </div>                        

                        <div class="mb-3">
                            <h6>ุงูุฃุตูุงู ุงููุดุชุฑุงุฉ</h6>
                            <div id="purchaseItemsContainer">
                                <div class="purchase-item row g-2 mb-2">
                                    <div class="col-md-5">
                                        <select class="form-select product-select" required>
                                            <option value="">ุงุฎุชุฑ ุงูุตูู</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control quantity-input" placeholder="ุงููููุฉ" required min="1">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" class="form-control price-input" placeholder="ุณุนุฑ ุงูุดุฑุงุก" step="0.01" required min="0.01">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-danger btn-sm remove-item-btn w-100">ุญุฐู</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addPurchaseItemBtn">ุฅุถุงูุฉ ุตูู</button>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="purchaseTotal" class="form-label">ุงูุฅุฌูุงูู</label>
                                <input type="number" class="form-control" id="purchaseTotal" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="purchaseNotes" class="form-label">ููุงุญุธุงุช</label>
                                <textarea class="form-control" id="purchaseNotes" rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" id="savePurchaseBtn">ุญูุธ ูุงุชูุฑุฉ ุงูุดุฑุงุก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ูููุฐุฌ ุฅุถุงูุฉ ูุฆุฉ -->
    <div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalLabel">ุฅุถุงูุฉ ูุฆุฉ ุฌุฏูุฏุฉ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">ุงุณู ุงููุฆุฉ</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>
                        <div class="mb-3">
                            <label for="categoryDescription" class="form-label">ุงููุตู</label>
                            <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" id="saveCategoryBtn">ุญูุธ ุงููุฆุฉ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ูููุฐุฌ ุงูุนูููุงุช ุงูููุฏูุฉ -->
    <div class="modal fade" id="cashOperationModal" tabindex="-1" aria-labelledby="cashOperationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cashOperationModalLabel">ุนูููุฉ ููุฏูุฉ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="cashOperationForm">
                        <input type="hidden" id="cashOperationType">
                        <div class="mb-3">
                            <label for="cashAmount" class="form-label">ุงููุจูุบ</label>
                            <input type="number" class="form-control" id="cashAmount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="cashDescription" class="form-label">ุงููุตู</label>
                            <input type="text" class="form-control" id="cashDescription" required>
                        </div>
                        <div class="mb-3" id="cashAccountContainer" style="display: none;">
                            <label for="cashAccount" class="form-label">ุงูุญุณุงุจ ุงููุณุชูุฏู</label>
                            <select class="form-select" id="cashAccount">
                                <option value="1020">ุงูุจูู</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" id="saveCashOperationBtn">ุชูููุฐ ุงูุนูููุฉ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ูููุฐุฌ ุงูููุฏ ุงููุฏูู -->
    <div class="modal fade" id="journalEntryModal" tabindex="-1" aria-labelledby="journalEntryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="journalEntryModalLabel">ุฅุถุงูุฉ ููุฏ ููููุฉ ูุฏูู</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="journalEntryForm">
                        <div class="mb-3">
                            <label for="entryDescription" class="form-label">ุงููุตู</label>
                            <input type="text" class="form-control" id="entryDescription" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>ุงูุญุณุงุจุงุช ุงููุฏููุฉ</h6>
                                <div id="debitEntriesContainer">
                                    <div class="debit-entry row g-2 mb-2">
                                        <div class="col-md-8">
                                            <select class="form-select debit-account-select" required>
                                                <option value="">ุงุฎุชุฑ ุงูุญุณุงุจ</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" class="form-control debit-amount" placeholder="ุงููุจูุบ" step="0.01" required>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addDebitEntryBtn">ุฅุถุงูุฉ ุญุณุงุจ ูุฏููุฉ</button>
                            </div>
                            <div class="col-md-6">
                                <h6>ุงูุญุณุงุจุงุช ุงูุฏุงุฆูุฉ</h6>
                                <div id="creditEntriesContainer">
                                    <div class="credit-entry row g-2 mb-2">
                                        <div class="col-md-8">
                                            <select class="form-select credit-account-select" required>
                                                <option value="">ุงุฎุชุฑ ุงูุญุณุงุจ</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" class="form-control credit-amount" placeholder="ุงููุจูุบ" step="0.01" required>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addCreditEntryBtn">ุฅุถุงูุฉ ุญุณุงุจ ุฏุงุฆู</button>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <strong>ูุฌููุน ุงููุฏูู:</strong> <span id="totalDebitAmount">0.00</span> ุฑ.ู
                            <strong class="ms-3">ูุฌููุน ุงูุฏุงุฆู:</strong> <span id="totalCreditAmount">0.00</span> ุฑ.ู
                            <strong class="ms-3">ุงููุฑู:</strong> <span id="balanceDifference">0.00</span> ุฑ.ู
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" id="saveJournalEntryBtn" disabled>ุญูุธ ุงูููุฏ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ูููุฐุฌ ุฅุชูุงู ุงูุจูุน -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="successModalLabel">โ ุนูููุฉ ุจูุน ูุงุฌุญุฉ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <h6>ูุงุชูุฑุฉ ุฑูู: <span id="invoiceNumberDisplay">INV-1000</span></h6>
                        <p>ุทุฑููุฉ ุงูุฏูุน: <span id="paymentMethodDisplay">ููุฏู</span></p>
                    </div>
                    
                    <div class="alert alert-success">
                        <h6 class="alert-heading">ุงูุฅุฌูุงูู ุงูููุงุฆู:</h6>
                        <h4 class="text-center" id="finalTotalDisplay">0.00 ุฑ.ู</h4>
                    </div>
                    
                    <div id="successMessage">
                        <p class="text-center">
                            ุงูุฑุจุญ ุงูุฅุฌูุงูู ุงููุญูู: 
                            <span class="success-profit" id="grossProfitDisplay">0.00 ุฑ.ู</span>
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
                    <button type="button" class="btn btn-primary" id="printReceiptBtn">๐จ๏ธ ุทุจุงุนุฉ ุงูุฅูุตุงู</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ูููุฐุฌ ูุนุงููุฉ ูุดุงุฑูุฉ ุงููุงุชุณุงุจ -->
    <div class="modal fade" id="whatsappPreviewModal" tabindex="-1" aria-labelledby="whatsappPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="whatsappPreviewModalLabel">๐ฑ ูุนุงููุฉ ูุดุงุฑูุฉ ุงููุงุชูุฑุฉ ุนุจุฑ ูุงุชุณุงุจ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="whatsapp-preview" id="whatsappMessagePreview">
                        <!-- ุณูุชู ุชุนุจุฆุชู ุฏููุงููููุงู -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-success" id="openWhatsappBtn">
                        <i class="bi bi-whatsapp"></i> ูุชุญ ูุงุชุณุงุจ ูููุดุงุฑูุฉ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ูููุฐุฌ ุฅุถุงูุฉ ููุฑุฏ -->
    <div class="modal fade" id="supplierModal" tabindex="-1" aria-labelledby="supplierModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="supplierModalLabel">ุฅุถุงูุฉ ููุฑุฏ ุฌุฏูุฏ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="supplierForm">
                        <input type="hidden" id="supplierId">
                        <div class="mb-3">
                            <label for="supplierName" class="form-label">ุงุณู ุงูููุฑุฏ</label>
                            <input type="text" class="form-control" id="supplierName" required>
                        </div>
                        <div class="mb-3">
                            <label for="supplierPhone" class="form-label">ุงููุงุชู</label>
                            <input type="text" class="form-control" id="supplierPhone">
                        </div>
                        <div class="mb-3">
                            <label for="supplierEmail" class="form-label">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                            <input type="email" class="form-control" id="supplierEmail">
                        </div>
                        <div class="mb-3">
                            <label for="supplierAddress" class="form-label">ุงูุนููุงู</label>
                            <textarea class="form-control" id="supplierAddress" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" id="saveSupplierBtn">ุญูุธ ุงูููุฑุฏ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ูููุฐุฌ ุฅุถุงูุฉ ุนููู -->
    <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalLabel">ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <input type="hidden" id="customerId">
                        <div class="mb-3">
                            <label for="customerName" class="form-label">ุงุณู ุงูุนููู</label>
                            <input type="text" class="form-control" id="customerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label">ุงููุงุชู</label>
                            <input type="text" class="form-control" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="customerEmail" class="form-label">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                            <input type="email" class="form-control" id="customerEmail">
                        </div>
                        <div class="mb-3">
                            <label for="customerAddress" class="form-label">ุงูุนููุงู</label>
                            <textarea class="form-control" id="customerAddress" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" id="saveCustomerBtn">ุญูุธ ุงูุนููู</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ูููุฐุฌ ุชุญุตูู ุงูุฏููู ูู ุงูุนููุงุก -->
    <div class="modal fade" id="collectionModal" tabindex="-1" aria-labelledby="collectionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="collectionModalLabel">๐ฐ ุชุญุตูู ุงูุฏููู ูู ุงูุนููุงุก</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="collectionForm">
                        <div class="mb-3">
                            <label for="collectionCustomerSelect" class="form-label">ุงุฎุชุฑ ุงูุนููู</label>
                            <select class="form-select" id="collectionCustomerSelect" required>
                                <option value="">ุฌุงุฑู ุชุญููู ุงูุนููุงุก...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="collectionAmount" class="form-label">ุงููุจูุบ ุงููุญุตู</label>
                            <input type="number" class="form-control" id="collectionAmount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="collectionDescription" class="form-label">ูุตู ุงูุนูููุฉ</label>
                            <input type="text" class="form-control" id="collectionDescription" placeholder="ูุตู ุนูููุฉ ุงูุชุญุตูู..." required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-success" id="executeCollectionBtn">โ ุชูููุฐ ุงูุชุญุตูู</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ูููุฐุฌ ุณุฏุงุฏ ุงูุฏููู ููููุฑุฏูู -->
    <div class="modal fade" id="supplierPaymentModal" tabindex="-1" aria-labelledby="supplierPaymentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="supplierPaymentModalLabel">๐ณ ุณุฏุงุฏ ุงูุฏููู ููููุฑุฏูู</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="supplierPaymentForm">
                        <div class="mb-3">
                            <label for="supplierPaymentSelect" class="form-label">ุงุฎุชุฑ ุงูููุฑุฏ</label>
                            <select class="form-select" id="supplierPaymentSelect" required>
                                <option value="">ุฌุงุฑู ุชุญููู ุงูููุฑุฏูู...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="supplierPaymentAmount" class="form-label">ุงููุจูุบ ุงููุณุฏุฏ</label>
                            <input type="number" class="form-control" id="supplierPaymentAmount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="supplierPaymentDescription" class="form-label">ูุตู ุงูุนูููุฉ</label>
                            <input type="text" class="form-control" id="supplierPaymentDescription" placeholder="ูุตู ุนูููุฉ ุงูุณุฏุงุฏ..." required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-success" id="executeSupplierPaymentBtn">โ ุชูููุฐ ุงูุณุฏุงุฏ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ุชุญุฏูุซ ุณูุฉ ุงููุดุชุฑูุงุช ูู ุงููุธุงู ุงูุญุงูู -->
    <div id="posCart">
        <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
            <h5 class="mb-0">๐ ุณูุฉ ุงููุดุชุฑูุงุช</h5>
            <button class="btn btn-sm btn-outline-secondary" id="closeCartBtn">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="p-3" style="height: calc(100% - 120px); overflow-y: auto;">
            <div id="cartItemsList"></div>
            <!-- ุชุญุฏูุซ ูุณู ุงูุฅุฌูุงููุงุช ูู ุณูุฉ ุงููุดุชุฑูุงุช -->
            <div class="border-top pt-3 mt-3">
                <div class="mb-3">
                    <label class="form-label">ุงุฎุชูุงุฑ ุงูุนููู:</label>
                    <select class="form-select" id="customerSelect">
                        <option value="">ุนููู ููุฏู</option>
                        <!-- ุณูุชู ุชุนุจุฆุชูุง ุฏููุงููููุงู -->
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ุทุฑููุฉ ุงูุฏูุน:</label>
                    <select class="form-select" id="paymentMethodSelect">
                        <option value="cash">ููุฏู</option>
                        <option value="credit">ุขุฌู</option>
                        <option value="card">ุจุทุงูุฉ</option>
                    </select>
                </div>

                <!-- ูุณู ุงูุถุฑูุจุฉ ุงููุญุณู -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label">ุงูุถุฑูุจุฉ:</label>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" id="taxRateInput" value="0" min="0" max="100" step="0.1">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label">ุงูุนููุฉ:</label>
                        <select class="form-select form-select-sm" id="currencySelect">
                            <option value="YER">ุฑูุงู ูููู (YER)</option>
                            <option value="SAR">ุฑูุงู ุณุนูุฏู (SAR)</option>
                            <option value="USD">ุฏููุงุฑ ุฃูุฑููู (USD)</option>
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label">ุณุนุฑ ุงูุตุฑู:</label>
                        <input type="number" class="form-control form-control-sm" id="exchangeRateInput" value="1" step="0.001" min="0.001">
                        <div class="form-text">1 <span id="selectedCurrency">YER</span> = <span id="exchangeRateDisplay">1</span> ุฑ.ู</div>
                    </div>
                </div>
                
                <!-- ุชูุงุตูู ุงูุฅุฌูุงููุงุช -->
                <div class="totals-breakdown mb-3">
                    <div class="d-flex justify-content-between small border-bottom pb-1">
                        <span>ุงููุฌููุน ุงููุฑุนู:</span>
                        <span id="cartSubtotal">0.00 ุฑ.ู</span>
                    </div>
                    <div class="d-flex justify-content-between small text-info border-bottom pb-1">
                        <span>ุงูุถุฑูุจุฉ:</span>
                        <span id="cartTax">0.00 ุฑ.ู</span>
                    </div>
                    <div class="d-flex justify-content-between fw-bold mt-2">
                        <span>ุงูุฅุฌูุงูู ุงูููุงุฆู:</span>
                        <span id="cartTotal" class="text-success">0.00 ุฑ.ู</span>
                    </div>
                </div>
                
                <button class="btn btn-success w-100 mb-2" id="saveInvoiceBtn">โ ุญูุธ ุงููุงุชูุฑุฉ</button>
                <button class="btn btn-outline-primary w-100 mb-2" id="printInvoiceBtn">๐จ๏ธ ุทุจุงุนุฉ</button>
                <button class="btn btn-outline-success w-100" id="shareWhatsappBtn">๐ฑ ูุดุงุฑูุฉ ูุงุชุณุงุจ</button>
            </div>
        </div>
    </div>


    <!-- ุฃุฒุฑุงุฑ ุงูุณูุฉ ุงูุนุงุฆูุฉ -->
    <button class="btn btn-primary fab-cart" id="fabCartBtn">
        <i class="bi bi-cart-fill"></i>
        <span class="cart-counter" id="cartCounter">0</span>
    </button>

    <div class="floating-cart" id="floatingCartBtn" style="display: none;">
        <div class="floating-cart-content">
            <span>ุฅุฌูุงูู ุงูุณูุฉ:</span>
            <span class="fw-bold text-success" id="floatingCartTotal">0.00 ุฑ.ู</span>
        </div>
    </div>
    
    <!-- ุนูุงุตุฑ ุฅุถุงููุฉ -->
    <select class="form-select d-none" id="customerSelect">
        <option value="">ุนููู ููุฏู</option>
    </select>
    
    <!-- ุฅุดุนุงุฑ ูุคูุช -->
    <div id="temporaryNotification" class="toast-notification" style="display: none;">
        ุชู ุฅุถุงูุฉ <span id="notificationProductName"></span> ุฅูู ุงูุณูุฉ
    </div>

    <!-- ููุชุจุงุช JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    

    <script>
        // ==================== ุงููุชุบูุฑุงุช ุงูุนุงูุฉ ====================
        // ๐ง ุชุญุฏูุซ ูุชููุฆุฉ ุงููุชุบูุฑุงุช ุงูุนุงูุฉ
        let db;
        let currentCart = [];
        let invoiceCounter = 1000;
        let categories = [];
        let suppliers = [];
        let customers = []; // ๐ง ุฅุถุงูุฉ ุงููุชุบูุฑ ุงูููููุฏ
        let salesHistory = JSON.parse(localStorage.getItem('pos_sales')) || [];
        let cameraStream = null;


        // ๐ง ุฅุถุงูุฉ ูุชุบูุฑุงุช ูุธุงู ุงูุนุฑุถ ุงูุฌุฏูุฏ
        let currentView = 'categories';
        let currentCategoryId = null;
        let currentCategoryName = '';


        const CURRENCY_RATES = {
            'YER': 1,
            'SAR': 425,
            'USD': 1160
        };

        const UNIT_CONVERSIONS = {
            'ูุฑุชูู': 24,
            'ุฏุฑุฒู': 12,
            'ุณูุฉ': 1,
            'ููุณ': 1,
            'ุทู': 1000,
            'ุญุจุฉ': 1,
            'ูููู': 1,
            'ูุชุฑ': 1,
            'ูุชุฑ': 1,
            'ุนูุจุฉ': 1,
            'ุฒุฌุงุฌุฉ': 1
        };

        /**
        * ุชุญููู ุงูุณุนุฑ ุจูู ุงูุนููุงุช
        */
        function convertCurrency(amount, fromCurrency, toCurrency = 'YER') {
            const rate = CURRENCY_RATES[fromCurrency] / CURRENCY_RATES[toCurrency];
            return amount * rate;
        }

        /**
        * ุชุญููู ุงููุญุฏุงุช
        */
        function convertUnits(quantity, fromUnit, toUnit) {
            const fromFactor = UNIT_CONVERSIONS[fromUnit] || 1;
            const toFactor = UNIT_CONVERSIONS[toUnit] || 1;
            return quantity * (fromFactor / toFactor);
        }

        /**
        * ุชุญุฏูุซ ุนุฑุถ ุณุนุฑ ุงูุตุฑู
        */
        function updateExchangeRateDisplay() {
            const currencySelect = document.getElementById('currencySelect');
            const exchangeRateInput = document.getElementById('exchangeRateInput');
            const selectedCurrency = document.getElementById('selectedCurrency');
            const exchangeRateDisplay = document.getElementById('exchangeRateDisplay');
            
            if (currencySelect && exchangeRateInput && selectedCurrency && exchangeRateDisplay) {
                const currency = currencySelect.value;
                const rate = exchangeRateInput.value;
                
                selectedCurrency.textContent = currency;
                exchangeRateDisplay.textContent = rate;
                
                // ุชุญุฏูุซ ุงูุณุนุฑ ุงูุชููุงุฆู ุฅุฐุง ูุงู ุงูุฑูุงู ุงููููู
                if (currency !== 'YER') {
                    exchangeRateInput.value = CURRENCY_RATES[currency] || 1;
                }
            }
        }
        async function recordPurchaseTaxEntry(purchaseInvoice, invoiceId) {
            try {
                const taxAmount = purchaseInvoice.tax || 0;
                
                if (taxAmount > 0) {
                    const description = `ุถุฑูุจุฉ ูุดุชุฑูุงุช - ูุงุชูุฑุฉ ${purchaseInvoice.invoiceNumber}`;
                    
                    const debits = [{
                        accountCode: '4010', // ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (ูุฏููุฉ)
                        amount: taxAmount,
                        description: `ุถุฑูุจุฉ ูุฏููุนุฉ ุนูู ูุดุชุฑูุงุช ูู ${purchaseInvoice.supplierName}`
                    }];
                    
                    const credits = [{
                        accountCode: '2030', // ุงูุถุฑูุจุฉ ุงููุณุชุญูุฉ
                        amount: taxAmount,
                        description: 'ุถุฑูุจุฉ ูุณุชุญูุฉ ุงูุฏูุน'
                    }];
                    
                    await createJournalEntry(
                        description,
                        debits,
                        credits,
                        'PurchaseTax',
                        invoiceId
                    );
                }
            } catch (error) {
                console.error('โ ูุดู ุชุณุฌูู ููุฏ ุงูุถุฑูุจุฉ:', error);
            }
        }

        /**
        * ุชุณุฌูู ููุฏ ูุญุงุณุจู ููุถุฑูุจุฉ ูู ุงููุจูุนุงุช
        */
        async function recordSalesTaxEntry(invoice, invoiceId) {
            try {
                const taxAmount = invoice.tax || 0;
                
                if (taxAmount > 0) {
                    const description = `ุถุฑูุจุฉ ูุจูุนุงุช - ูุงุชูุฑุฉ ${invoice.invoiceNumber}`;
                    
                    const debits = [{
                        accountCode: '2030', // ุงูุถุฑูุจุฉ ุงููุณุชุญูุฉ
                        amount: taxAmount,
                        description: `ุถุฑูุจุฉ ูุญุตูุฉ ูู ูุจูุนุงุช ููุนููู ${invoice.customerName}`
                    }];
                    
                    const credits = [{
                        accountCode: '4020', // ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (ุฏุงุฆูุฉ)
                        amount: taxAmount,
                        description: 'ุถุฑูุจุฉ ูุจูุนุงุช ูุณุชุญูุฉ'
                    }];
                    
                    await createJournalEntry(
                        description,
                        debits,
                        credits,
                        'SalesTax',
                        invoiceId
                    );
                }
            } catch (error) {
                console.error('โ ูุดู ุชุณุฌูู ููุฏ ุถุฑูุจุฉ ุงููุจูุนุงุช:', error);
            }
        }        

        // ==================== ุฏุงูุฉ ุชุญููู ุงูููุชุจุงุช ุงูุงุญุชูุงุทูุฉ ====================
        function loadFallbackLibraries() {
            return new Promise((resolve) => {
                const libraries = [
                    {
                        name: 'Bootstrap',
                        check: () => typeof bootstrap !== 'undefined',
                        url: 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js'
                    },
                    {
                        name: 'Chart.js',
                        check: () => typeof Chart !== 'undefined', 
                        url: 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js'
                    },
                    {
                        name: 'XLSX',
                        check: () => typeof XLSX !== 'undefined',
                        url: 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'
                    }
                ];

                let loadedCount = 0;
                const totalLibraries = libraries.length;

                function checkAllLoaded() {
                    loadedCount++;
                    if (loadedCount === totalLibraries) {
                        console.log('ุชู ุชุญููู ุฌููุน ุงูููุชุจุงุช ุจูุฌุงุญ');
                        resolve();
                    }
                }

                libraries.forEach(lib => {
                    if (!lib.check()) {
                        console.log(`ุฌุงุฑู ุชุญููู ${lib.name} ุจุดูู ุฏููุงูููู...`);
                        const script = document.createElement('script');
                        script.src = lib.url;
                        script.onload = checkAllLoaded;
                        script.onerror = () => {
                            console.error(`ูุดู ุชุญููู ${lib.name}`);
                            checkAllLoaded();
                        };
                        document.head.appendChild(script);
                    } else {
                        console.log(`${lib.name} ูุญูู ูุณุจูุงู`);
                        checkAllLoaded();
                    }
                });
            });
        }

        // ==================== ุฏูุงู ููุญุฉ ุงูุชุญูู ====================
        /**
        * ุชุญุฏูุซ ูุฅุธูุงุฑ ูุญุฏุฉ ููุญุฉ ุงูุชุญูู
        */
        function showDashboard() {
            loadDashboardData();
        }

        /**
        * ุชุญููู ุฌููุน ุจูุงูุงุช ููุญุฉ ุงูุชุญูู
        */
        async function loadDashboardData() {
            try {
                console.log('๐ ุฌุงุฑู ุชุญููู ุจูุงูุงุช ููุญุฉ ุงูุชุญูู...');
                
                await Promise.all([
                    loadTodaySales(),
                    loadTodayPurchases(),
                    loadInventoryValues(),
                    loadSalesReports(),
                    loadPurchasesReports(),
                    loadCustomersSuppliersCount(),
                    loadCapitalAndProfit(),
                    loadCreditSales(),
                    loadCreditPurchases()
                ]);
                
                console.log('โ ุชู ุชุญููู ุฌููุน ุจูุงูุงุช ููุญุฉ ุงูุชุญูู');
            } catch (error) {
                console.error('โ ูุดู ุชุญููู ุจูุงูุงุช ููุญุฉ ุงูุชุญูู:', error);
            }
        }

        /**
        * ุชุญููู ุจูุงูุงุช ุงููุจูุนุงุช ุงูููููุฉ
        */
        async function loadTodaySales() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const invoices = await getAllInvoices();
                
                const todayInvoices = invoices.filter(invoice => 
                    invoice.date.startsWith(today)
                );
                
                const todaySales = todayInvoices.reduce((sum, invoice) => sum + invoice.total, 0);
                
                // ุญุณุงุจ ุงูุฑุจุญ ุงููููู
                let todayProfit = 0;
                todayInvoices.forEach(invoice => {
                    if (invoice.items) {
                        invoice.items.forEach(item => {
                            const cost = item.purchasePrice * item.quantity;
                            const revenue = item.price * item.quantity;
                            todayProfit += (revenue - cost);
                        });
                    }
                });
                
                document.getElementById('todaySales').textContent = todaySales.toFixed(2) + ' ุฑ.ู';
                document.getElementById('todayProfit').textContent = todayProfit.toFixed(2) + ' ุฑ.ู';
                
            } catch (error) {
                console.error('ูุดู ุชุญููู ุงููุจูุนุงุช ุงูููููุฉ:', error);
            }
        }

        /**
        * ุชุญููู ุจูุงูุงุช ุงููุดุชุฑูุงุช ุงูููููุฉ
        */
        async function loadTodayPurchases() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const purchases = await new Promise((resolve) => {
                    const transaction = db.transaction(['purchaseInvoices'], 'readonly');
                    const store = transaction.objectStore('purchaseInvoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                });
                
                const todayPurchases = purchases.filter(purchase => 
                    purchase.date.startsWith(today)
                );
                
                const todayPurchasesTotal = todayPurchases.reduce((sum, purchase) => sum + purchase.total, 0);
                
                // ูููู ุฅุถุงูุฉ ุนุฑุถ ูููุดุชุฑูุงุช ุงูููููุฉ ุฅุฐุง ุฃุฑุฏุช
                console.log('ุงููุดุชุฑูุงุช ุงูููู:', todayPurchasesTotal);
                
            } catch (error) {
                console.error('ูุดู ุชุญููู ุงููุดุชุฑูุงุช ุงูููููุฉ:', error);
            }
        }

        /**
        * ุชุญููู ููู ุงููุฎุฒูู
        */
        async function loadInventoryValues() {
            try {
                const products = await getAllProducts();
                
                // ูููุฉ ุงููุฎุฒูู ุจุณุนุฑ ุงูุดุฑุงุก
                const inventoryValueCost = products.reduce((sum, product) => 
                    sum + (product.purchasePrice * product.quantity), 0
                );
                
                // ูููุฉ ุงููุฎุฒูู ุจุณุนุฑ ุงูุจูุน
                const inventoryValueSale = products.reduce((sum, product) => 
                    sum + (product.salePrice * product.quantity), 0
                );
                
                document.getElementById('inventoryValueCost').textContent = inventoryValueCost.toFixed(2) + ' ุฑ.ู';
                document.getElementById('inventoryValueSale').textContent = inventoryValueSale.toFixed(2) + ' ุฑ.ู';
                
            } catch (error) {
                console.error('ูุดู ุชุญููู ููู ุงููุฎุฒูู:', error);
            }
        }

        /**
        * ุชุญููู ุชูุงุฑูุฑ ุงููุจูุนุงุช
        */
        async function loadSalesReports() {
            try {
                const invoices = await getAllInvoices();
                
                // ุชุตููู ุงูููุงุชูุฑ
                const cashInvoices = invoices.filter(inv => inv.paymentMethod === 'cash');
                const creditInvoices = invoices.filter(inv => inv.paymentMethod === 'credit');
                
                const tbody = document.getElementById('salesReportsTable');
                tbody.innerHTML = '';
                
                // ููุงุชูุฑ ููุฏูุฉ
                const cashRow = document.createElement('tr');
                cashRow.innerHTML = `
                    <td>ููุงุชูุฑ ููุฏูุฉ</td>
                    <td>${cashInvoices.length}</td>
                    <td>${cashInvoices.reduce((sum, inv) => sum + inv.total, 0).toFixed(2)} ุฑ.ู</td>
                `;
                tbody.appendChild(cashRow);
                
                // ููุงุชูุฑ ุขุฌูุฉ
                const creditRow = document.createElement('tr');
                creditRow.innerHTML = `
                    <td>ููุงุชูุฑ ุขุฌูุฉ</td>
                    <td>${creditInvoices.length}</td>
                    <td>${creditInvoices.reduce((sum, inv) => sum + inv.total, 0).toFixed(2)} ุฑ.ู</td>
                `;
                tbody.appendChild(creditRow);
                
                // ุงูุฅุฌูุงูู
                const totalRow = document.createElement('tr');
                totalRow.className = 'fw-bold table-active';
                totalRow.innerHTML = `
                    <td>ุงูุฅุฌูุงูู</td>
                    <td>${invoices.length}</td>
                    <td>${invoices.reduce((sum, inv) => sum + inv.total, 0).toFixed(2)} ุฑ.ู</td>
                `;
                tbody.appendChild(totalRow);
                
            } catch (error) {
                console.error('ูุดู ุชุญููู ุชูุงุฑูุฑ ุงููุจูุนุงุช:', error);
            }
        }

        /**
        * ุชุญููู ุชูุงุฑูุฑ ุงููุดุชุฑูุงุช
        */
        async function loadPurchasesReports() {
            try {
                const purchases = await new Promise((resolve) => {
                    const transaction = db.transaction(['purchaseInvoices'], 'readonly');
                    const store = transaction.objectStore('purchaseInvoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                });
                
                // ุชุตููู ุงูููุงุชูุฑ
                const cashPurchases = purchases.filter(p => p.paymentMethod === 'cash');
                const creditPurchases = purchases.filter(p => p.paymentMethod === 'credit');
                
                const tbody = document.getElementById('purchasesReportsTable');
                tbody.innerHTML = '';
                
                // ููุงุชูุฑ ููุฏูุฉ
                const cashRow = document.createElement('tr');
                cashRow.innerHTML = `
                    <td>ูุดุชุฑูุงุช ููุฏูุฉ</td>
                    <td>${cashPurchases.length}</td>
                    <td>${cashPurchases.reduce((sum, p) => sum + p.total, 0).toFixed(2)} ุฑ.ู</td>
                `;
                tbody.appendChild(cashRow);
                
                // ููุงุชูุฑ ุขุฌูุฉ
                const creditRow = document.createElement('tr');
                creditRow.innerHTML = `
                    <td>ูุดุชุฑูุงุช ุขุฌูุฉ</td>
                    <td>${creditPurchases.length}</td>
                    <td>${creditPurchases.reduce((sum, p) => sum + p.total, 0).toFixed(2)} ุฑ.ู</td>
                `;
                tbody.appendChild(creditRow);
                
                // ุงูุฅุฌูุงูู
                const totalRow = document.createElement('tr');
                totalRow.className = 'fw-bold table-active';
                totalRow.innerHTML = `
                    <td>ุงูุฅุฌูุงูู</td>
                    <td>${purchases.length}</td>
                    <td>${purchases.reduce((sum, p) => sum + p.total, 0).toFixed(2)} ุฑ.ู</td>
                `;
                tbody.appendChild(totalRow);
                
            } catch (error) {
                console.error('ูุดู ุชุญููู ุชูุงุฑูุฑ ุงููุดุชุฑูุงุช:', error);
            }
        }

        /**
        * ุชุญููู ุฅุญุตุงุฆูุงุช ุงูุนููุงุก ูุงูููุฑุฏูู
        */
        async function loadCustomersSuppliersCount() {
            try {
                const [customers, suppliers] = await Promise.all([
                    loadCustomers(),
                    loadSuppliers()
                ]);
                
                document.getElementById('customersCount').textContent = customers.length;
                document.getElementById('suppliersCount').textContent = suppliers.length;
                
                // ุนุฑุถ ุฃูุถู 5 ุนููุงุก
                const topCustomers = customers
                    .filter(c => c.balance > 0)
                    .sort((a, b) => (b.balance || 0) - (a.balance || 0))
                    .slice(0, 5);
                
                const topCustomersList = document.getElementById('topCustomersList');
                topCustomersList.innerHTML = '';
                
                if (topCustomers.length === 0) {
                    topCustomersList.innerHTML = '<p class="text-muted">ูุง ุชูุฌุฏ ูุฏููููุงุช ุนูู ุงูุนููุงุก</p>';
                } else {
                    topCustomers.forEach(customer => {
                        const customerDiv = document.createElement('div');
                        customerDiv.className = 'd-flex justify-content-between align-items-center border-bottom py-1';
                        customerDiv.innerHTML = `
                            <span>${customer.name}</span>
                            <span class="text-danger fw-bold">${(customer.balance || 0).toFixed(2)} ุฑ.ู</span>
                        `;
                        topCustomersList.appendChild(customerDiv);
                    });
                }
                
            } catch (error) {
                console.error('ูุดู ุชุญููู ุฅุญุตุงุฆูุงุช ุงูุนููุงุก ูุงูููุฑุฏูู:', error);
            }
        }

        /**
        * ุชุญููู ุจูุงูุงุช ุฑุฃุณ ุงููุงู ูุงูุฃุฑุจุงุญ
        */
        async function loadCapitalAndProfit() {
            try {
                // ุฌูุจ ุญุณุงุจ ุฑุฃุณ ุงููุงู
                const capitalAccount = await new Promise((resolve) => {
                    const transaction = db.transaction(['chartOfAccounts'], 'readonly');
                    const store = transaction.objectStore('chartOfAccounts');
                    const request = store.get('2020'); // ููุฏ ุฑุฃุณ ุงููุงู
                    request.onsuccess = () => resolve(request.result);
                });
                
                // ุฌูุจ ุญุณุงุจ ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ
                const retainedEarnings = await new Promise((resolve) => {
                    const transaction = db.transaction(['chartOfAccounts'], 'readonly');
                    const store = transaction.objectStore('chartOfAccounts');
                    const request = store.get('3050'); // ููุฏ ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ
                    request.onsuccess = () => resolve(request.result);
                });
                
                // ุฌูุจ ุฌููุน ููุงุชูุฑ ุงููุจูุนุงุช ูุญุณุงุจ ุงูุฃุฑุจุงุญ
                const invoices = await getAllInvoices();
                let totalProfit = 0;
                
                invoices.forEach(invoice => {
                    if (invoice.items) {
                        invoice.items.forEach(item => {
                            const cost = (item.purchasePrice || 0) * item.quantity;
                            const revenue = item.price * item.quantity;
                            totalProfit += (revenue - cost);
                        });
                    }
                });
                
                // ุญุณุงุจ ุตุงูู ุงูุฑุจุญ (ุจุนุฏ ุชูููุฉ ุงูุจุถุงุนุฉ ูุงููุตุงุฑูู)
                const netProfit = totalProfit; // ูููู ุฅุถุงูุฉ ุฎุตู ุงููุตุงุฑูู ููุง ูุงุญูุงู
                
                document.getElementById('currentCapital').textContent = 
                    ((capitalAccount?.balance || 0) + (retainedEarnings?.balance || 0)).toFixed(2) + ' ุฑ.ู';
                
                document.getElementById('totalProfit').textContent = totalProfit.toFixed(2) + ' ุฑ.ู';
                document.getElementById('netProfit').textContent = netProfit.toFixed(2) + ' ุฑ.ู';
                
            } catch (error) {
                console.error('ูุดู ุชุญููู ุจูุงูุงุช ุฑุฃุณ ุงููุงู ูุงูุฃุฑุจุงุญ:', error);
            }
        }

        /**
        * ุชุญููู ููุงุชูุฑ ุงูุจูุน ุงูุขุฌูุฉ
        */
        async function loadCreditSales() {
            try {
                const invoices = await getAllInvoices();
                const creditInvoices = invoices.filter(inv => inv.paymentMethod === 'credit');
                
                const tbody = document.getElementById('creditSalesTable');
                tbody.innerHTML = '';
                
                if (creditInvoices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ูุง ุชูุฌุฏ ููุงุชูุฑ ุจูุน ุขุฌูุฉ</td></tr>';
                    return;
                }
                
                creditInvoices.forEach(invoice => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${invoice.invoiceNumber}</td>
                        <td>${invoice.customerName || 'ุบูุฑ ูุนุฑูู'}</td>
                        <td>${new Date(invoice.date).toLocaleDateString('ar-YE')}</td>
                        <td>${invoice.total.toFixed(2)} ุฑ.ู</td>
                        <td><span class="badge bg-warning">ุขุฌู</span></td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('ูุดู ุชุญููู ููุงุชูุฑ ุงูุจูุน ุงูุขุฌูุฉ:', error);
            }
        }

        /**
        * ุชุญููู ููุงุชูุฑ ุงูุดุฑุงุก ุงูุขุฌูุฉ
        */
        async function loadCreditPurchases() {
            try {
                const purchases = await new Promise((resolve) => {
                    const transaction = db.transaction(['purchaseInvoices'], 'readonly');
                    const store = transaction.objectStore('purchaseInvoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                });
                
                const creditPurchases = purchases.filter(p => p.paymentMethod === 'credit');
                
                const tbody = document.getElementById('creditPurchasesTable');
                tbody.innerHTML = '';
                
                if (creditPurchases.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ูุง ุชูุฌุฏ ููุงุชูุฑ ุดุฑุงุก ุขุฌูุฉ</td></tr>';
                    return;
                }
                
                creditPurchases.forEach(purchase => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${purchase.invoiceNumber || purchase.id}</td>
                        <td>${purchase.supplierName || 'ุบูุฑ ูุนุฑูู'}</td>
                        <td>${new Date(purchase.date).toLocaleDateString('ar-YE')}</td>
                        <td>${purchase.total.toFixed(2)} ุฑ.ู</td>
                        <td><span class="badge bg-warning">ุขุฌู</span></td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('ูุดู ุชุญููู ููุงุชูุฑ ุงูุดุฑุงุก ุงูุขุฌูุฉ:', error);
            }
        }

        /**
        * ุชุญุฏูุซ ููุญุฉ ุงูุชุญูู
        */
        function refreshDashboard() {
            loadDashboardData();
            alert('โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ููุญุฉ ุงูุชุญูู');
        }



        // ==================== 4.1. ุงูุชุญูู ูู ุงูููุท ูุงูุชุจููุจุงุช ====================
        
        /**
         * ุชุจุฏูู ุงูููุท ุจูู ุงููุงุชุญ ูุงูุฏุงูู
         */
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-bs-theme', newTheme);
            document.getElementById('themeIcon').className = newTheme === 'dark' ? 'bi bi-moon' : 'bi bi-sun';
            localStorage.setItem('theme', newTheme);
        }

        /**
         * ุนุฑุถ ูุญุฏุฉ ูุญุฏุฏุฉ ูุฅุฎูุงุก ุงูุจููุฉ
         * @param {string} moduleId - ููุนุฑู ุงููุญุฏุฉ ุงููุฑุงุฏ ุนุฑุถูุง (ูุซู 'dashboard').
         */
        function showModule(moduleId) {
            document.querySelectorAll('.module').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(moduleId).classList.add('active');

            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`.sidebar .nav-link[data-module="${moduleId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }

            // ุชุญุฏูุซุงุช ุฎุงุตุฉ ุจุงููุญุฏุงุช

            if (moduleId === 'dashboard') {
                showDashboard();
            } else if (moduleId === 'pos') {
                initializePOSModule();
            } else if (moduleId === 'inventory') {
                showSubTab('inventory-items');
                loadProductsTable();
            } else if (moduleId === 'inventory') {
                 // ุนุฑุถ ุงูุชุจููุจ ุงููุฑุนู ุงูุงูุชุฑุงุถู
                 showSubTab('inventory-items');
                 loadProductsTable();
            } else if (moduleId === 'accounting') {
                displayChartOfAccounts();
                loadJournalEntries();
            } else if (moduleId === 'cash') {
                loadCashTransactions();

            }
        }

        /**
         * ุนุฑุถ ุงูุชุจููุจุงุช ุงููุฑุนูุฉ ุฏุงุฎู ุงููุฎุฒูู
         */
        function showSubTab(tabId) {
            document.querySelectorAll('#inventoryTabs .tab-pane').forEach(el => el.classList.remove('show', 'active'));
            document.getElementById(tabId).classList.add('show', 'active');
            
            document.querySelectorAll('.nav-tabs .nav-link').forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.nav-tabs .nav-link[data-tab="${tabId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // ุชุญููู ูุญุชูู ุงูุชุจููุจ ุงููุทููุจ
            if (tabId === 'inventory-items') {
                loadProductsTable();
            } else if (tabId === 'inventory-purchases') {
                loadPurchasesTable();
            } else if (tabId === 'inventory-categories') {
                loadCategoriesTable();
            } else if (tabId === 'inventory-movements') {
                loadMovementsProductSelect();
            } else if (tabId === 'inventory-suppliers') {
                loadSuppliersTable();
            } else if (tabId === 'inventory-customers') { // โญ ุฌุฏูุฏ
                loadCustomersTable();
            }
        }

        // ==================== 4.2. IndexedDB & ุงููุญุงุณุจุฉ ====================

        // ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ุงูุงูุชุฑุงุถูุฉ
        const DEFAULT_ACCOUNTS = [
            // === ุงูุฃุตูู ===
            { code: '1000', name: 'ุงูุฃุตูู', type: 'header', parentCode: null },
            { code: '1010', name: 'ุงูุตูุฏูู', type: 'asset', parentCode: '1000', balance: 0.00 },
            { code: '1020', name: 'ุงูุจูู', type: 'asset', parentCode: '1000', balance: 0.00 },
            { code: '1030', name: 'ุงููุฎุฒูู', type: 'asset', parentCode: '1000', balance: 0.00 },
            
            // ุงูุนููุงุก - ุงูุฐูู ุงููุฏููุฉ
            { code: '1040', name: 'ุงูุนููุงุก - ุงูุฐูู ุงููุฏููุฉ', type: 'header', parentCode: '1000' },
            { code: '1040000', name: 'ุนููุงุก ููุฏููู', type: 'asset', parentCode: '1040', balance: 0.00 },
            
            // ุงูุฃุตูู ุงูุซุงุจุชุฉ
            { code: '1050', name: 'ุงูุฃุตูู ุงูุซุงุจุชุฉ', type: 'header', parentCode: '1000' },
            { code: '1051', name: 'ูุนุฏุงุช ููุจุงูู', type: 'asset', parentCode: '1050', balance: 0.00 },
            { code: '1052', name: 'ุฅููุงูุงุช ุชุฑุงูููุฉ', type: 'asset', parentCode: '1050', balance: 0.00 },
            
            // ุงููุตุงุฑูู ุงููุฏููุนุฉ ููุฏูุงู
            { code: '1060', name: 'ูุตุงุฑูู ูุฏููุนุฉ ููุฏูุงู', type: 'asset', parentCode: '1000', balance: 0.00 },
            
            // ุถุฑูุจุฉ ุงููุฏุฎูุงุช
            { code: '1070', name: 'ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ ุงููุงุจูุฉ ููุฎุตู', type: 'asset', parentCode: '1000', balance: 0.00 },

            // === ุงูุฎุตูู ูุญููู ุงูููููุฉ ===
            { code: '2000', name: 'ุงูุฎุตูู ูุญููู ุงูููููุฉ', type: 'header', parentCode: null },
            
            // ุงูููุฑุฏูู - ุงูุฐูู ุงูุฏุงุฆูุฉ
            { code: '2010', name: 'ุงูููุฑุฏูู - ุงูุฐูู ุงูุฏุงุฆูุฉ', type: 'header', parentCode: '2000' },
            { code: '2010000', name: 'ููุฑุฏูู ููุฏููู', type: 'liability', parentCode: '2010', balance: 0.00 },
            
            // ุญููู ุงูููููุฉ
            { code: '2020', name: 'ุฑุฃุณ ุงููุงู', type: 'equity', parentCode: '2000', balance: 0.00 },
            { code: '2030', name: 'ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ', type: 'equity', parentCode: '2000', balance: 0.00 },
            
            // ุงูุถุฑุงุฆุจ ุงููุณุชุญูุฉ
            { code: '2040', name: 'ุงูุถุฑุงุฆุจ ุงููุณุชุญูุฉ', type: 'header', parentCode: '2000' },
            { code: '2041', name: 'ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ ุงููุณุชุญูุฉ ุงูุฏูุน', type: 'liability', parentCode: '2040', balance: 0.00 },
            
            // ุงููุฑูุถ ูุงูุงูุชุฒุงูุงุช
            { code: '2050', name: 'ูุฑูุถ ุจูููุฉ', type: 'liability', parentCode: '2000', balance: 0.00 },
            { code: '2060', name: 'ุงูุชุฒุงูุงุช ุฃุฎุฑู', type: 'liability', parentCode: '2000', balance: 0.00 },

            // === ุงูุฅูุฑุงุฏุงุช ูุงููุตุฑููุงุช ===
            { code: '3000', name: 'ุงูุฅูุฑุงุฏุงุช ูุงููุตุฑููุงุช', type: 'header', parentCode: null },
            
            // ุงูุฅูุฑุงุฏุงุช
            { code: '3010', name: 'ุงููุจูุนุงุช', type: 'revenue', parentCode: '3000', balance: 0.00 },
            { code: '3011', name: 'ุฎุตููุงุช ุงููุจูุนุงุช', type: 'revenue', parentCode: '3000', balance: 0.00 },
            
            // ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ
            { code: '3020', name: 'ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ', type: 'expense', parentCode: '3000', balance: 0.00 },
            
            // ุงููุตุงุฑูู ุงูุชุดุบูููุฉ
            { code: '3030', name: 'ุงููุตุงุฑูู ุงูุชุดุบูููุฉ', type: 'header', parentCode: '3000' },
            { code: '3031', name: 'ูุตุงุฑูู ุงูุจูุน ูุงูุชุณููู', type: 'expense', parentCode: '3030', balance: 0.00 },
            { code: '3032', name: 'ูุตุงุฑูู ุฅุฏุงุฑูุฉ ูุนุงูุฉ', type: 'expense', parentCode: '3030', balance: 0.00 },
            { code: '3033', name: 'ูุตุงุฑูู ุงูุฅููุงู', type: 'expense', parentCode: '3030', balance: 0.00 },
            
            // ุงููุตุงุฑูู ุงูุฃุฎุฑู
            { code: '3040', name: 'ูุตุงุฑูู ุฃุฎุฑู', type: 'expense', parentCode: '3000', balance: 0.00 },
            { code: '3050', name: 'ุฅูุฑุงุฏุงุช ุฃุฎุฑู', type: 'revenue', parentCode: '3000', balance: 0.00 }
        ];
        /**
        * ุชููุฆุฉ IndexedDB
        */
        function initDatabase() {
            const request = indexedDB.open('ERP82_Database', 1); // โญโญโญโญโญโญ

            request.onerror = function(event) {
                console.error('ูุดู ูู ูุชุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช:', event.target.error);
                alert('ุฎุทุฃ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ. ุงููุธุงู ูู ูุนูู ุจุดูู ุตุญูุญ!');
            };

            request.onsuccess = function(event) {
                db = event.target.result;
                console.log('ุชู ูุชุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ');
                initializeChartOfAccounts().then(() => {
                    updateBalance();
                    loadProductsForPOS();
                    loadCategories();
                    loadSuppliers();
                });
            };

            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                const oldVersion = event.oldVersion;
                const newVersion = event.newVersion;
                
                console.log(`ุฌุงุฑู ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ุงูุฅุตุฏุงุฑ ${oldVersion} ุฅูู ${newVersion}`);
                
                // ุฅูุดุงุก ObjectStore ุฌุฏูุฏ ูุตูุฑ ุงูููุชุฌุงุช ุฅุฐุง ูู ููู ููุฌูุฏุงู
                if (!db.objectStoreNames.contains('productImages')) {
                    const imagesStore = db.createObjectStore('productImages', { keyPath: 'productName' });
                    console.log('โ ุชู ุฅูุดุงุก ูุฎุฒู ุตูุฑ ุงูููุชุฌุงุช');
                }
                // ูุงุฆูุฉ ุจุฌููุน ุงููุฎุงุฒู ุงููุทููุจุฉ
                const storeNames = ['products', 'invoices', 'customers', 'suppliers', 'cashTransactions', 'settings', 'chartOfAccounts', 'journalEntries', 'purchaseInvoices', 'categories'];
                
                // ุญุฐู ุงููุฎุงุฒู ุงููุฏููุฉ ุบูุฑ ุงูููุฌูุฏุฉ
                Array.from(db.objectStoreNames).forEach(storeName => {
                    if (!storeNames.includes(storeName)) {
                        db.deleteObjectStore(storeName);
                    }
                });

                // ุฅูุดุงุก ุงููุฎุงุฒู ุงูุฌุฏูุฏุฉ ูุชุญุฏูุซ ุงูููุงุฑุณ
                if (!db.objectStoreNames.contains('products')) {
                    const productsStore = db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                    productsStore.createIndex('code', 'code', { unique: true });
                    productsStore.createIndex('categoryId', 'categoryId', { unique: false }); // โญ ุงูููุฑุณ ุงูุฌุฏูุฏ ูููุฆุงุช
                    productsStore.createIndex('name', 'name', { unique: false }); // โญ ุงูููุฑุณ ุงูุฌุฏูุฏ ููุจุญุซ ุจุงูุงุณู
                } else if (oldVersion < 4) {
                    // โญ ุชุญุฏูุซ ุงูููุงุฑุณ ูููุณุชุฎุฏููู ุงููุฏุงูู
                    const transaction = event.currentTarget.transaction;
                    const productsStore = transaction.objectStore('products');
                    
                    // ุฅูุดุงุก ุงูููุงุฑุณ ุงูุฌุฏูุฏุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
                    if (!productsStore.indexNames.contains('categoryId')) {
                        productsStore.createIndex('categoryId', 'categoryId', { unique: false });
                    }
                    if (!productsStore.indexNames.contains('name')) {
                        productsStore.createIndex('name', 'name', { unique: false });
                    }
                }
                
                if (!db.objectStoreNames.contains('invoices')) {
                    const invoicesStore = db.createObjectStore('invoices', { keyPath: 'id', autoIncrement: true });
                    invoicesStore.createIndex('invoiceNumber', 'invoiceNumber', { unique: true });
                    invoicesStore.createIndex('date', 'date', { unique: false }); // โญ ุงูููุฑุณ ุงูุฌุฏูุฏ ููุจุญุซ ุจุงูุชุงุฑูุฎ
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const invoicesStore = transaction.objectStore('invoices');
                    if (!invoicesStore.indexNames.contains('date')) {
                        invoicesStore.createIndex('date', 'date', { unique: false });
                    }
                }
                
                if (!db.objectStoreNames.contains('customers')) {
                    const customersStore = db.createObjectStore('customers', { keyPath: 'id', autoIncrement: true });
                    customersStore.createIndex('accCode', 'accCode', { unique: true });
                    customersStore.createIndex('name', 'name', { unique: false }); // โญ ุงูููุฑุณ ุงูุฌุฏูุฏ ููุจุญุซ ุจุงูุงุณู
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const customersStore = transaction.objectStore('customers');
                    if (!customersStore.indexNames.contains('name')) {
                        customersStore.createIndex('name', 'name', { unique: false });
                    }
                }

                if (!db.objectStoreNames.contains('suppliers')) {
                    const suppliersStore = db.createObjectStore('suppliers', { keyPath: 'id', autoIncrement: true });
                    suppliersStore.createIndex('accCode', 'accCode', { unique: true });
                    suppliersStore.createIndex('name', 'name', { unique: false }); // โญ ุงูููุฑุณ ุงูุฌุฏูุฏ ููุจุญุซ ุจุงูุงุณู
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const suppliersStore = transaction.objectStore('suppliers');
                    if (!suppliersStore.indexNames.contains('name')) {
                        suppliersStore.createIndex('name', 'name', { unique: false });
                    }
                }
                
                if (!db.objectStoreNames.contains('cashTransactions')) {
                    const cashStore = db.createObjectStore('cashTransactions', { keyPath: 'id', autoIncrement: true });
                    cashStore.createIndex('date', 'date', { unique: false }); // โญ ุงูููุฑุณ ุงูุฌุฏูุฏ ููุจุญุซ ุจุงูุชุงุฑูุฎ
                    cashStore.createIndex('type', 'type', { unique: false }); // โญ ุงูููุฑุณ ุงูุฌุฏูุฏ ููุจุญุซ ุจุงูููุน
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const cashStore = transaction.objectStore('cashTransactions');
                    if (!cashStore.indexNames.contains('date')) {
                        cashStore.createIndex('date', 'date', { unique: false });
                    }
                    if (!cashStore.indexNames.contains('type')) {
                        cashStore.createIndex('type', 'type', { unique: false });
                    }
                }
                
                if (!db.objectStoreNames.contains('settings')) {
                    db.createObjectStore('settings', { keyPath: 'key' });
                }
                
                if (!db.objectStoreNames.contains('chartOfAccounts')) {
                    const coaStore = db.createObjectStore('chartOfAccounts', { keyPath: 'code' });
                    coaStore.createIndex('parentCode', 'parentCode', { unique: false });
                    coaStore.createIndex('type', 'type', { unique: false }); // โญ ุงูููุฑุณ ุงูุฌุฏูุฏ ููุจุญุซ ุจุงูููุน
                    coaStore.createIndex('customerId', 'customerId', { unique: false }); // โญ ุฌุฏูุฏ
                    coaStore.createIndex('supplierId', 'supplierId', { unique: false }); // โญ ุฌุฏูุฏ
                    coaStore.createIndex('accountType', 'accountType', { unique: false }); // โญ ุฌุฏูุฏ
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const coaStore = transaction.objectStore('chartOfAccounts');
                    if (!coaStore.indexNames.contains('type')) {
                        coaStore.createIndex('type', 'type', { unique: false });
                    }
                }
                
                if (!db.objectStoreNames.contains('journalEntries')) {
                    const journalStore = db.createObjectStore('journalEntries', { keyPath: 'id', autoIncrement: true });
                    journalStore.createIndex('date', 'date', { unique: false }); // โญ ุงูููุฑุณ ุงูุฌุฏูุฏ ููุจุญุซ ุจุงูุชุงุฑูุฎ
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const journalStore = transaction.objectStore('journalEntries');
                    if (!journalStore.indexNames.contains('date')) {
                        journalStore.createIndex('date', 'date', { unique: false });
                    }
                }

                if (!db.objectStoreNames.contains('purchaseInvoices')) {
                    const purchaseStore = db.createObjectStore('purchaseInvoices', { keyPath: 'id', autoIncrement: true });
                    purchaseStore.createIndex('date', 'date', { unique: false }); // โญ ุงูููุฑุณ ุงูุฌุฏูุฏ ููุจุญุซ ุจุงูุชุงุฑูุฎ
                    purchaseStore.createIndex('supplierId', 'supplierId', { unique: false }); // โญ ุงูููุฑุณ ุงูุฌุฏูุฏ ููุจุญุซ ุจุงูููุฑุฏ
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const purchaseStore = transaction.objectStore('purchaseInvoices');
                    if (!purchaseStore.indexNames.contains('date')) {
                        purchaseStore.createIndex('date', 'date', { unique: false });
                    }
                    if (!purchaseStore.indexNames.contains('supplierId')) {
                        purchaseStore.createIndex('supplierId', 'supplierId', { unique: false });
                    }
                }
                
                if (!db.objectStoreNames.contains('categories')) {
                    const categoriesStore = db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                    categoriesStore.createIndex('name', 'name', { unique: false }); // โญ ุงูููุฑุณ ุงูุฌุฏูุฏ ููุจุญุซ ุจุงูุงุณู
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const categoriesStore = transaction.objectStore('categories');
                    if (!categoriesStore.indexNames.contains('name')) {
                        categoriesStore.createIndex('name', 'name', { unique: false });
                    }
                }
                
                console.log('ุชู ุฅูุดุงุก/ุชุญุฏูุซ ูุฎุงุฒู ุงูุจูุงูุงุช ูุงูููุงุฑุณ ุจูุฌุงุญ.');
            };
        }

        /**
         * ุชููุฆุฉ ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ุงูุงูุชุฑุงุถูุฉ ุนูุฏ ุฃูู ุชุดุบูู.
         */
        function initializeChartOfAccounts() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['chartOfAccounts'], 'readwrite');
                const store = transaction.objectStore('chartOfAccounts');

                const countRequest = store.count();
                countRequest.onsuccess = function() {
                    if (countRequest.result === 0) {
                        console.log('ุชููุฆุฉ ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ูุฃูู ูุฑุฉ...');
                        DEFAULT_ACCOUNTS.forEach(account => {
                            store.add(account);
                        });
                        transaction.oncomplete = () => {
                            console.log('ุชู ุฅุถุงูุฉ ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ุงูุงูุชุฑุงุถูุฉ.');
                            resolve(true);
                        };
                    } else {
                        resolve(false);
                    }
                };

                countRequest.onerror = (e) => reject(e.target.error);
            });
        }
        
        // ๐ง ุฅุถุงูุฉ ุฏูุงู ุงูุชููุฆุฉ ุงูููููุฏุฉ
        async function loadProductsForPurchase() {
            try {
                const products = await getAllProducts();
                const productSelects = document.querySelectorAll('.product-select');
                
                productSelects.forEach(select => {
                    // ุญูุธ ุงูุงุฎุชูุงุฑ ุงูุญุงูู
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุตูู</option>';
                    
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (${product.code})`;
                        select.appendChild(option);
                    });
                    
                    // ุงุณุชุนุงุฏุฉ ุงูุงุฎุชูุงุฑ ุงูุณุงุจู ุฅุฐุง ูุงู ููุฌูุฏุงู
                    if (currentValue) {
                        select.value = currentValue;
                    }
                });
            } catch (error) {
                console.error('ูุดู ุชุญููู ุงูููุชุฌุงุช ููุดุฑุงุก:', error);
            }
        }

        // ๐ง ุฅุถุงูุฉ ุฏุงูุฉ ุชุญููู ุงูุนููุงุก ุงูููููุฏุฉ
        async function loadCustomers() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    customers = request.result;
                    resolve(customers);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        // ๐ง ุฅุถุงูุฉ ุฏุงูุฉ ุชุญููู ุงูููุงุชูุฑ ุงูููููุฏุฉ
        function getAllInvoices() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['invoices'], 'readonly');
                const store = transaction.objectStore('invoices');
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
        * ุฅูุดุงุก ููุฏ ูุญุงุณุจู ูุน ุณุฌู ุชุฏููู ูุงูู - ุงูุฅุตุฏุงุฑ ุงููุตุญุญ
        */
        function createJournalEntry(description, debits, credits, refType, refId, transaction) {
            return new Promise((resolve, reject) => {
                if (!transaction) {
                    transaction = db.transaction(['journalEntries', 'chartOfAccounts'], 'readwrite');
                }
                
                const journalStore = transaction.objectStore('journalEntries');
                const coaStore = transaction.objectStore('chartOfAccounts');
                
                // ุงูุชุญูู ูู ุชูุงุฒู ุงูููุฏ
                const totalDebits = debits.reduce((sum, item) => sum + item.amount, 0);
                const totalCredits = credits.reduce((sum, item) => sum + item.amount, 0);
                const difference = Math.abs(totalDebits - totalCredits);
                
                if (difference > 0.01) {
                    reject(new Error(`ุงูููุฏ ุบูุฑ ูุชูุงุฒู. ุงููุฏูู: ${totalDebits.toFixed(2)}ุ ุงูุฏุงุฆู: ${totalCredits.toFixed(2)}ุ ุงููุฑู: ${difference.toFixed(2)}`));
                    return;
                }
                
                // ุฅูุดุงุก ุงูููุฏ ูุน ุณุฌู ุงูุชุฏููู ุงููุงูู
                const entry = {
                    date: new Date().toISOString(),
                    description: description,
                    debits: debits,
                    credits: credits,
                    refType: refType,
                    refId: refId,
                    balanced: true,
                    totalAmount: totalDebits,
                    createdAt: new Date().toISOString(),
                    auditInfo: {
                        userId: 'system', // ูุฌุจ ุงุณุชุจุฏุงููุง ุจูุณุชุฎุฏู ุญูููู
                        userRole: 'accountant',
                        timestamp: new Date().toISOString(),
                        ipAddress: getClientIP(), // ุฏุงูุฉ ุงูุชุฑุงุถูุฉ
                        sessionId: generateSessionId(), // ุฏุงูุฉ ุงูุชุฑุงุถูุฉ
                        deviceInfo: navigator.userAgent,
                        approvalRequired: totalDebits > 10000, // ูุซุงู: ุชุญุชุงุฌ ููุงููุฉ ุฅุฐุง ุชุฌุงูุฒุช 10,000
                        approvedBy: null,
                        approvedAt: null,
                        status: 'pending',
                        changes: [],
                        version: 1
                    }
                };
                
                // ุชุณุฌูู ุงูููุฏ
                const journalRequest = journalStore.add(entry);

                journalRequest.onsuccess = function() {
                    const entryId = journalRequest.result;
                    
                    console.log(`โ ุชู ุชุณุฌูู ุงูููุฏ ุงููุญุงุณุจู: ${description} (ุฑูู: ${entryId})`);
                    
                    // ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช
                    const updatePromises = [];
                    
                    // ุชุญุฏูุซ ุงูุญุณุงุจุงุช ุงููุฏููุฉ
                    debits.forEach(debitEntry => {
                        updatePromises.push(new Promise((resolveUpdate, rejectUpdate) => {
                            const accountRequest = coaStore.get(debitEntry.accountCode);
                            accountRequest.onsuccess = function(e) {
                                const account = e.target.result;
                                if (account) {
                                    account.balance = (account.balance || 0) + debitEntry.amount;
                                    account.lastUpdated = new Date().toISOString();
                                    account.lastTransaction = debitEntry.description;
                                    account.transactionCount = (account.transactionCount || 0) + 1;
                                    
                                    const putRequest = coaStore.put(account);
                                    putRequest.onsuccess = () => resolveUpdate();
                                    putRequest.onerror = (e) => rejectUpdate(e.target.error);
                                } else {
                                    rejectUpdate(new Error(`ุงูุญุณุงุจ ุงููุฏูู ุบูุฑ ููุฌูุฏ: ${debitEntry.accountCode}`));
                                }
                            };
                            accountRequest.onerror = (e) => rejectUpdate(e.target.error);
                        }));
                    });
                    
                    // ุชุญุฏูุซ ุงูุญุณุงุจุงุช ุงูุฏุงุฆูุฉ
                    credits.forEach(creditEntry => {
                        updatePromises.push(new Promise((resolveUpdate, rejectUpdate) => {
                            const accountRequest = coaStore.get(creditEntry.accountCode);
                            accountRequest.onsuccess = function(e) {
                                const account = e.target.result;
                                if (account) {
                                    account.balance = (account.balance || 0) - creditEntry.amount;
                                    account.lastUpdated = new Date().toISOString();
                                    account.lastTransaction = creditEntry.description;
                                    account.transactionCount = (account.transactionCount || 0) + 1;
                                    
                                    const putRequest = coaStore.put(account);
                                    putRequest.onsuccess = () => resolveUpdate();
                                    putRequest.onerror = (e) => rejectUpdate(e.target.error);
                                } else {
                                    rejectUpdate(new Error(`ุงูุญุณุงุจ ุงูุฏุงุฆู ุบูุฑ ููุฌูุฏ: ${creditEntry.accountCode}`));
                                }
                            };
                            accountRequest.onerror = (e) => rejectUpdate(e.target.error);
                        }));
                    });
                    
                    // ุงูุชุธุงุฑ ุงูุชูุงู ุฌููุน ุชุญุฏูุซุงุช ุงูุญุณุงุจุงุช
                    Promise.all(updatePromises)
                        .then(() => {
                            console.log(`โ ุชู ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช ููููุฏ: ${entryId}`);
                            resolve(entryId);
                        })
                        .catch(error => {
                            console.error('โ ูุดู ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช:', error);
                            reject(error);
                        });
                };
                
                journalRequest.onerror = (e) => {
                    console.error('โ ูุดู ุชุณุฌูู ุงูููุฏ:', e.target.error);
                    reject(e.target.error);
                };
            });
        }

        // ุฏูุงู ูุณุงุนุฏุฉ ููุชุฏููู
        function getClientIP() {
            // ุชูููุฐ ูุนูู ููุญุตูู ุนูู IP ุงูุนููู
            return 'localhost'; // ูุคูุช
        }

        function generateSessionId() {
            return 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        /**
         * ุฌูุจ ูุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู ููุตูุฏูู ูู ุงููุงุฌูุฉ
         */
        async function updateBalance() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    console.error('โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ูุชุงุญุฉ');
                    reject(new Error("Database not initialized"));
                    return;
                }
                
                const transaction = db.transaction(['chartOfAccounts'], 'readonly');
                const store = transaction.objectStore('chartOfAccounts');
                
                const request = store.get('1010'); // ููุฏ ุงูุตูุฏูู
                
                request.onsuccess = function() {
                    const cashAccount = request.result;
                    const balance = cashAccount ? (cashAccount.balance || 0.00) : 0.00;
                    
                    console.log('๐ฐ ุชุญุฏูุซ ุฑุตูุฏ ุงูุตูุฏูู:', balance.toFixed(2));
                    
                    // ุชุญุฏูุซ ุฌููุน ุนูุงุตุฑ ุงูุนุฑุถ
                    const balanceElements = [
                        'currentBalance',
                        'posBalance', 
                        'cashModuleBalance'
                    ];
                    
                    balanceElements.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = `${balance.toFixed(2)} ุฑ.ู`;
                        }
                    });
                    
                    resolve(balance);
                };
                
                request.onerror = (e) => {
                    console.error('โ ูุดู ุชุญุฏูุซ ุงูุฑุตูุฏ:', e.target.error);
                    reject(e.target.error);
                };
                
                // ุงูุชุฃูุฏ ูู ุงูุชูุงู ุงููุนุงููุฉ
                transaction.oncomplete = () => {
                    console.log('โ ุงูุชูู ุชุญุฏูุซ ุงูุฑุตูุฏ');
                };
            });
        }

        // ุฅุถุงูุฉ ุชุญุฏูุซ ุชููุงุฆู ููุฑุตูุฏ ูู 5 ุซูุงูู
        function startBalanceAutoRefresh() {
            setInterval(async () => {
                try {
                    await updateBalance();
                } catch (error) {
                    console.warn('โ๏ธ ูุดู ุงูุชุญุฏูุซ ุงูุชููุงุฆู ููุฑุตูุฏ:', error);
                }
            }, 5000); // ูู 5 ุซูุงู
        }

        // ==================== 4.3. ุฅุฏุงุฑุฉ ุงููุฎุฒูู ====================

        /**
         * ุฌูุจ ุฌููุน ุงูุฃุตูุงู ูู IndexedDB
         */
        function getAllProducts() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['products'], 'readonly');
                const store = transaction.objectStore('products');
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * ุฌูุจ ุงููุฆุงุช ูู IndexedDB
         */
        function loadCategories() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['categories'], 'readonly');
                const store = transaction.objectStore('categories');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    categories = request.result;
                    resolve(categories);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * ุฌูุจ ุงูููุฑุฏูู ูู IndexedDB
         */
        function loadSuppliers() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['suppliers'], 'readonly');
                const store = transaction.objectStore('suppliers');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    suppliers = request.result;
                    resolve(suppliers);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * ุญูุธ ุตูู ุฌุฏูุฏ ุฃู ุชุญุฏูุซู
         */
        function saveProduct(product) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                
                const transaction = db.transaction(['products'], 'readwrite');
                const store = transaction.objectStore('products');
                
                // ุฅุฐุง ูุงู ุงูููุชุฌ ุฌุฏูุฏุงู (ุจุฏูู ID)ุ ูุถููู
                if (!product.id) {
                    const request = store.add(product);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                } else {
                    // ุฅุฐุง ูุงู ููุฌูุฏุงูุ ูุญุฏุซู
                    const request = store.put(product);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                }
            });
        }

        /**
         * ุญุฐู ุตูู
         */
        function deleteProduct(id) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                
                const transaction = db.transaction(['products'], 'readwrite');
                const store = transaction.objectStore('products');
                const request = store.delete(id);
                
                request.onsuccess = () => resolve(true);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * ุชุญููู ูุนุฑุถ ุงูููุชุฌุงุช ูู ุฌุฏูู ุงููุฎุฒูู
         */
        async function loadProductsTable() {
            try {
                const products = await getAllProducts();
                const tbody = document.getElementById('productsTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">ูุง ุชูุฌุฏ ููุชุฌุงุช ูุณุฌูุฉ ุจุนุฏ.</td></tr>';
                    return;
                }
                
                products.forEach(product => {
                    const row = document.createElement('tr');
                    if (product.quantity <= (product.minQuantity || 5)) {
                        row.classList.add('low-stock');
                    }
                    
                    if (product.expiryDate && new Date(product.expiryDate) < new Date()) {
                        row.classList.add('expired');
                    }
                    
                    // ูุนุงููุฉ ุงูุตูุฑุฉ ููุฌุฏูู
                    let imagePreview = product.image || '๐ฆ';
                    if (product.imageData) {
                        imagePreview = `<img src="${product.imageData}" alt="${product.name}" 
                            style="width: 30px; height: 30px; object-fit: cover; border-radius: 4px;"
                            onerror="this.outerHTML='<span>${product.image || '๐ฆ'}</span>'">`;
                    }
                    
                    row.innerHTML = `
                        <td>${product.code}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="me-2">${imagePreview}</div>
                                <div>${product.name}</div>
                            </div>
                        </td>
                        <td>${product.quantity}</td>
                        <td>${product.purchasePrice.toFixed(2)} ุฑ.ู</td>
                        <td>${product.salePrice.toFixed(2)} ุฑ.ู</td>
                        <td>${product.expiryDate ? new Date(product.expiryDate).toLocaleDateString('ar-YE') : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-product-btn" data-id="${product.id}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-product-btn" data-id="${product.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('ูุดู ุชุญููู ุฌุฏูู ุงูููุชุฌุงุช:', error);
            }
        }

        // ==================== ุฏูุงู ุฅุฏุงุฑุฉ ุงูุตูุฑ ูุงููุงููุฑุง ====================


        /**
        * ุชููุฆุฉ ุงููููุฐุฌ ูุงูุชุญูู ูู ุงูุตุญุฉ
        */
        function initializeProductForm() {
            const form = document.getElementById('productForm');
            
            // ุฅุนุงุฏุฉ ุชุนููู ุญุงูุฉ ุงูุชุญูู
            form.classList.remove('was-validated');
            
            // ูุณุชูุนุงุช ุงูุฃุญุฏุงุซ ููุชุญูู ุฃุซูุงุก ุงููุชุงุจุฉ
            const inputs = form.querySelectorAll('input[required], select[required]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    if (this.checkValidity()) {
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    } else {
                        this.classList.remove('is-valid');
                        this.classList.add('is-invalid');
                    }
                });
            });
        }

        /**
        * ุงูุชุญูู ูู ุตุญุฉ ุงููููุฐุฌ
        */
        function validateProductForm() {
            const form = document.getElementById('productForm');
            const requiredFields = [
                'productCode', 'productName', 'productPurchasePrice', 
                'productSalePrice', 'productQuantity', 'productMinQuantity'
            ];
            
            let isValid = true;
            
            // ุฅุนุงุฏุฉ ุชุนููู ุงูุชูุณูู
            form.classList.add('was-validated');
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    if (!field.checkValidity()) {
                        field.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        field.classList.remove('is-invalid');
                        field.classList.add('is-valid');
                    }
                }
            });
            
            return isValid;
        }

        /**
        * ุชููุฆุฉ ุงููุงููุฑุง
        */
        async function initializeCamera() {
            try {
                // ุฅููุงู ุงููุงููุฑุง ุงูุณุงุจูุฉ ุฅุฐุง ูุงูุช ุชุนูู
                if (cameraStream) {
                    stopCamera();
                }

                const video = document.getElementById('cameraVideo');
                const cameraContainer = document.getElementById('cameraContainer');
                
                // ุทูุจ ุฅุฐู ุงููุงููุฑุง ูุน ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก
                const constraints = {
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                video.srcObject = cameraStream;
                cameraContainer.style.display = 'block';
                document.getElementById('openCameraBtn').style.display = 'none';
                
                // ุงูุชุธุงุฑ ุชุญููู ุงูููุฏูู
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
                
                return true;
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุชุดุบูู ุงููุงููุฑุง:', error);
                return handleCameraError(error);
            }
        }

        /**
        * ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงููุงููุฑุง
        */
        function handleCameraError(error) {
            let errorMessage = 'ุชุนุฐุฑ ุงููุตูู ุฅูู ุงููุงููุฑุง. ';
            
            if (error.name === 'NotAllowedError') {
                errorMessage += 'ูุฑุฌู ุงูุณูุงุญ ุจุงุณุชุฎุฏุงู ุงููุงููุฑุง ูู ุฅุนุฏุงุฏุงุช ุงููุชุตูุญ.';
            } else if (error.name === 'NotFoundError') {
                errorMessage += 'ูู ูุชู ุงูุนุซูุฑ ุนูู ูุงููุฑุง.';
            } else if (error.name === 'NotSupportedError') {
                errorMessage += 'ุงููุชุตูุญ ูุง ูุฏุนู ุงููุงููุฑุง.';
            } else {
                errorMessage += 'ุฎุทุฃ ุบูุฑ ูุนุฑูู: ' + error.message;
            }
            
            alert('โ ' + errorMessage);
            return false;
        }

        /**
        * ุฅููุงู ุงููุงููุฑุง
        */
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => {
                    track.stop();
                });
                cameraStream = null;
            }
            
            const video = document.getElementById('cameraVideo');
            const cameraContainer = document.getElementById('cameraContainer');
            
            cameraContainer.style.display = 'none';
            document.getElementById('openCameraBtn').style.display = 'block';
            video.srcObject = null;
        }

        /**
        * ุงูุชูุงุท ุตูุฑุฉ ูู ุงููุงููุฑุง
        */
        function captureImage() {
            try {
                const video = document.getElementById('cameraVideo');
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                // ุถุจุท ุฃุจุนุงุฏ canvas ูุชุชูุงุณุจ ูุน ุงูููุฏูู
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // ุฑุณู ุงูุตูุฑุฉ ุนูู canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // ุชุญููู ุงูุตูุฑุฉ ุฅูู base64 ุจุฌูุฏุฉ ุนุงููุฉ
                const imageData = canvas.toDataURL('image/jpeg', 0.9);
                
                // ุญูุธ ุจูุงูุงุช ุงูุตูุฑุฉ
                saveImageData(imageData, 'ูุงููุฑุง');
                
                // ุฅููุงู ุงููุงููุฑุง ุจุนุฏ ุงูุงูุชูุงุท
                stopCamera();
                
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุงูุชูุงุท ุงูุตูุฑุฉ:', error);
                alert('โ ูุดู ูู ุงูุชูุงุท ุงูุตูุฑุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        }

        /**
        * ูุนุงูุฌุฉ ุฑูุน ุงูุตูุฑุฉ ูู ุงูููู
        */
        /**
        * ุงูุชูุงุท ุตูุฑุฉ ูู ุงููุงููุฑุง - ุงูุฅุตุฏุงุฑ ุงููุญุณูู
        */
        function captureImage() {
            try {
                const video = document.getElementById('cameraVideo');
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                // ุถุจุท ุฃุจุนุงุฏ canvas
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // ุฑุณู ุงูุตูุฑุฉ ุนูู canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // ุชุญููู ุงูุตูุฑุฉ ุฅูู base64
                const imageData = canvas.toDataURL('image/jpeg', 0.85);
                
                // ุญูุธ ูุนุฑุถ ุงูุตูุฑุฉ
                saveImageData(imageData, 'ูุงููุฑุง');
                stopCamera();
                
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุงูุชูุงุท ุงูุตูุฑุฉ:', error);
                alert('โ ูุดู ูู ุงูุชูุงุท ุงูุตูุฑุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        }

        /**
        * ูุนุงูุฌุฉ ุฑูุน ุงูุตูุฑุฉ ูู ุงูููู - ุงูุฅุตุฏุงุฑ ุงููุญุณูู
        */
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงูููู ูุชุฌูุจ ูุดุงูู ุงููุญุชูู
            event.target.value = '';
            
            // ุงูุชุญูู ูู ููุน ุงูููู
            if (!file.type.startsWith('image/')) {
                alert('โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ููู ุตูุฑุฉ ููุท (JPEG, PNG, GIF, etc.)');
                return;
            }
            
            // ุงูุชุญูู ูู ุญุฌู ุงูููู (8MB ูุญุฏ ุฃูุตู)
            if (file.size > 8 * 1024 * 1024) {
                alert('โ๏ธ ุญุฌู ุงูุตูุฑุฉ ูุจูุฑ ุฌุฏุงู. ุงูุญุฏ ุงูุฃูุตู 8MB');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const imageData = e.target.result;
                    saveImageData(imageData, 'ูุนุฑุถ');
                } catch (error) {
                    console.error('โ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุตูุฑุฉ:', error);
                    alert('โ ูุดู ูู ูุนุงูุฌุฉ ุงูุตูุฑุฉ. ูุฑุฌู ุงุฎุชูุงุฑ ุตูุฑุฉ ุฃุฎุฑู.');
                }
            };
            
            reader.onerror = function() {
                alert('โ ูุดู ูู ูุฑุงุกุฉ ุงูููู. ูุฑุฌู ุงุฎุชูุงุฑ ุตูุฑุฉ ุฃุฎุฑู.');
            };
            
            reader.readAsDataURL(file);
        }

        /**
        * ุชุญููู ุตูุฑุฉ ูู ุฑุงุจุท URL - ุงูุฅุตุฏุงุฑ ุงููุญุณูู
        */
        async function loadImageFromUrl() {
            const urlInput = document.getElementById('productImageUrl');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('โ๏ธ ูุฑุฌู ุฅุฏุฎุงู ุฑุงุจุท ุงูุตูุฑุฉ ุฃููุงู');
                urlInput.focus();
                return;
            }
            
            // ุงูุชุญูู ูู ุตุญุฉ ุงูุฑุงุจุท
            if (!isValidUrl(url)) {
                alert('โ ุฑุงุจุท ุบูุฑ ุตุงูุญ. ูุฑุฌู ุฅุฏุฎุงู ุฑุงุจุท ูุจุฏุฃ ุจู http:// ุฃู https://');
                urlInput.focus();
                return;
            }
            
            try {
                // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
                const loadBtn = document.getElementById('loadImageFromUrl');
                const originalText = loadBtn.innerHTML;
                loadBtn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                loadBtn.disabled = true;
                
                // ุงุณุชุฎุฏุงู CORS proxy ูุชุฌูุจ ูุดุงูู CORS
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    throw new Error(`ุฎุทุฃ ูู ุงูุชุญููู: ${response.status} ${response.statusText}`);
                }
                
                const blob = await response.blob();
                
                // ุงูุชุญูู ูู ููุน ุงูููู
                if (!blob.type.startsWith('image/')) {
                    throw new Error('ุงูุฑุงุจุท ูุง ูุดูุฑ ุฅูู ุตูุฑุฉ ุตุงูุญุฉ');
                }
                
                // ุชุญููู Blob ุฅูู base64
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    saveImageData(imageData, 'ุฑุงุจุท');
                    
                    // ุฅุนุงุฏุฉ ุชุนููู ุงูุฒุฑ
                    loadBtn.innerHTML = originalText;
                    loadBtn.disabled = false;
                    urlInput.value = ''; // ูุณุญ ุงูุฑุงุจุท ุจุนุฏ ุงูุชุญููู ุงููุงุฌุญ
                };
                
                reader.readAsDataURL(blob);
                
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุตูุฑุฉ:', error);
                alert(`โ ุชุนุฐุฑ ุชุญููู ุงูุตูุฑุฉ ูู ุงูุฑุงุจุท:\n${error.message}`);
                
                // ุฅุนุงุฏุฉ ุชุนููู ุงูุฒุฑ
                const loadBtn = document.getElementById('loadImageFromUrl');
                loadBtn.innerHTML = '<i class="bi bi-download"></i>';
                loadBtn.disabled = false;
            }
        }

        /**
        * ุงูุชุญูู ูู ุตุญุฉ ุงูุฑุงุจุท
        */
        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }

        /**
        * ุญูุธ ุจูุงูุงุช ุงูุตูุฑุฉ ูุนุฑุถ ุงููุนุงููุฉ - ุงูุฅุตุฏุงุฑ ุงููุญุณูู
        */
        async function saveImageData(imageData, source) {
            try {
                // ุถุบุท ุงูุตูุฑุฉ ุฃููุงู
                const compressedData = await compressImage(imageData);
                
                // ุญูุธ ุจูุงูุงุช ุงูุตูุฑุฉ ูู ุงูุญูู ุงููุฎูู
                document.getElementById('productImageData').value = compressedData;
                
                // ุนุฑุถ ุงููุนุงููุฉ
                const preview = document.getElementById('productImagePreview');
                preview.src = compressedData;
                preview.style.display = 'block';
                document.getElementById('noImagePlaceholder').style.display = 'none';
                
                // ุฅุธูุงุฑ ุฒุฑ ุฅุฒุงูุฉ ุงูุตูุฑุฉ
                document.getElementById('removeImageBtn').style.display = 'block';
                
                // ุฅุธูุงุฑ ูุนูููุงุช ุงููุตุฏุฑ
                const uploadedImageInfo = document.getElementById('uploadedImageInfo');
                uploadedImageInfo.style.display = 'block';
                uploadedImageInfo.innerHTML = `<small class="text-success">โ ุชู ${source === 'ูุนุฑุถ' ? 'ุงุฎุชูุงุฑ' : 'ุชุญููู'} ุงูุตูุฑุฉ ูู ${source}</small>`;
                
                console.log(`โ ุชู ุญูุธ ุตูุฑุฉ ูู ${source} ุจูุฌุงุญ (ุงูุญุฌู: ${Math.round(compressedData.length / 1024)} KB)`);
                
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุญูุธ ุจูุงูุงุช ุงูุตูุฑุฉ:', error);
                alert('โ ูุดู ูู ุญูุธ ุงูุตูุฑุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        }

        /**
        * ุฅุฒุงูุฉ ุงูุตูุฑุฉ ุงูุญุงููุฉ
        */
        function removeImage() {
            // ุฅุนุงุฏุฉ ุชุนููู ุฌููุน ุญููู ุงูุตูุฑ
            document.getElementById('productImageData').value = '';
            document.getElementById('productImagePreview').style.display = 'none';
            document.getElementById('noImagePlaceholder').style.display = 'block';
            document.getElementById('removeImageBtn').style.display = 'none';
            document.getElementById('uploadedImageInfo').style.display = 'none';
            document.getElementById('productImageUpload').value = '';
            document.getElementById('productImageUrl').value = '';
            
            // ุฅููุงู ุงููุงููุฑุง ุฅุฐุง ูุงูุช ุชุนูู
            if (cameraStream) {
                stopCamera();
            }
            
            console.log('๐๏ธ ุชู ุฅุฒุงูุฉ ุงูุตูุฑุฉ');
        }

        /**
        * ุถุบุท ุงูุตูุฑุฉ ูุชูููู ุงูุญุฌู - ุงูุฅุตุฏุงุฑ ุงููุญุณูู
        */
        function compressImage(imageData, maxWidth = 800, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ุญุณุงุจ ุงูุฃุจุนุงุฏ ุงูุฌุฏูุฏุฉ ูุน ุงูุญูุงุธ ุนูู ุงูุชูุงุณุจ
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ุชุญุณูู ุฌูุฏุฉ ุงูุฑุณู
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ุชุญููู ุฅูู base64 ูุน ุงูุฌูุฏุฉ ุงููุทููุจุฉ
                    try {
                        const compressedData = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                img.onerror = function() {
                    reject(new Error('ูุดู ูู ุชุญููู ุงูุตูุฑุฉ ููุถุบุท'));
                };
                
                img.src = imageData;
            });
        }

        /**
        * ูุชุญ ูููุฐุฌ ุฅุถุงูุฉ/ุชุนุฏูู ููุชุฌ - ูุน ุงูุชุญูู ูู ุงูุญููู
        */
        async function openProductModal(productId = null) {
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            
            // ุชููุฆุฉ ุงููููุฐุฌ
            initializeProductForm();
            
            // ุชุญููู ุงูุจูุงูุงุช
            await loadSettings();
            
            // ุชุนุจุฆุฉ ุฎูุงุฑุงุช ุงููุฆุงุช
            const categorySelect = document.getElementById('productCategory');
            categorySelect.innerHTML = '<option value="">ุจุฏูู ูุฆุฉ</option>';
            categories.forEach(category => {
                categorySelect.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
            
            // ุชุทุจูู ุฅุนุฏุงุฏุงุช ุงููููุฉ
            await setupQuantityFieldVisibility();
            
            // ุฅุนุงุฏุฉ ุชุนููู ุงูุตูุฑุฉ
            removeImage();
            
            if (productId) {
                // ูุถุน ุงูุชุนุฏูู
                document.getElementById('productModalLabel').textContent = 'ุชุนุฏูู ุงูุตูู';
                
                try {
                    const product = await getProductById(parseInt(productId));
                    if (product) {
                        // ุชุนุจุฆุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
                        document.getElementById('productId').value = product.id;
                        document.getElementById('productCode').value = product.code;
                        document.getElementById('productName').value = product.name;
                        document.getElementById('productPurchasePrice').value = product.purchasePrice;
                        document.getElementById('productSalePrice').value = product.salePrice;
                        
                        // ุชุนุจุฆุฉ ุงููููุฉ
                        const showQuantityField = await getSetting('showQuantityField', true);
                        if (showQuantityField) {
                            document.getElementById('productQuantity').value = product.quantity;
                        } else {
                            document.getElementById('productQuantity').value = '0';
                        }
                        
                        document.getElementById('productMinQuantity').value = product.minQuantity || 5;
                        document.getElementById('productExpiryDate').value = product.expiryDate || '';
                        document.getElementById('productCategory').value = product.categoryId || '';
                        document.getElementById('productImageEmoji').value = product.image || '๐ฆ';
                        
                        // ุชุญููู ุงูุตูุฑุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
                        if (product.imageData) {
                            saveImageData(product.imageData, 'ูุงุนุฏุฉ ุงูุจูุงูุงุช');
                        }
                    }
                } catch (error) {
                    console.error('โ ูุดู ุชุญููู ุจูุงูุงุช ุงูููุชุฌ:', error);
                    alert('โ ูุดู ูู ุชุญููู ุจูุงูุงุช ุงูููุชุฌ');
                }
            } else {
                // ูุถุน ุงูุฅุถุงูุฉ
                document.getElementById('productModalLabel').textContent = 'ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ';
                document.getElementById('productForm').reset();
                document.getElementById('productId').value = '';
                
                // ุชุนููู ุงููููุฉ ุตูุฑ ุฅุฐุง ูุงู ุงูุญูู ูุฎููุงู
                const showQuantityField = await getSetting('showQuantityField', true);
                if (!showQuantityField) {
                    document.getElementById('productQuantity').value = '0';
                }
            }
            
            modal.show();
        }

        /**
        * ุฌูุจ ุฅุนุฏุงุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        */
        async function getSetting(key, defaultValue = null) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(defaultValue);
                    return;
                }
                
                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.get(key);
                
                request.onsuccess = function() {
                    if (request.result) {
                        resolve(request.result.value);
                    } else {
                        resolve(defaultValue);
                    }
                };
                
                request.onerror = () => resolve(defaultValue);
            });
        }

        /**
        * ุงูุชุญูู ูู ุฅุธูุงุฑ/ุฅุฎูุงุก ุญูู ุงููููุฉ ุญุณุจ ุฅุนุฏุงุฏุงุช ุงููุฏูุฑ
        */
        async function setupQuantityFieldVisibility() {
            try {
                const showQuantityField = await getSetting('showQuantityField', true);
                const quantityField = document.getElementById('productQuantity');
                const quantityLabel = document.querySelector('label[for="productQuantity"]');
                
                if (quantityField && quantityLabel) {
                    // ุฅุฒุงูุฉ ุงูููุงุญุธุงุช ุงููุฏููุฉ ุฃููุงู
                    const existingNotes = quantityField.parentNode.querySelectorAll('.quantity-field-note');
                    existingNotes.forEach(note => note.remove());
                    
                    if (!showQuantityField) {
                        quantityField.style.display = 'none';
                        quantityLabel.style.display = 'none';
                        quantityField.value = '0';
                        quantityField.readOnly = true;
                        
                        // ุฅุถุงูุฉ ููุงุญุธุฉ ุชูุถูุญูุฉ ุฌุฏูุฏุฉ
                        const note = document.createElement('small');
                        note.className = 'form-text text-muted d-block quantity-field-note';
                        note.textContent = 'โ๏ธ ุญูู ุงููููุฉ ูุฎูู. ูุชู ุฅุถุงูุฉ ุงููููุงุช ุนุจุฑ ููุงุชูุฑ ุงูุดุฑุงุก ููุท';
                        quantityField.parentNode.appendChild(note);
                        
                        console.log('โ ุชู ุฅุฎูุงุก ุญูู ุงููููุฉ');
                    } else {
                        quantityField.style.display = 'block';
                        quantityLabel.style.display = 'block';
                        quantityField.readOnly = false;
                        quantityField.placeholder = 'ุงููููุฉ ุงููุชุงุญุฉ';
                        
                        console.log('โ ุชู ุฅุธูุงุฑ ุญูู ุงููููุฉ');
                    }
                }
            } catch (error) {
                console.error('โ ูุดู ุชุญููู ุฅุนุฏุงุฏุงุช ุญูู ุงููููุฉ:', error);
            }
        }

        /**
        * ุญูุธ ุฅุนุฏุงุฏ ุฅุธูุงุฑ/ุฅุฎูุงุก ุญูู ุงููููุฉ
        */
        async function saveQuantityFieldSetting() {
            const showQuantityField = document.getElementById('showQuantityFieldSetting').checked;
            
            try {
                const transaction = db.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                await store.put({ key: 'showQuantityField', value: showQuantityField });
                
                // ุชุทุจูู ุงูุชุบููุฑ ููุฑุงู ุนูู ุฌููุน ุงูููุงุฐุฌ ุงูููุชูุญุฉ
                await applyQuantityFieldSettingToAllModals(showQuantityField);
                
                alert('โ ุชู ุญูุธ ุงูุฅุนุฏุงุฏ ุจูุฌุงุญ! ุณูุชู ุชุทุจููู ุนูู ุฌููุน ุงูููุงุฐุฌ.');
            } catch (error) {
                console.error('ูุดู ุญูุธ ุฅุนุฏุงุฏ ุญูู ุงููููุฉ:', error);
                alert('โ ูุดู ุญูุธ ุงูุฅุนุฏุงุฏ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        }

        /**
        * ุชุทุจูู ุฅุนุฏุงุฏ ุญูู ุงููููุฉ ุนูู ุฌููุน ุงูููุงุฐุฌ ุงูููุชูุญุฉ
        */
        async function applyQuantityFieldSettingToAllModals(showQuantityField) {
            // ุชุญุฏูุซ ุงููููุฐุฌ ุงูุฑุฆูุณู ุฅุฐุง ูุงู ููุชูุญุงู
            const productModal = document.getElementById('productModal');
            if (productModal && productModal.style.display !== 'none') {
                await setupQuantityFieldVisibility();
            }
            
            // ุชุญุฏูุซ ุนุฑุถ ุงูููุชุฌุงุช ูู ููุทุฉ ุงูุจูุน
            if (currentView === 'products' && currentCategoryId) {
                await loadProductsForCategory(currentCategoryId);
            }
        }

        // ==================== ุฏูุงู ุฅุฏุงุฑุฉ ุตูุฑ ุงูููุชุฌุงุช ====================

        /**
        * ุญูุธ ุตูุฑุฉ ุงูููุชุฌ ูู IndexedDB ุจุงุณุชุฎุฏุงู ุงุณู ุงูููุชุฌ ููุนุฑู
        */
        async function saveProductImage(productName, imageFile) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("ูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ูุชุงุญุฉ"));
                    return;
                }

                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const transaction = db.transaction(['productImages'], 'readwrite');
                        const store = transaction.objectStore('productImages');
                        
                        const imageData = {
                            productName: productName,
                            imageData: e.target.result, // ุญูุธ ูู Data URL
                            mimeType: imageFile.type,
                            lastUpdated: new Date().toISOString()
                        };
                        
                        const request = store.put(imageData);
                        
                        request.onsuccess = () => {
                            console.log(`โ ุชู ุญูุธ ุตูุฑุฉ ุงูููุชุฌ: ${productName}`);
                            resolve(true);
                        };
                        
                        request.onerror = (e) => {
                            console.error('โ ูุดู ุญูุธ ุงูุตูุฑุฉ:', e.target.error);
                            reject(e.target.error);
                        };
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => {
                    reject(new Error('ูุดู ูู ูุฑุงุกุฉ ุงูููู'));
                };
                
                reader.readAsDataURL(imageFile); // ูุฑุงุกุฉ ุงูููู ูู Data URL
            });
        }

        /**
        * ุฌูุจ ุตูุฑุฉ ุงูููุชุฌ ูู IndexedDB ุจุงุณุชุฎุฏุงู ุงุณู ุงูููุชุฌ
        */
        async function getProductImage(productName) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(null);
                    return;
                }

                const transaction = db.transaction(['productImages'], 'readonly');
                const store = transaction.objectStore('productImages');
                const request = store.get(productName);
                
                request.onsuccess = function() {
                    const result = request.result;
                    if (result && result.imageData) {
                        console.log(`โ ุชู ุชุญููู ุตูุฑุฉ ุงูููุชุฌ: ${productName}`);
                        resolve(result.imageData);
                    } else {
                        resolve(null);
                    }
                };
                
                request.onerror = (e) => {
                    console.error('โ ูุดู ุฌูุจ ุงูุตูุฑุฉ:', e.target.error);
                    resolve(null);
                };
            });
        }

        /**
        * ุญุฐู ุตูุฑุฉ ุงูููุชุฌ
        */
        async function deleteProductImage(productName) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(false);
                    return;
                }

                const transaction = db.transaction(['productImages'], 'readwrite');
                const store = transaction.objectStore('productImages');
                const request = store.delete(productName);
                
                request.onsuccess = () => {
                    console.log(`โ ุชู ุญุฐู ุตูุฑุฉ ุงูููุชุฌ: ${productName}`);
                    resolve(true);
                };
                
                request.onerror = (e) => {
                    console.error('โ ูุดู ุญุฐู ุงูุตูุฑุฉ:', e.target.error);
                    resolve(false);
                };
            });
        }

        /**
        * ูุนุงููุฉ ุงูุตูุฑุฉ ูุจู ุงูุญูุธ
        */
        function setupImagePreview() {
            const imageUpload = document.getElementById('productImageUpload');
            const previewContainer = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            
            if (imageUpload && previewContainer && previewImg) {
                imageUpload.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImg.src = e.target.result;
                            previewContainer.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        previewContainer.style.display = 'none';
                    }
                });
            }
        }

        // ุฏุงูุฉ ูุนุงูุฌุฉ ุฑูุน ุงูุตูุฑุฉ
        function setupImageUpload() {
            const imageUpload = document.getElementById('productImageUpload');
            const productNameInput = document.getElementById('productName');
            
            imageUpload.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                const productName = productNameInput.value.trim();
                
                if (!file) return;
                
                if (!productName) {
                    alert('โ๏ธ ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงูููุชุฌ ุฃููุงู');
                    this.value = ''; // ูุณุญ ุงูููู
                    return;
                }
                
                // ุงูุชุญูู ูู ููุน ุงูููู
                if (!file.type.startsWith('image/')) {
                    alert('โ ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููู ุตูุฑุฉ ููุท');
                    this.value = '';
                    return;
                }
                
                // ุงูุชุญูู ูู ุญุฌู ุงูููู (2MB ูุญุฏ ุฃูุตู)
                if (file.size > 2 * 1024 * 1024) {
                    alert('โ ุญุฌู ุงูุตูุฑุฉ ูุจูุฑ ุฌุฏุงู. ุงูุญุฏ ุงูุฃูุตู 2MB');
                    this.value = '';
                    return;
                }
                
                // ุนุฑุถ ุงููุนุงููุฉ
                showImagePreview(file);
                
                // ูููู ุญูุธ ูุคูุช ููุง ุฅุฐุง ุฃุฑุฏุช
                console.log(`๐ธ ุฌุงูุฒ ูุญูุธ ุตูุฑุฉ: ${productName}`);
            });
        }

        // ุฏุงูุฉ ุงูุนุฑุถ ูู ูุงุฌูุฉ ุงูุจูุน
        async function displayProductImage(productName) {
            try {
                const imageData = await getProductImage(productName);
                if (imageData) {
                    return `<img src="${imageData}" class="product-image" 
                            alt="${productName}" 
                            style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">`;
                }
            } catch (error) {
                console.log('โ๏ธ ูุง ุชูุฌุฏ ุตูุฑุฉ ูุฎุตุตุฉ ููููุชุฌ');
            }
            
            // ุงูุฑุฌูุน ููุฅูููุฌู ุงูุงูุชุฑุงุถู
            return '๐ฆ';
        }
        // ุชุญูู ุฅุถุงูู ุนูุฏ ุงูุญูุธ
        async function validateImageBeforeSave(productName, imageFile) {
            // 1. ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงุณู ููุชุฌ
            if (!productName || productName.length < 2) {
                throw new Error('ุงุณู ุงูููุชุฌ ุบูุฑ ุตุงูุญ');
            }
            
            // 2. ุงูุชุฃูุฏ ูู ุฃู ุงูููู ุตูุฑุฉ
            if (!imageFile.type.startsWith('image/')) {
                throw new Error('ุงูููู ููุณ ุตูุฑุฉ');
            }
            
            // 3. ุงูุญุฏ ุงูุฃูุตู ููุญุฌู 2MB
            if (imageFile.size > 2 * 1024 * 1024) {
                throw new Error('ุญุฌู ุงูุตูุฑุฉ ูุชุฌุงูุฒ 2MB');
            }
            
            return true;
        }

        /**
        * ุญูุธ ุงูููุชุฌ ูู ุงููููุฐุฌ - ุงูุญู ุงููุคูุช (ุฅุถุงูุฉ ูุฑุฃุณ ุงููุงู)
        */
        async function saveProductFromForm() {
            // ุงูุชุญูู ูู ุตุญุฉ ุงููููุฐุฌ
            if (!validateProductForm()) {
                alert('โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุงูุญููู ุงููุทููุจุฉ ุจุดูู ุตุญูุญ');
                return;
            }
            
            const productId = document.getElementById('productId').value;
            const showQuantityField = await getSetting('showQuantityField', true);
            
            const product = {
                code: document.getElementById('productCode').value.trim(),
                name: document.getElementById('productName').value.trim(),
                purchasePrice: parseFloat(document.getElementById('productPurchasePrice').value) || 0,
                salePrice: parseFloat(document.getElementById('productSalePrice').value),
                wholesalePrice: parseFloat(document.getElementById('productWholesalePrice').value) || 0,
                quantity: showQuantityField ? (parseInt(document.getElementById('productQuantity').value) || 0) : 0,
                minQuantity: parseInt(document.getElementById('productMinQuantity').value) || 5,
                expiryDate: document.getElementById('productExpiryDate').value || null,
                categoryId: document.getElementById('productCategory').value || null,
                image: document.getElementById('productImageEmoji').value || '๐ฆ',
                baseUnit: document.getElementById('productBaseUnit').value,
                purchaseUnit: document.getElementById('productPurchaseUnit').value,
                conversionFactor: parseInt(document.getElementById('productConversionFactor').value) || 1,
                currency: 'YER' // ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ
            };
            
            // ุฅุถุงูุฉ ุจูุงูุงุช ุงูุตูุฑุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
            const imageData = document.getElementById('productImageData').value;
            if (imageData) {
                product.imageData = imageData;
            }
            
            if (productId) {
                product.id = parseInt(productId);
            }

            try {
                const savedProductId = await saveProduct(product);
                
                // ุชุณุฌูู ุงูููุฏ ุงููุญุงุณุจู ููููุชุฌุงุช ุงูุฌุฏูุฏุฉ
                const inventoryValue = product.purchasePrice * product.quantity;
                if ((!productId || productId === '') && inventoryValue > 0) {
                    await recordManualInventoryAsCapital(product, inventoryValue, savedProductId);
                }
                
                // ุฅุบูุงู ุงููููุฐุฌ ูุชูุธูู ุงูููุงุฑุฏ
                const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                modal.hide();
                
                if (cameraStream) {
                    stopCamera();
                }
                
                // ุชุญุฏูุซ ุงููุงุฌูุงุช
                loadProductsTable();
                loadCategoriesView();
                displayChartOfAccounts();
                updateBalance();
                
                alert('โ ุชู ุญูุธ ุงูููุชุฌ ุจูุฌุงุญ!');
                
            } catch (error) {
                console.error('โ ูุดู ุญูุธ ุงูููุชุฌ:', error);
                alert('โ ูุดู ุญูุธ ุงูููุชุฌ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        }
        /**
        * ุชุณุฌูู ููุฏ ุฅุถุงูุฉ ูุฏููุฉ ูุฑุฃุณ ูุงู (ุญู ูุคูุช)
        */
        async function recordManualInventoryAsCapital(product, inventoryValue, productId) {
            try {
                const description = `ุฅุถุงูุฉ ููุชุฌ ูุฏูู - ${product.name} (${product.code})`;
                
                const debits = [{
                    accountCode: '1030', // ุงููุฎุฒูู
                    amount: inventoryValue,
                    description: `ูุฎุฒูู ูุถุงู ูุฏููุงู: ${product.name}`
                }];
                
                const credits = [{
                    accountCode: '2020', // ุฑุฃุณ ุงููุงู
                    amount: inventoryValue,
                    description: 'ุชูููู ูุฎุฒูู ูุฏูู (ุญู ูุคูุช)'
                }];
                
                await createJournalEntry(
                    description,
                    debits,
                    credits,
                    'ManualInventory_Capital',
                    productId
                );
                
                console.log(`โ ุชู ุชุณุฌูู ุงูููุฏ ุงููุคูุช: ${inventoryValue.toFixed(2)} ุฑ.ู ูุฑุฃุณ ุงููุงู`);
                
            } catch (error) {
                console.error('โ ูุดู ุชุณุฌูู ุงูููุฏ ุงููุคูุช:', error);
            }
        }
        /**
        * ูุนุงูุฌุฉ ุชุญุฏูุซ ูููุงุช ุงููุฎุฒูู ุงูุญุงููุฉ
        */
        async function handleInventoryUpdate(updatedProduct, newValue, productId) {
            try {
                // ุฌูุจ ุงูููุชุฌ ุงููุฏูู ููููุงุฑูุฉ
                const oldProduct = await getProductById(productId);
                const oldValue = oldProduct.purchasePrice * oldProduct.quantity;
                const valueDifference = newValue - oldValue;
                
                // ุฅุฐุง ูุงู ููุงู ูุฑู ูู ุงููููุฉุ ุชุณุฌูู ููุฏ ุชุนุฏูู
                if (Math.abs(valueDifference) > 0.01) {
                    await recordInventoryAdjustmentJournalEntry(
                        oldProduct, 
                        updatedProduct, 
                        valueDifference, 
                        productId
                    );
                }
            } catch (error) {
                console.error('ูุดู ูุนุงูุฌุฉ ุชุญุฏูุซ ุงููุฎุฒูู:', error);
            }
        }

        /**
        * ุชุณุฌูู ููุฏ ุชุนุฏูู ุงููุฎุฒูู
        */
        async function recordInventoryAdjustmentJournalEntry(oldProduct, newProduct, valueDifference, productId) {
            try {
                const description = `ุชุนุฏูู ูุฎุฒูู - ${newProduct.name} (${newProduct.code})`;
                
                if (valueDifference > 0) {
                    // ุฒูุงุฏุฉ ูู ุงููุฎุฒูู
                    const debits = [{
                        accountCode: '1030',
                        amount: valueDifference,
                        description: `ุฒูุงุฏุฉ ูุฎุฒูู: ${newProduct.name}`
                    }];
                    
                    const credits = [{
                        accountCode: '2020',
                        amount: valueDifference,
                        description: 'ุชูููู ุฒูุงุฏุฉ ูุฎุฒูู'
                    }];
                    
                    await createJournalEntry(description, debits, credits, 'InventoryAdjustment', productId);
                } else {
                    // ููุตุงู ูู ุงููุฎุฒูู
                    const debits = [{
                        accountCode: '2020',
                        amount: Math.abs(valueDifference),
                        description: 'ุชุนุฏูู ุฑุฃุณ ุงููุงู ูููุตุงู ุงููุฎุฒูู'
                    }];
                    
                    const credits = [{
                        accountCode: '1030',
                        amount: Math.abs(valueDifference),
                        description: `ููุตุงู ูุฎุฒูู: ${newProduct.name}`
                    }];
                    
                    await createJournalEntry(description, debits, credits, 'InventoryAdjustment', productId);
                }
                
                console.log(`โ ุชู ุชุณุฌูู ููุฏ ุชุนุฏูู ุงููุฎุฒูู: ${valueDifference.toFixed(2)} ุฑ.ู`);
                
            } catch (error) {
                console.error('โ ูุดู ุชุณุฌูู ููุฏ ุชุนุฏูู ุงููุฎุฒูู:', error);
            }
        }        
        /**
         * ุญุฐู ููุชุฌ
         */
        async function deleteProductHandler(productId) {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูููุชุฌุ')) {
                try {
                    await deleteProduct(parseInt(productId));
                    loadProductsTable();
                    loadProductsForPOS();
                    alert('ุชู ุญุฐู ุงูููุชุฌ ุจูุฌุงุญ!');
                } catch (error) {
                    console.error('ูุดู ุญุฐู ุงูููุชุฌ:', error);
                    alert('ูุดู ุญุฐู ุงูููุชุฌ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
                }
            }
        }

        /**
         * ุงุณุชูุฑุงุฏ ุงูููุชุฌุงุช ูู ููู Excel
         */
        function importProductsFromExcel(file) {
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        alert('ูุง ุชูุฌุฏ ุจูุงูุงุช ูู ุงูููู ุงููุญุฏุฏ.');
                        return;
                    }
                    
                    // ุงูุชุญูู ูู ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ
                    const requiredColumns = ['ููุฏ', 'ุงุณู', 'ุณุนุฑ ุงูุดุฑุงุก', 'ุณุนุฑ ุงูุจูุน', 'ุงููููุฉ'];
                    const firstRow = jsonData[0];
                    const missingColumns = requiredColumns.filter(col => !Object.keys(firstRow).includes(col));
                    
                    if (missingColumns.length > 0) {
                        alert(`ุงูููู ูุง ูุญุชูู ุนูู ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ: ${missingColumns.join(', ')}`);
                        return;
                    }
                    
                    // ุชุญููู ุงูุจูุงูุงุช ูุญุณุงุจ ุงููููุฉ ุงูุฅุฌูุงููุฉ
                    let totalInventoryValue = 0;
                    const products = jsonData.map(row => {
                        const purchasePrice = parseFloat(row['ุณุนุฑ ุงูุดุฑุงุก']) || 0;
                        const quantity = parseInt(row['ุงููููุฉ']) || 0;
                        const productValue = purchasePrice * quantity;
                        totalInventoryValue += productValue;
                        
                        return {
                            code: row['ููุฏ'],
                            name: row['ุงุณู'],
                            purchasePrice: purchasePrice,
                            salePrice: parseFloat(row['ุณุนุฑ ุงูุจูุน']) || 0,
                            quantity: quantity,
                            minQuantity: parseInt(row['ุงูุญุฏ ุงูุฃุฏูู']) || 5,
                            expiryDate: row['ุชุงุฑูุฎ ุงูุงูุชูุงุก'] || null,
                            categoryId: null,
                            image: row['ุฑูุฒ ุงูููุชุฌ'] || '๐ฆ',
                            importValue: productValue // ุญูุธ ูููุฉ ุงูุงุณุชูุฑุงุฏ ููู ููุชุฌ
                        };
                    });
                    
                    console.log('๐งฎ ุงููููุฉ ุงูุฅุฌูุงููุฉ ูููุฎุฒูู ุงููุณุชูุฑุฏ:', totalInventoryValue.toFixed(2));
                    
                    if (totalInventoryValue <= 0) {
                        alert('ุงููููุฉ ุงูุฅุฌูุงููุฉ ูููุฎุฒูู ูุฌุจ ุฃู ุชููู ุฃูุจุฑ ูู ุงูุตูุฑ');
                        return;
                    }
                    
                    // ุจุฏุก ุงููุนุงููุฉ ุงููุญุงุณุจูุฉ
                    const transaction = db.transaction([
                        'products', 
                        'journalEntries', 
                        'chartOfAccounts'
                    ], 'readwrite');
                    
                    const productsStore = transaction.objectStore('products');
                    const journalStore = transaction.objectStore('journalEntries');
                    const coaStore = transaction.objectStore('chartOfAccounts');
                    
                    // 1. ุญูุธ ุงูููุชุฌุงุช
                    let importedCount = 0;
                    for (const product of products) {
                        try {
                            await productsStore.add(product);
                            importedCount++;
                        } catch (error) {
                            console.error('ูุดู ุญูุธ ุงูููุชุฌ:', product.code, error);
                        }
                    }
                    
                    // 2. ุชุณุฌูู ุงูููุฏ ุงููุญุงุณุจู
                    const journalEntry = {
                        date: new Date().toISOString(),
                        description: `ุงุณุชูุฑุงุฏ ูุฎุฒูู ุฃููู - ${importedCount} ููุชุฌ`,
                        debits: [{
                            accountCode: '1030',
                            amount: totalInventoryValue,
                            description: 'ูุฎุฒูู ูุณุชูุฑุฏ ูู ููู Excel'
                        }],
                        credits: [{
                            accountCode: '2020',
                            amount: totalInventoryValue,
                            description: 'ุชูููู ูุฎุฒูู ุฃููู'
                        }],
                        refType: 'InventoryImport',
                        refId: `IMPORT-${Date.now()}`,
                        balanced: true,
                        totalAmount: totalInventoryValue,
                        importedProducts: importedCount,
                        totalValue: totalInventoryValue,
                        createdAt: new Date().toISOString()
                    };
                    
                    await journalStore.add(journalEntry);
                    
                    // 3. ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช
                    // ุชุญุฏูุซ ุญุณุงุจ ุงููุฎุฒูู (1030)
                    const inventoryAccountRequest = coaStore.get('1030');
                    inventoryAccountRequest.onsuccess = function() {
                        const inventoryAccount = inventoryAccountRequest.result;
                        if (inventoryAccount) {
                            inventoryAccount.balance = (inventoryAccount.balance || 0) + totalInventoryValue;
                            coaStore.put(inventoryAccount);
                        }
                    };
                    
                    // ุชุญุฏูุซ ุญุณุงุจ ุฑุฃุณ ุงููุงู (2020)
                    const capitalAccountRequest = coaStore.get('2020');
                    capitalAccountRequest.onsuccess = function() {
                        const capitalAccount = capitalAccountRequest.result;
                        if (capitalAccount) {
                            capitalAccount.balance = (capitalAccount.balance || 0) + totalInventoryValue;
                            coaStore.put(capitalAccount);
                        }
                    };
                    
                    transaction.oncomplete = async () => {
                        // ุชุญุฏูุซ ุงููุงุฌูุงุช
                        loadProductsTable();
                        loadProductsForPOS();
                        displayChartOfAccounts();
                        updateBalance();
                        
                        // ุนุฑุถ ุชูุฑูุฑ ุงููุชูุฌุฉ
                        alert(`โ ุชู ุงูุงุณุชูุฑุงุฏ ุจูุฌุงุญ!

        โข ุนุฏุฏ ุงูููุชุฌุงุช: ${importedCount} ููุชุฌ
        โข ุงููููุฉ ุงูุฅุฌูุงููุฉ: ${totalInventoryValue.toFixed(2)} ุฑ.ู
        โข ุชู ุชุณุฌูู ุงูููุฏ ุงููุญุงุณุจู ุชููุงุฆูุงู

        ููููู ูุฑุงุฌุนุฉ ุงูููุฏ ูู ุชุจููุจ ุงููุญุงุณุจุฉ.`);
                    };
                    
                } catch (error) {
                    console.error('โ ูุดู ุนูููุฉ ุงูุงุณุชูุฑุงุฏ:', error);
                    alert('ูุดู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช. ูุฑุฌู ุงูุชุฃูุฏ ูู ุตุญุฉ ุงูููู.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        /**
        * ุชุณุฌูู ููุฏ ุงุณุชูุฑุงุฏ ุงููุฎุฒูู ูู ุงููุธุงู ุงููุญุงุณุจู
        */
        async function recordInventoryImportJournalEntry(products, totalValue) {
            try {
                const description = `ุงุณุชูุฑุงุฏ ูุฎุฒูู ุฃููู - ${products.length} ููุชุฌ`;
                
                const debits = [{
                    accountCode: '1030', // ุงููุฎุฒูู
                    amount: totalValue,
                    description: 'ุฒูุงุฏุฉ ุงููุฎุฒูู ูู ุงูุงุณุชูุฑุงุฏ'
                }];
                
                const credits = [{
                    accountCode: '2020', // ุฑุฃุณ ุงููุงู
                    amount: totalValue,
                    description: 'ุชูููู ุงููุฎุฒูู ุงููุณุชูุฑุฏ'
                }];
                
                // ุชุณุฌูู ุงูููุฏ ูู ุงูููููุฉ
                await createJournalEntry(
                    description,
                    debits,
                    credits,
                    'InventoryImport',
                    null
                );
                
                console.log(`โ ุชู ุชุณุฌูู ููุฏ ุงุณุชูุฑุงุฏ ุงููุฎุฒูู ุจูููุฉ: ${totalValue.toFixed(2)} ุฑ.ู`);
                
            } catch (error) {
                console.error('โ ูุดู ุชุณุฌูู ููุฏ ุงูุงุณุชูุฑุงุฏ:', error);
                throw error;
            }
        }        

        /**
        * ุชุญุฏูุซ ูููุฉ ุงููุฎุฒูู ูู ุดุฌุฑุฉ ุงูุญุณุงุจุงุช
        */
        async function updateInventoryAccount() {
            try {
                const products = await getAllProducts();
                
                // ุญุณุงุจ ุงููููุฉ ุงูุฅุฌูุงููุฉ ูููุฎุฒูู
                const totalInventoryValue = products.reduce((total, product) => {
                    return total + (product.purchasePrice * product.quantity);
                }, 0);

                // ุชุญุฏูุซ ุญุณุงุจ ุงููุฎุฒูู (1030) ูู ุดุฌุฑุฉ ุงูุญุณุงุจุงุช
                const transaction = db.transaction(['chartOfAccounts'], 'readwrite');
                const store = transaction.objectStore('chartOfAccounts');
                
                const inventoryAccount = await new Promise((resolve) => {
                    const request = store.get('1030'); // ููุฏ ุญุณุงุจ ุงููุฎุฒูู
                    request.onsuccess = () => resolve(request.result);
                });

                if (inventoryAccount) {
                    inventoryAccount.balance = totalInventoryValue;
                    await store.put(inventoryAccount);
                    console.log('โ ุชู ุชุญุฏูุซ ูููุฉ ุงููุฎุฒูู:', totalInventoryValue.toFixed(2), 'ุฑ.ู');
                }

            } catch (error) {
                console.error('โ ูุดู ุชุญุฏูุซ ุญุณุงุจ ุงููุฎุฒูู:', error);
            }
        }

        /**
         * ุชุตุฏูุฑ ุงูููุชุฌุงุช ุฅูู ููู Excel
         */
        async function exportProductsToExcel() {
            try {
                const products = await getAllProducts();
                
                if (products.length === 0) {
                    alert('ูุง ุชูุฌุฏ ููุชุฌุงุช ูุชุตุฏูุฑูุง.');
                    return;
                }
                
                // ุชุญููู ุงูุจูุงูุงุช ุฅูู ุชูุณูู Excel
                const exportData = products.map(product => ({
                    'ููุฏ': product.code,
                    'ุงุณู': product.name,
                    'ุณุนุฑ ุงูุดุฑุงุก': product.purchasePrice,
                    'ุณุนุฑ ุงูุจูุน': product.salePrice,
                    'ุงููููุฉ': product.quantity,
                    'ุงูุญุฏ ุงูุฃุฏูู': product.minQuantity || 5,
                    'ุชุงุฑูุฎ ุงูุงูุชูุงุก': product.expiryDate || '',
                    'ุงููุฆุฉ': product.categoryId ? (categories.find(c => c.id === product.categoryId)?.name || '') : '',
                    'ุฑูุฒ ุงูููุชุฌ': product.image || '๐ฆ'
                }));
                
                // ุฅูุดุงุก ูุฑูุฉ ุนูู
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'ุงูููุชุฌุงุช');
                
                // ุชูุฒูู ุงูููู
                XLSX.writeFile(workbook, 'ููุชุฌุงุช_ุงููุฎุฒูู.xlsx');
            } catch (error) {
                console.error('ูุดู ุชุตุฏูุฑ ุงูููุชุฌุงุช:', error);
                alert('ูุดู ุชุตุฏูุฑ ุงูููุชุฌุงุช. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        }
        // ==================== 4.4. POS Logic ====================
        /**
        * ุชุญููู ูุนุฑุถ ุงููุฆุงุช ูู ูุงุฌูุฉ ููุทุฉ ุงูุจูุน
        */
        async function loadCategoriesView() {
            try {
                const [categories, products] = await Promise.all([
                    loadCategories(),
                    getAllProducts()
                ]);
                
                const categoriesGrid = document.getElementById('categoriesGrid');
                if (!categoriesGrid) return;
                
                categoriesGrid.innerHTML = '';
                
                if (categories.length === 0) {
                    categoriesGrid.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <i class="bi bi-info-circle"></i>
                                ูุง ุชูุฌุฏ ูุฆุงุช ูุณุฌูุฉ. ูุฑุฌู ุฅุถุงูุฉ ูุฆุงุช ูู ุชุจููุจ ุงููุฎุฒูู.
                            </div>
                        </div>
                    `;
                    return;
                }

                // ุฅุถุงูุฉ ูุฆุฉ "ุงููู" ูุน ุงูุนุฏุงุฏ ุงูุตุญูุญ
                const allProductsCount = products.length;
                const allCategoryCard = document.createElement('div');
                allCategoryCard.className = 'col-6 col-md-4 col-lg-3 mb-3';
                allCategoryCard.innerHTML = `
                    <div class="category-card" data-category-id="all">
                        <div class="category-icon">๐ฆ</div>
                        <div class="category-name">ุฌููุน ุงูููุชุฌุงุช</div>
                        <div class="category-count">${allProductsCount} ููุชุฌ</div>
                    </div>
                `;
                allCategoryCard.addEventListener('click', () => showProductsView('all', 'ุฌููุน ุงูููุชุฌุงุช'));
                categoriesGrid.appendChild(allCategoryCard);
                
                // ุฅุถุงูุฉ ุงููุฆุงุช ูุน ุนุฏุฏ ุงูููุชุฌุงุช ุงููุญุฏุซ
                categories.forEach(category => {
                    const categoryProductsCount = products.filter(p => p.categoryId === category.id).length;
                    
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'col-6 col-md-4 col-lg-3 mb-3';
                    categoryCard.innerHTML = `
                        <div class="category-card" data-category-id="${category.id}">
                            <div class="category-icon">${category.icon || 'โญ'}</div>
                            <div class="category-name">${category.name}</div>
                            <div class="category-count">${categoryProductsCount} ููุชุฌ</div>
                        </div>
                    `;
                    categoryCard.addEventListener('click', () => showProductsView(category.id, category.name));
                    categoriesGrid.appendChild(categoryCard);
                });
                
            } catch (error) {
                console.error('ูุดู ุชุญููู ุนุฑุถ ุงููุฆุงุช:', error);
                const categoriesGrid = document.getElementById('categoriesGrid');
                if (categoriesGrid) {
                    categoriesGrid.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger text-center">
                                ูุดู ูู ุชุญููู ุงููุฆุงุช
                            </div>
                        </div>
                    `;
                }
            }
        }

        /**
        * ุงูุงูุชูุงู ุฅูู ุนุฑุถ ุงูููุชุฌุงุช ููุฆุฉ ูุญุฏุฏุฉ
        */
        async function showProductsView(categoryId, categoryName) {
            try {
                currentView = 'products';
                currentCategoryId = categoryId;
                currentCategoryName = categoryName;
                
                // ุชุญุฏูุซ ุงููุงุฌูุฉ
                document.getElementById('categoriesView').style.display = 'none';
                document.getElementById('productsView').style.display = 'block';
                document.getElementById('currentCategoryTitle').textContent = categoryName;
                
                // ุชุญููู ุงูููุชุฌุงุช ุงูุฎุงุตุฉ ุจูุฐู ุงููุฆุฉ
                await loadProductsForCategory(categoryId);
                
            } catch (error) {
                console.error('ูุดู ุงูุงูุชูุงู ุฅูู ุนุฑุถ ุงูููุชุฌุงุช:', error);
                alert('ูุดู ุชุญููู ุงูููุชุฌุงุช. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        }

        /**
        * ุงูุนูุฏุฉ ุฅูู ุนุฑุถ ุงููุฆุงุช
        */
        function showCategoriesView() {
            currentView = 'categories';
            currentCategoryId = null;
            currentCategoryName = '';
            
            // ุชุญุฏูุซ ุงููุงุฌูุฉ
            document.getElementById('categoriesView').style.display = 'block';
            document.getElementById('productsView').style.display = 'none';
            
            // ุฅุนุงุฏุฉ ุชุนููู ุงูุจุญุซ
            const searchInput = document.getElementById('productSearchInput');
            if (searchInput) {
                searchInput.value = '';
                searchInput.placeholder = '๐ ุจุญุซ ููุฑู ุนู ุงูููุชุฌ (ุงูุงุณู ุฃู ุงูููุฏ)...';
            }
        }

        /**
        * ุชุญููู ุงูููุชุฌุงุช ููุฆุฉ ูุญุฏุฏุฉ
        */
        async function loadProductsForCategory(categoryId) {
            try {
                const products = await getAllProducts();
                const productsGrid = document.getElementById('productsGrid');
                const productsCount = document.getElementById('productsCount');
                
                if (!productsGrid || !productsCount) return;
                
                productsGrid.innerHTML = '';
                
                // ุชุตููุฉ ุงูููุชุฌุงุช ุญุณุจ ุงููุฆุฉ
                let filteredProducts = products;
                if (categoryId !== 'all') {
                    filteredProducts = products.filter(product => product.categoryId == categoryId);
                }
                
                // ุชุญุฏูุซ ุนุฏุฏ ุงูููุชุฌุงุช
                productsCount.textContent = `${filteredProducts.length} ููุชุฌ`;
                
                if (filteredProducts.length === 0) {
                    productsGrid.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <i class="bi bi-info-circle"></i>
                                ูุง ุชูุฌุฏ ููุชุฌุงุช ูู ูุฐู ุงููุฆุฉ.
                            </div>
                        </div>
                    `;
                    return;
                }

                // ุนุฑุถ ุงูููุชุฌุงุช ูุน ุชูุณูู ูุญุณู ููุตูุฑ
                filteredProducts.forEach(product => {
                    const cartItem = currentCart.find(item => item.id === product.id);
                    const quantityInCart = cartItem ? cartItem.quantity : 0;
                    
                    // ุงุณุชุฎุฏุงู ุงูุตูุฑุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉุ ูุฅูุง ุงุณุชุฎุฏุงู ุงูุฅูููุฌู
                    let imageContent = '';
                    if (product.imageData) {
                        imageContent = `
                            <div class="product-image-container">
                                <img src="${product.imageData}" alt="${product.name}" 
                                    class="product-image-real" 
                                    onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\\'product-emoji-placeholder\\'>${product.image || '๐ฆ'}</div>';">
                            </div>
                        `;
                    } else {
                        imageContent = `
                            <div class="product-image-container">
                                <div class="product-emoji-placeholder">
                                    ${product.image || '๐ฆ'}
                                </div>
                            </div>
                        `;
                    }
                    
                    const productElement = document.createElement('div');
                    productElement.className = 'col-6 col-md-4 col-lg-3 mb-3';
                    productElement.innerHTML = `
                        <div class="product-card ${quantityInCart > 0 ? 'added' : ''}" 
                            data-product-id="${product.id}" 
                            data-product-price="${product.salePrice}" 
                            data-product-cost="${product.purchasePrice}">
                            
                            ${quantityInCart > 0 ? `<div class="quantity-badge">${quantityInCart}</div>` : ''}
                            
                            ${imageContent}
                            
                            <div class="product-info">
                                <div>
                                    <div class="product-name">${product.name}</div>
                                    <div class="product-code">${product.code}</div>
                                </div>
                                
                                <div class="product-details">
                                    <span class="product-price">${product.salePrice.toFixed(2)} ุฑ.ู</span>
                                    <span class="product-stock badge ${product.quantity > (product.minQuantity || 5) ? 'bg-success' : 'bg-danger'}">
                                        ${product.quantity}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // ุฅุถุงูุฉ ุญุฏุซ ุงูููุฑ ูุฅุถุงูุฉ ุงูููุชุฌ ููุณูุฉ
                    productElement.addEventListener('click', () => {
                        addToCart(product.id, product.name, product.salePrice, product.purchasePrice);
                    });
                    
                    productsGrid.appendChild(productElement);
                });
                
            } catch(error) {
                console.error('ูุดู ุชุญููู ููุชุฌุงุช ุงููุฆุฉ:', error);
                const productsGrid = document.getElementById('productsGrid');
                if (productsGrid) {
                    productsGrid.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger text-center">
                                <i class="bi bi-exclamation-triangle"></i>
                                ูุดู ูู ุชุญููู ุงูููุชุฌุงุช.
                            </div>
                        </div>
                    `;
                }
            }
        }
        /**
        * ุชููุฆุฉ ูุญุฏุฉ ููุทุฉ ุงูุจูุน ุจุงููุธุงู ุงูุฌุฏูุฏ
        */
        function initializePOSModule() {
            loadCategoriesView();
            loadQuickSuggestions();
            updateCartDisplay();
            updateCartCount();
            updateFloatingCart();
            loadCustomersForPOS();
            
            // ุฅุนุงุฏุฉ ุชุนููู ุญุงูุฉ ุงูุนุฑุถ
            currentView = 'categories';
            currentCategoryId = null;
            document.getElementById('categoriesView').style.display = 'block';
            document.getElementById('productsView').style.display = 'none';
            
            // ุชุญุฏูุซ ุงูุจุญุซ ุงูููุฑู
            setupInstantSearch();
        }

        /**
        * ุฅุนุฏุงุฏ ุงูุจุญุซ ุงูููุฑู
        */
        function setupInstantSearch() {
            const searchInput = document.getElementById('productSearchInput');
            const resultsContainer = document.getElementById('posSearchResults');
            
            if (!searchInput || !resultsContainer) return;
            
            let searchTimeout;
            
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                
                if (query.length < 1) {
                    resultsContainer.style.display = 'none';
                    resultsContainer.innerHTML = '';
                    return;
                }
                
                searchTimeout = setTimeout(async () => {
                    const results = await performInstantSearch(query);
                    renderSearchResults(results, resultsContainer);
                }, 300);
            });
            
            // ุฅุฎูุงุก ุงููุชุงุฆุฌ ุนูุฏ ููุฏุงู ุงูุชุฑููุฒ
            searchInput.addEventListener('blur', function() {
                setTimeout(() => {
                    resultsContainer.style.display = 'none';
                }, 200);
            });
            
            // ุฅุธูุงุฑ ุงููุชุงุฆุฌ ุนูุฏ ุงูุชุฑููุฒ ุฅุฐุง ูุงู ููุงู ูุต
            searchInput.addEventListener('focus', function() {
                const query = this.value.trim();
                if (query.length > 0) {
                    performInstantSearch(query).then(results => {
                        renderSearchResults(results, resultsContainer);
                    });
                }
            });
        }
        /**
        * ุนุฑุถ ูุชุงุฆุฌ ุงูุจุญุซ
        */
        function renderSearchResults(results, container) {
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="p-3 text-center text-muted">
                        ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุทุงุจูุฉ
                    </div>
                `;
                container.style.display = 'block';
                return;
            }
            
            results.forEach(product => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item p-3 border-bottom';
                resultItem.style.cursor = 'pointer';
                
                resultItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="fw-bold">${product.name}</div>
                            <div class="text-muted small">ููุฏ: ${product.code}</div>
                            <div class="text-success fw-bold mt-1">${product.salePrice.toFixed(2)} ุฑ.ู</div>
                        </div>
                        <div class="text-end">
                            <span class="badge ${product.quantity > 0 ? 'bg-success' : 'bg-danger'}">
                                ${product.quantity} ูุชููุฑ
                            </span>
                        </div>
                    </div>
                `;
                
                resultItem.addEventListener('click', () => {
                    addToCart(product.id, product.name, product.salePrice, product.purchasePrice);
                    container.style.display = 'none';
                    document.getElementById('productSearchInput').value = '';
                });
                
                container.appendChild(resultItem);
            });
            
            container.style.display = 'block';
        }

        /**
        * ุชุญููู ูุนุฑุถ ุงูููุชุฌุงุช ูู ูุงุฌูุฉ ููุทุฉ ุงูุจูุน - ุงูุฅุตุฏุงุฑ ุงููุญุณูู
        */
        async function loadProductsForPOS() {
            // ููุญูุงุธ ุนูู ุงูุชูุงูู ูุน ุงูุฃุฌุฒุงุก ุงูุฃุฎุฑู ูู ุงููุธุงู
            return loadCategoriesView();
        }
        
        /**
        * ุงูุจุญุซ ุงูููุฑู ุงููุญุณู - ุจุฏูู ุจุงุฑููุฏ
        */
        async function performInstantSearch(searchTerm) {
            try {
                const products = await getAllProducts();
                const cleanSearch = searchTerm.toLowerCase().trim();
                
                if (cleanSearch.length < 1) return [];
                
                return products.filter(product => 
                    product.name.toLowerCase().includes(cleanSearch) ||
                    product.code.toLowerCase().includes(cleanSearch) ||
                    this.simpleArabicMatch(product.name, cleanSearch)
                ).slice(0, 8); // ุฃูู 8 ูุชุงุฆุฌ ููุท
                
            } catch (error) {
                console.error('ูุดู ุงูุจุญุซ ุงูููุฑู:', error);
                return [];
            }
        }

        /**
        * ูุทุงุจูุฉ ุนุฑุจูุฉ ูุจุณุทุฉ
        */
        function simpleArabicMatch(text, search) {
            const cleanText = text
                .replace(/[ุฃุฅุข]/g, 'ุง')
                .replace(/[ุฉ]/g, 'ู')
                .replace(/[ูู]/g, 'ู')
                .toLowerCase();
            
            const cleanSearch = search
                .replace(/[ุฃุฅุข]/g, 'ุง')
                .replace(/[ุฉ]/g, 'ู')
                .replace(/[ูู]/g, 'ู')
                .toLowerCase();
            
            return cleanText.includes(cleanSearch);
        }

        /**
        * ุชุญููู ุงูุนููุงุก ูู ูุงุฌูุฉ ุงูุจูุน
        */
        async function loadCustomersForPOS() {
            try {
                const customers = await loadCustomers();
                const select = document.getElementById('customerSelect');
                
                if (!select) return;
                
                select.innerHTML = '<option value="">ุนููู ููุฏู</option>';
                
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.name} ${customer.phone ? `(${customer.phone})` : ''}`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('ูุดู ุชุญููู ุงูุนููุงุก:', error);
            }
        }

        // ุงูุฏูุงู ุงูููููุฏุฉ ุงูุชู ุชุณุจุจ ุฃุฎุทุงุก
        async function getProductById(productId) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['products'], 'readonly');
                const store = transaction.objectStore('products');
                const request = store.get(parseInt(productId));
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function updateProduct(product) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['products'], 'readwrite');
                const store = transaction.objectStore('products');
                const request = store.put(product);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        // ุฅุตูุงุญ ุฏุงูุฉ updateSalesHistory
        function updateSalesHistory(productId) {
            // ูููู ุชูููุฐ ูุฐู ุงูุฏุงูุฉ ูุงุญูุงู ุฃู ุฅุฒุงูุฉ ุงุณุชุฏุนุงุฆูุง
            console.log('Update sales history for product:', productId);
        }

        /**
        * ุฅุถุงูุฉ ุงูููุชุฌ ุฅูู ุงูุณูุฉ ูุน ุงูุชุญูู ูู ุงููุฎุฒูู
        */
        async function addToCart(productId, name, price, cost) {
            try {
                // ุงูุชุญูู ูู ุชููุฑ ุงูููุชุฌ ูุงููููุฉ
                const product = await getProductById(productId);
                if (!product) {
                    throw new Error('ุงูููุชุฌ ุบูุฑ ููุฌูุฏ ูู ุงููุฎุฒูู');
                }
                
                const existingItem = currentCart.find(item => item.id === productId);
                const requestedQuantity = (existingItem?.quantity || 0) + 1;
                
                if (product.quantity < requestedQuantity) {
                    throw new Error(`ุงููููุฉ ุบูุฑ ูุชุงุญุฉ! ุงููุชุงุญ: ${product.quantity}ุ ุงููุทููุจ: ${requestedQuantity}`);
                }
                
                if (product.quantity <= (product.minQuantity || 5)) {
                    console.warn(`โ๏ธ ุชูุจูู: ุงูููุชุฌ "${product.name}" ูุงุฑุจ ุนูู ุงูููุงุฏ. ุงููุชุงุญ: ${product.quantity}`);
                }

                // ูุชุงุจุนุฉ ุงูุฅุถุงูุฉ ููุณูุฉ
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    currentCart.push({ 
                        id: productId, 
                        name: name, 
                        price: price, 
                        purchasePrice: cost || price, 
                        quantity: 1 
                    });
                }
                
                updateCartDisplay();
                updateCartCount();
                updateFloatingCart();
                
                // ุชุญุฏูุซ ุนุฑุถ ุงูููุชุฌุงุช ุฅุฐุง ููุง ูู ุนุฑุถ ุงูููุชุฌุงุช
                if (currentView === 'products' && currentCategoryId) {
                    loadProductsForCategory(currentCategoryId);
                }
                
                updateSalesHistory(productId);
                showNotification(name);
                
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูููุชุฌ ููุณูุฉ:', error);
                alert(`โ ${error.message}`);
            }
        }
        /**
        * ุนุฑุถ ุฅุดุนุงุฑ ูุคูุช ุนูุฏ ุฅุถุงูุฉ ููุชุฌ
        */
        function showNotification(productName) {
            // ุฅูุดุงุก ุนูุตุฑ ุงูุฅุดุนุงุฑ ุฅุฐุง ูู ููู ููุฌูุฏุงู
            let notification = document.getElementById('temporaryNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'temporaryNotification';
                notification.className = 'toast-notification';
                document.body.appendChild(notification);
            }
            
            notification.innerHTML = `ุชู ุฅุถุงูุฉ <strong>${productName}</strong> ุฅูู ุงูุณูุฉ`;
            notification.style.display = 'block';
            
            // ุฅุฎูุงุก ุชููุงุฆู ุจุนุฏ 3 ุซูุงูู
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        /**
        * ุงูุชุญูู ูู ูุฌูุฏ ุฑูู ูุงุชูุฑุฉ ูุณุจูุงู
        */
        function checkInvoiceNumberExists(invoiceNumber) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['invoices'], 'readonly');
                const store = transaction.objectStore('invoices');
                const index = store.index('invoiceNumber');
                const request = index.get(invoiceNumber);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * ุชุญุฏูุซ ุนุฑุถ ุงูุณูุฉ ูู ุงูุฏุฑุฌ ุงูุฌุงูุจู
         */
        function updateCartDisplay() {
            const list = document.getElementById('cartItemsList');
            const totalDisplay = document.getElementById('cartTotal');
            const cartCounter = document.getElementById('cartCounter');
            const subtotalDisplay = document.getElementById('cartSubtotal');
            const taxDisplay = document.getElementById('cartTax');
            
            if (!list || !totalDisplay) return;
            
            let subtotal = 0;
            list.innerHTML = '';

            if (currentCart.length === 0) {
                list.innerHTML = '<p class="text-center text-muted mt-5">ุงูุณูุฉ ูุงุฑุบุฉ ุญุงููุงู.</p>';
                if (cartCounter) {
                    cartCounter.textContent = '0';
                    cartCounter.style.display = 'none';
                }
                
                // ุฅุนุงุฏุฉ ุชุนููู ุงูุฅุฌูุงููุงุช
                if (subtotalDisplay) subtotalDisplay.textContent = '0.00 ุฑ.ู';
                if (taxDisplay) taxDisplay.textContent = '0.00 ุฑ.ู';
                if (totalDisplay) totalDisplay.textContent = '0.00 ุฑ.ู';
                
            } else {
                currentCart.forEach((item, index) => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    
                    const itemElement = document.createElement('div');
                    itemElement.className = 'd-flex justify-content-between align-items-center border-bottom py-2';
                    itemElement.innerHTML = `
                        <div class="flex-grow-1">
                            <div class="fw-bold">${item.name}</div>
                            <small class="text-muted">${item.quantity} x ${item.price.toFixed(2)} ุฑ.ู</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="fw-bold text-primary me-2">${itemTotal.toFixed(2)} ุฑ.ู</span>
                            <button class="btn btn-sm btn-outline-danger remove-item-btn" data-index="${index}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(itemElement);
                });
                
                if (cartCounter) {
                    const totalItems = currentCart.reduce((sum, item) => sum + item.quantity, 0);
                    cartCounter.textContent = totalItems.toString();
                    cartCounter.style.display = totalItems > 0 ? 'flex' : 'none';
                }
                
                // ุญุณุงุจ ุงูุถุฑูุจุฉ ูุงูุฅุฌูุงูู (ุจุฏูู ุฎุตู)
                const taxRate = parseFloat(document.getElementById('taxRateInput').value) || 0;
                const taxAmount = subtotal * (taxRate / 100);
                const total = subtotal + taxAmount;
                
                // ุชุญุฏูุซ ุฌููุน ุนูุงุตุฑ ุงูุนุฑุถ
                if (subtotalDisplay) subtotalDisplay.textContent = `${subtotal.toFixed(2)} ุฑ.ู`;
                if (taxDisplay) taxDisplay.textContent = `${taxAmount.toFixed(2)} ุฑ.ู`;
                if (totalDisplay) totalDisplay.textContent = `${total.toFixed(2)} ุฑ.ู`;
            }
            
            // ุชุญุฏูุซ ุงูุณูุฉ ุงูุนุงุฆูุฉ
            updateFloatingCart();
        }

        /**
         * ุชุญุฏูุซ ุนุฏุงุฏ ุงูุณูุฉ (ุนูู ุฒุฑ FAB)
         */
        function updateCartCount() {
            const totalItems = currentCart.reduce((sum, item) => sum + item.quantity, 0);
            const cartCounter = document.getElementById('cartCounter');
            if (cartCounter) {
                cartCounter.textContent = totalItems.toString();
                cartCounter.style.display = totalItems > 0 ? 'flex' : 'none';
            }
            
            // ุชุญุฏูุซ ุงูุนูุงูุงุช ุนูู ุจุทุงูุงุช ุงูููุชุฌุงุช
            updateProductBadges();
        }

        function updateProductBadges() {
            document.querySelectorAll('.product-card').forEach(card => {
                const productId = parseInt(card.dataset.productId);
                const cartItem = currentCart.find(item => item.id === productId);
                const quantityInCart = cartItem ? cartItem.quantity : 0;
                
                // ุฅุฒุงูุฉ ุงูุนูุงูุงุช ุงููุฏููุฉ
                const existingBadge = card.querySelector('.quantity-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
                
                // ุฅุถุงูุฉ ุนูุงูุฉ ุฌุฏูุฏุฉ ุฅุฐุง ูุงูุช ุงููููุฉ ุฃูุจุฑ ูู 0
                if (quantityInCart > 0) {
                    const badge = document.createElement('div');
                    badge.className = 'quantity-badge';
                    badge.textContent = quantityInCart;
                    card.appendChild(badge);
                }
                
                // ุชุญุฏูุซ ูุธูุฑ ุงูุจุทุงูุฉ
                if (quantityInCart > 0) {
                    card.classList.add('added');
                } else {
                    card.classList.remove('added');
                }
            });
        }
        /**
         * ุชุญุฏูุซ ุจูุงูุงุช ุงููุจูุนุงุช ุงูุชุงุฑูุฎูุฉ
         */
        function updateSalesHistory(productId) {
            const existingSale = salesHistory.find(sale => sale.productId === productId);
            
            if (existingSale) {
                existingSale.lastSold = new Date().toISOString();
                existingSale.saleCount += 1;
            } else {
                salesHistory.push({
                    productId: productId,
                    lastSold: new Date().toISOString(),
                    saleCount: 1
                });
            }
            
            // ุญูุธ ูู localStorage
            localStorage.setItem('pos_sales', JSON.stringify(salesHistory));
        }

        /**
         * ุชุญููู ุงูุงูุชุฑุงุญุงุช ุงูุณุฑูุนุฉ
         */
        async function loadQuickSuggestions() {
            try {
                const products = await getAllProducts();
                const container = document.getElementById('quickSuggestions');
                if (!container) return;
                
                container.innerHTML = '';
                if (products.length === 0) return;

                // ุชุฑุชูุจ ุงูููุชุฌุงุช ุญุณุจ ุงููุจูุนุงุช ุงูุชุงุฑูุฎูุฉ
                const sortedProducts = products
                    .map(product => {
                        const saleData = salesHistory.find(sale => sale.productId === product.id) || {
                            lastSold: new Date(0).toISOString(),
                            saleCount: 0
                        };
                        return {
                            ...product,
                            lastSold: saleData.lastSold,
                            saleCount: saleData.saleCount
                        };
                    })
                    .sort((a, b) => {
                        if (new Date(b.lastSold) - new Date(a.lastSold) !== 0) {
                            return new Date(b.lastSold) - new Date(a.lastSold);
                        }
                        return b.saleCount - a.saleCount;
                    })
                    .slice(0, 7);

                sortedProducts.forEach(product => {
                    // ุงุณุชุฎุฏุงู ุงูุตูุฑุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉุ ูุฅูุง ุงุณุชุฎุฏุงู ุงูุฅูููุฌู
                    let imageContent = '';
                    if (product.imageData) {
                        imageContent = `<img src="${product.imageData}" alt="${product.name}" 
                            style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color);"
                            onerror="this.style.display='none'; this.parentNode.innerHTML='<div style=\\'width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 1.5rem;\\'>${product.image || '๐ฆ'}</div>'">`;
                    } else {
                        imageContent = `<div style="width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 1.5rem;">
                            ${product.image || '๐ฆ'}
                        </div>`;
                    }
                    
                    const suggestion = document.createElement('div');
                    suggestion.className = 'suggestion-item';
                    suggestion.innerHTML = `
                        <div class="suggestion-emoji">${imageContent}</div>
                        <div class="suggestion-name">${product.name}</div>
                    `;
                    suggestion.addEventListener('click', () => {
                        addToCart(product.id, product.name, product.salePrice, product.purchasePrice);
                        showNotification(product.name);
                    });
                    container.appendChild(suggestion);
                });
            } catch (error) {
                console.error('ูุดู ุชุญููู ุงูุงูุชุฑุงุญุงุช ุงูุณุฑูุนุฉ:', error);
            }
        }
        /**
         * ุชุญุฏูุซ ุงูุณูุฉ ุงูุนุงุฆูุฉ
         */
        function updateFloatingCart() {
            const floatingCart = document.getElementById('floatingCartBtn');
            const floatingTotal = document.getElementById('floatingCartTotal');
            
            if (!floatingCart || !floatingTotal) return;
            
            if (currentCart.length === 0) {
                floatingCart.style.display = 'none';
            } else {
                floatingCart.style.display = 'flex';
                
                // ุญุณุงุจ ุงูุฅุฌูุงูู
                let subtotal = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                

                
                // ๐ง ุฅุถุงูุฉ ุญุฏุซ ุงูููุฑ ููุชุญ ุงูุณูุฉ
                floatingCart.onclick = function() {
                    const posCart = document.getElementById('posCart');
                    if (posCart) {
                        posCart.classList.add('show');
                    }
                };
            }
        }



        /**
        * ุญูุธ ุงููุงุชูุฑุฉ ูุน ุงููุธุงู ุงููุญุงุณุจู ุงููุชูุงูู - ุงูุฅุตุฏุงุฑ ุงูููุงุฆู ุงููุตุญุญ
        */
        async function saveInvoice() {
            if (currentCart.length === 0) {
                alert('ุงูุณูุฉ ูุงุฑุบุฉ! ุฃุถู ููุชุฌุงุช ูุจู ุญูุธ ุงููุงุชูุฑุฉ.');
                return;
            }
            
            try {
                console.log('๐ ุจุฏุก ุนูููุฉ ุญูุธ ุงููุงุชูุฑุฉ ูุน ุงููุธุงู ุงูุฌุฏูุฏ...');
                
                // ุงูุชุญูู ูู ุชููุฑ ุงููุฎุฒูู ุฃููุงู
                await validateCartStock();
                
                // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
                const subtotal = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                // ุงูุญุตูู ุนูู ุฅุนุฏุงุฏุงุช ุงูุถุฑูุจุฉ ูุงูุนููุฉ
                const taxRate = parseFloat(document.getElementById('taxRateInput').value) || 0;
                const currency = document.getElementById('currencySelect').value;
                const exchangeRate = parseFloat(document.getElementById('exchangeRateInput').value) || 1;
                const customerId = document.getElementById('customerSelect').value;
                const paymentMethod = document.getElementById('paymentMethodSelect').value;
                
                // ุญุณุงุจ ุงูุถุฑูุจุฉ ูุงูุฅุฌูุงูู (ุจุฏูู ุฎุตู)
                const taxAmount = subtotal * (taxRate / 100);
                const total = subtotal + taxAmount;
                
                console.log('๐งฎ ุงูุญุณุงุจุงุช:', { 
                    subtotal, 
                    taxAmount, 
                    total,
                    customerId,
                    paymentMethod
                });

                // ุญุณุงุจ ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ
                let costOfGoods = 0;
                const productUpdates = [];
                
                for (const item of currentCart) {
                    const product = await getProductById(item.id);
                    if (product) {
                        const itemCost = (product.purchasePrice || 0) * item.quantity;
                        costOfGoods += itemCost;
                        
                        // ุชุญุถูุฑ ุชุญุฏูุซุงุช ุงูููุชุฌุงุช
                        productUpdates.push({
                            product: product,
                            newQuantity: product.quantity - item.quantity,
                            itemName: product.name
                        });
                        
                        console.log(`๐ฆ ููุชุฌ: ${product.name}, ุงููููุฉ: ${item.quantity}, ุงูุชูููุฉ: ${itemCost}`);
                    }
                }

                console.log(`๐ฐ ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ: ${costOfGoods}`);

                // ุงูุญุตูู ุนูู ุจูุงูุงุช ุงูุนููู ูุญุณุงุจู
                let customerAccountCode = '1040000'; // ุนููุงุก ููุฏููู ุงูุชุฑุงุถู
                let customerName = 'ุนููู ููุฏู';
                
                if (customerId) {
                    try {
                        const customer = await getCustomerById(parseInt(customerId));
                        if (customer && customer.accCode) {
                            customerAccountCode = customer.accCode;
                            customerName = customer.name;
                            console.log(`โ ุงุณุชุฎุฏุงู ุญุณุงุจ ุงูุนููู ุงููุฑุฏู: ${customerAccountCode} - ${customerName}`);
                        }
                    } catch (error) {
                        console.error('โ ุฎุทุฃ ูู ุฌูุจ ุจูุงูุงุช ุงูุนููู:', error);
                    }
                }

                // ุชูููุฏ ุฑูู ูุงุชูุฑุฉ ูุฑูุฏ
                let invoiceNumber = `INV-${invoiceCounter}`;
                let isInvoiceNumberUnique = false;
                let attempts = 0;
                
                while (!isInvoiceNumberUnique && attempts < 10) {
                    const existingInvoice = await checkInvoiceNumberExists(invoiceNumber);
                    if (!existingInvoice) {
                        isInvoiceNumberUnique = true;
                    } else {
                        invoiceCounter++;
                        invoiceNumber = `INV-${invoiceCounter}`;
                        attempts++;
                    }
                }

                const invoice = {
                    invoiceNumber: invoiceNumber,
                    date: new Date().toISOString(),
                    customerId: customerId || null,
                    customerName: customerName,
                    customerAccount: customerAccountCode,
                    paymentMethod: paymentMethod,
                    items: JSON.parse(JSON.stringify(currentCart)),
                    subtotal: subtotal,
                    tax: taxAmount,
                    total: total,
                    status: 'completed',
                    costOfGoods: costOfGoods,
                    taxRate: taxRate,
                    currency: currency,
                    exchangeRate: exchangeRate,
                    createdAt: new Date().toISOString()
                };

                console.log('๐งพ ุจูุงูุงุช ุงููุงุชูุฑุฉ ุงูููุงุฆูุฉ:', invoice);

                // ุชูููุฐ ุฌููุน ุงูุนูููุงุช ูู ูุนุงููุฉ ูุงุญุฏุฉ
                await executeInvoiceTransaction(invoice, productUpdates, customerId);
                
                // ุชุญุฏูุซ ุงููุงุฌูุฉ ุจุนุฏ ูุฌุงุญ ุงูุนูููุฉ
                currentCart = [];
                updateCartDisplay();
                updateCartCount();
                updateFloatingCart();
                
                // ุฅุบูุงู ุณูุฉ ุงููุดุชุฑูุงุช
                const posCart = document.getElementById('posCart');
                if (posCart) {
                    posCart.classList.remove('show');
                }
                
                // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
                if (currentView === 'products' && currentCategoryId) {
                    loadProductsForCategory(currentCategoryId);
                }
                
                updateBalance();
                displayChartOfAccounts();
                
                // ุนุฑุถ ูููุฐุฌ ุงููุฌุงุญ
                showSuccessModal(invoice);
                
                console.log('โ ุชู ุญูุธ ุงููุงุชูุฑุฉ ุจูุฌุงุญ ูุน ุงููุธุงู ุงูุฌุฏูุฏ!');
                
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุญูุธ ุงููุงุชูุฑุฉ:', error);
                alert(`โ ูุดู ูู ุญูุธ ุงููุงุชูุฑุฉ: ${error.message}`);
                
                // ุชุญุฏูุซ ุงูุฑุตูุฏ ูุจุงุดุฑุฉ ูู ุญุงูุฉ ุงููุดู
                updateBalance();
                displayChartOfAccounts();
            }
        }

        /**
        * ุชูููุฐ ุฌููุน ุนูููุงุช ุงููุงุชูุฑุฉ ูู ูุนุงููุฉ ูุงุญุฏุฉ
        */
        function executeInvoiceTransaction(invoice, productUpdates, customerId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([
                    'invoices', 
                    'products', 
                    'customers',
                    'cashTransactions',
                    'journalEntries',
                    'chartOfAccounts'
                ], 'readwrite');
                
                transaction.onerror = (e) => {
                    console.error('โ ุฎุทุฃ ูู ุงููุนุงููุฉ:', e.target.error);
                    reject(new Error(`ูุดู ูู ูุนุงููุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${e.target.error}`));
                };
                
                transaction.oncomplete = () => {
                    console.log('โ ุงูุชููุช ูุนุงููุฉ ุงููุงุชูุฑุฉ ุจูุฌุงุญ');
                    resolve();
                };
                
                const invoiceStore = transaction.objectStore('invoices');
                const productsStore = transaction.objectStore('products');
                const customersStore = transaction.objectStore('customers');
                const cashStore = transaction.objectStore('cashTransactions');
                const journalStore = transaction.objectStore('journalEntries');
                const coaStore = transaction.objectStore('chartOfAccounts');
                
                // 1. ุชุญุฏูุซ ูููุงุช ุงูููุชุฌุงุช
                console.log('๐ ุชุญุฏูุซ ูููุงุช ุงูููุชุฌุงุช...');
                for (const update of productUpdates) {
                    update.product.quantity = update.newQuantity;
                    update.product.lastSold = new Date().toISOString();
                    const putRequest = productsStore.put(update.product);
                    putRequest.onerror = (e) => {
                        console.error(`โ ูุดู ุชุญุฏูุซ ุงูููุชุฌ ${update.itemName}:`, e.target.error);
                    };
                }
                
                // 2. ุญูุธ ุงููุงุชูุฑุฉ
                console.log('๐พ ุญูุธ ุงููุงุชูุฑุฉ...');
                const invoiceRequest = invoiceStore.add(invoice);
                
                invoiceRequest.onsuccess = (e) => {
                    const invoiceId = e.target.result;
                    invoiceCounter++;
                    console.log(`โ ุชู ุญูุธ ุงููุงุชูุฑุฉ ุจุฑูู: ${invoiceId}`);
                    
                    // 3. ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู ุฅุฐุง ูุงูุช ูุงุชูุฑุฉ ุขุฌูุฉ
                    if (invoice.paymentMethod === 'credit' && customerId) {
                        console.log('๐ค ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู...');
                        const customerRequest = customersStore.get(parseInt(customerId));
                        
                        customerRequest.onsuccess = (e) => {
                            const customer = e.target.result;
                            if (customer) {
                                customer.balance = (customer.balance || 0) + invoice.total;
                                customer.lastTransaction = new Date().toISOString();
                                const updateRequest = customersStore.put(customer);
                                updateRequest.onsuccess = () => {
                                    console.log(`โ ุชู ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู: ${customer.balance}`);
                                };
                                updateRequest.onerror = (e) => {
                                    console.error('โ ูุดู ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู:', e.target.error);
                                };
                            }
                        };
                        
                        customerRequest.onerror = (e) => {
                            console.error('โ ูุดู ุฌูุจ ุจูุงูุงุช ุงูุนููู:', e.target.error);
                        };
                    }
                    
                    // 4. ุชุณุฌูู ุงููููุฏ ุงููุญุงุณุจูุฉ ูุน ุญุณุงุจุงุช ุงูุนููุงุก ุงููุฑุฏูุฉ
                    console.log('๐ ุชุณุฌูู ุงููููุฏ ุงููุญุงุณุจูุฉ...');
                    recordAccountingEntriesInTransaction(invoice, invoiceId, transaction)
                        .then(() => {
                            console.log('โ ุชู ุชุณุฌูู ุงููููุฏ ุงููุญุงุณุจูุฉ');
                            
                            // 5. ุชุณุฌูู ุญุฑูุฉ ุงูุตูุฏูู ุฅุฐุง ูุงูุช ููุฏูุฉ
                            if (invoice.paymentMethod === 'cash') {
                                console.log('๐ต ุชุณุฌูู ุญุฑูุฉ ุงูุตูุฏูู...');
                                const cashTransaction = {
                                    date: new Date().toISOString(),
                                    type: 'Sale',
                                    amount: invoice.total,
                                    reference: `ูุงุชูุฑุฉ ูุจูุนุงุช ${invoice.invoiceNumber}`,
                                    invoiceId: invoiceId,
                                    customerId: customerId || null,
                                    customerName: invoice.customerName
                                };
                                const cashRequest = cashStore.add(cashTransaction);
                                cashRequest.onsuccess = () => {
                                    console.log('โ ุชู ุชุณุฌูู ุญุฑูุฉ ุงูุตูุฏูู');
                                };
                                cashRequest.onerror = (e) => {
                                    console.error('โ ูุดู ุชุณุฌูู ุญุฑูุฉ ุงูุตูุฏูู:', e.target.error);
                                };
                            }
                        })
                        .catch(error => {
                            console.error('โ ูุดู ุชุณุฌูู ุงููููุฏ ุงููุญุงุณุจูุฉ:', error);
                            reject(error);
                        });
                };
                
                invoiceRequest.onerror = (e) => {
                    reject(new Error(`ูุดู ุญูุธ ุงููุงุชูุฑุฉ: ${e.target.error}`));
                };
            });
        }

        /**
        * ุชุณููุฉ ุถุฑูุจุฉ ุงููุจูุนุงุช - ุงูุฅุตุฏุงุฑ ุงููุตุญุญ
        */
        async function recordSalesTaxReconciliation(invoice, invoiceId, transaction) {
            return new Promise((resolve, reject) => {
                const journalStore = transaction.objectStore('journalEntries');
                const coaStore = transaction.objectStore('chartOfAccounts');
                
                const taxAmount = invoice.tax || 0;
                
                if (taxAmount <= 0) {
                    resolve();
                    return;
                }

                console.log('๐งพ ุจุฏุก ุชุณููุฉ ุถุฑูุจุฉ ุงููุจูุนุงุช...');
                
                // โ ููุฏ ุชุณููุฉ ุงูุถุฑูุจุฉ: ููู ุงูุถุฑูุจุฉ ูู ุงูุญุณุงุจ ุงููุคูุช ุฅูู ุงูุญุณุงุจ ุงูุฏุงุฆู
                const taxReconciliationEntry = {
                    date: new Date().toISOString(),
                    description: `ุชุณููุฉ ุถุฑูุจุฉ ูุจูุนุงุช - ูุงุชูุฑุฉ ${invoice.invoiceNumber}`,
                    debits: [{ 
                        accountCode: '4020', // ุถุฑูุจุฉ ุงููุจูุนุงุช ุงููุคูุชุฉ (ุฏุงุฆูุฉ)
                        amount: taxAmount,
                        description: `ุชุณููุฉ ุถุฑูุจุฉ ูุจูุนุงุช - ${invoice.customerName}`
                    }],
                    credits: [{ 
                        accountCode: '2041', // ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ ุงููุณุชุญูุฉ ุงูุฏูุน
                        amount: taxAmount,
                        description: 'ุชุณููุฉ ุถุฑูุจุฉ ูุณุชุญูุฉ ุงูุฏูุน'
                    }],
                    refType: 'TaxReconciliation',
                    refId: invoiceId,
                    balanced: true,
                    totalAmount: taxAmount,
                    createdAt: new Date().toISOString(),
                    auditInfo: {
                        userId: 'system',
                        timestamp: new Date().toISOString(),
                        ipAddress: 'localhost',
                        sessionId: 'tax-reconciliation'
                    }
                };
                
                const taxRequest = journalStore.add(taxReconciliationEntry);
                
                taxRequest.onsuccess = () => {
                    console.log('โ ุชู ุชุณุฌูู ููุฏ ุชุณููุฉ ุงูุถุฑูุจุฉ ุจูุฌุงุญ');
                    
                    // ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช
                    updateAccountBalances(
                        [{ accountCode: '4020', amount: taxAmount }],
                        [{ accountCode: '2041', amount: taxAmount }],
                        coaStore
                    )
                    .then(() => {
                        console.log('โ ุชู ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุญุณุงุจุงุช ุงูุถุฑูุจุฉ');
                        resolve();
                    })
                    .catch(reject);
                };
                
                taxRequest.onerror = (e) => {
                    console.error('โ ูุดู ุชุณุฌูู ููุฏ ุชุณููุฉ ุงูุถุฑูุจุฉ:', e.target.error);
                    reject(new Error(`ูุดู ุชุณุฌูู ููุฏ ุชุณููุฉ ุงูุถุฑูุจุฉ: ${e.target.error}`));
                };
            });
        }
        /**
        * ุชุณููุฉ ุถุฑูุจุฉ ุงููุดุชุฑูุงุช - ุงูุฅุตุฏุงุฑ ุงููุตุญุญ
        */
        async function recordPurchaseTaxReconciliation(purchase, purchaseId, transaction) {
            return new Promise((resolve, reject) => {
                const journalStore = transaction.objectStore('journalEntries');
                const coaStore = transaction.objectStore('chartOfAccounts');
                
                const taxAmount = purchase.tax || 0;
                
                if (taxAmount <= 0) {
                    resolve();
                    return;
                }

                console.log('๐งพ ุจุฏุก ุชุณููุฉ ุถุฑูุจุฉ ุงููุดุชุฑูุงุช...');
                
                // โ ููุฏ ุชุณููุฉ ุงูุถุฑูุจุฉ: ููู ุงูุถุฑูุจุฉ ูู ุงูุญุณุงุจ ุงููุคูุช ุฅูู ุงูุญุณุงุจ ุงูุฏุงุฆู
                const taxReconciliationEntry = {
                    date: new Date().toISOString(),
                    description: `ุชุณููุฉ ุถุฑูุจุฉ ูุดุชุฑูุงุช - ูุงุชูุฑุฉ ${purchase.invoiceNumber}`,
                    debits: [{ 
                        accountCode: '2041', // ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ ุงููุณุชุญูุฉ ุงูุฏูุน
                        amount: taxAmount,
                        description: `ุชุณููุฉ ุถุฑูุจุฉ ูุฏููุนุฉ - ${purchase.supplierName}`
                    }],
                    credits: [{ 
                        accountCode: '4010', // ุถุฑูุจุฉ ุงููุดุชุฑูุงุช ุงููุคูุชุฉ (ูุฏููุฉ)
                        amount: taxAmount,
                        description: 'ุชุณููุฉ ุถุฑูุจุฉ ูุงุจูุฉ ููุฎุตู'
                    }],
                    refType: 'PurchaseTaxReconciliation',
                    refId: purchaseId,
                    balanced: true,
                    totalAmount: taxAmount,
                    createdAt: new Date().toISOString(),
                    auditInfo: {
                        userId: 'system',
                        timestamp: new Date().toISOString(),
                        ipAddress: 'localhost',
                        sessionId: 'tax-reconciliation'
                    }
                };
                
                const taxRequest = journalStore.add(taxReconciliationEntry);
                
                taxRequest.onsuccess = () => {
                    console.log('โ ุชู ุชุณุฌูู ููุฏ ุชุณููุฉ ุถุฑูุจุฉ ุงููุดุชุฑูุงุช ุจูุฌุงุญ');
                    
                    // ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช
                    updateAccountBalances(
                        [{ accountCode: '2041', amount: taxAmount }],
                        [{ accountCode: '4010', amount: taxAmount }],
                        coaStore
                    )
                    .then(() => {
                        console.log('โ ุชู ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุญุณุงุจุงุช ุถุฑูุจุฉ ุงููุดุชุฑูุงุช');
                        resolve();
                    })
                    .catch(reject);
                };
                
                taxRequest.onerror = (e) => {
                    console.error('โ ูุดู ุชุณุฌูู ููุฏ ุชุณููุฉ ุถุฑูุจุฉ ุงููุดุชุฑูุงุช:', e.target.error);
                    reject(new Error(`ูุดู ุชุณุฌูู ููุฏ ุชุณููุฉ ุถุฑูุจุฉ ุงููุดุชุฑูุงุช: ${e.target.error}`));
                };
            });
        }

        /**
        * ุชุณุฌูู ุงููููุฏ ุงููุญุงุณุจูุฉ ุฏุงุฎู ุงููุนุงููุฉ - ุงูุฅุตุฏุงุฑ ุงููุตุญุญ
        */
        async function recordAccountingEntriesInTransaction(invoice, invoiceId, transaction) {
            return new Promise((resolve, reject) => {
                console.log('๐ฏ ุจุฏุก ุชุณุฌูู ุงููููุฏ ุงููุญุงุณุจูุฉ ุงููุตุญุญุฉ ููุจูุน...');
                
                const journalStore = transaction.objectStore('journalEntries');
                const coaStore = transaction.objectStore('chartOfAccounts');
                
                const customerAccountCode = invoice.customerAccount || '1040000';
                
                console.log('๐ ุงุณุชุฎุฏุงู ุญุณุงุจ ุงูุนููู:', customerAccountCode);
                
                // ุญุณุงุจ ุงูุถุฑูุจุฉ ูุงูุฅุฌูุงููุงุช
                const taxAmount = invoice.tax || 0;
                const subtotal = invoice.subtotal;
                const total = invoice.total;
                const netRevenue = subtotal; // ุงูุฅูุฑุงุฏ ุงูุตุงูู ูุจู ุงูุถุฑูุจุฉ
                
                console.log('๐งฎ ุงูุญุณุงุจุงุช:', { 
                    subtotal, 
                    taxAmount, 
                    total,
                    netRevenue 
                });

                // โ ุงูููุฏ 1: ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช ูุงูุถุฑูุจุฉ
                const revenueDebits = [];
                const revenueCredits = [];
                
                if (invoice.paymentMethod === 'cash') {
                    // ๐ฅ ุงูุจูุน ุงูููุฏู: ุงูุตูุฏูู (ูุฏูู) โ ุงูุฅูุฑุงุฏุงุช + ุงูุถุฑูุจุฉ (ุฏุงุฆู)
                    revenueDebits.push({ 
                        accountCode: '1010', // ุงูุตูุฏูู
                        amount: total,
                        description: `ููุจูุถุงุช ุจูุน ููุฏู - ${invoice.customerName} - ูุงุชูุฑุฉ ${invoice.invoiceNumber}`
                    });
                } else {
                    // ๐ฅ ุงูุจูุน ุงูุขุฌู: ุงูุนููู (ูุฏูู) โ ุงูุฅูุฑุงุฏุงุช + ุงูุถุฑูุจุฉ (ุฏุงุฆู)
                    revenueDebits.push({ 
                        accountCode: customerAccountCode, // ุญุณุงุจ ุงูุนููู ุงููุฑุฏู
                        amount: total,
                        description: `ุฐูู ุนููุงุก ุขุฌูุฉ - ${invoice.customerName} - ูุงุชูุฑุฉ ${invoice.invoiceNumber}`
                    });
                }
                
                // ุงูุฏุงุฆู: ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช (ุตุงูู)
                revenueCredits.push({ 
                    accountCode: '3010', // ุงููุจูุนุงุช
                    amount: netRevenue,
                    description: `ุฅูุฑุงุฏุงุช ูุจูุนุงุช - ูุงุชูุฑุฉ ${invoice.invoiceNumber}`
                });
                
                // ุงูุฏุงุฆู: ุงูุถุฑูุจุฉ ุงููุณุชุญูุฉ (ุฅุฐุง ูุฌุฏุช)
                if (taxAmount > 0) {
                    revenueCredits.push({ 
                        accountCode: '4020', // ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ ุงููุณุชุญูุฉ
                        amount: taxAmount,
                        description: `ุถุฑูุจุฉ ูุจูุนุงุช ูุณุชุญูุฉ - ูุงุชูุฑุฉ ${invoice.invoiceNumber}`
                    });
                }
                
                console.log('๐ ุงูููุฏ 1 - ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช:');
                console.log('ุงููุฏูู:', revenueDebits);
                console.log('ุงูุฏุงุฆู:', revenueCredits);
                
                // ุงูุชุญูู ูู ุงูุชูุงุฒู
                const totalRevenueDebit = revenueDebits.reduce((sum, d) => sum + d.amount, 0);
                const totalRevenueCredit = revenueCredits.reduce((sum, c) => sum + c.amount, 0);
                const revenueDifference = Math.abs(totalRevenueDebit - totalRevenueCredit);
                
                console.log('โ๏ธ ุงูุชุญูู ูู ุชูุงุฒู ููุฏ ุงูุฅูุฑุงุฏุงุช:', {
                    'ูุฌููุน ุงููุฏูู': totalRevenueDebit,
                    'ูุฌููุน ุงูุฏุงุฆู': totalRevenueCredit,
                    'ุงููุฑู': revenueDifference
                });
                
                if (revenueDifference > 0.01) {
                    const error = new Error(`ููุฏ ุงูุฅูุฑุงุฏุงุช ุบูุฑ ูุชูุงุฒู! ุงููุฏูู: ${totalRevenueDebit}, ุงูุฏุงุฆู: ${totalRevenueCredit}`);
                    console.error('โ', error.message);
                    reject(error);
                    return;
                }
                
                // ุชุณุฌูู ููุฏ ุงูุฅูุฑุงุฏุงุช
                const revenueEntry = {
                    date: new Date().toISOString(),
                    description: `ุฅูุฑุงุฏุงุช ูุจูุนุงุช ${invoice.invoiceNumber} - ${invoice.paymentMethod === 'credit' ? 'ุขุฌู' : 'ููุฏู'} - ${invoice.customerName}`,
                    debits: revenueDebits,
                    credits: revenueCredits,
                    refType: 'SaleRevenue',
                    refId: invoiceId,
                    balanced: true,
                    totalAmount: total,
                    createdAt: new Date().toISOString(),
                    auditInfo: {
                        userId: 'system',
                        timestamp: new Date().toISOString(),
                        ipAddress: 'localhost',
                        sessionId: 'sales-process'
                    }
                };
                
                console.log('๐พ ุญูุธ ููุฏ ุงูุฅูุฑุงุฏุงุช:', revenueEntry);
                
                const revenueRequest = journalStore.add(revenueEntry);
                
                revenueRequest.onsuccess = () => {
                    console.log('โ ุชู ุชุณุฌูู ููุฏ ุงูุฅูุฑุงุฏุงุช ุจูุฌุงุญ');
                    
                    // โ ุงูููุฏ 2: ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ (COGS)
                    const cogsAmount = invoice.costOfGoods || 0;
                    
                    if (cogsAmount > 0) {
                        console.log('๐ฆ ุชุณุฌูู ููุฏ ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ...');
                        
                        const cogsEntry = {
                            date: new Date().toISOString(),
                            description: `ุชูููุฉ ุจุถุงุนุฉ ูุจุงุนุฉ - ูุงุชูุฑุฉ ${invoice.invoiceNumber}`,
                            debits: [{ 
                                accountCode: '3020', // ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ
                                amount: cogsAmount,
                                description: `ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ - ${invoice.invoiceNumber}`
                            }],
                            credits: [{ 
                                accountCode: '1030', // ุงููุฎุฒูู
                                amount: cogsAmount,
                                description: `ุชุฎููุถ ุงููุฎุฒูู - ูุงุชูุฑุฉ ${invoice.invoiceNumber}`
                            }],
                            refType: 'COGS',
                            refId: invoiceId,
                            balanced: true,
                            totalAmount: cogsAmount,
                            createdAt: new Date().toISOString(),
                            auditInfo: {
                                userId: 'system',
                                timestamp: new Date().toISOString(),
                                ipAddress: 'localhost',
                                sessionId: 'sales-process'
                            }
                        };
                        
                        const cogsRequest = journalStore.add(cogsEntry);
                        
                        cogsRequest.onsuccess = () => {
                            console.log('โ ุชู ุชุณุฌูู ููุฏ ุงูุชูููุฉ');
                            
                            // ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช ููุฅูุฑุงุฏุงุช ูุงูุชูููุฉ
                            updateAccountBalances(revenueDebits, revenueCredits, coaStore)
                                .then(() => {
                                    console.log('โ ุชู ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุญุณุงุจุงุช ุงูุฅูุฑุงุฏุงุช');
                                    return updateAccountBalances(
                                        [{ accountCode: '3020', amount: cogsAmount }],
                                        [{ accountCode: '1030', amount: cogsAmount }],
                                        coaStore
                                    );
                                })
                                .then(() => {
                                    console.log('โ ุชู ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุญุณุงุจุงุช ุงูุชูููุฉ');
                                    
                                    // โ ุงูููุฏ 3: ุชุณููุฉ ุถุฑูุจุฉ ุงููุจูุนุงุช (ุฅุฐุง ูุฌุฏุช)
                                    if (taxAmount > 0) {
                                        return recordSalesTaxReconciliation(invoice, invoiceId, transaction);
                                    } else {
                                        resolve();
                                    }
                                })
                                .then(() => {
                                    console.log('โ ุงูุชููุช ุฌููุน ุงููููุฏ ุงููุญุงุณุจูุฉ ููุจูุน');
                                    resolve();
                                })
                                .catch(reject);
                        };
                        
                        cogsRequest.onerror = (e) => {
                            reject(new Error(`ูุดู ุชุณุฌูู ููุฏ ุงูุชูููุฉ: ${e.target.error}`));
                        };
                    } else {
                        // ุฅุฐุง ูู ุชูุฌุฏ ุชูููุฉุ ูุญุฏุซ ููุท ุญุณุงุจุงุช ุงูุฅูุฑุงุฏุงุช
                        updateAccountBalances(revenueDebits, revenueCredits, coaStore)
                            .then(() => {
                                console.log('โ ุชู ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุญุณุงุจุงุช ุงูุฅูุฑุงุฏุงุช');
                                
                                // ุชุณููุฉ ุงูุถุฑูุจุฉ ุฅุฐุง ูุฌุฏุช
                                if (taxAmount > 0) {
                                    return recordSalesTaxReconciliation(invoice, invoiceId, transaction);
                                } else {
                                    resolve();
                                }
                            })
                            .then(resolve)
                            .catch(reject);
                    }
                };
                
                revenueRequest.onerror = (e) => {
                    console.error('โ ูุดู ุชุณุฌูู ููุฏ ุงูุฅูุฑุงุฏุงุช:', e.target.error);
                    reject(new Error(`ูุดู ุชุณุฌูู ููุฏ ุงูุฅูุฑุงุฏุงุช: ${e.target.error}`));
                };
            });
        }

        /**
        * ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช
        */
        function updateAccountBalances(debits, credits, coaStore) {
            return new Promise((resolve, reject) => {
                let completed = 0;
                const totalOperations = debits.length + credits.length;
                
                if (totalOperations === 0) {
                    resolve();
                    return;
                }

                const checkCompletion = () => {
                    completed++;
                    if (completed === totalOperations) {
                        resolve();
                    }
                };

                // ุชุญุฏูุซ ุงูุญุณุงุจุงุช ุงููุฏููุฉ
                debits.forEach(debitEntry => {
                    const accountRequest = coaStore.get(debitEntry.accountCode);
                    accountRequest.onsuccess = (e) => {
                        const account = e.target.result;
                        if (account) {
                            account.balance = (account.balance || 0) + debitEntry.amount;
                            account.lastUpdated = new Date().toISOString();
                            account.lastTransaction = debitEntry.description || 'ุนูููุฉ ูุฏููุฉ';
                            
                            const putRequest = coaStore.put(account);
                            putRequest.onsuccess = checkCompletion;
                            putRequest.onerror = (e) => {
                                console.error(`โ ูุดู ุชุญุฏูุซ ุงูุญุณุงุจ ุงููุฏูู ${debitEntry.accountCode}:`, e.target.error);
                                checkCompletion();
                            };
                        } else {
                            console.error(`โ ุงูุญุณุงุจ ุงููุฏูู ุบูุฑ ููุฌูุฏ: ${debitEntry.accountCode}`);
                            checkCompletion();
                        }
                    };
                    accountRequest.onerror = (e) => {
                        console.error(`โ ูุดู ุฌูุจ ุงูุญุณุงุจ ุงููุฏูู ${debitEntry.accountCode}:`, e.target.error);
                        checkCompletion();
                    };
                });

                // ุชุญุฏูุซ ุงูุญุณุงุจุงุช ุงูุฏุงุฆูุฉ
                credits.forEach(creditEntry => {
                    const accountRequest = coaStore.get(creditEntry.accountCode);
                    accountRequest.onsuccess = (e) => {
                        const account = e.target.result;
                        if (account) {
                            account.balance = (account.balance || 0) - creditEntry.amount;
                            account.lastUpdated = new Date().toISOString();
                            account.lastTransaction = creditEntry.description || 'ุนูููุฉ ุฏุงุฆูุฉ';
                            
                            const putRequest = coaStore.put(account);
                            putRequest.onsuccess = checkCompletion;
                            putRequest.onerror = (e) => {
                                console.error(`โ ูุดู ุชุญุฏูุซ ุงูุญุณุงุจ ุงูุฏุงุฆู ${creditEntry.accountCode}:`, e.target.error);
                                checkCompletion();
                            };
                        } else {
                            console.error(`โ ุงูุญุณุงุจ ุงูุฏุงุฆู ุบูุฑ ููุฌูุฏ: ${creditEntry.accountCode}`);
                            checkCompletion();
                        }
                    };
                    accountRequest.onerror = (e) => {
                        console.error(`โ ูุดู ุฌูุจ ุงูุญุณุงุจ ุงูุฏุงุฆู ${creditEntry.accountCode}:`, e.target.error);
                        checkCompletion();
                    };
                });
            });
        }
        /**
        * ุงูุชุญูู ูู ุชููุฑ ุงููุฎุฒูู - ุงูุฅุตุฏุงุฑ ุงููุญุณูู
        */
        async function validateCartStock() {
            const stockErrors = [];
            
            for (const item of currentCart) {
                const product = await getProductById(item.id);
                if (!product) {
                    stockErrors.push(`ุงูููุชุฌ ุบูุฑ ููุฌูุฏ: ${item.name}`);
                } else if (product.quantity < item.quantity) {
                    stockErrors.push(`ุงููููุฉ ุบูุฑ ูุงููุฉ ููููุชุฌ: ${product.name}. ุงููุชุงุญ: ${product.quantity}ุ ุงููุทููุจ: ${item.quantity}`);
                }
            }
            
            if (stockErrors.length > 0) {
                throw new Error(stockErrors.join('\n'));
            }
        }


        /**
        * ุทุจุงุนุฉ ุงููุงุชูุฑุฉ ุงูุญุงููุฉ ูู ุงูุณูุฉ
        */
        function printInvoice() {

            // ูุชุญ ูุงูุฐุฉ ุงูุทุจุงุนุฉ
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // ุงูุงูุชุธุงุฑ ููููุงู ุซู ุงูุทุจุงุนุฉ
            setTimeout(() => {
                printWindow.print();
                // ุฅุบูุงู ุงููุงูุฐุฉ ุจุนุฏ ุงูุทุจุงุนุฉ
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            }, 500);
        }

        /**
        * ุฅูุดุงุก ูุนุงููุฉ ุฑุณุงูุฉ ุงููุงุชุณุงุจ ูููุงุชูุฑุฉ ุงูุญุงููุฉ
        */
        function createWhatsappPreview() {
            if (currentCart.length === 0) {
                alert('ุงูุณูุฉ ูุงุฑุบุฉ!');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('whatsappPreviewModal'));
            const preview = document.getElementById('whatsappMessagePreview');

            // ุญุณุงุจ ุงูุฅุฌูุงููุงุช ูู ุงูุณูุฉ ุงูุญุงููุฉ

            // ุจูุงุก ูุต ุงููุงุชูุฑุฉ ุจุดูู ููุณู
            let message = `๐ *ูุงุชูุฑุฉ ูุจูุนุงุช* ๐งพ\n\n`;
            message += `๐ *ุงูุชุงุฑูุฎ:* ${new Date().toLocaleDateString('ar-YE')}\n`;
            message += `โฐ *ุงูููุช:* ${new Date().toLocaleTimeString('ar-YE')}\n`;
            message += `๐ค *ุงูุนููู:* ${customerName}\n`;
            message += `๐ณ *ุทุฑููุฉ ุงูุฏูุน:* ${paymentMethod === 'credit' ? 'ุขุฌู' : 'ููุฏู'}\n\n`;
            
            message += `๐ *ุชูุงุตูู ุงููุงุชูุฑุฉ:*\n`;
            message += `โโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n`;
            
            currentCart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                message += `โ ${index + 1}. ${item.name}\n`;
                message += `โ    ${item.quantity} ร ${item.price.toFixed(2)} = ${itemTotal.toFixed(2)} ุฑ.ู\n`;
            });
            
            message += `โโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n`;
            
            message += `๐ฐ *ุงูุฅุฌูุงููุงุช:*\n`;
            message += `โ ุงููุฌููุน ุงููุฑุนู: ${subtotal.toFixed(2)} ุฑ.ู\n`;
            

            
            if (taxAmount > 0) {
                message += `โ ุงูุถุฑูุจุฉ: ${taxAmount.toFixed(2)} ุฑ.ู\n`;
            }
            
            message += `โ *ุงูุฅุฌูุงูู ุงูููุงุฆู: ${total.toFixed(2)} ุฑ.ู*\n\n`;
            
            message += `๐ *ุดูุฑุงู ูุชุนุงูููู ูุนูุง!*\n`;
            message += `๐ ููุงุณุชูุณุงุฑ: ูุธุงู ERP ${new Date().getFullYear()}`;

            preview.textContent = message;

            // ุญูุธ ุฑุงุจุท ุงููุงุชุณุงุจ
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;

            // ุฅุถุงูุฉ ูุณุชูุน ููุฒุฑ
            const openWhatsappBtn = document.getElementById('openWhatsappBtn');
            openWhatsappBtn.onclick = () => {
                window.open(whatsappUrl, '_blank');
                modal.hide();
            };

            modal.show();
        }

        /**
         * ุนุฑุถ ูููุฐุฌ ุฅุชูุงู ุงูุจูุน ูุน ุญุณุงุจ ุงูุฑุจุญ
         */
        function showSuccessModal(invoiceData) {
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            
            // ุชุนุจุฆุฉ ุงูุจูุงูุงุช ุจุดูู ุตุญูุญ
            document.getElementById('invoiceNumberDisplay').textContent = invoiceData.invoiceNumber || 'INV-' + invoiceCounter;
            
            const paymentMethod = invoiceData.paymentMethod === 'credit' ? 'ุขุฌู' : 
                                invoiceData.paymentMethod === 'card' ? 'ุจุทุงูุฉ' : 'ููุฏู';
            document.getElementById('paymentMethodDisplay').textContent = paymentMethod;
            
            document.getElementById('finalTotalDisplay').textContent = `${invoiceData.total.toFixed(2)} ุฑ.ู`;
            
            // ุญุณุงุจ ูุนุฑุถ ุงูุฑุจุญ ุงูุฅุฌูุงูู ุจุดูู ุตุญูุญ
            const grossProfit = invoiceData.items.reduce((sum, item) => {
                const itemCost = (item.purchasePrice || 0) * item.quantity;
                const itemRevenue = item.price * item.quantity;
                return sum + (itemRevenue - itemCost);
            }, 0);
            
            document.getElementById('grossProfitDisplay').textContent = `${grossProfit.toFixed(2)} ุฑ.ู`;
            
            // ุฅุถุงูุฉ ูุณุชูุน ุญุฏุซ ูุฒุฑ ุงูุทุจุงุนุฉ
            document.getElementById('printReceiptBtn').onclick = function() {
                printInvoiceFromSuccess(invoiceData);
            };
            
            modal.show();
        }

        // ุฏุงูุฉ ูุณุงุนุฏุฉ ูุทุจุงุนุฉ ุงูุฅูุตุงู ูู ูููุฐุฌ ุงููุฌุงุญ
        function printInvoiceFromSuccess(invoiceData) {

            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            }, 500);
        }
        // ==================== 4.5. ุงููุญุงุณุจุฉ - ุนุฑุถ ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ====================
        async function displayChartOfAccounts() {
            try {
                const transaction = db.transaction(['chartOfAccounts'], 'readonly');
                const store = transaction.objectStore('chartOfAccounts');
                const request = store.getAll();
                
                request.onsuccess = function() {
                    const accounts = request.result;
                    const coaList = document.getElementById('coaList');
                    if (!coaList) return;
                    
                    coaList.innerHTML = '';
                    
                    // ุชุญููู ุงููุงุฆูุฉ ุฅูู ูููู ุดุฌุฑุฉ
                    const tree = {};
                    accounts.forEach(acc => {
                        acc.children = [];
                        tree[acc.code] = acc;
                    });

                    accounts.forEach(acc => {
                        if (acc.parentCode && tree[acc.parentCode]) {
                            tree[acc.parentCode].children.push(acc);
                        }
                    });

                    // ุฏุงูุฉ ูุณุงุนุฏุฉ ูุนุฑุถ ุงูุนูุฏุฉ ูู HTML
                    function renderAccount(account, level = 0) {
                        const li = document.createElement('li');
                        li.className = `list-group-item d-flex justify-content-between align-items-center ${account.type === 'header' ? 'fw-bold bg-light' : ''}`;
                        li.style.paddingRight = `${10 + level * 20}px`;

                        li.innerHTML = `
                            <span>${account.code} - ${account.name}</span>
                            <span>${account.balance !== undefined ? account.balance.toFixed(2) + ' ุฑ.ู' : ''}</span>
                        `;
                        
                        coaList.appendChild(li);

                        account.children.forEach(child => renderAccount(child, level + 1));
                    }

                    // ุงูุจุฏุก ูู ุงูุญุณุงุจุงุช ุงูุฑุฆูุณูุฉ (ุงูุชู ููุณ ููุง ูุงูุฏ ุฃู ูุงูุฏูุง ุบูุฑ ููุฌูุฏ ูู ุงููุงุฆูุฉ)
                    Object.values(tree).filter(acc => !acc.parentCode || !tree[acc.parentCode]).forEach(acc => renderAccount(acc));
                };
            } catch (error) {
                console.error('ูุดู ุนุฑุถ ุดุฌุฑุฉ ุงูุญุณุงุจุงุช:', error);
            }
        }

 
        /**
        * ุฌูุจ ุฌููุน ุงูููุงุชูุฑ
        */
        function getAllInvoices() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['invoices'], 'readonly');
                const store = transaction.objectStore('invoices');
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
        * ุฌูุจ ุฌููุน ุญุฑูุงุช ุงูุตูุฏูู
        */
        function getAllCashTransactions() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['cashTransactions'], 'readonly');
                const store = transaction.objectStore('cashTransactions');
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }


        // ==================== 4.8. ุฅุฏุงุฑุฉ ุงููุดุชุฑูุงุช ูุงูููุฑุฏูู ====================
        /**
        * ูุชุญ ูููุฐุฌ ูุงุชูุฑุฉ ุงูุดุฑุงุก
        */
        function openPurchaseModal() {
            const modal = new bootstrap.Modal(document.getElementById('purchaseModal'));
            
            // ุชุนุจุฆุฉ ุงูููุฑุฏูู
            const supplierSelect = document.getElementById('purchaseSupplier');
            supplierSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูููุฑุฏ</option>';
            suppliers.forEach(supplier => {
                supplierSelect.innerHTML += `<option value="${supplier.id}">${supplier.name}</option>`;
            });

            // ุชุนุจุฆุฉ ุงูููุชุฌุงุช
            loadProductsForPurchase();
            
            // ุชุนููู ุงูุชุงุฑูุฎ ุงูุญุงูู
            document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
            
            // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ
            document.getElementById('purchaseForm').reset();
            document.getElementById('purchaseTotal').value = '0';
            
            modal.show();
        }

        /**
        * ุชุญููู ุงูููุชุฌุงุช ูู ูููุฐุฌ ุงูุดุฑุงุก
        */
        async function loadProductsForPOS() {
            try {
                const products = await getAllProducts();
                const productsGrid = document.getElementById('productsGrid');
                if (!productsGrid) return;
                
                productsGrid.innerHTML = '';
                
                if (products.length === 0) {
                    productsGrid.innerHTML = '<div class="col-12"><p class="alert alert-info text-center">ูุง ุชูุฌุฏ ููุชุฌุงุช ูุณุฌูุฉ. ูุฑุฌู ุฅุถุงูุฉ ููุชุฌ ูู ุชุจููุจ "ุฅุฏุงุฑุฉ ุงููุฎุฒูู".</p></div>';
                    return;
                }

                products.forEach(product => {
                    const cartItem = currentCart.find(item => item.id === product.id);
                    const quantityInCart = cartItem ? cartItem.quantity : 0;
                    
                    const productCard = document.createElement('div');
                    productCard.className = `col-4 mb-3`; // ูุฐู ุณุชุตุจุญ 3 ุฃุนูุฏุฉ ูุน ุงูุดุจูุฉ ุงูุฌุฏูุฏุฉ
                    
                    productCard.innerHTML = `
                        <div class="card product-card h-100 ${quantityInCart > 0 ? 'added' : ''}" 
                            data-product-id="${product.id}" 
                            data-product-price="${product.salePrice}" 
                            data-product-cost="${product.purchasePrice}">
                            ${quantityInCart > 0 ? `<div class="quantity-badge">${quantityInCart}</div>` : ''}
                            <div class="card-body p-2 text-center">
                                <div class="product-image mb-1">${product.image || '๐ฆ'}</div>
                                <h6 class="card-title mb-0">${product.name}</h6>
                                <p class="card-text text-muted small mb-1">${product.code}</p>
                                <div class="d-flex justify-content-around align-items-center">
                                    <span class="fw-bold text-primary">${product.salePrice.toFixed(2)} ุฑ.ู</span>
                                    <span class="badge ${product.quantity > (product.minQuantity || 5) ? 'bg-success' : 'bg-danger'}" style="font-size: 0.6rem;">
                                        ${product.quantity}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                    productsGrid.appendChild(productCard);
                });
                
            } catch(error) {
                console.error('ูุดู ุชุญููู ุงูููุชุฌุงุช:', error);
                const productsGrid = document.getElementById('productsGrid');
                if (productsGrid) {
                    productsGrid.innerHTML = '<div class="col-12"><p class="alert alert-danger text-center">ูุดู ูู ุชุญููู ุงูููุชุฌุงุช.</p></div>';
                }
            }
        }

        /**
        * ุญูุธ ูุงุชูุฑุฉ ุงูุดุฑุงุก ูุน ุงููุธุงู ุงููุญุงุณุจู ุงููุชูุงูู - ุงูุฅุตุฏุงุฑ ุงููุตุญุญ
        */
        async function savePurchaseInvoice() {
            const form = document.getElementById('purchaseForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const purchaseItems = [];
            let isValid = true;

            // ุฌูุน ุนูุงุตุฑ ุงููุงุชูุฑุฉ ูุน ุงูุชุญูู
            document.querySelectorAll('.purchase-item').forEach(item => {
                const productSelect = item.querySelector('.product-select');
                const quantityInput = item.querySelector('.quantity-input');
                const priceInput = item.querySelector('.price-input');
                
                if (productSelect.value && quantityInput.value && priceInput.value) {
                    const quantity = parseInt(quantityInput.value);
                    const price = parseFloat(priceInput.value);
                    
                    if (quantity <= 0 || price <= 0) {
                        isValid = false;
                        alert('ุงููููุฉ ูุงูุณุนุฑ ูุฌุจ ุฃู ููููุง ุฃูุจุฑ ูู ุงูุตูุฑ');
                        return;
                    }
                    
                    purchaseItems.push({
                        productId: parseInt(productSelect.value),
                        productName: productSelect.options[productSelect.selectedIndex].text,
                        quantity: quantity,
                        price: price,
                        total: quantity * price
                    });
                } else {
                    isValid = false;
                }
            });

            if (!isValid || purchaseItems.length === 0) {
                alert('ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุญููู ุงูุฃุตูุงู ุจุดูู ุตุญูุญ');
                return;
            }

            // ุงูุญุตูู ุนูู ุจูุงูุงุช ุงูููุฑุฏ ูุญุณุงุจู
            const supplierId = parseInt(document.getElementById('purchaseSupplier').value);
            let supplierAccountCode = '2010000'; // ููุฑุฏูู ููุฏููู ุงูุชุฑุงุถู
            let supplierName = 'ููุฑุฏ ููุฏู';
            
            if (supplierId) {
                try {
                    const supplier = await getSupplierById(supplierId);
                    if (supplier && supplier.accCode) {
                        supplierAccountCode = supplier.accCode;
                        supplierName = supplier.name;
                        console.log(`โ ุงุณุชุฎุฏุงู ุญุณุงุจ ุงูููุฑุฏ ุงููุฑุฏู: ${supplierAccountCode} - ${supplierName}`);
                    }
                } catch (error) {
                    console.error('โ ุฎุทุฃ ูู ุฌูุจ ุจูุงูุงุช ุงูููุฑุฏ:', error);
                }
            }

            // ุงูุญุตูู ุนูู ุฅุนุฏุงุฏุงุช ุงูุถุฑูุจุฉ ูุงูุนููุฉ
            const taxRate = parseFloat(document.getElementById('purchaseTaxRate').value) || 0;
            const currency = document.getElementById('purchaseCurrency').value;
            const exchangeRate = parseFloat(document.getElementById('purchaseExchangeRate').value) || 1;
            const purchaseUnit = document.getElementById('purchaseUnit').value;
            
            const subtotal = purchaseItems.reduce((sum, item) => sum + item.total, 0);
            const taxAmount = subtotal * (taxRate / 100);
            const total = subtotal + taxAmount;

            const purchaseInvoice = {
                supplierId: supplierId,
                supplierName: supplierName,
                supplierAccount: supplierAccountCode,
                date: document.getElementById('purchaseDate').value,
                paymentMethod: document.getElementById('purchasePaymentMethod').value,
                invoiceNumber: document.getElementById('purchaseInvoiceNumber').value || `PUR-${Date.now()}`,
                items: purchaseItems,
                subtotal: subtotal,
                tax: taxAmount,
                taxRate: taxRate,
                total: total,
                currency: currency,
                exchangeRate: exchangeRate,
                purchaseUnit: purchaseUnit,
                notes: document.getElementById('purchaseNotes').value,
                createdAt: new Date().toISOString(),
                status: 'completed'
            };

            // ุงูุชุญูู ูู ุตุญุฉ ุงูุฅุฌูุงูู
            const calculatedTotal = purchaseItems.reduce((sum, item) => sum + item.total, 0) + taxAmount;
            if (Math.abs(purchaseInvoice.total - calculatedTotal) > 0.01) {
                alert('ุฅุฌูุงูู ุงููุงุชูุฑุฉ ูุง ูุชุทุงุจู ูุน ูุฌููุน ุงูุฃุตูุงู');
                return;
            }

            try {
                console.log('๐ ุจุฏุก ุนูููุฉ ุญูุธ ูุงุชูุฑุฉ ุงูุดุฑุงุก ูุน ุงููุธุงู ุงูุฌุฏูุฏ...');
                
                // ุชูููุฐ ุฌููุน ุงูุนูููุงุช ูู ูุนุงููุฉ ูุงุญุฏุฉ
                await executePurchaseTransaction(purchaseInvoice, purchaseItems);
                
                // ุฅุบูุงู ุงููููุฐุฌ ูุชุญุฏูุซ ุงููุงุฌูุงุช
                const modal = bootstrap.Modal.getInstance(document.getElementById('purchaseModal'));
                modal.hide();
                
                // ุชุญุฏูุซ ุฌููุน ุงููุงุฌูุงุช
                updateBalance();
                displayChartOfAccounts();
                loadProductsTable();
                loadProductsForPOS();
                loadPurchasesTable();
                
                alert('โ ุชู ุญูุธ ูุงุชูุฑุฉ ุงูุดุฑุงุก ุจูุฌุงุญ ูุชุญุฏูุซ ุงููุฎุฒูู!');

            } catch (error) {
                console.error('โ ูุดู ุญูุธ ูุงุชูุฑุฉ ุงูุดุฑุงุก:', error);
                alert(`โ ูุดู ุญูุธ ูุงุชูุฑุฉ ุงูุดุฑุงุก: ${error.message}`);
            }
        }

        /**
        * ุฌูุจ ุจูุงูุงุช ุงูููุฑุฏ ุจูุงุณุทุฉ ุงููุนุฑู
        */
        async function getSupplierById(supplierId) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['suppliers'], 'readonly');
                const store = transaction.objectStore('suppliers');
                const request = store.get(parseInt(supplierId));
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
        * ุชูููุฐ ุฌููุน ุนูููุงุช ูุงุชูุฑุฉ ุงูุดุฑุงุก ูู ูุนุงููุฉ ูุงุญุฏุฉ
        */
        function executePurchaseTransaction(purchase, purchaseItems) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([
                    'purchaseInvoices', 
                    'products', 
                    'suppliers',
                    'cashTransactions',
                    'journalEntries',
                    'chartOfAccounts'
                ], 'readwrite');
                
                transaction.onerror = (e) => {
                    console.error('โ ุฎุทุฃ ูู ูุนุงููุฉ ุงูุดุฑุงุก:', e.target.error);
                    reject(new Error(`ูุดู ูู ูุนุงููุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${e.target.error}`));
                };
                
                transaction.oncomplete = () => {
                    console.log('โ ุงูุชููุช ูุนุงููุฉ ุงูุดุฑุงุก ุจูุฌุงุญ');
                    resolve();
                };
                
                const purchaseStore = transaction.objectStore('purchaseInvoices');
                const productsStore = transaction.objectStore('products');
                const suppliersStore = transaction.objectStore('suppliers');
                const cashStore = transaction.objectStore('cashTransactions');
                const journalStore = transaction.objectStore('journalEntries');
                const coaStore = transaction.objectStore('chartOfAccounts');

                // 1. ุชุญุฏูุซ ุงูููุชุฌุงุช ุฃููุงู
                console.log('๐ ุชุญุฏูุซ ุงูููุชุฌุงุช...');
                
                for (const item of purchaseItems) {
                    const productRequest = productsStore.get(item.productId);
                    
                    productRequest.onsuccess = (e) => {
                        const product = e.target.result;
                        if (product) {
                            // โ ุญุณุงุจ ูุชูุณุท ุงูุชูููุฉ ุงููุฑุฌุญ ุจุดูู ุตุญูุญ
                            const currentTotalValue = product.purchasePrice * product.quantity;
                            const newTotalValue = item.price * item.quantity;
                            const totalValue = currentTotalValue + newTotalValue;
                            const totalQuantity = product.quantity + item.quantity;
                            
                            if (totalQuantity > 0) {
                                product.purchasePrice = totalValue / totalQuantity; // ุงููุชูุณุท ุงูุตุญูุญ
                            } else {
                                product.purchasePrice = item.price; // ุฅุฐุง ูุงู ุงููุฎุฒูู ุตูุฑ
                            }
                            
                            product.quantity = totalQuantity;
                            product.lastPurchased = new Date().toISOString();
                            
                            // ุฅุฐุง ูุงูุช ูุญุฏุฉ ุงูุดุฑุงุก "ุฌููุฉ"ุ ุชุญุฏูุซ ุณุนุฑ ุงูุฌููุฉ
                            if (purchase.purchaseUnit === 'ุฌููุฉ') {
                                product.wholesalePrice = item.price;
                                // ุญุณุงุจ ุณุนุฑ ุงูุชุฌุฒุฆุฉ ุชููุงุฆูุงู ุฅุฐุง ูู ููู ูุญุฏุฏุงู
                                if (!product.salePrice || product.salePrice < item.price * 1.1) {
                                    product.salePrice = item.price * 1.3; // ูุงูุด ุฑุจุญ 30%
                                }
                            }
                            
                            const updateRequest = productsStore.put(product);
                            updateRequest.onsuccess = () => {
                                console.log(`โ ุชู ุชุญุฏูุซ ุงูููุชุฌ: ${product.name}, ุงูุณุนุฑ: ${product.purchasePrice}, ุงููููุฉ: ${product.quantity}`);
                            };
                            updateRequest.onerror = (e) => {
                                console.error(`โ ูุดู ุชุญุฏูุซ ุงูููุชุฌ ${product.name}:`, e.target.error);
                            };
                            
                        } else {
                            // ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ
                            const newProduct = {
                                code: `ITEM-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                                name: item.productName,
                                purchasePrice: item.price,
                                salePrice: item.price * 1.3, // ูุงูุด ุฑุจุญ 30%
                                wholesalePrice: purchase.purchaseUnit === 'ุฌููุฉ' ? item.price : 0,
                                quantity: item.quantity,
                                minQuantity: 5,
                                categoryId: null,
                                image: '๐ฆ',
                                baseUnit: 'ุญุจุฉ',
                                purchaseUnit: purchase.purchaseUnit,
                                conversionFactor: 1,
                                currency: purchase.currency,
                                createdAt: new Date().toISOString()
                            };
                            
                            const addRequest = productsStore.add(newProduct);
                            addRequest.onsuccess = (e) => {
                                console.log(`โ ุชู ุฅุถุงูุฉ ุงูููุชุฌ ุงูุฌุฏูุฏ: ${item.productName}`);
                                // ุชุญุฏูุซ ูุนุฑู ุงูููุชุฌ ููุงุณุชุฎุฏุงู ูุงุญูุงู
                                item.productId = e.target.result;
                            };
                            addRequest.onerror = (e) => {
                                console.error(`โ ูุดู ุฅุถุงูุฉ ุงูููุชุฌ ุงูุฌุฏูุฏ ${item.productName}:`, e.target.error);
                            };
                        }
                    };
                    
                    productRequest.onerror = (e) => {
                        console.error(`โ ูุดู ุฌูุจ ุงูููุชุฌ:`, e.target.error);
                    };
                }

                // 2. ุญูุธ ูุงุชูุฑุฉ ุงูุดุฑุงุก
                console.log('๐พ ุญูุธ ูุงุชูุฑุฉ ุงูุดุฑุงุก...');
                const purchaseRequest = purchaseStore.add(purchase);
                
                purchaseRequest.onsuccess = (e) => {
                    const purchaseId = e.target.result;
                    console.log(`โ ุชู ุญูุธ ูุงุชูุฑุฉ ุงูุดุฑุงุก ุจุฑูู: ${purchaseId}`);
                    
                    // 3. ุชุณุฌูู ุงููููุฏ ุงููุญุงุณุจูุฉ ููุดุฑุงุก ูุน ุญุณุงุจุงุช ุงูููุฑุฏูู ุงููุฑุฏูุฉ
                    console.log('๐ ุชุณุฌูู ุงููููุฏ ุงููุญุงุณุจูุฉ ููุดุฑุงุก...');
                    recordPurchaseAccountingEntriesInTransaction(purchase, purchaseId, transaction)
                        .then(() => {
                            console.log('โ ุชู ุชุณุฌูู ุงููููุฏ ุงููุญุงุณุจูุฉ ููุดุฑุงุก');
                            
                            // 4. ุชุณุฌูู ุญุฑูุฉ ุงูุตูุฏูู ุฅุฐุง ูุงูุช ููุฏูุฉ
                            if (purchase.paymentMethod === 'cash') {
                                console.log('๐ต ุชุณุฌูู ุญุฑูุฉ ุงูุตูุฏูู ููุดุฑุงุก...');
                                const cashTransaction = {
                                    date: purchase.date,
                                    type: 'Purchase',
                                    amount: -purchase.total,
                                    reference: `ูุงุชูุฑุฉ ุดุฑุงุก ${purchase.invoiceNumber}`,
                                    purchaseId: purchaseId,
                                    supplierId: purchase.supplierId,
                                    supplierName: purchase.supplierName
                                };
                                const cashRequest = cashStore.add(cashTransaction);
                                cashRequest.onsuccess = () => {
                                    console.log('โ ุชู ุชุณุฌูู ุญุฑูุฉ ุงูุตูุฏูู ููุดุฑุงุก');
                                };
                                cashRequest.onerror = (e) => {
                                    console.error('โ ูุดู ุชุณุฌูู ุญุฑูุฉ ุงูุตูุฏูู:', e.target.error);
                                };
                            }
                            
                            // 5. ุชุญุฏูุซ ุฑุตูุฏ ุงูููุฑุฏ ุฅุฐุง ูุงูุช ุขุฌูุฉ
                            if (purchase.paymentMethod === 'credit' && purchase.supplierId) {
                                console.log('๐ฅ ุชุญุฏูุซ ุฑุตูุฏ ุงูููุฑุฏ...');
                                const supplierRequest = suppliersStore.get(purchase.supplierId);
                                
                                supplierRequest.onsuccess = (e) => {
                                    const supplier = e.target.result;
                                    if (supplier) {
                                        supplier.balance = (supplier.balance || 0) + purchase.total;
                                        supplier.lastTransaction = new Date().toISOString();
                                        const updateRequest = suppliersStore.put(supplier);
                                        updateRequest.onsuccess = () => {
                                            console.log(`โ ุชู ุชุญุฏูุซ ุฑุตูุฏ ุงูููุฑุฏ: ${supplier.balance}`);
                                        };
                                        updateRequest.onerror = (e) => {
                                            console.error('โ ูุดู ุชุญุฏูุซ ุฑุตูุฏ ุงูููุฑุฏ:', e.target.error);
                                        };
                                    }
                                };
                                
                                supplierRequest.onerror = (e) => {
                                    console.error('โ ูุดู ุฌูุจ ุจูุงูุงุช ุงูููุฑุฏ:', e.target.error);
                                };
                            }
                        })
                        .catch(error => {
                            console.error('โ ูุดู ุชุณุฌูู ุงููููุฏ ุงููุญุงุณุจูุฉ ููุดุฑุงุก:', error);
                            reject(error);
                        });
                };
                
                purchaseRequest.onerror = (e) => {
                    reject(new Error(`ูุดู ุญูุธ ูุงุชูุฑุฉ ุงูุดุฑุงุก: ${e.target.error}`));
                };
            });
        }

        /**
        * ุชุณุฌูู ุงููููุฏ ุงููุญุงุณุจูุฉ ููุดุฑุงุก ุฏุงุฎู ุงููุนุงููุฉ - ุงูุฅุตุฏุงุฑ ุงููุตุญุญ
        */
        async function recordPurchaseAccountingEntriesInTransaction(purchase, purchaseId, transaction) {
            return new Promise((resolve, reject) => {
                console.log('๐ฏ ุจุฏุก ุชุณุฌูู ุงููููุฏ ุงููุญุงุณุจูุฉ ุงููุตุญุญุฉ ููุดุฑุงุก...');
                
                const journalStore = transaction.objectStore('journalEntries');
                const coaStore = transaction.objectStore('chartOfAccounts');
                
                const supplierAccountCode = purchase.supplierAccount || '2010000';
                
                console.log('๐ ุงุณุชุฎุฏุงู ุญุณุงุจ ุงูููุฑุฏ:', supplierAccountCode);
                
                // ุญุณุงุจ ุงูุถุฑูุจุฉ ูุงูุฅุฌูุงููุงุช
                const taxAmount = purchase.tax || 0;
                const subtotal = purchase.subtotal;
                const total = purchase.total;
                const netPurchase = subtotal; // ุงููุดุชุฑูุงุช ุงูุตุงููุฉ ูุจู ุงูุถุฑูุจุฉ
                
                console.log('๐งฎ ุญุณุงุจุงุช ุงูุดุฑุงุก:', { 
                    subtotal, 
                    taxAmount, 
                    total,
                    netPurchase 
                });

                // โ ุงูููุฏ 1: ุงููุดุชุฑูุงุช ูุงูุถุฑูุจุฉ
                const purchaseDebits = [];
                const purchaseCredits = [];
                
                // ุงููุฏูู: ุงููุฎุฒูู (ุงููููุฉ ุงูุตุงููุฉ)
                purchaseDebits.push({ 
                    accountCode: '1030', // ุงููุฎุฒูู
                    amount: netPurchase,
                    description: `ุฒูุงุฏุฉ ุงููุฎุฒูู ูู ุงูุดุฑุงุก - ${purchase.supplierName} - ูุงุชูุฑุฉ ${purchase.invoiceNumber}`
                });
                
                // ุงููุฏูู: ุถุฑูุจุฉ ุงููุฏุฎูุงุช (ุฅุฐุง ูุฌุฏุช)
                if (taxAmount > 0) {
                    purchaseDebits.push({ 
                        accountCode: '4010', // ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ ุงููุงุจูุฉ ููุฎุตู
                        amount: taxAmount,
                        description: `ุถุฑูุจุฉ ูุฏุฎูุงุช - ${purchase.supplierName} - ูุงุชูุฑุฉ ${purchase.invoiceNumber}`
                    });
                }
                
                if (purchase.paymentMethod === 'cash') {
                    // ๐ฅ ุงูุดุฑุงุก ุงูููุฏู: ุงููุฎุฒูู + ุงูุถุฑูุจุฉ (ูุฏูู) โ ุงูุตูุฏูู (ุฏุงุฆู)
                    purchaseCredits.push({ 
                        accountCode: '1010', // ุงูุตูุฏูู
                        amount: total,
                        description: `ูุตุงุฑูู ููุฏูุฉ ููุดุฑุงุก - ${purchase.supplierName} - ูุงุชูุฑุฉ ${purchase.invoiceNumber}`
                    });
                } else {
                    // ๐ฅ ุงูุดุฑุงุก ุงูุขุฌู: ุงููุฎุฒูู + ุงูุถุฑูุจุฉ (ูุฏูู) โ ุงูููุฑุฏูู (ุฏุงุฆู)
                    purchaseCredits.push({ 
                        accountCode: supplierAccountCode, // ุญุณุงุจ ุงูููุฑุฏ ุงููุฑุฏู
                        amount: total,
                        description: `ุฐูู ููุฑุฏูู ุขุฌูุฉ - ${purchase.supplierName} - ูุงุชูุฑุฉ ${purchase.invoiceNumber}`
                    });
                }
                
                console.log('๐ ุงูููุฏ 1 - ุงููุดุชุฑูุงุช:');
                console.log('ุงููุฏูู:', purchaseDebits);
                console.log('ุงูุฏุงุฆู:', purchaseCredits);
                
                // ุงูุชุญูู ูู ุงูุชูุงุฒู
                const totalPurchaseDebit = purchaseDebits.reduce((sum, d) => sum + d.amount, 0);
                const totalPurchaseCredit = purchaseCredits.reduce((sum, c) => sum + c.amount, 0);
                const purchaseDifference = Math.abs(totalPurchaseDebit - totalPurchaseCredit);
                
                console.log('โ๏ธ ุงูุชุญูู ูู ุชูุงุฒู ููุฏ ุงููุดุชุฑูุงุช:', {
                    'ูุฌููุน ุงููุฏูู': totalPurchaseDebit,
                    'ูุฌููุน ุงูุฏุงุฆู': totalPurchaseCredit,
                    'ุงููุฑู': purchaseDifference
                });
                
                if (purchaseDifference > 0.01) {
                    const error = new Error(`ููุฏ ุงููุดุชุฑูุงุช ุบูุฑ ูุชูุงุฒู! ุงููุฏูู: ${totalPurchaseDebit}, ุงูุฏุงุฆู: ${totalPurchaseCredit}`);
                    console.error('โ', error.message);
                    reject(error);
                    return;
                }
                
                const purchaseEntry = {
                    date: new Date().toISOString(),
                    description: `ูุดุชุฑูุงุช ${purchase.invoiceNumber} - ${purchase.paymentMethod === 'credit' ? 'ุขุฌู' : 'ููุฏู'} - ${purchase.supplierName}`,
                    debits: purchaseDebits,
                    credits: purchaseCredits,
                    refType: 'Purchase',
                    refId: purchaseId,
                    balanced: true,
                    totalAmount: total,
                    createdAt: new Date().toISOString(),
                    auditInfo: {
                        userId: 'system',
                        timestamp: new Date().toISOString(),
                        ipAddress: 'localhost',
                        sessionId: 'purchase-process'
                    }
                };
                
                console.log('๐พ ุญูุธ ููุฏ ุงูุดุฑุงุก:', purchaseEntry);
                
                const purchaseRequest = journalStore.add(purchaseEntry);
                
                purchaseRequest.onsuccess = () => {
                    console.log('โ ุชู ุชุณุฌูู ููุฏ ุงูุดุฑุงุก ุจูุฌุงุญ');
                    
                    // ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช
                    updateAccountBalances(purchaseDebits, purchaseCredits, coaStore)
                        .then(() => {
                            console.log('โ ุชู ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุญุณุงุจุงุช ุงูุดุฑุงุก');
                            
                            // โ ุงูููุฏ 2: ุชุณููุฉ ุถุฑูุจุฉ ุงููุดุชุฑูุงุช (ุฅุฐุง ูุฌุฏุช)
                            if (taxAmount > 0) {
                                return recordPurchaseTaxReconciliation(purchase, purchaseId, transaction);
                            } else {
                                resolve();
                            }
                        })
                        .then(() => {
                            console.log('โ ุงูุชููุช ุฌููุน ุงููููุฏ ุงููุญุงุณุจูุฉ ููุดุฑุงุก');
                            resolve();
                        })
                        .catch(reject);
                };
                
                purchaseRequest.onerror = (e) => {
                    console.error('โ ูุดู ุชุณุฌูู ููุฏ ุงูุดุฑุงุก:', e.target.error);
                    reject(new Error(`ูุดู ุชุณุฌูู ููุฏ ุงูุดุฑุงุก: ${e.target.error}`));
                };
            });
        }

        /**
        * ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ ูู ูุงุชูุฑุฉ ุงูุดุฑุงุก
        */
        function addPurchaseItem() {
            const container = document.getElementById('purchaseItemsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'purchase-item row g-2 mb-2';
            newItem.innerHTML = `
                <div class="col-md-5">
                    <select class="form-select product-select" required>
                        <option value="">ุงุฎุชุฑ ุงูุตูู</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control quantity-input" placeholder="ุงููููุฉ" required min="1">
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control price-input" placeholder="ุณุนุฑ ุงูุดุฑุงุก" step="0.01" required min="0.01">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm remove-item-btn w-100">ุญุฐู</button>
                </div>
            `;
            container.appendChild(newItem);
            
            // ุชุญููู ุงูููุชุฌุงุช ูู ุงูุนูุตุฑ ุงูุฌุฏูุฏ
            loadProductsForPurchaseItem(newItem);
            
            // ุฅุถุงูุฉ ูุณุชูุนุงุช ุงูุฃุญุฏุงุซ ููุนูุตุฑ ุงูุฌุฏูุฏ
            const quantityInput = newItem.querySelector('.quantity-input');
            const priceInput = newItem.querySelector('.price-input');
            
            quantityInput.addEventListener('input', calculatePurchaseTotal);
            priceInput.addEventListener('input', calculatePurchaseTotal);
            
            // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฌูุงูู
            calculatePurchaseTotal();
        }

        /**
        * ุชุญููู ุงูููุชุฌุงุช ูุนูุตุฑ ุดุฑุงุก ูุญุฏุฏ
        */
        async function loadProductsForPurchaseItem(itemElement) {
            try {
                const products = await getAllProducts();
                const select = itemElement.querySelector('.product-select');
                
                select.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุตูู</option>';
                
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (${product.code}) - ${product.quantity} ูุชููุฑ`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('ูุดู ุชุญููู ุงูููุชุฌุงุช:', error);
            }
        }

        /**
        * ุญุณุงุจ ุฅุฌูุงูู ูุงุชูุฑุฉ ุงูุดุฑุงุก
        */
        function calculatePurchaseTotal() {
            let total = 0;
            document.querySelectorAll('.purchase-item').forEach(item => {
                const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(item.querySelector('.price-input').value) || 0;
                total += quantity * price;
            });
            document.getElementById('purchaseTotal').value = total.toFixed(2);
        }

        /**
        * ุงูุชุญูู ูู ุตุญุฉ ูุงุชูุฑุฉ ุงูุจูุน ูุจู ุงูุญูุธ
        */
        function validateInvoiceData(invoice) {
            const errors = [];
            
            if (!invoice.items || invoice.items.length === 0) {
                errors.push('ุงููุงุชูุฑุฉ ูุฌุจ ุฃู ุชุญุชูู ุนูู ุฃุตูุงู');
            }
            
            if (invoice.total <= 0) {
                errors.push('ุฅุฌูุงูู ุงููุงุชูุฑุฉ ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู ุงูุตูุฑ');
            }
            
            
            if (invoice.paymentMethod === 'credit' && !invoice.customerId) {
                errors.push('ูุฌุจ ุงุฎุชูุงุฑ ุนููู ููููุงุชูุฑ ุงูุขุฌูุฉ');
            }
            
            return errors;
        }

        /**
        * ุงูุชุญูู ูู ุตุญุฉ ูุงุชูุฑุฉ ุงูุดุฑุงุก ูุจู ุงูุญูุธ
        */
        function validatePurchaseData(purchase) {
            const errors = [];
            
            if (!purchase.items || purchase.items.length === 0) {
                errors.push('ูุงุชูุฑุฉ ุงูุดุฑุงุก ูุฌุจ ุฃู ุชุญุชูู ุนูู ุฃุตูุงู');
            }
            
            if (purchase.total <= 0) {
                errors.push('ุฅุฌูุงูู ูุงุชูุฑุฉ ุงูุดุฑุงุก ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู ุงูุตูุฑ');
            }
            
            if (!purchase.supplierId) {
                errors.push('ูุฌุจ ุงุฎุชูุงุฑ ููุฑุฏ');
            }
            
            // ุงูุชุญูู ูู ุฃู ุงูุฅุฌูุงูู ูุณุงูู ูุฌููุน ุงูุฃุตูุงู
            const calculatedTotal = purchase.items.reduce((sum, item) => sum + item.total, 0);
            if (Math.abs(purchase.total - calculatedTotal) > 0.01) {
                errors.push('ุฅุฌูุงูู ุงููุงุชูุฑุฉ ูุง ูุชุทุงุจู ูุน ูุฌููุน ุงูุฃุตูุงู');
            }
            
            return errors;
        }

        /**
        * ุชุญููู ุฌุฏูู ููุงุชูุฑ ุงูุดุฑุงุก
        */
        async function loadPurchasesTable() {
            try {
                const transaction = db.transaction(['purchaseInvoices'], 'readonly');
                const store = transaction.objectStore('purchaseInvoices');
                const request = store.getAll();
                
                request.onsuccess = function() {
                    const purchases = request.result;
                    const tbody = document.getElementById('purchasesTableBody');
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    if (purchases.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ูุง ุชูุฌุฏ ููุงุชูุฑ ุดุฑุงุก ูุณุฌูุฉ.</td></tr>';
                        return;
                    }
                    
                    purchases.forEach(purchase => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${purchase.id}</td>
                            <td>${suppliers.find(s => s.id === purchase.supplierId)?.name || 'ุบูุฑ ูุนุฑูู'}</td>
                            <td>${new Date(purchase.date).toLocaleDateString('ar-YE')}</td>
                            <td>${purchase.total.toFixed(2)} ุฑ.ู</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info view-purchase-btn" data-id="${purchase.id}">ุนุฑุถ</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                };
            } catch (error) {
                console.error('ูุดู ุชุญููู ููุงุชูุฑ ุงูุดุฑุงุก:', error);
            }
        }

        /**
        * ุชูููุฏ ููุฒุงู ุงููุฑุงุฌุนุฉ - ุงูุฅุตุฏุงุฑ ุงููุตุญุญ
        */
        async function generateTrialBalance(startDate, endDate) {
            try {
                const accounts = await new Promise((resolve) => {
                    const transaction = db.transaction(['chartOfAccounts'], 'readonly');
                    const store = transaction.objectStore('chartOfAccounts');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                });

                const journalEntries = await new Promise((resolve) => {
                    const transaction = db.transaction(['journalEntries'], 'readonly');
                    const store = transaction.objectStore('journalEntries');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                });

                // ุชุตููุฉ ุงููููุฏ ุญุณุจ ุงูุชุงุฑูุฎ
                const filteredEntries = journalEntries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    return (!startDate || entryDate >= new Date(startDate)) && 
                        (!endDate || entryDate <= new Date(endDate));
                });

                // ุญุณุงุจ ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช
                const accountBalances = {};
                
                accounts.forEach(account => {
                    if (account.type !== 'header') {
                        accountBalances[account.code] = {
                            code: account.code,
                            name: account.name,
                            type: account.type,
                            debit: 0,
                            credit: 0,
                            balance: account.balance || 0
                        };
                    }
                });

                // ุชุฌููุน ุงูุญุฑูุงุช
                filteredEntries.forEach(entry => {
                    entry.debits.forEach(debit => {
                        if (accountBalances[debit.accountCode]) {
                            accountBalances[debit.accountCode].debit += debit.amount;
                        }
                    });
                    
                    entry.credits.forEach(credit => {
                        if (accountBalances[credit.accountCode]) {
                            accountBalances[credit.accountCode].credit += credit.amount;
                        }
                    });
                });

                // ุชุญููู ุฅูู ูุตูููุฉ ูุญุณุงุจ ุงูุฃุฑุตุฏุฉ ุงูููุงุฆูุฉ
                const trialBalance = Object.values(accountBalances).map(account => {
                    let finalBalance = 0;
                    
                    if (account.type === 'asset' || account.type === 'expense') {
                        finalBalance = account.balance + account.debit - account.credit;
                    } else {
                        finalBalance = account.balance + account.credit - account.debit;
                    }
                    
                    return {
                        ...account,
                        finalBalance: Math.abs(finalBalance),
                        balanceType: (account.type === 'asset' || account.type === 'expense') ? 'debit' : 'credit'
                    };
                });

                // ุงูุชุญูู ูู ุชูุงุฒู ุงูููุฒุงู
                const totalDebits = trialBalance
                    .filter(acc => acc.balanceType === 'debit')
                    .reduce((sum, acc) => sum + acc.finalBalance, 0);
                    
                const totalCredits = trialBalance
                    .filter(acc => acc.balanceType === 'credit')
                    .reduce((sum, acc) => sum + acc.finalBalance, 0);
                    
                const difference = Math.abs(totalDebits - totalCredits);

                return {
                    trialBalance,
                    totals: {
                        totalDebits,
                        totalCredits,
                        difference,
                        isBalanced: difference < 0.01
                    },
                    period: {
                        startDate,
                        endDate,
                        generatedAt: new Date().toISOString()
                    }
                };

            } catch (error) {
                console.error('โ ูุดู ุชูููุฏ ููุฒุงู ุงููุฑุงุฌุนุฉ:', error);
                throw error;
            }
        }

        /**
        * ุชูููุฏ ูุงุฆูุฉ ุงูุฏุฎู - ุงูุฅุตุฏุงุฑ ุงููุตุญุญ
        */
        async function generateIncomeStatement(startDate, endDate) {
            try {
                const trialBalance = await generateTrialBalance(startDate, endDate);
                
                const revenues = trialBalance.trialBalance
                    .filter(acc => acc.type === 'revenue')
                    .reduce((sum, acc) => sum + acc.finalBalance, 0);
                    
                const cogs = trialBalance.trialBalance
                    .filter(acc => acc.code === '3020')
                    .reduce((sum, acc) => sum + acc.finalBalance, 0);
                    
                const operatingExpenses = trialBalance.trialBalance
                    .filter(acc => acc.type === 'expense' && acc.code !== '3020')
                    .reduce((sum, acc) => sum + acc.finalBalance, 0);

                const grossProfit = revenues - cogs;
                const netIncome = grossProfit - operatingExpenses;

                return {
                    period: {
                        startDate,
                        endDate,
                        generatedAt: new Date().toISOString()
                    },
                    revenues: {
                        total: revenues,
                        accounts: trialBalance.trialBalance.filter(acc => acc.type === 'revenue')
                    },
                    costOfGoodsSold: {
                        total: cogs,
                        accounts: trialBalance.trialBalance.filter(acc => acc.code === '3020')
                    },
                    grossProfit: grossProfit,
                    operatingExpenses: {
                        total: operatingExpenses,
                        accounts: trialBalance.trialBalance.filter(acc => acc.type === 'expense' && acc.code !== '3020')
                    },
                    netIncome: netIncome,
                    summary: {
                        grossMargin: revenues > 0 ? (grossProfit / revenues) * 100 : 0,
                        netMargin: revenues > 0 ? (netIncome / revenues) * 100 : 0
                    }
                };

            } catch (error) {
                console.error('โ ูุดู ุชูููุฏ ูุงุฆูุฉ ุงูุฏุฎู:', error);
                throw error;
            }
        }

        /**
        * ุชูููุฏ ุงูููุฒุงููุฉ ุงูุนููููุฉ - ุงูุฅุตุฏุงุฑ ุงููุตุญุญ
        */
        async function generateBalanceSheet(asOfDate) {
            try {
                const trialBalance = await generateTrialBalance(null, asOfDate);
                
                const assets = trialBalance.trialBalance
                    .filter(acc => acc.type === 'asset')
                    .reduce((sum, acc) => sum + acc.finalBalance, 0);
                    
                const liabilities = trialBalance.trialBalance
                    .filter(acc => acc.type === 'liability')
                    .reduce((sum, acc) => sum + acc.finalBalance, 0);
                    
                const equity = trialBalance.trialBalance
                    .filter(acc => acc.type === 'equity')
                    .reduce((sum, acc) => sum + acc.finalBalance, 0);

                // ุญุณุงุจ ุตุงูู ุงูุฏุฎู ูู ุจุฏุงูุฉ ุงููุชุฑุฉ
                const incomeStatement = await generateIncomeStatement(
                    new Date(new Date(asOfDate).getFullYear(), 0, 1).toISOString().split('T')[0],
                    asOfDate
                );

                const totalEquity = equity + incomeStatement.netIncome;
                const totalLiabilitiesAndEquity = liabilities + totalEquity;

                return {
                    asOfDate,
                    generatedAt: new Date().toISOString(),
                    assets: {
                        total: assets,
                        accounts: trialBalance.trialBalance.filter(acc => acc.type === 'asset')
                    },
                    liabilities: {
                        total: liabilities,
                        accounts: trialBalance.trialBalance.filter(acc => acc.type === 'liability')
                    },
                    equity: {
                        total: totalEquity,
                        accounts: trialBalance.trialBalance.filter(acc => acc.type === 'equity'),
                        netIncome: incomeStatement.netIncome
                    },
                    validation: {
                        assets: assets,
                        liabilitiesAndEquity: totalLiabilitiesAndEquity,
                        isBalanced: Math.abs(assets - totalLiabilitiesAndEquity) < 0.01,
                        difference: Math.abs(assets - totalLiabilitiesAndEquity)
                    }
                };

            } catch (error) {
                console.error('โ ูุดู ุชูููุฏ ุงูููุฒุงููุฉ ุงูุนููููุฉ:', error);
                throw error;
            }
        }



        // ==================== 4.9. ุฅุฏุงุฑุฉ ุงููุฆุงุช ูุงูุญุฑูุงุช ====================
        /**
        * ูุชุญ ูููุฐุฌ ุฅุถุงูุฉ/ุชุนุฏูู ูุฆุฉ
        */
        function openCategoryModal(categoryId = null) {
            const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
            const form = document.getElementById('categoryForm');
            
            if (categoryId) {
                document.getElementById('categoryModalLabel').textContent = 'ุชุนุฏูู ุงููุฆุฉ';
                
                const category = categories.find(c => c.id === parseInt(categoryId));
                if (category) {
                    document.getElementById('categoryName').value = category.name;
                    document.getElementById('categoryDescription').value = category.description || '';
                }
            } else {
                document.getElementById('categoryModalLabel').textContent = 'ุฅุถุงูุฉ ูุฆุฉ ุฌุฏูุฏุฉ';
                form.reset();
            }
            
            modal.show();
        }

        /**
        * ุชุญููู ุดุฑูุท ุงููุฆุงุช ูู ููุทุฉ ุงูุจูุน - ุงูุฅุตุฏุงุฑ ุงููุนุฏู
        */
        async function loadCategoriesBar() {
            const categoriesBar = document.getElementById('categoriesBar');
            if (!categoriesBar) return;

            try {
                const transaction = db.transaction(['categories'], 'readonly');
                const store = transaction.objectStore('categories');
                const request = store.getAll();

                request.onsuccess = function() {
                    const categories = request.result;
                    
                    // ุฅุฒุงูุฉ ุงููุฆุงุช ุงููุฏููุฉ (ุจุงุณุชุซูุงุก ุฒุฑ "ุงููู")
                    const existingItems = categoriesBar.querySelectorAll('.suggestion-item:not([data-category-id="all"])');
                    existingItems.forEach(item => item.remove());

                    categories.forEach(category => {
                        const categoryItem = document.createElement('button');
                        categoryItem.className = 'suggestion-item';
                        categoryItem.dataset.categoryId = category.id;
                        categoryItem.onclick = () => {
                            // ุฅุฒุงูุฉ ุงูุชุญุฏูุฏ ูู ุฌููุน ุงูุฃุฒุฑุงุฑ
                            categoriesBar.querySelectorAll('.suggestion-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            // ุชุญุฏูุฏ ุงูุฒุฑ ุงูุฌุฏูุฏ
                            categoryItem.classList.add('active');
                            loadProductsGrid(category.id);
                        };

                        categoryItem.innerHTML = `
                            <span class="suggestion-name">${category.name}</span>
                        `;
                        categoriesBar.appendChild(categoryItem);
                    });
                };
            } catch (error) {
                console.error('ูุดู ุชุญููู ุดุฑูุท ุงููุฆุงุช:', error);
            }
        }

        async function loadProductsGrid(categoryId = null) {
            try {
                const products = await getAllProducts();
                const productsGrid = document.getElementById('productsGrid');
                if (!productsGrid) return;
                
                productsGrid.innerHTML = '';
                
                // ุชุตููุฉ ุงูููุชุฌุงุช ุญุณุจ ุงููุฆุฉ
                let filteredProducts = products;
                if (categoryId && categoryId !== 'all') {
                    filteredProducts = products.filter(product => product.categoryId == categoryId);
                }
                
                if (filteredProducts.length === 0) {
                    productsGrid.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <i class="bi bi-info-circle"></i>
                                ูุง ุชูุฌุฏ ููุชุฌุงุช ูู ูุฐู ุงููุฆุฉ.
                            </div>
                        </div>
                    `;
                    return;
                }

                filteredProducts.forEach(product => {
                    const cartItem = currentCart.find(item => item.id === product.id);
                    const quantityInCart = cartItem ? cartItem.quantity : 0;
                    
                    // ุงุณุชุฎุฏุงู ุงูุตูุฑุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉุ ูุฅูุง ุงุณุชุฎุฏุงู ุงูุฅูููุฌู
                    let imageContent = '';
                    if (product.imageData) {
                        imageContent = `
                            <div class="product-image-container">
                                <img src="${product.imageData}" alt="${product.name}" 
                                    class="product-image-real"
                                    onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\\'product-emoji-placeholder\\'>${product.image || '๐ฆ'}</div>';">
                            </div>
                        `;
                    } else {
                        imageContent = `
                            <div class="product-image-container">
                                <div class="product-emoji-placeholder">
                                    ${product.image || '๐ฆ'}
                                </div>
                            </div>
                        `;
                    }
                    
                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-4 col-lg-3 mb-3';
                    col.innerHTML = `
                        <div class="product-card ${quantityInCart > 0 ? 'added' : ''}" 
                            data-product-id="${product.id}" 
                            data-product-price="${product.salePrice}" 
                            data-product-cost="${product.purchasePrice}">
                            
                            ${quantityInCart > 0 ? `<div class="quantity-badge">${quantityInCart}</div>` : ''}
                            
                            ${imageContent}
                            
                            <div class="product-info">
                                <div>
                                    <div class="product-name">${product.name}</div>
                                    <div class="product-code">${product.code}</div>
                                </div>
                                
                                <div class="product-details">
                                    <span class="product-price">${product.salePrice.toFixed(2)} ุฑ.ู</span>
                                    <span class="product-stock badge ${product.quantity > (product.minQuantity || 5) ? 'bg-success' : 'bg-danger'}">
                                        ${product.quantity}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // ุฅุถุงูุฉ ุญุฏุซ ุงูููุฑ
                    col.addEventListener('click', () => {
                        addToCart(product.id, product.name, product.salePrice, product.purchasePrice);
                    });
                    
                    productsGrid.appendChild(col);
                });
                
            } catch(error) {
                console.error('ูุดู ุชุญููู ุงูููุชุฌุงุช:', error);
                const productsGrid = document.getElementById('productsGrid');
                if (productsGrid) {
                    productsGrid.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger text-center">
                                <i class="bi bi-exclamation-triangle"></i>
                                ูุดู ูู ุชุญููู ุงูููุชุฌุงุช.
                            </div>
                        </div>
                    `;
                }
            }
        }
    
        /**
        * ุญูุธ ุงููุฆุฉ
        */
        async function saveCategory() {
            const form = document.getElementById('categoryForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const category = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value,
                icon: '๐' // ูููู ุฅุถุงูุฉ ุญูู ููุฃููููุฉ ูุงุญูุงู
            };

            try {
                const transaction = db.transaction(['categories'], 'readwrite');
                const store = transaction.objectStore('categories');
                const request = store.add(category);
                
                request.onsuccess = () => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('categoryModal'));
                    modal.hide();
                    loadCategoriesTable();
                    loadCategories(); // ุชุญุฏูุซ ูุตูููุฉ ุงููุฆุงุช
                    loadCategoriesBar(); // โญ ุชุญุฏูุซ ุดุฑูุท ุงููุฆุงุช ูู ููุทุฉ ุงูุจูุน
                    alert('ุชู ุญูุธ ุงููุฆุฉ ุจูุฌุงุญ!');
                };
            } catch (error) {
                console.error('ูุดู ุญูุธ ุงููุฆุฉ:', error);
                alert('ูุดู ุญูุธ ุงููุฆุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        }

        /**
        * ุชุญููู ุฌุฏูู ุงููุฆุงุช
        */
        async function loadCategoriesTable() {
            try {
                const categories = await loadCategories();
                const tbody = document.getElementById('categoriesTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (categories.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ูุง ุชูุฌุฏ ูุฆุงุช ูุณุฌูุฉ.</td></tr>';
                    return;
                }
                
                // ุฌูุจ ุนุฏุฏ ุงูููุชุฌุงุช ูู ูู ูุฆุฉ
                const products = await getAllProducts();
                
                categories.forEach(category => {
                    const productCount = products.filter(p => p.categoryId === category.id).length;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${category.name}</td>
                        <td>${category.description || '-'}</td>
                        <td>${productCount}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-category-btn" data-id="${category.id}">ุชุนุฏูู</button>
                            <button class="btn btn-sm btn-outline-danger delete-category-btn" data-id="${category.id}">ุญุฐู</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('ูุดู ุชุญููู ุฌุฏูู ุงููุฆุงุช:', error);
            }
        }

        /**
        * ุชุญููู ูุงุฆูุฉ ุงูููุชุฌุงุช ูุชุจููุจ ุงูุญุฑูุงุช
        */
        async function loadMovementsProductSelect() {
            try {
                const products = await getAllProducts();
                const select = document.getElementById('movementProductSelect');
                if (!select) return;
                
                select.innerHTML = '<option value="">ุงุฎุชุฑ ููุชุฌ ูุนุฑุถ ุญุฑูุงุชู</option>';
                
                products.forEach(product => {
                    select.innerHTML += `<option value="${product.id}">${product.name} (${product.code})</option>`;
                });
                
                // ุฅุถุงูุฉ ูุณุชูุน ุงูุญุฏุซ
                select.addEventListener('change', function() {
                    if (this.value) {
                        loadProductMovements(parseInt(this.value));
                    } else {
                        const movementsTableBody = document.getElementById('movementsTableBody');
                        if (movementsTableBody) {
                            movementsTableBody.innerHTML = '';
                        }
                    }
                });
            } catch (error) {
                console.error('ูุดู ุชุญููู ูุงุฆูุฉ ุงูููุชุฌุงุช ููุญุฑูุงุช:', error);
            }
        }

        /**
        * ุชุญููู ุญุฑูุงุช ููุชุฌ ูุญุฏุฏ
        */
        async function loadProductMovements(productId) {
            try {
                const [invoices, purchases] = await Promise.all([
                    getAllInvoices(),
                    new Promise((resolve) => {
                        const transaction = db.transaction(['purchaseInvoices'], 'readonly');
                        const store = transaction.objectStore('purchaseInvoices');
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                    })
                ]);

                const movements = [];
                
                // ุญุฑูุงุช ุงููุจูุนุงุช (ุฎุฑูุฌ)
                invoices.forEach(invoice => {
                    if (invoice.items) {
                        invoice.items.forEach(item => {
                            if (item.id === productId) {
                                movements.push({
                                    date: invoice.date,
                                    type: 'ุจูุน',
                                    quantity: -item.quantity,
                                    price: item.price,
                                    reference: `ูุงุชูุฑุฉ ${invoice.invoiceNumber}`
                                });
                            }
                        });
                    }
                });
                
                // ุญุฑูุงุช ุงููุดุชุฑูุงุช (ุฏุฎูู)
                purchases.forEach(purchase => {
                    if (purchase.items) {
                        purchase.items.forEach(item => {
                            if (item.productId === productId) {
                                movements.push({
                                    date: purchase.date,
                                    type: 'ุดุฑุงุก',
                                    quantity: item.quantity,
                                    price: item.price,
                                    reference: `ุดุฑุงุก ${purchase.id}`
                                });
                            }
                        });
                    }
                });
                
                // ุชุฑุชูุจ ุงูุญุฑูุงุช ุญุณุจ ุงูุชุงุฑูุฎ
                movements.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // ุนุฑุถ ุงูุญุฑูุงุช
                const tbody = document.getElementById('movementsTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (movements.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ูุง ุชูุฌุฏ ุญุฑูุงุช ููุฐุง ุงูููุชุฌ.</td></tr>';
                    return;
                }
                
                movements.forEach(movement => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(movement.date).toLocaleDateString('ar-YE')}</td>
                        <td>
                            <span class="badge ${movement.type === 'ุจูุน' ? 'bg-danger' : 'bg-success'}">
                                ${movement.type}
                            </span>
                        </td>
                        <td>${movement.quantity > 0 ? '+' : ''}${movement.quantity}</td>
                        <td>${movement.price.toFixed(2)} ุฑ.ู</td>
                        <td>${movement.reference}</td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('ูุดู ุชุญููู ุญุฑูุงุช ุงูููุชุฌ:', error);
            }
        }
        // ==================== 4.10. ุฏูุงู ุฅุฏุงุฑุฉ ุงูุตูุฏูู ุงููุงููุฉ ====================
        /**
        * ูุชุญ ูููุฐุฌ ุงูุนูููุฉ ุงูููุฏูุฉ
        */
        function openCashOperationModal(operationType) {
            const modal = new bootstrap.Modal(document.getElementById('cashOperationModal'));
            document.getElementById('cashOperationType').value = operationType;
            
            // ุชุฎุตูุต ุงููุงุฌูุฉ ุญุณุจ ููุน ุงูุนูููุฉ
            const titleMap = {
                'deposit': 'ุฅูุฏุงุน ููุฏู',
                'withdraw': 'ุณุญุจ ููุฏู', 
                'transfer': 'ุชุญููู ุจูู ุงูุญุณุงุจุงุช'
            };
            
            document.getElementById('cashOperationModalLabel').textContent = titleMap[operationType];
            
            // ุฅุธูุงุฑ/ุฅุฎูุงุก ุญูู ุงูุญุณุงุจ ุงููุณุชูุฏู
            const accountContainer = document.getElementById('cashAccountContainer');
            accountContainer.style.display = operationType === 'transfer' ? 'block' : 'none';
            
            modal.show();
        }

        /**
        * ุชูููุฐ ุงูุนูููุฉ ุงูููุฏูุฉ
        */
        async function executeCashOperation() {
            const operationType = document.getElementById('cashOperationType').value;
            const amount = parseFloat(document.getElementById('cashAmount').value);
            const description = document.getElementById('cashDescription').value;
            const targetAccount = document.getElementById('cashAccount').value;

            if (!amount || amount <= 0) {
                alert('ูุฑุฌู ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ');
                return;
            }

            try {
                let debits = [];
                let credits = [];
                let journalDescription = '';

                switch(operationType) {
                    case 'deposit':
                        // ุงูุฅูุฏุงุน: ุฒูุงุฏุฉ ุงูุตูุฏูู ูุฒูุงุฏุฉ ุฑุฃุณ ุงููุงู
                        debits = [{ accountCode: '1010', amount: amount }];
                        credits = [{ accountCode: '2020', amount: amount }];
                        journalDescription = `ุฅูุฏุงุน ููุฏู: ${description}`;
                        break;
                        
                    case 'withdraw':
                        // ุงูุณุญุจ: ููุตุงู ุงูุตูุฏูู ูุฒูุงุฏุฉ ุงููุตุฑููุงุช
                        debits = [{ accountCode: '3030', amount: amount }];
                        credits = [{ accountCode: '1010', amount: amount }];
                        journalDescription = `ุณุญุจ ููุฏู: ${description}`;
                        break;
                        
                    case 'transfer':
                        // ุงูุชุญููู: ููุตุงู ุงูุตูุฏูู ูุฒูุงุฏุฉ ุงูุจูู
                        debits = [{ accountCode: targetAccount, amount: amount }];
                        credits = [{ accountCode: '1010', amount: amount }];
                        journalDescription = `ุชุญููู ููุฏู: ${description}`;
                        break;
                }

                // ุชุณุฌูู ุงูููุฏ ุงููุญุงุณุจู
                await createJournalEntry(journalDescription, debits, credits, 'CashOperation', null);
                
                // ุชุณุฌูู ุญุฑูุฉ ุงูุตูุฏูู
                const transaction = db.transaction(['cashTransactions'], 'readwrite');
                const store = transaction.objectStore('cashTransactions');
                
                const cashTransaction = {
                    date: new Date().toISOString(),
                    type: operationType === 'deposit' ? 'Deposit' : 
                        operationType === 'withdraw' ? 'Withdraw' : 'Transfer',
                    amount: operationType === 'withdraw' ? -amount : amount,
                    reference: description
                };
                
                store.add(cashTransaction);

                const modal = bootstrap.Modal.getInstance(document.getElementById('cashOperationModal'));
                modal.hide();
                
                alert('ุชู ุชูููุฐ ุงูุนูููุฉ ุงูููุฏูุฉ ุจูุฌุงุญ!');
                updateBalance();
                loadCashTransactions();

            } catch (error) {
                console.error('ูุดู ุชูููุฐ ุงูุนูููุฉ ุงูููุฏูุฉ:', error);
                alert('ูุดู ุชูููุฐ ุงูุนูููุฉ: ' + error.message);
            }
        }

        /**
        * ุชุญููู ุญุฑูุงุช ุงูุตูุฏูู
        */
        async function loadCashTransactions() {
            try {
                const transactions = await getAllCashTransactions();
                const tbody = document.getElementById('cashTransactionsTable');
                if (!tbody) return;

                tbody.innerHTML = '';

                if (transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ูุง ุชูุฌุฏ ุญุฑูุงุช ูุณุฌูุฉ.</td></tr>';
                    return;
                }

                // ุชุฑุชูุจ ุงูุญุฑูุงุช ูู ุงูุฃุญุฏุซ ุฅูู ุงูุฃูุฏู
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                transactions.forEach(trans => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(trans.date).toLocaleDateString('ar-YE')}</td>
                        <td>
                            <span class="badge ${
                                trans.type === 'Sale' ? 'bg-success' :
                                trans.type === 'Deposit' ? 'bg-info' :
                                trans.type === 'Withdraw' ? 'bg-danger' :
                                trans.type === 'Transfer' ? 'bg-warning' : 'bg-secondary'
                            }">
                                ${trans.type === 'Sale' ? 'ุจูุน' :
                                trans.type === 'Deposit' ? 'ุฅูุฏุงุน' :
                                trans.type === 'Withdraw' ? 'ุณุญุจ' :
                                trans.type === 'Transfer' ? 'ุชุญููู' : trans.type}
                            </span>
                        </td>
                        <td class="${trans.amount < 0 ? 'text-danger' : 'text-success'}">
                            ${trans.amount > 0 ? '+' : ''}${trans.amount.toFixed(2)} ุฑ.ู
                        </td>
                        <td>${trans.reference}</td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('ูุดู ุชุญููู ุญุฑูุงุช ุงูุตูุฏูู:', error);
            }
        }

        /**
        * ุฅููุงู ุงููุฑุฏูุฉ ูุนูู ุชุณููุฉ
        */
        async function closeShift() {
            if (!confirm('ูู ุชุฑูุฏ ุฅููุงู ุงููุฑุฏูุฉ ุงูุญุงููุฉ ูุนูู ุชุณููุฉุ')) {
                return;
            }

            try {
                // ุฌูุจ ุญุฑูุงุช ุงูููู
                const today = new Date().toDateString();
                const cashTransactions = await getAllCashTransactions();
                const todayTransactions = cashTransactions.filter(trans => 
                    new Date(trans.date).toDateString() === today
                );

                // ุญุณุงุจ ุงูุฅุฌูุงูู
                const totalDeposits = todayTransactions
                    .filter(trans => trans.type === 'Deposit')
                    .reduce((sum, trans) => sum + trans.amount, 0);
                    
                const totalWithdrawals = todayTransactions
                    .filter(trans => trans.type === 'Withdraw')
                    .reduce((sum, trans) => sum + Math.abs(trans.amount), 0);
                    
                const totalSales = todayTransactions
                    .filter(trans => trans.type === 'Sale')
                    .reduce((sum, trans) => sum + trans.amount, 0);

                const netAmount = totalDeposits + totalSales - totalWithdrawals;

                // ุนุฑุถ ุชูุฑูุฑ ุงููุฑุฏูุฉ
                const report = `
        ุฅููุงู ุงููุฑุฏูุฉ - ${new Date().toLocaleDateString('ar-YE')}

        ุฅุฌูุงูู ุงูุฅูุฏุงุนุงุช: ${totalDeposits.toFixed(2)} ุฑ.ู
        ุฅุฌูุงูู ุงููุณุญูุจุงุช: ${totalWithdrawals.toFixed(2)} ุฑ.ู
        ุฅุฌูุงูู ุงููุจูุนุงุช: ${totalSales.toFixed(2)} ุฑ.ู
        ุตุงูู ุงูุญุฑูุงุช: ${netAmount.toFixed(2)} ุฑ.ู

        ูู ุชุฑูุฏ ุญูุธ ูุฐุง ุงูุชูุฑูุฑุ
                `;

                if (confirm(report)) {
                    // ูููู ุญูุธ ุงูุชูุฑูุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃู ุทุจุงุนุชู
                    alert('ุชู ุฅููุงู ุงููุฑุฏูุฉ ุจูุฌุงุญ!');
                }

            } catch (error) {
                console.error('ูุดู ุฅููุงู ุงููุฑุฏูุฉ:', error);
                alert('ูุดู ุฅููุงู ุงููุฑุฏูุฉ: ' + error.message);
            }
        }
        // ==================== 4.11. ุฏูุงู ุงููุญุงุณุจุฉ ุงููุงููุฉ ====================
        /**
        * ูุชุญ ูููุฐุฌ ุงูููุฏ ุงููุฏูู
        */
        function openJournalEntryModal() {
            const modal = new bootstrap.Modal(document.getElementById('journalEntryModal'));
            
            // ุชุญููู ูุงุฆูุฉ ุงูุญุณุงุจุงุช
            loadAccountOptions();
            
            // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ
            document.getElementById('journalEntryForm').reset();
            
            // ุฅุนุงุฏุฉ ุชุนููู ุงูุญููู
            document.getElementById('debitEntriesContainer').innerHTML = `
                <div class="debit-entry row g-2 mb-2">
                    <div class="col-md-8">
                        <select class="form-select debit-account-select" required>
                            <option value="">ุงุฎุชุฑ ุงูุญุณุงุจ</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="number" class="form-control debit-amount" placeholder="ุงููุจูุบ" step="0.01" required>
                    </div>
                </div>
            `;
            
            document.getElementById('creditEntriesContainer').innerHTML = `
                <div class="credit-entry row g-2 mb-2">
                    <div class="col-md-8">
                        <select class="form-select credit-account-select" required>
                            <option value="">ุงุฎุชุฑ ุงูุญุณุงุจ</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="number" class="form-control credit-amount" placeholder="ุงููุจูุบ" step="0.01" required>
                    </div>
                </div>
            `;
            
            // ุฅุนุงุฏุฉ ุชุญููู ุฎูุงุฑุงุช ุงูุญุณุงุจุงุช
            setTimeout(() => {
                loadAccountOptions();
                calculateJournalEntryTotals();
            }, 500);
            
            modal.show();
        }

        /**
        * ุชุญููู ุฎูุงุฑุงุช ุงูุญุณุงุจุงุช ูู ุงููููุฐุฌ
        */
        async function loadAccountOptions() {
            try {
                const transaction = db.transaction(['chartOfAccounts'], 'readonly');
                const store = transaction.objectStore('chartOfAccounts');
                const request = store.getAll();
                
                request.onsuccess = function() {
                    const accounts = request.result;
                    
                    // โ ุงูุชุตุญูุญ: ุชุตููุฉ ุงูุญุณุงุจุงุช ุงููุดุทุฉ ููุท
                    const activeAccounts = accounts.filter(acc => 
                        acc.isActive !== false && // ุงูุญุณุงุจุงุช ุงููุดุทุฉ ููุท
                        acc.type !== 'header' // ุงุณุชุจุนุงุฏ ุงูุญุณุงุจุงุช ุงูุฑุฃุณูุฉ
                    );
                    
                    // โ ุงูุชุตุญูุญ: ุชุตููู ุงูุญุณุงุจุงุช ุจุดูู ุตุญูุญ
                    const mainAccounts = activeAccounts.filter(acc => 
                        !acc.customerId && !acc.supplierId
                    );
                    
                    const customerAccounts = activeAccounts.filter(acc => 
                        acc.customerId && acc.accountType === 'customer'
                    );
                    
                    const supplierAccounts = activeAccounts.filter(acc => 
                        acc.supplierId && acc.accountType === 'supplier'
                    );
                    
                    const debitSelects = document.querySelectorAll('.debit-account-select');
                    const creditSelects = document.querySelectorAll('.credit-account-select');
                    
                    // ุจูุงุก HTML ููุฎูุงุฑุงุช ูุน ูุฌููุนุงุช
                    let optionsHTML = '';
                    
                    // ุงูุญุณุงุจุงุช ุงูุฑุฆูุณูุฉ
                    if (mainAccounts.length > 0) {
                        optionsHTML += '<optgroup label="๐ ุงูุญุณุงุจุงุช ุงูุฑุฆูุณูุฉ">';
                        mainAccounts.forEach(acc => {
                            const balanceText = acc.balance !== undefined ? ` (${acc.balance.toFixed(2)} ุฑ.ู)` : '';
                            optionsHTML += `<option value="${acc.code}" data-type="${acc.type}">${acc.code} - ${acc.name}${balanceText}</option>`;
                        });
                        optionsHTML += '</optgroup>';
                    }
                    
                    // ุญุณุงุจุงุช ุงูุนููุงุก - ุงูุฐูู ุงููุฏููุฉ
                    if (customerAccounts.length > 0) {
                        optionsHTML += '<optgroup label="๐ฅ ุงูุนููุงุก - ุงูุฐูู ุงููุฏููุฉ">';
                        customerAccounts.forEach(acc => {
                            const balanceText = acc.balance !== undefined ? ` (${acc.balance.toFixed(2)} ุฑ.ู)` : '';
                            optionsHTML += `<option value="${acc.code}" data-type="customer" data-customer-id="${acc.customerId}">${acc.code} - ${acc.name}${balanceText}</option>`;
                        });
                        optionsHTML += '</optgroup>';
                    } else {
                        // โ ุฅุถุงูุฉ ุญุณุงุจ ุงูุนููู ุงูููุฏู ุงูุงูุชุฑุงุถู ุฅุฐุง ูู ุชูุฌุฏ ุญุณุงุจุงุช ุนููุงุก
                        optionsHTML += '<optgroup label="๐ฅ ุงูุนููุงุก - ุงูุฐูู ุงููุฏููุฉ">';
                        optionsHTML += `<option value="1040000" data-type="customer">1040000 - ุนููุงุก ููุฏููู</option>`;
                        optionsHTML += '</optgroup>';
                    }
                    
                    // ุญุณุงุจุงุช ุงูููุฑุฏูู - ุงูุฐูู ุงูุฏุงุฆูุฉ
                    if (supplierAccounts.length > 0) {
                        optionsHTML += '<optgroup label="๐ข ุงูููุฑุฏูู - ุงูุฐูู ุงูุฏุงุฆูุฉ">';
                        supplierAccounts.forEach(acc => {
                            const balanceText = acc.balance !== undefined ? ` (${acc.balance.toFixed(2)} ุฑ.ู)` : '';
                            optionsHTML += `<option value="${acc.code}" data-type="supplier" data-supplier-id="${acc.supplierId}">${acc.code} - ${acc.name}${balanceText}</option>`;
                        });
                        optionsHTML += '</optgroup>';
                    } else {
                        // โ ุฅุถุงูุฉ ุญุณุงุจ ุงูููุฑุฏ ุงูููุฏู ุงูุงูุชุฑุงุถู ุฅุฐุง ูู ุชูุฌุฏ ุญุณุงุจุงุช ููุฑุฏูู
                        optionsHTML += '<optgroup label="๐ข ุงูููุฑุฏูู - ุงูุฐูู ุงูุฏุงุฆูุฉ">';
                        optionsHTML += `<option value="2010000" data-type="supplier">2010000 - ููุฑุฏูู ููุฏููู</option>`;
                        optionsHTML += '</optgroup>';
                    }
                    
                    // โ ุงูุชุญุฏูุซ: ุชุทุจูู ุงูุฎูุงุฑุงุช ุนูู ุฌููุน ุงูุนูุงุตุฑ
                    debitSelects.forEach(select => {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุญุณุงุจ</option>' + optionsHTML;
                        if (currentValue) select.value = currentValue;
                    });
                    
                    creditSelects.forEach(select => {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุญุณุงุจ</option>' + optionsHTML;
                        if (currentValue) select.value = currentValue;
                    });

                    console.log('โ ุชู ุชุญููู ุฎูุงุฑุงุช ุงูุญุณุงุจุงุช:', {
                        main: mainAccounts.length,
                        customers: customerAccounts.length,
                        suppliers: supplierAccounts.length
                    });
                };
            } catch (error) {
                console.error('โ ูุดู ุชุญููู ุฎูุงุฑุงุช ุงูุญุณุงุจุงุช:', error);
            }
        }

        /**
        * ุฅุถุงูุฉ ุญุณุงุจ ูุฏููุฉ ุฌุฏูุฏ ูู ุงููููุฐุฌ
        */
        function addDebitEntry() {
            const container = document.getElementById('debitEntriesContainer');
            const newEntry = document.createElement('div');
            newEntry.className = 'debit-entry row g-2 mb-2';
            newEntry.innerHTML = `
                <div class="col-md-8">
                    <select class="form-select debit-account-select" required>
                        <option value="">ุงุฎุชุฑ ุงูุญุณุงุจ</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="number" class="form-control debit-amount" placeholder="ุงููุจูุบ" step="0.01" required>
                </div>
            `;
            container.appendChild(newEntry);
            loadAccountOptions();
            
            // ุฅุถุงูุฉ ูุณุชูุนุงุช ุงูุฃุญุฏุงุซ
            const amountInput = newEntry.querySelector('.debit-amount');
            amountInput.addEventListener('input', calculateJournalEntryTotals);
        }

        /**
        * ุฅุถุงูุฉ ุญุณุงุจ ุฏุงุฆู ุฌุฏูุฏ ูู ุงููููุฐุฌ
        */
        function addCreditEntry() {
            const container = document.getElementById('creditEntriesContainer');
            const newEntry = document.createElement('div');
            newEntry.className = 'credit-entry row g-2 mb-2';
            newEntry.innerHTML = `
                <div class="col-md-8">
                    <select class="form-select credit-account-select" required>
                        <option value="">ุงุฎุชุฑ ุงูุญุณุงุจ</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="number" class="form-control credit-amount" placeholder="ุงููุจูุบ" step="0.01" required>
                </div>
            `;
            container.appendChild(newEntry);
            loadAccountOptions();
            
            // ุฅุถุงูุฉ ูุณุชูุนุงุช ุงูุฃุญุฏุงุซ
            const amountInput = newEntry.querySelector('.credit-amount');
            amountInput.addEventListener('input', calculateJournalEntryTotals);
        }

        /**
        * ุญุณุงุจ ูุฌุงููุน ุงููุฏูู ูุงูุฏุงุฆู ูุงููุฑู ุจููููุง
        */
        function calculateJournalEntryTotals() {
            let totalDebit = 0;
            let totalCredit = 0;
            
            document.querySelectorAll('.debit-amount').forEach(input => {
                totalDebit += parseFloat(input.value) || 0;
            });
            
            document.querySelectorAll('.credit-amount').forEach(input => {
                totalCredit += parseFloat(input.value) || 0;
            });
            
            document.getElementById('totalDebitAmount').textContent = totalDebit.toFixed(2);
            document.getElementById('totalCreditAmount').textContent = totalCredit.toFixed(2);
            
            const difference = totalDebit - totalCredit;
            document.getElementById('balanceDifference').textContent = difference.toFixed(2);
            
            // ุชูุนูู ุฒุฑ ุงูุญูุธ ููุท ุฅุฐุง ูุงู ุงูููุฏ ูุชูุงุฒู
            const saveBtn = document.getElementById('saveJournalEntryBtn');
            saveBtn.disabled = Math.abs(difference) > 0.01;
        }





        /**
        * ุญูุธ ุงูููุฏ ุงููุฏูู
        */
        async function saveJournalEntry() {
            const description = document.getElementById('entryDescription').value;
            
            if (!description) {
                alert('ูุฑุฌู ุฅุฏุฎุงู ูุตู ููููุฏ');
                return;
            }

            // ุฌูุน ุงูุญุณุงุจุงุช ุงููุฏููุฉ ุงูุชูููุฏูุฉ
            const debits = [];
            document.querySelectorAll('.debit-entry').forEach(entry => {
                const accountSelect = entry.querySelector('.debit-account-select');
                const amountInput = entry.querySelector('.debit-amount');
                
                if (accountSelect.value && amountInput.value) {
                    debits.push({
                        accountCode: accountSelect.value,
                        amount: parseFloat(amountInput.value),
                        accountType: accountSelect.options[accountSelect.selectedIndex].dataset.type
                    });
                }
            });

            // ุฌูุน ุงูุญุณุงุจุงุช ุงูุฏุงุฆูุฉ ุงูุชูููุฏูุฉ
            const credits = [];
            document.querySelectorAll('.credit-entry').forEach(entry => {
                const accountSelect = entry.querySelector('.credit-account-select');
                const amountInput = entry.querySelector('.credit-amount');
                
                if (accountSelect.value && amountInput.value) {
                    credits.push({
                        accountCode: accountSelect.value,
                        amount: parseFloat(amountInput.value),
                        accountType: accountSelect.options[accountSelect.selectedIndex].dataset.type
                    });
                }
            });

            // ุฌูุน ุนูููุงุช ุงูุชุญุตูู
            const collectionEntries = [];
            document.querySelectorAll('.collection-entry').forEach(entry => {
                const customerSelect = entry.querySelector('.collection-customer-select');
                const supplierSelect = entry.querySelector('.collection-supplier-select');
                const amountInput = entry.querySelector('.collection-amount');
                const paymentMethod = entry.querySelector('.collection-payment-method');
                const collectionDescription = entry.querySelector('.collection-description');
                
                if (amountInput.value) {
                    const amount = parseFloat(amountInput.value);
                    let collectionEntry = {
                        amount: amount,
                        paymentMethod: paymentMethod?.value || 'cash',
                        description: collectionDescription?.value || 'ุนูููุฉ ุชุญุตูู'
                    };
                    
                    if (customerSelect && customerSelect.value) {
                        // ุชุญุตูู ูู ุนููู
                        collectionEntry.type = 'customer_collection';
                        collectionEntry.customerId = parseInt(customerSelect.value);
                        collectionEntry.customerAccount = customerSelect.options[customerSelect.selectedIndex].dataset.account;
                        
                        // ุฅุถุงูุฉ ูููููุฏ: ุงูุตูุฏูู (ูุฏูู) โ ุงูุนููู (ุฏุงุฆู)
                        debits.push({ accountCode: '1010', amount: amount });
                        credits.push({ accountCode: collectionEntry.customerAccount, amount: amount });
                        
                    } else if (supplierSelect && supplierSelect.value) {
                        // ุณุฏุงุฏ ูููุฑุฏ
                        collectionEntry.type = 'supplier_payment';
                        collectionEntry.supplierId = parseInt(supplierSelect.value);
                        collectionEntry.supplierAccount = supplierSelect.options[supplierSelect.selectedIndex].dataset.account;
                        
                        // ุฅุถุงูุฉ ูููููุฏ: ุงูููุฑุฏ (ูุฏูู) โ ุงูุตูุฏูู (ุฏุงุฆู)
                        debits.push({ accountCode: collectionEntry.supplierAccount, amount: amount });
                        credits.push({ accountCode: '1010', amount: amount });
                    }
                    
                    collectionEntries.push(collectionEntry);
                }
            });

            if (debits.length === 0 && credits.length === 0 && collectionEntries.length === 0) {
                alert('ูุฑุฌู ุฅุฏุฎุงู ููุฏ ูุญุงุณุจู ูุงุญุฏ ุนูู ุงูุฃูู');
                return;
            }

            try {
                await createJournalEntry(description, debits, credits, 'Manual', null);
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('journalEntryModal'));
                modal.hide();
                
                // ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ ููุงุณุจุฉ
                if (collectionEntries.length > 0) {
                    let successMessage = 'โ ุชู ุญูุธ ุงูููุฏ ุจูุฌุงุญ!';
                    collectionEntries.forEach(entry => {
                        if (entry.type === 'customer_collection') {
                            successMessage += `\n๐ฐ ุชู ุชุญุตูู ${entry.amount.toFixed(2)} ุฑ.ู ูู ุงูุนููู`;
                        } else if (entry.type === 'supplier_payment') {
                            successMessage += `\n๐ณ ุชู ุณุฏุงุฏ ${entry.amount.toFixed(2)} ุฑ.ู ููููุฑุฏ`;
                        }
                    });
                    alert(successMessage);
                } else {
                    alert('โ ุชู ุญูุธ ุงูููุฏ ุงููุฏูู ุจูุฌุงุญ!');
                }
                
                displayChartOfAccounts();
                loadJournalEntries();

            } catch (error) {
                console.error('ูุดู ุญูุธ ุงูููุฏ ุงููุฏูู:', error);
                alert('โ ูุดู ุญูุธ ุงูููุฏ: ' + error.message);
            }
        }

        /**
        * ุชุญููู ูุนุฑุถ ุงููููุฏ ุงูููููุฉ
        */
        async function loadJournalEntries() {
            try {
                const transaction = db.transaction(['journalEntries'], 'readonly');
                const store = transaction.objectStore('journalEntries');
                const request = store.getAll();
                
                request.onsuccess = function() {
                    const entries = request.result;
                    const tbody = document.getElementById('journalEntriesTable');
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    if (entries.length === 0) {
                        tbody.innerHTML = '<tr class="text-center text-muted"><td colspan="4">ูุง ุชูุฌุฏ ูููุฏ ููููุฉ ูุณุฌูุฉ ุจุนุฏ.</td></tr>';
                        return;
                    }
                    
                    // ุชุฑุชูุจ ุงููููุฏ ูู ุงูุฃุญุฏุซ ุฅูู ุงูุฃูุฏู
                    entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    entries.forEach(entry => {
                        const totalDebit = entry.debits.reduce((sum, d) => sum + d.amount, 0);
                        const totalCredit = entry.credits.reduce((sum, c) => sum + c.amount, 0);
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${new Date(entry.date).toLocaleDateString('ar-YE')}</td>
                            <td>${entry.description}</td>
                            <td>${totalDebit.toFixed(2)}</td>
                            <td>${totalCredit.toFixed(2)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                };
            } catch (error) {
                console.error('ูุดู ุชุญููู ุงููููุฏ ุงูููููุฉ:', error);
            }
        }
        // ==================== 4.12. ุฅุฏุงุฑุฉ ุงูููุฑุฏูู ====================
        /**
        * ูุชุญ ูููุฐุฌ ุฅุถุงูุฉ/ุชุนุฏูู ููุฑุฏ
        */
        function openSupplierModal(supplierId = null) {
            const modal = new bootstrap.Modal(document.getElementById('supplierModal'));
            const form = document.getElementById('supplierForm');
            
            if (supplierId) {
                document.getElementById('supplierModalLabel').textContent = 'ุชุนุฏูู ุงูููุฑุฏ';
                const supplier = suppliers.find(s => s.id === parseInt(supplierId));
                if (supplier) {
                    document.getElementById('supplierId').value = supplier.id;
                    document.getElementById('supplierName').value = supplier.name;
                    document.getElementById('supplierPhone').value = supplier.phone || '';
                    document.getElementById('supplierEmail').value = supplier.email || '';
                    document.getElementById('supplierAddress').value = supplier.address || '';
                }
            } else {
                document.getElementById('supplierModalLabel').textContent = 'ุฅุถุงูุฉ ููุฑุฏ ุฌุฏูุฏ';
                form.reset();
            }
            
            modal.show();
        }
        /**
        * ุญูุธ ุงูููุฑุฏ ูุน ุฅูุดุงุก ุญุณุงุจ ุชููุงุฆู ูู ุดุฌุฑุฉ ุงูุญุณุงุจุงุช
        */
        async function saveSupplier() {
            const form = document.getElementById('supplierForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const supplier = {
                name: document.getElementById('supplierName').value,
                phone: document.getElementById('supplierPhone').value,
                email: document.getElementById('supplierEmail').value,
                address: document.getElementById('supplierAddress').value
            };

            const supplierId = document.getElementById('supplierId').value;
            if (supplierId) {
                supplier.id = parseInt(supplierId);
            }

            try {
                let savedSupplierId;
                
                if (supplierId) {
                    // ุชุญุฏูุซ ููุฑุฏ ููุฌูุฏ
                    const transaction = db.transaction(['suppliers'], 'readwrite');
                    const store = transaction.objectStore('suppliers');
                    await store.put(supplier);
                    savedSupplierId = supplier.id;
                    console.log('โ ุชู ุชุญุฏูุซ ุงูููุฑุฏ ุงูููุฌูุฏ');
                } else {
                    // ุฅุถุงูุฉ ููุฑุฏ ุฌุฏูุฏ
                    const transaction = db.transaction(['suppliers'], 'readwrite');
                    const store = transaction.objectStore('suppliers');
                    const request = store.add(supplier);
                    
                    await new Promise((resolve, reject) => {
                        request.onsuccess = (e) => {
                            savedSupplierId = e.target.result;
                            supplier.id = savedSupplierId;
                            resolve();
                        };
                        request.onerror = (e) => reject(e.target.error);
                    });
                    
                    // ุฅูุดุงุก ุญุณุงุจ ุชููุงุฆู ููููุฑุฏ ุงูุฌุฏูุฏ
                    await createSupplierAccount(supplier);
                    console.log('โ ุชู ุฅูุดุงุก ุญุณุงุจ ุชููุงุฆู ููููุฑุฏ');
                }

                // ุชุญุฏูุซ ุงููุงุฌูุฉ
                const modal = bootstrap.Modal.getInstance(document.getElementById('supplierModal'));
                modal.hide();
                
                // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
                await loadSuppliersTable();
                await loadSuppliers();
                
                // ุชุญุฏูุซ ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ุฅุฐุง ูุงูุช ููุชูุญุฉ
                if (document.getElementById('accounting').classList.contains('active')) {
                    displayChartOfAccounts();
                }
                
                alert('โ ุชู ุญูุธ ุงูููุฑุฏ ุจูุฌุงุญ ูุฅูุดุงุก ุญุณุงุจู ูู ุดุฌุฑุฉ ุงูุญุณุงุจุงุช!');

            } catch (error) {
                console.error('โ ูุดู ุญูุธ ุงูููุฑุฏ:', error);
                alert('โ ูุดู ุญูุธ ุงูููุฑุฏ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        }

        /**
        * ุฅูุดุงุก ุญุณุงุจ ุชููุงุฆู ููููุฑุฏ ูู ุดุฌุฑุฉ ุงูุญุณุงุจุงุช
        */
        async function createSupplierAccount(supplier) {
            return new Promise((resolve, reject) => {
                const accountCode = `2010${supplier.id.toString().padStart(4, '0')}`;
                const account = {
                    code: accountCode,
                    name: `ููุฑุฏ - ${supplier.name}`,
                    type: 'liability',
                    parentCode: '2010',
                    balance: 0.00,
                    supplierId: supplier.id,
                    supplierName: supplier.name,
                    supplierPhone: supplier.phone,
                    accountType: 'supplier',
                    isActive: true,
                    createdAt: new Date().toISOString()
                };
                
                const transaction = db.transaction(['chartOfAccounts'], 'readwrite');
                const store = transaction.objectStore('chartOfAccounts');
                const request = store.add(account);
                
                request.onsuccess = async () => {
                    console.log(`โ ุชู ุฅูุดุงุก ุงูุญุณุงุจ ${accountCode} ููููุฑุฏ ${supplier.name}`);
                    
                    // ุชุญุฏูุซ ุงูููุฑุฏ ุจุฑูู ุงูุญุณุงุจ
                    const supplierTransaction = db.transaction(['suppliers'], 'readwrite');
                    const supplierStore = supplierTransaction.objectStore('suppliers');
                    supplier.accCode = accountCode;
                    await supplierStore.put(supplier);
                    
                    resolve(accountCode);
                };
                
                request.onerror = (e) => {
                    console.error('โ ูุดู ุฅูุดุงุก ุญุณุงุจ ุงูููุฑุฏ:', e.target.error);
                    reject(e.target.error);
                };
            });
        }
        /**
        * ุชุญููู ุฌุฏูู ุงูููุฑุฏูู
        */
        async function loadSuppliersTable() {
            try {
                const suppliers = await loadSuppliers();
                const tbody = document.getElementById('suppliersTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (suppliers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ูุง ุชูุฌุฏ ููุฑุฏูู ูุณุฌููู.</td></tr>';
                    return;
                }
                
                suppliers.forEach(supplier => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${supplier.name}</td>
                        <td>${supplier.phone || '-'}</td>
                        <td>${supplier.email || '-'}</td>
                        <td>${supplier.address || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-supplier-btn" data-id="${supplier.id}">ุชุนุฏูู</button>
                            <button class="btn btn-sm btn-outline-danger delete-supplier-btn" data-id="${supplier.id}">ุญุฐู</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('ูุดู ุชุญููู ุฌุฏูู ุงูููุฑุฏูู:', error);
            }
        }

        /**
        * ุญุฐู ููุฑุฏ
        */
        async function deleteSupplier(supplierId) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูููุฑุฏุ')) return;
            
            try {
                const transaction = db.transaction(['suppliers'], 'readwrite');
                const store = transaction.objectStore('suppliers');
                await store.delete(parseInt(supplierId));
                
                loadSuppliersTable();
                loadSuppliers();
                alert('ุชู ุญุฐู ุงูููุฑุฏ ุจูุฌุงุญ!');
            } catch (error) {
                console.error('ูุดู ุญุฐู ุงูููุฑุฏ:', error);
                alert('ูุดู ุญุฐู ุงูููุฑุฏ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        }
        /**
        * ูุชุญ ูููุฐุฌ ุฅุถุงูุฉ/ุชุนุฏูู ุนููู
        */
        function openCustomerModal(customerId = null) {
            const modal = new bootstrap.Modal(document.getElementById('customerModal'));
            const form = document.getElementById('customerForm');
            
            if (customerId) {
                document.getElementById('customerModalLabel').textContent = 'ุชุนุฏูู ุงูุนููู';
                const customer = customers.find(c => c.id === parseInt(customerId));
                if (customer) {
                    document.getElementById('customerId').value = customer.id;
                    document.getElementById('customerName').value = customer.name;
                    document.getElementById('customerPhone').value = customer.phone || '';
                    document.getElementById('customerEmail').value = customer.email || '';
                    document.getElementById('customerAddress').value = customer.address || '';
                }
            } else {
                document.getElementById('customerModalLabel').textContent = 'ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ';
                form.reset();
            }
            
            modal.show();
        }
        /**
        * ุญูุธ ุงูุนููู
        */
        async function saveCustomer() {
            const form = document.getElementById('customerForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const customer = {
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                email: document.getElementById('customerEmail').value,
                address: document.getElementById('customerAddress').value,
                balance: 0
            };

            const customerId = document.getElementById('customerId').value;
            if (customerId) {
                customer.id = parseInt(customerId);
            }

            try {
                let savedCustomerId;
                
                if (customerId) {
                    // ุชุญุฏูุซ ุนููู ููุฌูุฏ
                    const transaction = db.transaction(['customers'], 'readwrite');
                    const store = transaction.objectStore('customers');
                    await store.put(customer);
                    savedCustomerId = customer.id;
                    console.log('โ ุชู ุชุญุฏูุซ ุงูุนููู ุงูููุฌูุฏ');
                } else {
                    // ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ
                    const transaction = db.transaction(['customers'], 'readwrite');
                    const store = transaction.objectStore('customers');
                    const request = store.add(customer);
                    
                    await new Promise((resolve, reject) => {
                        request.onsuccess = (e) => {
                            savedCustomerId = e.target.result;
                            customer.id = savedCustomerId;
                            resolve();
                        };
                        request.onerror = (e) => reject(e.target.error);
                    });
                    
                    // ุฅูุดุงุก ุญุณุงุจ ุชููุงุฆู ููุนููู ุงูุฌุฏูุฏ
                    await createCustomerAccount(customer);
                    console.log('โ ุชู ุฅูุดุงุก ุญุณุงุจ ุชููุงุฆู ููุนููู');
                }

                // ุชุญุฏูุซ ุงููุงุฌูุฉ
                const modal = bootstrap.Modal.getInstance(document.getElementById('customerModal'));
                modal.hide();
                
                // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
                await loadCustomersTable();
                await loadCustomers();
                await loadCustomersForPOS();
                
                // ุชุญุฏูุซ ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ุฅุฐุง ูุงูุช ููุชูุญุฉ
                if (document.getElementById('accounting').classList.contains('active')) {
                    displayChartOfAccounts();
                }
                
                alert('โ ุชู ุญูุธ ุงูุนููู ุจูุฌุงุญ ูุฅูุดุงุก ุญุณุงุจู ูู ุดุฌุฑุฉ ุงูุญุณุงุจุงุช!');

            } catch (error) {
                console.error('โ ูุดู ุญูุธ ุงูุนููู:', error);
                alert('โ ูุดู ุญูุธ ุงูุนููู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        }

        /**
        * ุฅูุดุงุก ุญุณุงุจ ุชููุงุฆู ููุนููู ูู ุดุฌุฑุฉ ุงูุญุณุงุจุงุช
        */
        async function createCustomerAccount(customer) {
            return new Promise((resolve, reject) => {
                const accountCode = `1040${customer.id.toString().padStart(4, '0')}`;
                const account = {
                    code: accountCode,
                    name: `ุนููู - ${customer.name}`,
                    type: 'asset',
                    parentCode: '1040',
                    balance: 0.00,
                    customerId: customer.id,
                    customerName: customer.name,
                    customerPhone: customer.phone,
                    accountType: 'customer',
                    isActive: true,
                    createdAt: new Date().toISOString()
                };
                
                const transaction = db.transaction(['chartOfAccounts'], 'readwrite');
                const store = transaction.objectStore('chartOfAccounts');
                const request = store.add(account);
                
                request.onsuccess = async () => {
                    console.log(`โ ุชู ุฅูุดุงุก ุงูุญุณุงุจ ${accountCode} ููุนููู ${customer.name}`);
                    
                    // ุชุญุฏูุซ ุงูุนููู ุจุฑูู ุงูุญุณุงุจ
                    const customerTransaction = db.transaction(['customers'], 'readwrite');
                    const customerStore = customerTransaction.objectStore('customers');
                    customer.accCode = accountCode;
                    await customerStore.put(customer);
                    
                    resolve(accountCode);
                };
                
                request.onerror = (e) => {
                    console.error('โ ูุดู ุฅูุดุงุก ุญุณุงุจ ุงูุนููู:', e.target.error);
                    reject(e.target.error);
                };
            });
        }

        /**
        * ุชุญููู ุฌุฏูู ุงูุนููุงุก
        */
        async function loadCustomersTable() {
            try {
                const customers = await loadCustomers();
                const tbody = document.getElementById('customersTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ูุง ุชูุฌุฏ ุนููุงุก ูุณุฌููู.</td></tr>';
                    return;
                }
                
                customers.forEach(customer => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${customer.name}</td>
                        <td>${customer.phone || '-'}</td>
                        <td>${customer.email || '-'}</td>
                        <td>${customer.address || '-'}</td>
                        <td class="${(customer.balance || 0) > 0 ? 'text-danger' : 'text-success'}">
                            ${(customer.balance || 0).toFixed(2)} ุฑ.ู
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-customer-btn" data-id="${customer.id}">ุชุนุฏูู</button>
                            <button class="btn btn-sm btn-outline-danger delete-customer-btn" data-id="${customer.id}">ุญุฐู</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('ูุดู ุชุญููู ุฌุฏูู ุงูุนููุงุก:', error);
            }
        }

        /**
        * ูุชุญ ูููุฐุฌ ุชุณุฏูุฏ ุงูุฏููู ููููุฑุฏูู
        */
        function openSupplierPaymentModal() {
            const modal = new bootstrap.Modal(document.getElementById('supplierPaymentModal'));
            
            // ุชุญููู ุงูููุฑุฏูู ุงูุฐูู ูุฏููู ุฃุฑุตุฏุฉ
            loadSuppliersWithBalances();
            
            modal.show();
        }

        /**
        * ุชุญููู ุงูููุฑุฏูู ุงูุฐูู ูุฏููู ุฃุฑุตุฏุฉ ุฏุงุฆูุฉ
        */
        async function loadSuppliersWithBalances() {
            try {
                const suppliers = await loadSuppliers();
                const supplierSelect = document.getElementById('supplierPaymentSelect');
                
                if (!supplierSelect) return;
                
                supplierSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูููุฑุฏ</option>';
                
                let hasBalances = false;
                
                for (const supplier of suppliers) {
                    if (supplier.balance > 0) {
                        hasBalances = true;
                        const option = document.createElement('option');
                        option.value = supplier.id;
                        option.textContent = `${supplier.name} - ูุณุชุญู: ${supplier.balance.toFixed(2)} ุฑ.ู`;
                        option.dataset.balance = supplier.balance;
                        option.dataset.accountCode = supplier.accCode;
                        supplierSelect.appendChild(option);
                    }
                }
                
                if (!hasBalances) {
                    supplierSelect.innerHTML = '<option value="">ูุง ุชูุฌุฏ ูุฏููููุฉ ููููุฑุฏูู</option>';
                }
                
            } catch (error) {
                console.error('โ ูุดู ุชุญููู ุงูููุฑุฏูู:', error);
            }
        }

        /**
        * ุชูููุฐ ุนูููุฉ ุงูุณุฏุงุฏ ููููุฑุฏ
        */
        async function executeSupplierPayment() {
            const supplierSelect = document.getElementById('supplierPaymentSelect');
            const amountInput = document.getElementById('supplierPaymentAmount');
            const descriptionInput = document.getElementById('supplierPaymentDescription');
            
            const supplierId = supplierSelect.value;
            const amount = parseFloat(amountInput.value);
            const description = descriptionInput.value;
            
            if (!supplierId || !amount || amount <= 0) {
                alert('ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุงูุญููู ุจุดูู ุตุญูุญ');
                return;
            }
            
            try {
                // ุงูุญุตูู ุนูู ุจูุงูุงุช ุงูููุฑุฏ
                const supplier = await getSupplierById(parseInt(supplierId));
                if (!supplier) {
                    alert('ุงูููุฑุฏ ุบูุฑ ููุฌูุฏ');
                    return;
                }
                
                // ุงูุชุญูู ูู ุฃู ุงููุจูุบ ุงููุณุฏุฏ ูุง ูุชุฌุงูุฒ ุงูุฑุตูุฏ
                if (amount > supplier.balance) {
                    alert(`ุงููุจูุบ ุงููุณุฏุฏ (${amount.toFixed(2)}) ูุชุฌุงูุฒ ุงููุจูุบ ุงููุณุชุญู (${supplier.balance.toFixed(2)})`);
                    return;
                }
                
                // โ ุชุณุฌูู ุงูููุฏ ุงููุญุงุณุจู ููุณุฏุงุฏ
                const debits = [{
                    accountCode: supplier.accCode || '2010000', // ุญุณุงุจ ุงูููุฑุฏ
                    amount: amount,
                    description: `ุณุฏุงุฏ ูููุฑุฏ - ${description}`
                }];
                
                const credits = [{
                    accountCode: '1010', // ุงูุตูุฏูู
                    amount: amount,
                    description: `ุณุฏุงุฏ ุฐูู ุฏุงุฆูุฉ - ${supplier.name}`
                }];
                
                await createJournalEntry(
                    `ุณุฏุงุฏ ูุฏููููุฉ ููููุฑุฏ ${supplier.name} - ${description}`,
                    debits,
                    credits,
                    'SupplierPayment',
                    supplier.id
                );
                
                // โ ุชุญุฏูุซ ุฑุตูุฏ ุงูููุฑุฏ
                supplier.balance -= amount;
                await updateSupplier(supplier);
                
                // โ ุชุณุฌูู ุญุฑูุฉ ุงูุตูุฏูู
                const transaction = db.transaction(['cashTransactions'], 'readwrite');
                const store = transaction.objectStore('cashTransactions');
                await store.add({
                    date: new Date().toISOString(),
                    type: 'SupplierPayment',
                    amount: -amount,
                    reference: `ุณุฏุงุฏ ููููุฑุฏ ${supplier.name} - ${description}`,
                    supplierId: supplier.id,
                    supplierName: supplier.name
                });
                
                // ุฅุบูุงู ุงููููุฐุฌ ูุฅุธูุงุฑ ุฑุณุงูุฉ ุงููุฌุงุญ
                const modal = bootstrap.Modal.getInstance(document.getElementById('supplierPaymentModal'));
                modal.hide();
                
                alert(`โ ุชู ุณุฏุงุฏ ${amount.toFixed(2)} ุฑ.ู ููููุฑุฏ ${supplier.name} ุจูุฌุงุญ!`);
                
                // ุชุญุฏูุซ ุงููุงุฌูุงุช
                updateBalance();
                displayChartOfAccounts();
                loadSuppliersTable();
                
            } catch (error) {
                console.error('โ ูุดู ุนูููุฉ ุงูุณุฏุงุฏ:', error);
                alert('โ ูุดู ูู ุนูููุฉ ุงูุณุฏุงุฏ: ' + error.message);
            }
        }

        /**
        * ูุชุญ ูููุฐุฌ ุชุญุตูู ุงูุฏููู ูู ุงูุนููุงุก
        */
        function openCollectionModal() {
            const modal = new bootstrap.Modal(document.getElementById('collectionModal'));
            
            // ุชุญููู ุงูุนููุงุก ุงูุฐูู ูุฏููู ุฃุฑุตุฏุฉ
            loadCustomersWithBalances();
            
            modal.show();
        }

        /**
        * ุชุญููู ุงูุนููุงุก ุงูุฐูู ูุฏููู ุฃุฑุตุฏุฉ ูุฏููุฉ
        */
        async function loadCustomersWithBalances() {
            try {
                const customers = await loadCustomers();
                const customerSelect = document.getElementById('collectionCustomerSelect');
                
                if (!customerSelect) return;
                
                customerSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุนููู</option>';
                
                let hasBalances = false;
                
                for (const customer of customers) {
                    if (customer.balance > 0) {
                        hasBalances = true;
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = `${customer.name} - ุฑุตูุฏ: ${customer.balance.toFixed(2)} ุฑ.ู`;
                        option.dataset.balance = customer.balance;
                        option.dataset.accountCode = customer.accCode;
                        customerSelect.appendChild(option);
                    }
                }
                
                if (!hasBalances) {
                    customerSelect.innerHTML = '<option value="">ูุง ุชูุฌุฏ ุฏููู ูุณุชุญูุฉ</option>';
                }
                
            } catch (error) {
                console.error('โ ูุดู ุชุญููู ุงูุนููุงุก:', error);
            }
        }

        /**
        * ุชูููุฐ ุนูููุฉ ุงูุชุญุตูู ูู ุงูุนููู
        */
        async function executeCollection() {
            const customerSelect = document.getElementById('collectionCustomerSelect');
            const amountInput = document.getElementById('collectionAmount');
            const descriptionInput = document.getElementById('collectionDescription');
            
            const customerId = customerSelect.value;
            const amount = parseFloat(amountInput.value);
            const description = descriptionInput.value;
            
            if (!customerId || !amount || amount <= 0) {
                alert('ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุงูุญููู ุจุดูู ุตุญูุญ');
                return;
            }
            
            try {
                // ุงูุญุตูู ุนูู ุจูุงูุงุช ุงูุนููู
                const customer = await getCustomerById(parseInt(customerId));
                if (!customer) {
                    alert('ุงูุนููู ุบูุฑ ููุฌูุฏ');
                    return;
                }
                
                // ุงูุชุญูู ูู ุฃู ุงููุจูุบ ุงููุญุตู ูุง ูุชุฌุงูุฒ ุงูุฑุตูุฏ
                if (amount > customer.balance) {
                    alert(`ุงููุจูุบ ุงููุญุตู (${amount.toFixed(2)}) ูุชุฌุงูุฒ ุงูุฑุตูุฏ ุงููุณุชุญู (${customer.balance.toFixed(2)})`);
                    return;
                }
                
                // โ ุชุณุฌูู ุงูููุฏ ุงููุญุงุณุจู ููุชุญุตูู
                const debits = [{
                    accountCode: '1010', // ุงูุตูุฏูู
                    amount: amount,
                    description: `ุชุญุตูู ูู ${customer.name}`
                }];
                
                const credits = [{
                    accountCode: customer.accCode || '1040000', // ุญุณุงุจ ุงูุนููู
                    amount: amount,
                    description: `ุชุญุตูู ุฐูู ูุฏููุฉ - ${description}`
                }];
                
                await createJournalEntry(
                    `ุชุญุตูู ุฏููู ูู ${customer.name} - ${description}`,
                    debits,
                    credits,
                    'Collection',
                    customer.id
                );
                
                // โ ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู
                customer.balance -= amount;
                await updateCustomer(customer);
                
                // โ ุชุณุฌูู ุญุฑูุฉ ุงูุตูุฏูู
                const transaction = db.transaction(['cashTransactions'], 'readwrite');
                const store = transaction.objectStore('cashTransactions');
                await store.add({
                    date: new Date().toISOString(),
                    type: 'Collection',
                    amount: amount,
                    reference: `ุชุญุตูู ูู ${customer.name} - ${description}`,
                    customerId: customer.id,
                    customerName: customer.name
                });
                
                // ุฅุบูุงู ุงููููุฐุฌ ูุฅุธูุงุฑ ุฑุณุงูุฉ ุงููุฌุงุญ
                const modal = bootstrap.Modal.getInstance(document.getElementById('collectionModal'));
                modal.hide();
                
                alert(`โ ุชู ุชุญุตูู ${amount.toFixed(2)} ุฑ.ู ูู ${customer.name} ุจูุฌุงุญ!`);
                
                // ุชุญุฏูุซ ุงููุงุฌูุงุช
                updateBalance();
                displayChartOfAccounts();
                loadCustomersTable();
                
            } catch (error) {
                console.error('โ ูุดู ุนูููุฉ ุงูุชุญุตูู:', error);
                alert('โ ูุดู ูู ุนูููุฉ ุงูุชุญุตูู: ' + error.message);
            }
        }

        /**
        * ุญุฐู ุนููู
        */
        async function deleteCustomer(customerId) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุนูููุ')) return;
            
            try {
                const transaction = db.transaction(['customers'], 'readwrite');
                const store = transaction.objectStore('customers');
                await store.delete(parseInt(customerId));
                
                loadCustomersTable();
                loadCustomers();
                alert('ุชู ุญุฐู ุงูุนููู ุจูุฌุงุญ!');
            } catch (error) {
                console.error('ูุดู ุญุฐู ุงูุนููู:', error);
                alert('ูุดู ุญุฐู ุงูุนููู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        }

        /**
        * ุฌูุจ ุงูุนููุงุก ูู IndexedDB
        */
        function loadCustomers() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    customers = request.result;
                    resolve(customers);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
        * ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู
        */
        async function updateCustomer(customer) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['customers'], 'readwrite');
                const store = transaction.objectStore('customers');
                const request = store.put(customer);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
        * ุชุญุฏูุซ ุจูุงูุงุช ุงูููุฑุฏ
        */
        async function updateSupplier(supplier) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['suppliers'], 'readwrite');
                const store = transaction.objectStore('suppliers');
                const request = store.put(supplier);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }
        // ==================== 4.14. ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ ====================

        /**
        * ุญูุธ ุงูุฅุนุฏุงุฏุงุช
        */
        async function saveSettings() {
            try {
                console.log('๐ ุจุฏุก ุนูููุฉ ุญูุธ ุงูุฅุนุฏุงุฏุงุช...');
                
                // ุฌูุน ุงูุจูุงูุงุช ูู ุงูุญููู
                const settings = {
                    exchangeRate: parseFloat(document.getElementById('exchangeRateInput').value) || 425,
                    taxRate: parseFloat(document.getElementById('taxRateInput').value) || 0,
                    showQuantityField: document.getElementById('showQuantityFieldSetting') ? 
                        document.getElementById('showQuantityFieldSetting').checked : true
                };

                // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
                if (isNaN(settings.exchangeRate) || settings.exchangeRate <= 0) {
                    alert('ูุฑุฌู ุฅุฏุฎุงู ุณุนุฑ ุตุฑู ุตุญูุญ');
                    return;
                }

                if (isNaN(settings.taxRate) || settings.taxRate < 0) {
                    alert('ูุฑุฌู ุฅุฏุฎุงู ูุณุจุฉ ุถุฑูุจุฉ ุตุญูุญุฉ');
                    return;
                }

                console.log('๐ ุงูุฅุนุฏุงุฏุงุช ุงููุฌูุนุฉ:', settings);

                // ุญูุธ ุงูุฅุนุฏุงุฏุงุช ูู IndexedDB
                await saveSettingsToDatabase(settings);
                
                // ุชุทุจูู ุงูุฅุนุฏุงุฏุงุช ููุฑุงู
                await applySettingsImmediately(settings);
                
                // ุฅุธูุงุฑ ุฑุณุงูุฉ ุงููุฌุงุญ
                showSettingsSuccessMessage(settings);
                
            } catch (error) {
                console.error('โ ูุดู ุญูุธ ุงูุฅุนุฏุงุฏุงุช:', error);
                alert('โ ูุดู ุญูุธ ุงูุฅุนุฏุงุฏุงุช: ' + error.message);
            }
        }

        /**
        * ุญูุธ ุงูุฅุนุฏุงุฏุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        */
        async function saveSettingsToDatabase(settings) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('ูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ูุชุงุญุฉ'));
                    return;
                }

                const transaction = db.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                
                // ุญูุธ ูู ุฅุนุฏุงุฏ ุจุดูู ูููุตู
                const promises = [
                    new Promise((res, rej) => {
                        const request = store.put({ key: 'exchangeRate', value: settings.exchangeRate });
                        request.onsuccess = () => res();
                        request.onerror = (e) => rej(e.target.error);
                    }),
                    new Promise((res, rej) => {
                        const request = store.put({ key: 'taxRate', value: settings.taxRate });
                        request.onsuccess = () => res();
                        request.onerror = (e) => rej(e.target.error);
                    }),
                    new Promise((res, rej) => {
                        const request = store.put({ key: 'showQuantityField', value: settings.showQuantityField });
                        request.onsuccess = () => res();
                        request.onerror = (e) => rej(e.target.error);
                    })
                ];

                // ุงูุชุธุงุฑ ุงูุชูุงู ุฌููุน ุนูููุงุช ุงูุญูุธ
                Promise.all(promises)
                    .then(() => {
                        console.log('โ ุชู ุญูุธ ุฌููุน ุงูุฅุนุฏุงุฏุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช');
                        resolve();
                    })
                    .catch(error => {
                        console.error('โ ูุดู ุญูุธ ุจุนุถ ุงูุฅุนุฏุงุฏุงุช:', error);
                        reject(error);
                    });

                // ุงูุชุฃูุฏ ูู ุงูุชูุงู ุงููุนุงููุฉ
                transaction.oncomplete = () => {
                    console.log('โ ุงูุชููุช ูุนุงููุฉ ุญูุธ ุงูุฅุนุฏุงุฏุงุช');
                };

                transaction.onerror = (e) => {
                    console.error('โ ูุดู ูุนุงููุฉ ุญูุธ ุงูุฅุนุฏุงุฏุงุช:', e.target.error);
                    reject(e.target.error);
                };
            });
        }

        /**
        * ุชุทุจูู ุงูุฅุนุฏุงุฏุงุช ููุฑุงู ุจุนุฏ ุงูุญูุธ
        */
        async function applySettingsImmediately(settings) {
            try {
                console.log('๐ ุชุทุจูู ุงูุฅุนุฏุงุฏุงุช ููุฑุงู...');
                
                // 1. ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช ุงูุถุฑูุจุฉ ูู ูุงุฌูุฉ ุงูุจูุน
                const taxRateInputPOS = document.getElementById('taxRateInput');
                if (taxRateInputPOS) {
                    taxRateInputPOS.value = settings.taxRate;
                }

                const taxInput = document.getElementById('taxInput');
                if (taxInput) {
                    taxInput.value = settings.taxRate;
                }

                // 2. ุชุทุจูู ุฅุนุฏุงุฏุงุช ุฅุธูุงุฑ/ุฅุฎูุงุก ุญูู ุงููููุฉ
                await setupQuantityFieldVisibility();
                
                // 3. ุชุญุฏูุซ ุฃู ุนูุงุตุฑ ุฃุฎุฑู ุชุชุฃุซุฑ ุจุงูุฅุนุฏุงุฏุงุช
                updateAffectedElements(settings);
                
                console.log('โ ุชู ุชุทุจูู ุฌููุน ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ');
                
            } catch (error) {
                console.error('โ ูุดู ุชุทุจูู ุงูุฅุนุฏุงุฏุงุช:', error);
                throw error;
            }
        }

        /**
        * ุชุญุฏูุซ ุงูุนูุงุตุฑ ุงููุชุฃุซุฑุฉ ุจุงูุฅุนุฏุงุฏุงุช
        */
        function updateAffectedElements(settings) {
            // ุชุญุฏูุซ ุฃู ุนูุงุตุฑ ูู ุงููุงุฌูุฉ ุชุชุฃุซุฑ ุจุชุบููุฑ ุงูุฅุนุฏุงุฏุงุช
            const exchangeRateElements = document.querySelectorAll('[data-exchange-rate]');
            exchangeRateElements.forEach(el => {
                el.textContent = settings.exchangeRate;
            });

            const taxRateElements = document.querySelectorAll('[data-tax-rate]');
            taxRateElements.forEach(el => {
                el.textContent = settings.taxRate;
            });
        }

        /**
        * ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ ุงูุญูุธ
        */
        function showSettingsSuccessMessage(settings) {
            const message = `
        โ ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ!

        โข ุณุนุฑ ุงูุตุฑู: ${settings.exchangeRate} YER = 1 SAR
        โข ูุณุจุฉ ุงูุถุฑูุจุฉ: ${settings.taxRate}%
        โข ุญูู ุงููููุฉ: ${settings.showQuantityField ? 'ูุธููุฑ' : 'ูุฎูู'}

        ุณูุชู ุชุทุจูู ุงูุฅุนุฏุงุฏุงุช ุนูู ุฌููุน ุงูุนูููุงุช.
            `.trim();

            alert(message);
        }

        /**
        * ุชุญููู ุงูุฅุนุฏุงุฏุงุช ุนูุฏ ูุชุญ ุงููุธุงู - ุงููุณุฎุฉ ุงููุญุฏุซุฉ
        */
        async function loadSettings() {
            try {
                console.log('๐ฅ ุฌุงุฑู ุชุญููู ุงูุฅุนุฏุงุฏุงุช...');
                
                if (!db) {
                    console.warn('โ๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ุฌุงูุฒุฉุ ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุจุนุฏ ุซุงููุฉ...');
                    setTimeout(loadSettings, 1000);
                    return;
                }

                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.getAll();

                request.onsuccess = function() {
                    const settings = request.result;
                    const settingsMap = {};
                    
                    // ุชุญููู ุงููุตูููุฉ ุฅูู ูุงุฆู ูููุตูู ุงูุณุฑูุน
                    settings.forEach(setting => {
                        settingsMap[setting.key] = setting.value;
                    });

                    console.log('๐ ุงูุฅุนุฏุงุฏุงุช ุงููุญููุฉ:', settingsMap);

                    // ุชุทุจูู ุงูุฅุนุฏุงุฏุงุช ุนูู ุงููุงุฌูุฉ
                    applyLoadedSettings(settingsMap);
                    
                    // ุชุทุจูู ุฅุนุฏุงุฏุงุช ุญูู ุงููููุฉ
                    setTimeout(() => setupQuantityFieldVisibility(), 500);
                };

                request.onerror = function(e) {
                    console.error('โ ูุดู ุชุญููู ุงูุฅุนุฏุงุฏุงุช:', e.target.error);
                    // ุงุณุชุฎุฏุงู ุงูููู ุงูุงูุชุฑุงุถูุฉ ูู ุญุงูุฉ ุงูุฎุทุฃ
                    applyDefaultSettings();
                };

            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุฅุนุฏุงุฏุงุช:', error);
                applyDefaultSettings();
            }
        }

        /**
        * ุชุทุจูู ุงูุฅุนุฏุงุฏุงุช ุงููุญููุฉ ุนูู ุงููุงุฌูุฉ
        */
        function applyLoadedSettings(settingsMap) {
            // ุณุนุฑ ุงูุตุฑู
            const exchangeRateInput = document.getElementById('exchangeRateInput');
            if (exchangeRateInput) {
                exchangeRateInput.value = settingsMap.exchangeRate || 425;
            }

            // ูุณุจุฉ ุงูุถุฑูุจุฉ
            const taxRateInput = document.getElementById('taxRateInput');
            if (taxRateInput) {
                taxRateInput.value = settingsMap.taxRate || 0;
            }

            // ุญูู ุงููููุฉ
            const showQuantityFieldSetting = document.getElementById('showQuantityFieldSetting');
            if (showQuantityFieldSetting) {
                showQuantityFieldSetting.checked = settingsMap.showQuantityField !== undefined ? 
                    settingsMap.showQuantityField : true;
            }

            // ุชุญุฏูุซ ุงูุญููู ุงูุฃุฎุฑู ุงููุชุฃุซุฑุฉ
            const taxInput = document.getElementById('taxInput');
            if (taxInput) {
                taxInput.value = settingsMap.taxRate || 0;
            }

            const taxRateInputPOS = document.getElementById('taxRateInput');
            if (taxRateInputPOS) {
                taxRateInputPOS.value = settingsMap.taxRate || 0;
            }
        }

        /**
        * ุชุทุจูู ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ ูู ุญุงูุฉ ุงูุฎุทุฃ
        */
        function applyDefaultSettings() {
            console.log('๐ ุชุทุจูู ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ...');
            
            const defaultSettings = {
                exchangeRate: 425,
                taxRate: 0,
                showQuantityField: true
            };

            applyLoadedSettings(defaultSettings);
        }

        /**
        * ุงูุชุญูู ูู ุตุญุฉ ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ
        */
        async function validateCurrentSettings() {
            try {
                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.getAll();

                request.onsuccess = function() {
                    const settings = request.result;
                    if (settings.length === 0) {
                        console.log('โน๏ธ ูุง ุชูุฌุฏ ุฅุนุฏุงุฏุงุช ูุญููุธุฉุ ุณูุชู ุงุณุชุฎุฏุงู ุงูุงูุชุฑุงุถูุงุช');
                        // ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
                        saveDefaultSettings();
                    } else {
                        console.log('โ ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ ุตุงูุญุฉ:', settings);
                    }
                };

            } catch (error) {
                console.error('โ ูุดู ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช:', error);
            }
        }

        /**
        * ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
        */
        async function saveDefaultSettings() {
            const defaultSettings = {
                exchangeRate: 425,
                taxRate: 0,
                showQuantityField: true
            };

            try {
                await saveSettingsToDatabase(defaultSettings);
                console.log('โ ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ');
            } catch (error) {
                console.error('โ ูุดู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ:', error);
            }
        }

        /**
        * ูุณุฎ ุงุญุชูุงุทู ููุจูุงูุงุช
        */
        async function backupData() {
            try {
                const [products, invoices, customers, suppliers, categories, purchaseInvoices, productImages] = await Promise.all([
                    getAllProducts(),
                    getAllInvoices(),
                    loadCustomers(),
                    loadSuppliers(),
                    loadCategories(),
                    new Promise(resolve => {
                        const transaction = db.transaction(['purchaseInvoices'], 'readonly');
                        const store = transaction.objectStore('purchaseInvoices');
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                    }),
                    new Promise(resolve => {
                        const transaction = db.transaction(['productImages'], 'readonly');
                        const store = transaction.objectStore('productImages');
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                    })
                ]);

                const backupData = {
                    products,
                    invoices,
                    customers,
                    suppliers,
                    categories,
                    purchaseInvoices,
                    productImages,
                    backupDate: new Date().toISOString(),
                    version: '2.0' // ุฅุตุฏุงุฑ ุฌุฏูุฏ ูุชุถูู ุงูุตูุฑ
                };

                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `ERP_Backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                alert('โ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุงููุฉ ุชุดูู ุตูุฑ ุงูููุชุฌุงุช!');
                
            } catch (error) {
                console.error('โ ูุดู ุงููุณุฎ ุงูุงุญุชูุงุทู:', error);
                alert('โ ูุดู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ.');
            }
        }

        /**
        * ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช
        */
        async function importData(file) {
            if (!confirm('ุชุญุฐูุฑ: ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุณูุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ. ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ')) {
                return;
            }
            
            try {
                const fileText = await file.text();
                const backup = JSON.parse(fileText);
                
                const stores = Object.keys(backup);
                
                // ูุณุญ ุงูุจูุงูุงุช ุงูุญุงููุฉ
                for (const storeName of stores) {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    await store.clear();
                }
                
                // ุฅุถุงูุฉ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
                for (const storeName of stores) {
                    const data = backup[storeName];
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    for (const item of data) {
                        await store.add(item);
                    }
                }
                
                alert('ุชู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุจูุฌุงุญ! ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
                setTimeout(() => location.reload(), 2000);
                
            } catch (error) {
                console.error('ูุดู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช:', error);
                alert('ูุดู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช. ูุฑุฌู ุงูุชุฃูุฏ ูู ุตุญุฉ ุงูููู.');
            }
        }
        // ==================== 4.6. ูุนุงูุฌุงุช ุงูุฃุญุฏุงุซ (Event Listeners) ====================
        document.addEventListener('DOMContentLoaded', function() {
            // ุชุญููู ุงูููุชุจุงุช ุฃููุงู ุซู ุชููุฆุฉ ุงููุธุงู
            loadFallbackLibraries().then(() => {
                initDatabase();
                // ๐ฅ ุฅุถุงูุฉ ูุนุงููุฉ ุงูุตูุฑุฉ
                setupImagePreview();
            });

            // ุชุทุจูู ุงูููุท ุงููุญููุธ
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                themeIcon.className = savedTheme === 'dark' ? 'bi bi-moon' : 'bi bi-sun';
            }

            // ุชุจุฏูู ุงูููุท
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // ุชุจุฏูู ุงูุชุจููุจุงุช ุงูุฑุฆูุณูุฉ
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showModule(this.dataset.module);
                });
            });

            // ุชุจุฏูู ุงูุชุจููุจุงุช ุงููุฑุนูุฉ ูู ุงููุฎุฒูู
            document.querySelectorAll('.nav-tabs .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSubTab(this.dataset.tab);
                });
            });

            // ุฒุฑ ูุชุญ/ุฅุบูุงู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ (ุงูุฌูุงู)
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    document.getElementById('appSidebar').classList.toggle('show');
                });
            }
            
            // ุฅุบูุงู ุงูุดุฑูุท ุงูุฌุงูุจู ุนูุฏ ุงูููุฑ ุฎุงุฑุฌ ุงููุงุฆูุฉ
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.addEventListener('click', function() {
                    if (window.innerWidth < 768) {
                        const sidebar = document.getElementById('appSidebar');
                        if (sidebar && sidebar.classList.contains('show')) {
                            sidebar.classList.remove('show');
                        }
                    }
                });
            }

            // ==================== ููุทุฉ ุงูุจูุน - ุงููุธุงู ุงูุฌุฏูุฏ ====================

            // ุฒุฑ FAB ููุชุญ ุงูุณูุฉ
            const fabCartBtn = document.getElementById('fabCartBtn');
            if (fabCartBtn) {
                fabCartBtn.addEventListener('click', function() {
                    const posCart = document.getElementById('posCart');
                    if (posCart) {
                        posCart.classList.add('show');
                    }
                });
            }
            
            // ุฒุฑ ุฅุบูุงู ุงูุณูุฉ
            const closeCartBtn = document.getElementById('closeCartBtn');
            if (closeCartBtn) {
                closeCartBtn.addEventListener('click', function() {
                    const posCart = document.getElementById('posCart');
                    if (posCart) {
                        posCart.classList.remove('show');
                    }
                });
            }
            
            // ุฒุฑ ุงูุนูุฏุฉ ูููุฆุงุช ูู ุนุฑุถ ุงูููุชุฌุงุช
            const backToCategoriesBtn = document.getElementById('backToCategoriesBtn');
            if (backToCategoriesBtn) {
                backToCategoriesBtn.addEventListener('click', showCategoriesView);
            }


            
            // ุงูุจุญุซ ูู ููุทุฉ ุงูุจูุน - ุงููุธุงู ุงูุฌุฏูุฏ
            // ๐ง ุชุญุฏูุซ ุฏุงูุฉ ุงูุจุญุซ ุงูููุฑู
            const productSearchInput = document.getElementById('productSearchInput');
            if (productSearchInput) {
                productSearchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const searchResults = document.getElementById('posSearchResults');
                    
                    if (searchTerm.length < 2) {
                        searchResults.style.display = 'none';
                        searchResults.innerHTML = '';
                        return;
                    }
                    
                    // ๐ง ุงูุจุญุซ ุงููุนูู ูู ุงูููุชุฌุงุช
                    performInstantSearch(searchTerm).then(results => {
                        if (results.length > 0) {
                            renderSearchResults(results, searchResults);
                            searchResults.style.display = 'block';
                        } else {
                            searchResults.style.display = 'none';
                            searchResults.innerHTML = '';
                        }
                    });
                });
                
                // ุฅุฎูุงุก ูุชุงุฆุฌ ุงูุจุญุซ ุนูุฏ ููุฏุงู ุงูุชุฑููุฒ
                productSearchInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        const searchResults = document.getElementById('posSearchResults');
                        searchResults.style.display = 'none';
                    }, 200);
                });
            }

        // ๐ง ุฅุถุงูุฉ ุฏุงูุฉ ุงูุจุญุซ ุงูููุฑู ุงููุณุงุนุฏุฉ
        async function performInstantSearch(searchTerm) {
            try {
                const products = await getAllProducts();
                return products.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.code.toLowerCase().includes(searchTerm)
                ).slice(0, 10); // ุฃูู 10 ูุชุงุฆุฌ ููุท
            } catch (error) {
                console.error('ูุดู ุงูุจุญุซ ุงูููุฑู:', error);
                return [];
            }
        }

        // ๐ง ุฅุถุงูุฉ ุฏุงูุฉ ุนุฑุถ ูุชุงุฆุฌ ุงูุจุญุซ
        function renderSearchResults(results, container) {
            container.innerHTML = '';
            
            results.forEach(product => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item p-2 border-bottom';
                resultItem.style.cursor = 'pointer';
                resultItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${product.name}</strong>
                            <small class="text-muted d-block">${product.code}</small>
                        </div>
                        <div class="text-success fw-bold">${product.salePrice.toFixed(2)} ุฑ.ู</div>
                    </div>
                `;
                
                resultItem.addEventListener('click', () => {
                    addToCart(product.id, product.name, product.salePrice, product.purchasePrice);
                    container.style.display = 'none';
                    productSearchInput.value = '';
                });
                
                container.appendChild(resultItem);
            });
        }
            
            // ุฒุฑ ุญูุธ ุงููุงุชูุฑุฉ
            const saveInvoiceBtn = document.getElementById('saveInvoiceBtn');
            if (saveInvoiceBtn) {
                saveInvoiceBtn.addEventListener('click', saveInvoice);
            }

            // ุฅุฒุงูุฉ ุนูุตุฑ ูู ุงูุณูุฉ
            const cartItemsList = document.getElementById('cartItemsList');
            if (cartItemsList) {
                cartItemsList.addEventListener('click', function(e) {
                    const removeBtn = e.target.closest('.remove-item-btn');
                    if (removeBtn) {
                        const index = parseInt(removeBtn.dataset.index);
                        if (!isNaN(index) && index >= 0 && index < currentCart.length) {
                            currentCart.splice(index, 1);
                            updateCartDisplay();
                            updateCartCount();
                            // ุฅุนุงุฏุฉ ุชุญููู ุนุฑุถ ุงูููุชุฌุงุช ูุชุญุฏูุซ ุงูู badges
                            if (currentView === 'products' && currentCategoryId) {
                                loadProductsForCategory(currentCategoryId);
                            }
                        }
                    }
                });
            }
            
            // ุทุจุงุนุฉ ุงููุงุชูุฑุฉ
            // ุชุญุฏูุซ ุฒุฑ ุงูุทุจุงุนุฉ ูุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ
            const printInvoiceBtn = document.getElementById('printInvoiceBtn');
            if (printInvoiceBtn) {
                printInvoiceBtn.addEventListener('click', printInvoice);
            }
            
            // ูุดุงุฑูุฉ ุงููุงุชูุฑุฉ ุนุจุฑ ูุงุชุณุงุจ
            // ุชุญุฏูุซ ุฒุฑ ูุดุงุฑูุฉ ุงููุงุชุณุงุจ ูุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ
            const shareWhatsappBtn = document.getElementById('shareWhatsappBtn');
            if (shareWhatsappBtn) {
                shareWhatsappBtn.addEventListener('click', createWhatsappPreview);
            }

            // ุฒุฑ ุทุจุงุนุฉ ุงูุฅูุตุงู
            const printReceiptBtn = document.getElementById('printReceiptBtn');
            if (printReceiptBtn) {
                printReceiptBtn.addEventListener('click', function() {
                    window.print();
                });
            }

            // ==================== ุฅุฏุงุฑุฉ ุงููุฎุฒูู ====================

            // ุฒุฑ ุฅุถุงูุฉ ููุชุฌ
            const addProductBtn = document.getElementById('addProductBtn');
            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    openProductModal();
                });
            }

            // ุชุนุฏูู ุฃู ุญุฐู ููุชุฌ (ุจุงุณุชุฎุฏุงู ุงูุชูููุถ)
            const productsTableBody = document.getElementById('productsTableBody');
            if (productsTableBody) {
                productsTableBody.addEventListener('click', function(e) {
                    if (e.target.classList.contains('edit-product-btn')) {
                        const productId = e.target.dataset.id;
                        openProductModal(productId);
                    } else if (e.target.classList.contains('delete-product-btn')) {
                        const productId = e.target.dataset.id;
                        deleteProductHandler(productId);
                    }
                });
            }

            // ุฒุฑ ุญูุธ ุงูููุชุฌ ูู ุงููููุฐุฌ
            const saveProductBtn = document.getElementById('saveProductBtn');
            if (saveProductBtn) {
                saveProductBtn.addEventListener('click', saveProductFromForm);
            }

            // ุงุณุชูุฑุงุฏ ุงูููุชุฌุงุช
            const importProductsBtn = document.getElementById('importProductsBtn');
            if (importProductsBtn) {
                importProductsBtn.addEventListener('click', function() {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.xlsx, .xls';
                    fileInput.addEventListener('change', function(e) {
                        if (e.target.files.length > 0) {
                            importProductsFromExcel(e.target.files[0]);
                        }
                    });
                    fileInput.click();
                });
            }

            // ุชุตุฏูุฑ ุงูููุชุฌุงุช
            const exportProductsBtn = document.getElementById('exportProductsBtn');
            if (exportProductsBtn) {
                exportProductsBtn.addEventListener('click', exportProductsToExcel);
            }

            // ุงูุจุญุซ ูู ุงูุฃุตูุงู
            const inventorySearchInput = document.getElementById('inventorySearchInput');
            if (inventorySearchInput) {
                inventorySearchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#productsTableBody tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            }

            // ุฒุฑ ุชุณุฌูู ูุงุชูุฑุฉ ุดุฑุงุก
            const recordPurchaseBtn = document.getElementById('recordPurchaseBtn');
            if (recordPurchaseBtn) {
                recordPurchaseBtn.addEventListener('click', openPurchaseModal);
            }

            // ุฅุถุงูุฉ ุตูู ูู ูุงุชูุฑุฉ ุงูุดุฑุงุก
            const addPurchaseItemBtn = document.getElementById('addPurchaseItemBtn');
            if (addPurchaseItemBtn) {
                addPurchaseItemBtn.addEventListener('click', addPurchaseItem);
            }

            // ุฅุฒุงูุฉ ุตูู ูู ูุงุชูุฑุฉ ุงูุดุฑุงุก (ุจุงุณุชุฎุฏุงู ุงูุชูููุถ)
            const purchaseItemsContainer = document.getElementById('purchaseItemsContainer');
            if (purchaseItemsContainer) {
                purchaseItemsContainer.addEventListener('click', function(e) {
                    if (e.target.classList.contains('remove-item-btn')) {
                        e.target.closest('.purchase-item').remove();
                        calculatePurchaseTotal();
                    }
                });
            }

            // ุญูุธ ูุงุชูุฑุฉ ุงูุดุฑุงุก
            const savePurchaseBtn = document.getElementById('savePurchaseBtn');
            if (savePurchaseBtn) {
                savePurchaseBtn.addEventListener('click', savePurchaseInvoice);
            }

            // ุฒุฑ ุฅุถุงูุฉ ูุฆุฉ
            const addCategoryBtn = document.getElementById('addCategoryBtn');
            if (addCategoryBtn) {
                addCategoryBtn.addEventListener('click', () => {
                    openCategoryModal();
                });
            }

            // ุชุนุฏูู ุฃู ุญุฐู ูุฆุฉ
            const categoriesTableBody = document.getElementById('categoriesTableBody');
            if (categoriesTableBody) {
                categoriesTableBody.addEventListener('click', function(e) {
                    if (e.target.classList.contains('edit-category-btn')) {
                        const categoryId = e.target.dataset.id;
                        openCategoryModal(categoryId);
                    } else if (e.target.classList.contains('delete-category-btn')) {
                        const categoryId = e.target.dataset.id;
                        if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงููุฆุฉุ ุณูุชู ุฅุฒุงูุฉ ุชุตููู ุงูููุชุฌุงุช ุงููุฑุชุจุทุฉ ุจูุง.')) {
                            deleteCategory(categoryId);
                        }
                    }
                });
            }

            // ุญูุธ ุงููุฆุฉ
            const saveCategoryBtn = document.getElementById('saveCategoryBtn');
            if (saveCategoryBtn) {
                saveCategoryBtn.addEventListener('click', saveCategory);
            }

            // ุงูุจุญุซ ูู ุญุฑูุงุช ุงูุตูู
            const movementSearchInput = document.getElementById('movementSearchInput');
            if (movementSearchInput) {
                movementSearchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const select = document.getElementById('movementProductSelect');
                    const options = select.options;
                    
                    for (let i = 0; i < options.length; i++) {
                        const option = options[i];
                        const text = option.textContent.toLowerCase();
                        option.style.display = text.includes(searchTerm) ? '' : 'none';
                    }
                });
            }
            // ==================== ุงูุตูุฏูู ูุงูุญุณุงุจุงุช ====================
            // ุฃุฒุฑุงุฑ ุงูุนูููุงุช ุงูููุฏูุฉ
            const depositBtn = document.getElementById('depositBtn');
            if (depositBtn) {
                depositBtn.addEventListener('click', () => {
                    openCashOperationModal('deposit');
                });
            }
            
            const withdrawBtn = document.getElementById('withdrawBtn');
            if (withdrawBtn) {
                withdrawBtn.addEventListener('click', () => {
                    openCashOperationModal('withdraw');
                });
            }
            
            const transferBtn = document.getElementById('transferBtn');
            if (transferBtn) {
                transferBtn.addEventListener('click', () => {
                    openCashOperationModal('transfer');
                });
            }
            
            const closeShiftBtn = document.getElementById('closeShiftBtn');
            if (closeShiftBtn) {
                closeShiftBtn.addEventListener('click', closeShift);
            }

            // ุญูุธ ุงูุนูููุฉ ุงูููุฏูุฉ
            const saveCashOperationBtn = document.getElementById('saveCashOperationBtn');
            if (saveCashOperationBtn) {
                saveCashOperationBtn.addEventListener('click', executeCashOperation);
            }
            // ==================== ุงููุญุงุณุจุฉ ====================
            // ุฒุฑ ุฅุถุงูุฉ ููุฏ ูุฏูู
            const addManualEntryBtn = document.getElementById('addManualEntryBtn');
            if (addManualEntryBtn) {
                addManualEntryBtn.addEventListener('click', openJournalEntryModal);
            }

            // ุฃุฒุฑุงุฑ ุฅุถุงูุฉ ุญุณุงุจุงุช ูู ุงูููุฏ ุงููุฏูู
            const addDebitEntryBtn = document.getElementById('addDebitEntryBtn');
            if (addDebitEntryBtn) {
                addDebitEntryBtn.addEventListener('click', addDebitEntry);
            }
            
            const addCreditEntryBtn = document.getElementById('addCreditEntryBtn');
            if (addCreditEntryBtn) {
                addCreditEntryBtn.addEventListener('click', addCreditEntry);
            }

            // ุญุณุงุจ ุงููุฌุงููุน ุนูุฏ ุชุบููุฑ ุงูููู ูู ุงูููุฏ
            const debitEntriesContainer = document.getElementById('debitEntriesContainer');
            if (debitEntriesContainer) {
                debitEntriesContainer.addEventListener('input', calculateJournalEntryTotals);
            }
            
            const creditEntriesContainer = document.getElementById('creditEntriesContainer');
            if (creditEntriesContainer) {
                creditEntriesContainer.addEventListener('input', calculateJournalEntryTotals);
            }

            // ุญูุธ ุงูููุฏ ุงููุฏูู
            const saveJournalEntryBtn = document.getElementById('saveJournalEntryBtn');
            if (saveJournalEntryBtn) {
                saveJournalEntryBtn.addEventListener('click', saveJournalEntry);
            }
            // ==================== ุฅุฏุงุฑุฉ ุงูููุฑุฏูู ====================
            const addSupplierBtn = document.getElementById('addSupplierBtn');
            if (addSupplierBtn) {
                addSupplierBtn.addEventListener('click', () => {
                    openSupplierModal();
                });
            }

            const saveSupplierBtn = document.getElementById('saveSupplierBtn');
            if (saveSupplierBtn) {
                saveSupplierBtn.addEventListener('click', saveSupplier);
            }

            const suppliersTableBody = document.getElementById('suppliersTableBody');
            if (suppliersTableBody) {
                suppliersTableBody.addEventListener('click', function(e) {
                    if (e.target.classList.contains('edit-supplier-btn')) {
                        const supplierId = e.target.dataset.id;
                        openSupplierModal(supplierId);
                    } else if (e.target.classList.contains('delete-supplier-btn')) {
                        const supplierId = e.target.dataset.id;
                        deleteSupplier(supplierId);
                    }
                });
            }
            // ==================== ุฅุฏุงุฑุฉ ุงูุนููุงุก ====================
            const addCustomerBtn = document.getElementById('addCustomerBtn');
            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    openCustomerModal();
                });
            }

            const saveCustomerBtn = document.getElementById('saveCustomerBtn');
            if (saveCustomerBtn) {
                saveCustomerBtn.addEventListener('click', saveCustomer);
            }

            const customersTableBody = document.getElementById('customersTableBody');
            if (customersTableBody) {
                customersTableBody.addEventListener('click', function(e) {
                    if (e.target.classList.contains('edit-customer-btn')) {
                        const customerId = e.target.dataset.id;
                        openCustomerModal(customerId);
                    } else if (e.target.classList.contains('delete-customer-btn')) {
                        const customerId = e.target.dataset.id;
                        deleteCustomer(customerId);
                    }
                });
            }

            // ูุนุงูุฌุงุช ุงูุฃุญุฏุงุซ ุงูุฌุฏูุฏุฉ ููุชุญุตูู ูุงูุณุฏุงุฏ
            document.getElementById('executeCollectionBtn')?.addEventListener('click', executeCollection);
            document.getElementById('executeSupplierPaymentBtn')?.addEventListener('click', executeSupplierPayment);

            // ุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุฌุฏูุฏุฉ ูู ูุงุฌูุฉ ุงููุญุงุณุจุฉ
            // ุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุงูุชุญุตูู ูุงูุณุฏุงุฏ ูู ูุณู ุงููุญุงุณุจุฉ
            const accountingHeader = document.querySelector('#accounting .card-header');
            if (accountingHeader) {
                const buttonsHtml = `
                    <button class="btn btn-sm btn-success me-2" id="openCollectionModalBtn">
                        <i class="bi bi-cash-coin"></i> ุชุญุตูู ูู ุนููุงุก
                    </button>
                    <button class="btn btn-sm btn-warning" id="openSupplierPaymentModalBtn">
                        <i class="bi bi-credit-card"></i> ุณุฏุงุฏ ูููุฑุฏูู
                    </button>
                `;
                accountingHeader.innerHTML += buttonsHtml;
            }

            // ูุนุงูุฌุงุช ุงูุฃุญุฏุงุซ ููุฃุฒุฑุงุฑ ุงูุฌุฏูุฏุฉ
            document.getElementById('openCollectionModalBtn')?.addEventListener('click', openCollectionModal);
            document.getElementById('openSupplierPaymentModalBtn')?.addEventListener('click', openSupplierPaymentModal);
        
            // ==================== ุงูุฅุนุฏุงุฏุงุช ====================
            document.addEventListener('DOMContentLoaded', function() {
                // ุชุญุฏูุซ ุณุนุฑ ุงูุตุฑู ุนูุฏ ุชุบููุฑ ุงูุนููุฉ
                const currencySelect = document.getElementById('currencySelect');
                if (currencySelect) {
                    currencySelect.addEventListener('change', updateExchangeRateDisplay);
                }
                
                const exchangeRateInput = document.getElementById('exchangeRateInput');
                if (exchangeRateInput) {
                    exchangeRateInput.addEventListener('input', updateExchangeRateDisplay);
                }
                
                
                // ุชุญุฏูุซ ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ูุฅุฒุงูุฉ ุงูุฎุตู
                displayChartOfAccounts();
            });
            
            const backupBtn = document.getElementById('backupBtn');
            if (backupBtn) {
                backupBtn.addEventListener('click', backupData);
            }
            
            const restoreBtn = document.getElementById('restoreBtn');
            if (restoreBtn) {
                restoreBtn.addEventListener('click', function() {
                    document.getElementById('restoreFileInput').click();
                });
            }

            const restoreFileInput = document.getElementById('restoreFileInput');
            if (restoreFileInput) {
                restoreFileInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        importData(e.target.files[0]);
                    }
                });
            }
            // ==================== ุฃุญุฏุงุซ ุฅุถุงููุฉ ูููุธุงู ุงูุฌุฏูุฏ ====================
            // ุฅุถุงูุฉ ููุชุฌ ุฅูู ุงูุณูุฉ ุนูุฏ ุงูููุฑ ุนูู ุจุทุงูุฉ ุงูููุชุฌ
            document.addEventListener('click', function(e) {
                const productCard = e.target.closest('.product-card');
                if (productCard && currentView === 'products') {
                    const productId = parseInt(productCard.dataset.productId);
                    const productName = productCard.querySelector('.card-title').textContent;
                    const productPrice = parseFloat(productCard.dataset.productPrice);
                    const productCost = parseFloat(productCard.dataset.productCost) || 0;
                    
                    if (!isNaN(productId)) {
                        addToCart(productId, productName, productPrice, productCost);
                    }
                }
            });

            // 10. ุฅุตูุงุญ ุฏุงูุฉ ูุชุญ ุณูุฉ ุงููุดุชุฑูุงุช
            document.addEventListener('click', function(e) {
                if (e.target.id === 'fabCartBtn' || e.target.closest('#fabCartBtn')) {
                    const posCart = document.getElementById('posCart');
                    if (posCart) {
                        posCart.classList.add('show');
                    }
                }
                
                if (e.target.id === 'floatingCartBtn' || e.target.closest('#floatingCartBtn')) {
                    const posCart = document.getElementById('posCart');
                    if (posCart) {
                        posCart.classList.add('show');
                    }
                }
            });

            // 11. ุฅุตูุงุญ ุฏุงูุฉ ุฅุฒุงูุฉ ุงูุนูุตุฑ ูู ุงูุณูุฉ
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-item-btn') || e.target.closest('.remove-item-btn')) {
                    const removeBtn = e.target.closest('.remove-item-btn');
                    if (removeBtn && removeBtn.dataset.index) {
                        const index = parseInt(removeBtn.dataset.index);
                        if (!isNaN(index) && index >= 0 && index < currentCart.length) {
                            currentCart.splice(index, 1);
                            updateCartDisplay();
                            updateCartCount();
                            // ุฅุนุงุฏุฉ ุชุญููู ุนุฑุถ ุงูููุชุฌุงุช ูุชุญุฏูุซ ุงูู badges
                            if (currentView === 'products' && currentCategoryId) {
                                loadProductsForCategory(currentCategoryId);
                            }
                        }
                    }
                }
            });
            // ุฅุนุงุฏุฉ ุชุญููู ุนุฑุถ ุงููุฆุงุช ุนูุฏ ุชุญุฏูุซ ุงูุจูุงูุงุช
            document.addEventListener('dataUpdated', function() {
                if (currentView === 'categories') {
                    loadCategoriesView();
                } else if (currentView === 'products' && currentCategoryId) {
                    loadProductsForCategory(currentCategoryId);
                }
            });


            // โญ ุฅุถุงูุฉ ูุณุชูุน ุญุฏุซ ูุญูู ุฅุนุฏุงุฏ ุงููููุฉ
            const showQuantityFieldSetting = document.getElementById('showQuantityFieldSetting');
            if (showQuantityFieldSetting) {
                showQuantityFieldSetting.addEventListener('change', function() {
                    // ุชุทุจูู ุงูุชุบููุฑ ููุฑุงู ุฏูู ุงูุญุงุฌุฉ ูุญูุธ ุงูุฅุนุฏุงุฏุงุช
                    setupQuantityFieldVisibility();
                });
            }
            
            // โญ ุชุญุฏูุซ ูุณุชูุน ุฒุฑ ุญูุธ ุงูุฅุนุฏุงุฏุงุช
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', async function() {
                    await saveSettings();
                    // ุชุฃูุฏ ูู ุชุทุจูู ุฅุนุฏุงุฏุงุช ุงููููุฉ ุจุนุฏ ุงูุญูุธ
                    await setupQuantityFieldVisibility();
                });
            }

            // ุชุญููู ุงูุฅุนุฏุงุฏุงุช ุนูุฏ ุงูุจุฏุก
            setTimeout(loadSettings, 1000);
            // ุชุนููู ุงููุญุฏุฉ ุงูุงูุชุฑุงุถูุฉ ุจุนุฏ ุชุฃุฎูุฑ ุจุณูุท
            // ุฅุถุงูุฉ ุชููุฆุฉ ุฅุถุงููุฉ
            setTimeout(() => {
                // ุชุญุฏูุซ ุงูุฑุตูุฏ
                updateBalance();
                
                // ุชุญููู ุงูุจูุงูุงุช ุงูุฃูููุฉ
                loadProductsForPOS();
                loadCategories();
                loadSuppliers();
                loadCustomers();
                
                // ุชุญุฏูุซ ุงูุนุฏุงุฏ
                updateCartCount();
                updateCartDisplay();
                
                console.log('ุชู ุชููุฆุฉ ุงููุธุงู ุจูุฌุงุญ');
            }, 1000);
        });

        // ==================== ุฏูุงู ูุณุงุนุฏุฉ ููุฃุญุฏุงุซ ====================

        /**
        * ุญุฐู ูุฆุฉ
        */
        async function deleteCategory(categoryId) {
            try {
                // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ููุชุฌุงุช ูุฑุชุจุทุฉ ุจูุฐู ุงููุฆุฉ
                const products = await getAllProducts();
                const productsInCategory = products.filter(p => p.categoryId == categoryId);
                
                if (productsInCategory.length > 0) {
                    if (!confirm(`ูุฐู ุงููุฆุฉ ุชุญุชูู ุนูู ${productsInCategory.length} ููุชุฌ. ุณูุชู ุฅุฒุงูุฉ ุงูุชุตููู ูู ูุฐู ุงูููุชุฌุงุช. ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ`)) {
                        return;
                    }
                    
                    // ุฅุฒุงูุฉ ุงูุชุตููู ูู ุงูููุชุฌุงุช ุงููุฑุชุจุทุฉ
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    
                    for (const product of productsInCategory) {
                        product.categoryId = null;
                        await store.put(product);
                    }
                }
                
                // ุญุฐู ุงููุฆุฉ
                const categoryTransaction = db.transaction(['categories'], 'readwrite');
                const categoryStore = categoryTransaction.objectStore('categories');
                await categoryStore.delete(parseInt(categoryId));
                
                // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
                loadCategoriesTable();
                loadCategories();
                if (currentView === 'categories') {
                    loadCategoriesView();
                }
                
                alert('ุชู ุญุฐู ุงููุฆุฉ ุจูุฌุงุญ!');
            } catch (error) {
                console.error('ูุดู ุญุฐู ุงููุฆุฉ:', error);
                alert('ูุดู ุญุฐู ุงููุฆุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        }

        async function loadAccountOptions() {
            try {
                const transaction = db.transaction(['chartOfAccounts'], 'readonly');
                const store = transaction.objectStore('chartOfAccounts');
                const request = store.getAll();
                
                request.onsuccess = function() {
                    const accounts = request.result;
                    const mainAccounts = accounts.filter(acc => 
                        !acc.customerId && !acc.supplierId && acc.type !== 'header'
                    );
                    
                    let optionsHTML = '<optgroup label="ุงูุญุณุงุจุงุช ุงูุฑุฆูุณูุฉ">';
                    mainAccounts.forEach(acc => {
                        optionsHTML += `<option value="${acc.code}">${acc.code} - ${acc.name}</option>`;
                    });
                    optionsHTML += '</optgroup>';
                    
                    // ุชุญุฏูุซ ุฌููุน ุนูุงุตุฑ ุงูุงุฎุชูุงุฑ
                    document.querySelectorAll('.debit-account-select, .credit-account-select').forEach(select => {
                        select.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุญุณุงุจ</option>' + optionsHTML;
                    });
                };
            } catch (error) {
                console.error('ูุดู ุชุญููู ุฎูุงุฑุงุช ุงูุญุณุงุจุงุช:', error);
            }
        }

        // ุฅุตูุงุญ ุญุฏุซ ุชุญููู ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', function() {
            // ุชุฃูุฏ ูู ุชููุฆุฉ ุฌููุน ุงููุนุงูุฌุงุช
            setTimeout(() => {
                showModule('dashboard');
                if (typeof initDatabase === 'function') {
                    initDatabase();
                }
                if (typeof loadSettings === 'function') {
                    loadSettings();
                }
            }, 1000);

        // ==================== ูุณุชูุนุงุช ุงูุฃุญุฏุงุซ ููุตูุฑ ูุงููุงููุฑุง ====================
            // ุงููุงููุฑุง
            document.getElementById('openCameraBtn').addEventListener('click', initializeCamera);
            document.getElementById('captureBtn').addEventListener('click', captureImage);
            document.getElementById('cancelCameraBtn').addEventListener('click', stopCamera);
            
            // ุงููุนุฑุถ
            document.getElementById('productImageUpload').addEventListener('change', handleImageUpload);
            
            // ุฑุงุจุท ุงูุตูุฑุฉ
            document.getElementById('loadImageFromUrl').addEventListener('click', loadImageFromUrl);
            document.getElementById('productImageUrl').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadImageFromUrl();
                }
            });
            
            // ุฅุฒุงูุฉ ุงูุตูุฑุฉ
            document.getElementById('removeImageBtn').addEventListener('click', removeImage);
            
            // ุญูุธ ุงูููุชุฌ
            document.getElementById('saveProductBtn').addEventListener('click', saveProductFromForm);
            
            // ุชูุธูู ุงูููุงุฑุฏ ุนูุฏ ุฅุบูุงู ุงููููุฐุฌ
            document.getElementById('productModal').addEventListener('hidden.bs.modal', function() {
                if (cameraStream) {
                    stopCamera();
                }
            });
        });

        // ุจุฏุก ุงูุชุญุฏูุซ ุงูุชููุงุฆู ููุฑุตูุฏ
        startBalanceAutoRefresh();


        /**
        * ุญุฏุซ ูุฎุตุต ูุฅุดุนุงุฑ ุชุญุฏูุซ ุงูุจูุงูุงุช
        */
        function triggerDataUpdate() {
            const event = new CustomEvent('dataUpdated');
            document.dispatchEvent(event);
        }

        // ุฌุนู ุงูุฏูุงู ูุชุงุญุฉ globally ููุงุณุชุฏุนุงุก ูู HTML ุฅุฐุง ูุฒู ุงูุฃูุฑ
        window.showCategoriesView = showCategoriesView;
        window.loadCategoriesView = loadCategoriesView;






    </script>
</body>
</html>
